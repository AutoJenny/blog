<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Actions</title>
    <!-- Tailwind CSS -->
    <link href="/static/css/dist/main.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .header-gradient {
            background: linear-gradient(90deg, #181c2a 0%, #23273a 100%);
        }

        .nav-dropdown {
            background: #23273a;
            border: 1px solid #31364a;
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.45);
        }

        .nav-dropdown a {
            color: #e0e0e0;
        }

        .nav-dropdown a:hover {
            background: #23273a;
            color: #a5b4fc;
        }
    </style>
    
<link href="/static/css/dist/main.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/admin.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    body {
        background: #18181b;
    }

    .admin-card {
        background: #23272F;
        border-radius: 1rem;
        box-shadow: 0 6px 32px rgba(0, 0, 0, 0.18);
        padding: 2.5rem 2rem 2rem 2rem;
        margin-bottom: 2rem;
    }

    .action-card {
        background: #26293a;
        border: 1.5px solid #35395a;
        border-radius: 1rem;
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 12px rgba(56, 189, 248, 0.08);
    }

    .action-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .action-accordion-item {
        background: #23273a;
        border: 1.5px solid #35395a;
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        transition: box-shadow 0.2s, border 0.2s, background 0.2s;
        box-shadow: 0 2px 8px rgba(56, 189, 248, 0.06);
        cursor: pointer;
    }

    .action-accordion-item:hover {
        border-color: #38bdf8;
        background: #23273aee;
        box-shadow: 0 4px 16px rgba(56, 189, 248, 0.13);
    }

    .action-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1.5rem;
    }

    .action-name {
        font-size: 1.15rem;
        font-weight: 700;
        color: #e0e0e0;
        letter-spacing: 0.01em;
    }

    .action-model {
        color: #a5b4fc;
        font-size: 1em;
        margin-left: 1.5rem;
        font-weight: 500;
    }

    .action-actions {
        display: flex;
        gap: 0.75rem;
    }

    .action-prompt {
        font-family: 'Monaco', 'Menlo', monospace;
        background: #18181b;
        padding: 1.1rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.95em;
        line-height: 1.6;
        white-space: pre-wrap;
        color: #e0e0e0;
        border: 1px solid #35395a;
        margin-top: 0.5rem;
    }

    .action-accordion-content {
        margin-top: 1rem;
        display: none;
    }

    .action-accordion-content.active,
    .action-accordion-content[style*='block'] {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1.4rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
        font-size: 0.95em;
    }

    .btn-primary {
        background: linear-gradient(90deg, #6366f1 0%, #38bdf8 100%);
        color: #fff;
        border: none;
        font-weight: 700;
    }

    .btn-primary:hover {
        background: linear-gradient(90deg, #38bdf8 0%, #6366f1 100%);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.18);
        color: #fff;
    }

    .btn-secondary {
        background: #23273a;
        border: 1.5px solid #35395a;
        color: #a5b4fc;
    }

    .btn-secondary:hover {
        background: #3730a3;
        border-color: #38bdf8;
        color: #fff;
    }

    .btn-danger {
        background: #DC2626;
        color: white;
        border: none;
    }

    .btn-danger:hover {
        background: #B91C1C;
        color: #fff;
    }

    .sortable-ghost {
        opacity: 0.4;
        background: #6366F1 !important;
    }

    .sortable-chosen {
        border-top: 6px solid #6366F1 !important;
        margin-top: -6px;
        box-shadow: 0 0 0 2px #6366F1;
        transition: border 0.2s, box-shadow 0.2s;
    }

    /* Modal Styling */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #23273a;
        border-radius: 1rem;
        padding: 2.5rem 2rem 2rem 2rem;
        width: 100%;
        max-width: 480px;
        box-shadow: 0 8px 32px rgba(56, 189, 248, 0.18);
        border: 1.5px solid #35395a;
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #35395a;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #e0e0e0;
    }

    .modal-close {
        background: none;
        border: none;
        color: #a5b4fc;
        cursor: pointer;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1.5rem;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: #3730a3;
        color: #fff;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        color: #a5b4fc;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.97em;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        background: #18181b;
        border: 1.5px solid #35395a;
        color: #e0e0e0;
        padding: 0.7rem 1rem;
        border-radius: 0.5rem;
        font-size: 1em;
        margin-bottom: 0.1rem;
        transition: border 0.2s, box-shadow 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
        border-color: #38bdf8;
        outline: none;
        box-shadow: 0 0 0 2px #38bdf8aa;
    }

    .form-textarea {
        min-height: 110px;
        font-family: 'Monaco', 'Menlo', monospace;
        line-height: 1.5;
        resize: vertical;
    }

    .flex.justify-end.gap-4 {
        margin-top: 2rem;
    }

    @media (max-width: 600px) {

        .admin-card,
        .modal-content {
            padding: 1.2rem;
        }

        .action-card {
            padding: 1rem;
        }
    }
</style>

</head>

<body class="min-h-screen bg-dark-bg text-dark-text flex flex-col">
    <!-- Header -->
    <header class="header-gradient shadow-lg border-b border-dark-border py-4">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-nowrap items-center justify-between h-16 space-x-6">
                <div class="flex items-center space-x-8 flex-1 min-w-0">
                    <!-- Logo and Title -->
                    <a href="/" class="flex items-center gap-3 text-white text-2xl font-bold tracking-tight">
                        <img src="/static/images/site/brand-logo.png" alt="BlogForge Logo"
                            class="w-10 h-10 rounded-full shadow"
                            style="background:#23273a; width: 40px; height: 40px;" />
                        <span class="font-bold text-white">BlogForge</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4 ml-8">
                    <!-- Only Preview link remains, right-aligned -->
                </div>
                <div class="flex-shrink-0 flex items-center gap-4 ml-4">
                    <a href="/blog/posts"
                        class="text-dark-text hover:text-dark-accent px-3 py-2 rounded-md text-sm font-medium transition">Posts</a>
                    <button
                        class="admin-button bg-dark-accent text-white hover:bg-dark-bg border border-dark-accent px-4 py-2 rounded-lg flex items-center gap-2 shadow transition"
                        id="newPostBtn">
                        <i class="fa-solid fa-plus"></i>
                        New Post
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    
    
    
    <div class="llm-nav flex justify-center gap-4 mb-8">
    <a href="/llm/providers"
        class="llm-nav-link flex items-center gap-2"
        title="Provider Management">
        <i class="fa-solid fa-server icon text-[#fbbf24]"></i>
        <span>Providers</span>
    </a>
    <a href="/llm/models"
        class="llm-nav-link flex items-center gap-2"
        title="Model Management">
        <i class="fa-solid fa-cubes icon text-[#fbbf24]"></i>
        <span>Models</span>
    </a>
    <a href="/llm/prompts"
        class="llm-nav-link flex items-center gap-2"
        title="Prompt Templates">
        <i class="fa-solid fa-scroll icon text-[#fbbf24]"></i>
        <span>Prompts</span>
    </a>
    <a href="/llm/actions"
        class="llm-nav-link flex items-center gap-2 active"
        title="Actions & Tasks">
        <i class="fa-solid fa-bolt icon text-[#fbbf24]"></i>
        <span>Actions</span>
    </a>
    <a href="/llm/logs"
        class="llm-nav-link flex items-center gap-2"
        title="Interaction Logs">
        <i class="fa-solid fa-list icon text-[#fbbf24]"></i>
        <span>Logs</span>
    </a>
    <a href="/llm/settings"
        class="llm-nav-link flex items-center gap-2"
        title="Settings">
        <i class="fa-solid fa-gear icon text-[#fbbf24]"></i>
        <span>Settings</span>
    </a>
</div>
<style>
    .llm-nav-link.active {
        color: #38bdf8 !important;
    }

    .llm-nav-link {
        color: #e0e0e0;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: background 0.2s, color 0.2s;
        text-decoration: none;
    }

    .llm-nav-link:hover {
        background: rgba(99, 102, 241, 0.08);
        color: #a5b4fc;
    }

    .llm-action-btn {
        background: linear-gradient(90deg, #6366f1 0%, #38bdf8 100%);
        color: #fff;
        font-weight: 700;
        font-size: 1.1rem;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(56, 189, 248, 0.10);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .llm-action-btn:hover {
        background: linear-gradient(90deg, #38bdf8 0%, #6366f1 100%);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.18);
        color: #fff;
    }
</style>
    
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
<div class="max-w-5xl mx-auto py-10">
    <div class="admin-content">
        <div class="admin-card">
            <div class="flex items-center justify-between mb-6">
                <h1 class="admin-title">
                    <i class="fas fa-bolt mr-2"></i>
                    LLM Actions
                </h1>
                <button class="btn btn-primary" id="newActionBtn">
                    <i class="fas fa-plus"></i>
                    New Action
                </button>
            </div>
            <div class="action-card">
                <div class="action-list" id="actionAccordionList">
                    
                    <div class="text-center text-gray-400 py-8">No actions found in the database.</div>
                    
                    
                </div>
            </div>
        </div>
    </div>

    <!-- New/Edit Action Modal -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalActionTitle">New Action</h2>
                <button type="button" class="modal-close" id="modalActionCloseBtn">×</button>
            </div>
            <form id="actionForm">
                <input type="hidden" id="actionId" name="id">
                <div class="form-group">
                    <label class="form-label" for="actionFieldName">Field Name</label>
                    <input type="text" id="actionFieldName" name="field_name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionProvider">LLM Provider</label>
                    <select id="actionProvider" name="provider_id" class="form-input" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionModel">LLM Model</label>
                    <select id="actionModel" name="llm_model" class="form-input" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionPromptTemplate">Prompt Template</label>
                    <textarea id="actionPromptTemplate" name="prompt_template" class="form-textarea"
                        required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionTemperature">Temperature</label>
                    <input type="number" id="actionTemperature" name="temperature" class="form-input" min="0" max="2"
                        step="0.1" value="0.7">
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionMaxTokens">Max Tokens</label>
                    <input type="number" id="actionMaxTokens" name="max_tokens" class="form-input" min="1" max="4096"
                        value="1000">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="btn btn-secondary" id="cancelActionBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Action</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Details Modal (Prompt Parts Management) -->
    <div id="actionDetailsModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" id="closeActionDetails">&times;</span>
            <h2>Action Details: <span id="detailsActionName"></span></h2>
            <div>
                <label>Input Field:</label> <span id="detailsInputField"></span><br>
                <label>Output Field:</label> <span id="detailsOutputField"></span>
            </div>
            <h3>Prompt Parts</h3>
            <ul id="promptPartsList" class="draggable-list"></ul>
            <button id="addPromptPartBtn">+ Add Prompt Part</button>
            <div id="promptPartEditForm" style="display:none;">
                <h4 id="promptPartFormTitle">Add/Edit Prompt Part</h4>
                <form>
                    <label>Type:
                        <select id="promptPartType">
                            <option value="system">system</option>
                            <option value="style">style</option>
                            <option value="instructions">instructions</option>
                            <option value="user">user</option>
                            <option value="assistant">assistant</option>
                            <option value="other">other</option>
                        </select>
                    </label>
                    <label>Role:
                        <select id="promptPartRole">
                            <option value="system">system</option>
                            <option value="user">user</option>
                            <option value="assistant">assistant</option>
                            <option value="tool">tool</option>
                            <option value="function">function</option>
                            <option value="other">other</option>
                        </select>
                    </label>
                    <label>Content:<br>
                        <textarea id="promptPartContent" rows="3"></textarea>
                    </label>
                    <label>Description:<br>
                        <input id="promptPartDescription" type="text" />
                    </label>
                    <label>Tags:<br>
                        <input id="promptPartTags" type="text" placeholder="Comma-separated" />
                    </label>
                    <button type="button" id="savePromptPartBtn">Save</button>
                    <button type="button" id="cancelPromptPartBtn">Cancel</button>
                </form>
            </div>
            <div style="margin-top:1em;">
                <button id="savePromptPartsOrderBtn">Save Order</button>
            </div>
            <hr>
            <h3>Test Action</h3>
            <label>Test Input:<br><textarea id="testActionInput" rows="2"></textarea></label>
            <button id="testActionBtn">Run Test</button>
            <div id="testActionOutput" style="margin-top:1em;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script>
        async function loadProviders(selectedProviderId) {
            const providerSelect = document.getElementById('actionProvider');
            providerSelect.innerHTML = '<option value="">Loading...</option>';
            const resp = await fetch('/api/v1/llm/providers');
            const providers = await resp.json();
            providerSelect.innerHTML = providers.map(p => `<option value="${p.id}" ${selectedProviderId == p.id ? 'selected' : ''}>${p.name}</option>`).join('');
        }
        async function loadModels(providerId, selectedModelId) {
            const modelSelect = document.getElementById('actionModel');
            modelSelect.innerHTML = '<option value="">Loading...</option>';
            const resp = await fetch('/api/v1/llm/models');
            const models = await resp.json();
            const filtered = models.filter(m => m.provider_id == providerId);
            modelSelect.innerHTML = filtered.map(m => `<option value="${m.name}" data-model-id="${m.id}" ${selectedModelId == m.name ? 'selected' : ''}>${m.name} (${m.description || ''})</option>`).join('');
        }
        document.addEventListener('DOMContentLoaded', function () {
            // Accordion logic
            document.querySelectorAll('.action-header').forEach(header => {
                header.addEventListener('click', function (e) {
                    if (e.target.closest('.edit-action-btn') || e.target.closest('.delete-action-btn')) return;
                    const item = header.parentElement;
                    const content = item.querySelector('.action-accordion-content');
                    const chevron = header.querySelector('.chevron');
                    const isOpen = content.classList.contains('active') || content.style.display === 'block';
                    document.querySelectorAll('.action-accordion-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.chevron').forEach(ch => ch.style.transform = 'rotate(0deg)');
                    if (!isOpen) {
                        content.classList.add('active');
                        chevron.style.transform = 'rotate(90deg)';
                    }
                });
            });
            // Drag-and-drop with SortableJS
            const el = document.getElementById('actionAccordionList');
            if (el) {
                new Sortable(el, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        const ids = Array.from(el.querySelectorAll('.action-accordion-item')).map(item => item.dataset.id);
                        fetch('/api/v1/llm/actions/order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order: ids })
                        }).then(r => r.json()).then(data => {
                            if (!data.success) {
                                alert('Failed to save order: ' + (data.error || 'Unknown error'));
                            }
                        }).catch(err => {
                            alert('Error saving order: ' + err);
                        });
                    }
                });
            }
            // Modal logic
            const actionModal = document.getElementById('actionModal');
            const newActionBtn = document.getElementById('newActionBtn');
            const modalActionCloseBtn = document.getElementById('modalActionCloseBtn');
            const cancelActionBtn = document.getElementById('cancelActionBtn');
            const actionForm = document.getElementById('actionForm');
            newActionBtn.addEventListener('click', function () {
                document.getElementById('modalActionTitle').textContent = 'New Action';
                actionForm.reset();
                document.getElementById('actionId').value = '';
                loadProviders().then(() => {
                    const providerId = document.getElementById('actionProvider').value;
                    loadModels(providerId);
                });
                actionModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            document.getElementById('actionProvider').addEventListener('change', function () {
                loadModels(this.value);
            });
            modalActionCloseBtn.addEventListener('click', function () {
                actionModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            cancelActionBtn.addEventListener('click', function () {
                actionModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            // Edit Action
            document.querySelectorAll('.edit-action-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    const response = await fetch(`/api/v1/llm/actions/${id}`);
                    if (!response.ok) return alert('Failed to load action');
                    const data = await response.json();
                    document.getElementById('modalActionTitle').textContent = 'Edit Action';
                    document.getElementById('actionId').value = data.action.id;
                    document.getElementById('actionFieldName').value = data.action.field_name;
                    // Find model and provider
                    const modelName = data.action.llm_model;
                    const resp = await fetch('/api/v1/llm/models');
                    const models = await resp.json();
                    const model = models.find(m => m.name === modelName);
                    const providerId = model ? model.provider_id : '';
                    await loadProviders(providerId);
                    await loadModels(providerId, modelName);
                    document.getElementById('actionProvider').value = providerId;
                    document.getElementById('actionModel').value = modelName;
                    document.getElementById('actionPromptTemplate').value = data.action.prompt_template;
                    document.getElementById('actionTemperature').value = data.action.temperature;
                    document.getElementById('actionMaxTokens').value = data.action.max_tokens;
                    actionModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
            });
            // Delete Action
            document.querySelectorAll('.delete-action-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    if (!confirm('Are you sure you want to delete this action?')) return;
                    const id = btn.dataset.id;
                    const response = await fetch(`/api/v1/llm/actions/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete action');
                    }
                });
            });
            // Form submit
            actionForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const actionId = document.getElementById('actionId').value;
                const method = actionId ? 'PUT' : 'POST';
                const url = actionId ? `/api/v1/llm/actions/${actionId}` : '/api/v1/llm/actions';
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            field_name: document.getElementById('actionFieldName').value,
                            llm_model: document.getElementById('actionModel').value,
                            prompt_template: document.getElementById('actionPromptTemplate').value,
                            temperature: parseFloat(document.getElementById('actionTemperature').value),
                            max_tokens: parseInt(document.getElementById('actionMaxTokens').value)
                        })
                    });
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        throw new Error('Failed to save action');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving action');
                }
            });
            // Close modal when clicking outside
            actionModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    actionModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            // Prompt Parts modal open/close logic
            function closeActionDetailsModal() {
                document.getElementById('actionDetailsModal').style.display = 'none';
                document.getElementById('promptPartEditForm').style.display = 'none';
                document.getElementById('testActionOutput').textContent = '';
            }
            document.getElementById('closeActionDetails').onclick = closeActionDetailsModal;
            document.getElementById('actionDetailsModal').onclick = function (e) {
                if (e.target === this) closeActionDetailsModal();
            };
            document.querySelectorAll('.prompt-parts-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    openActionDetails(btn.dataset.id);
                });
            });
            // Prompt Part CRUD logic
            function refreshPromptParts(actionId) {
                fetch(`/api/v1/llm/actions/${actionId}`)
                    .then(r => r.json())
                    .then(data => {
                        const action = data.action || data;
                        const list = document.getElementById('promptPartsList');
                        list.innerHTML = '';
                        (action.prompt_parts || []).forEach((part, idx) => {
                            const li = document.createElement('li');
                            li.draggable = true;
                            li.dataset.id = part.id;
                            li.dataset.order = part.order;
                            li.innerHTML = `<b>${part.type}</b> [${part.role}]<br>${part.content}<br><button type='button' class='btn btn-secondary btn-xs' onclick='editPromptPart(${actionId},${part.id})'>Edit</button> <button type='button' class='btn btn-danger btn-xs' onclick='removePromptPart(${actionId},${part.id})'>Remove</button>`;
                            list.appendChild(li);
                        });
                    });
            }
            window.editPromptPart = function (actionId, partId) {
                fetch(`/api/v1/llm/prompt_parts/${partId}`)
                    .then(r => r.json())
                    .then(part => {
                        document.getElementById('promptPartType').value = part.type;
                        document.getElementById('promptPartRole').value = part.role;
                        document.getElementById('promptPartContent').value = part.content;
                        document.getElementById('promptPartDescription').value = part.description || '';
                        document.getElementById('promptPartTags').value = (part.tags || []).join(', ');
                        document.getElementById('promptPartEditForm').style.display = 'block';
                        document.getElementById('promptPartEditForm').dataset.editing = partId;
                        document.getElementById('promptPartEditForm').dataset.actionId = actionId;
                    });
            };
            window.removePromptPart = function (actionId, partId) {
                if (!confirm('Remove this prompt part from the action?')) return;
                fetch(`/api/v1/llm/actions/${actionId}/prompt_parts/${partId}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(() => refreshPromptParts(actionId));
            };
            document.getElementById('addPromptPartBtn').onclick = function () {
                document.getElementById('promptPartType').value = 'system';
                document.getElementById('promptPartRole').value = 'user';
                document.getElementById('promptPartContent').value = '';
                document.getElementById('promptPartDescription').value = '';
                document.getElementById('promptPartTags').value = '';
                document.getElementById('promptPartEditForm').style.display = 'block';
                document.getElementById('promptPartEditForm').dataset.editing = '';
                document.getElementById('promptPartEditForm').dataset.actionId = document.getElementById('actionDetailsModal').dataset.actionId;
            };
            document.getElementById('cancelPromptPartBtn').onclick = function () {
                document.getElementById('promptPartEditForm').style.display = 'none';
            };
            document.getElementById('savePromptPartBtn').onclick = function () {
                const type = document.getElementById('promptPartType').value;
                const role = document.getElementById('promptPartRole').value;
                const content = document.getElementById('promptPartContent').value;
                const description = document.getElementById('promptPartDescription').value;
                const tags = document.getElementById('promptPartTags').value.split(',').map(t => t.trim()).filter(Boolean);
                const editing = document.getElementById('promptPartEditForm').dataset.editing;
                const actionId = document.getElementById('promptPartEditForm').dataset.actionId;
                let url, method, body;
                if (editing) {
                    url = `/api/v1/llm/prompt_parts/${editing}`;
                    method = 'PUT';
                    body = JSON.stringify({ type, role, content, description, tags });
                } else {
                    url = `/api/v1/llm/prompt_parts`;
                    method = 'POST';
                    body = JSON.stringify({ type, role, content, description, tags });
                }
                fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body })
                    .then(r => r.json())
                    .then(part => {
                        if (!editing) {
                            // Link to action
                            fetch(`/api/v1/llm/actions/${actionId}/prompt_parts`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ prompt_part_id: part.id })
                            }).then(() => refreshPromptParts(actionId));
                        } else {
                            refreshPromptParts(actionId);
                        }
                        document.getElementById('promptPartEditForm').style.display = 'none';
                    });
            };
            // Drag-and-drop reordering for prompt parts
            new Sortable(document.getElementById('promptPartsList'), {
                animation: 150,
                onEnd: function (evt) {
                    const actionId = document.getElementById('actionDetailsModal').dataset.actionId;
                    const ids = Array.from(document.getElementById('promptPartsList').children).map(li => li.dataset.id);
                    fetch(`/api/v1/llm/actions/${actionId}/prompt_parts/order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order: ids })
                    }).then(r => r.json()).then(data => {
                        if (!data.success) alert('Failed to save prompt part order: ' + (data.error || 'Unknown error'));
                    });
                }
            });
            document.getElementById('savePromptPartsOrderBtn').onclick = function () {
                const actionId = document.getElementById('actionDetailsModal').dataset.actionId;
                const ids = Array.from(document.getElementById('promptPartsList').children).map(li => li.dataset.id);
                fetch(`/api/v1/llm/actions/${actionId}/prompt_parts/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order: ids })
                }).then(r => r.json()).then(data => {
                    if (!data.success) alert('Failed to save prompt part order: ' + (data.error || 'Unknown error'));
                });
            };
            // Test Action logic
            document.getElementById('testActionBtn').onclick = function () {
                const actionId = document.getElementById('actionDetailsModal').dataset.actionId;
                const input = document.getElementById('testActionInput').value;
                document.getElementById('testActionOutput').textContent = 'Running...';
                fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input })
                })
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('testActionOutput').textContent = data.output || data.result || JSON.stringify(data);
                    })
                    .catch(err => {
                        document.getElementById('testActionOutput').textContent = 'Error: ' + err;
                    });
            };
        });
    </script>
</div>

    </main>
    

    <!-- Footer -->
    <footer class="bg-indigo-950 border-t border-dark-border py-6 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-dark-text">
                &copy; 2025 Blog CMS. All rights reserved. |
                <a href="/docs" class="text-indigo-300 hover:text-indigo-100 underline ml-2">Docs</a>
            </p>
        </div>
    </footer>

    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var newPostBtn = document.getElementById('newPostBtn');
            if (newPostBtn) {
                newPostBtn.addEventListener('click', async () => {
                    const basicIdea = prompt('Enter your basic idea for the post:');
                    if (!basicIdea) return;
                    try {
                        const response = await fetch("/blog/new", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ basic_idea: basicIdea })
                        });
                        const data = await response.json();
                        if (response.ok && data.id) {
                            window.location.href = `/workflow/idea/?post_id=${data.id}`;
                        } else {
                            alert(data.error || 'Failed to create post');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Failed to create post');
                    }
                });
            }
        });
    </script>
    
    <!-- Mermaid.js for diagrams in markdown -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.mermaid) {
                setTimeout(function () {
                    mermaid.initialize({ startOnLoad: false });
                    document.querySelectorAll('pre > code.language-mermaid').forEach(function (block, i) {
                        var parent = block.parentElement;
                        var code = block.innerText;
                        var d = document.createElement('div');
                        d.className = 'mermaid';
                        d.innerText = code;
                        parent.replaceWith(d);
                    });
                    try {
                        mermaid.run();
                    } catch (e) {
                        console.error('Mermaid render error:', e);
                        document.querySelectorAll('.mermaid').forEach(function (el) {
                            el.innerHTML = '<div style="color:#f87171;background:#23273a;padding:1em;border-radius:.5em;">Mermaid render error:<br>' + e.message + '</div>';
                        });
                    }
                }, 100);
            }
        });
    </script>
</body>

</html>