# Structure Planning Stage

## Purpose

The Structure Planning stage is responsible for organizing the content into a logical, engaging structure based on the research and facts gathered in previous stages. This stage creates a clear outline that will guide the content creation process.

## Page URL
```
http://localhost:5000/workflow/structure/?post_id=<id>
```

## Page Components

### Inputs Panel
```html
<!-- templates/workflow/planning/structure/index.html -->
<div class="panel bg-gray-800 dark:bg-[#23293a] rounded-lg p-6">
    <h2 class="text-lg font-bold mb-2 text-gray-800 dark:text-gray-200">Inputs</h2>
    <div class="mb-2">
        <label class="block font-semibold text-gray-700 dark:text-gray-200">Title</label>
        <input type="text" class="input w-full bg-gray-900 dark:bg-[#181c23] text-gray-200 placeholder-gray-400 border border-gray-700" />
    </div>
    <div class="mb-2">
        <label class="block font-semibold text-gray-700 dark:text-gray-200">Basic Idea</label>
        <textarea class="input w-full bg-gray-900 dark:bg-[#181c23] text-gray-200 placeholder-gray-400 border border-gray-700" rows="2"></textarea>
    </div>
    <div class="mb-2">
        <label class="block font-semibold text-gray-700 dark:text-gray-200">Interesting Facts</label>
        <textarea class="input w-full bg-gray-900 dark:bg-[#181c23] text-gray-200 placeholder-gray-400 border border-gray-700" rows="3"></textarea>
    </div>
</div>
```

### Component References
- **Title Input** 
  - Field: `post_development.provisional_title`
  - Used in: `app/static/js/workflow/structure_stage.js:planStructure()`
  - Event handler: `app/static/js/workflow/structure_stage.js:handleTitleChange()`
  - Source: `workflow_field_mapping` table (id: 1, stage_id: 10, substage_id: 1, order_index: 1)

- **Basic Idea Textarea**
  - Field: `post_development.basic_idea`
  - Used in: `app/static/js/workflow/structure_stage.js:planStructure()`
  - Event handler: `app/static/js/workflow/structure_stage.js:handleIdeaChange()`
  - Source: `workflow_field_mapping` table (id: 1, stage_id: 10, substage_id: 1, order_index: 2)

- **Interesting Facts Textarea**
  - Field: `post_development.interesting_facts`
  - Used in: `app/static/js/workflow/structure_stage.js:planStructure()`
  - Event handler: `app/static/js/workflow/structure_stage.js:handleFactsChange()`
  - Source: `workflow_field_mapping` table (id: 5, stage_id: 10, substage_id: 2, order_index: 2)

### Structure Panel
```html
<!-- templates/workflow/planning/structure/index.html -->
<div class="panel bg-gray-800 dark:bg-[#23293a] rounded-lg p-6">
    <h2 class="text-lg font-bold mb-2 text-gray-800 dark:text-gray-200">Structure</h2>
    <button class="btn-primary bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Generate Structure
    </button>
    <div id="sections-list" class="mt-4 space-y-4"></div>
</div>
```

- **Generate Structure Button**
  - Action: `section_structure_creator`
  - Used in: `app/static/js/workflow/structure_stage.js:planStructure()`
  - Endpoint: `POST /api/v1/structure/plan`

- **Structure Display**
  - Field: `post_development.section_planning`
  - Used in: `app/static/js/workflow/structure_stage.js:renderSections()`
  - Source: `workflow_field_mapping` table (id: 7, stage_id: 10, substage_id: 3, order_index: 1)

## API Endpoints

### Main Structure Planning Endpoint
```python
# app/api/routes.py
POST /api/v1/structure/plan
Content-Type: application/json

Request Body:
{
    "title": string,  # From post_development.provisional_title
    "idea": string,   # From post_development.basic_idea
    "facts": string[] # From post_development.interesting_facts
}

Response:
{
    "sections": [
        {
            "name": string,
            "description": string,
            "themes": string[],
            "facts": string[]
        }
    ]
}
```

## Database Fields

### post_development Table
```sql
-- Used in: app/static/js/workflow/structure_stage.js:planStructure()
id: integer (PRIMARY KEY)  -- From URL parameter post_id
provisional_title: text    -- From input[type="text"]
basic_idea: text          -- From textarea (first)
interesting_facts: text    -- From textarea (second)
section_planning: text     -- Generated by section_structure_creator
```

## JavaScript Functions

### Structure Panel
```javascript
// app/static/js/workflow/structure_stage.js
async function planStructure(title, idea, facts) {
  const resp = await fetch('/api/v1/structure/plan', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, idea, facts })
  });
  return await resp.json();
}

// Event handlers for input changes
document.addEventListener('DOMContentLoaded', async () => {
  const titleInput = document.querySelector('input[type="text"]');
  const ideaTextarea = document.querySelectorAll('textarea')[0];
  const factsTextarea = document.querySelectorAll('textarea')[1];
  
  // Load existing data
  const dev = await fetchPostDevelopment(postId);
  if (dev) {
    if (titleInput && dev.provisional_title) titleInput.value = dev.provisional_title;
    if (ideaTextarea && dev.basic_idea) ideaTextarea.value = dev.basic_idea;
    if (factsTextarea && dev.interesting_facts) factsTextarea.value = dev.interesting_facts;
  }
});
```

## Error Handling

### HTTP Status Codes
```python
# app/api/routes.py:plan_structure()
400: Bad Request - Invalid input data  # Used in app/static/js/workflow/structure_stage.js:handleError()
404: Not Found - Post not found        # Used in app/static/js/workflow/structure_stage.js:handleError()
500: Internal Server Error             # Used in app/static/js/workflow/structure_stage.js:handleError()
```

### Error Response Format
```json
{
    "error": "string",
    "details": "string"
}
```

## Recent Changes

### 2024-06-14
- Updated to use universal modular LLM panel  # Changed: static/js/workflow/panels/structure_panel.js
- Added error handling for Ollama service  # Changed: app/api/llm_service.py
- Implemented retry logic for LLM calls  # Changed: app/api/llm_service.py 

## Complete Data Reference

### Database Fields

#### Input Fields (post_development table)
```sql
-- All fields used in this stage
id: integer (PRIMARY KEY)  -- From URL parameter post_id
provisional_title: text    -- From input[type="text"]
basic_idea: text          -- From textarea (first)
interesting_facts: text    -- From textarea (second)
section_planning: text     -- Generated by section_structure_creator
current_stage: text       -- Set to 'structure' when entering this stage
current_substage: text    -- Set to 'plan' when entering this stage
```

### API Endpoints

#### GET /workflow/structure/
```python
# app/api/routes.py:structure_stage()
# Used by: templates/workflow/structure.html

Query Parameters:
- post_id: integer (required)  # Used to fetch post_development record

Response:
- HTML page with structure planning interface
- Includes post data from post_development table
```

#### POST /api/v1/structure/plan
```python
# app/api/routes.py:plan_structure()
# Used by: static/js/workflow/panels/structure_panel.js:generateStructure()

Request Body:
{
    "title": string,  # From post_development.provisional_title
    "idea": string,   # From post_development.basic_idea
    "facts": string[] # From post_development.interesting_facts
}

Response:
{
    "sections": [
        {
            "name": string,  # Stored in post_development.section_planning
            "description": string  # Stored in post_development.section_planning
        }
    ]
}
```

#### POST /api/v1/workflow/update_stage
```python
# app/api/routes.py:update_workflow_stage()
# Used by: static/js/workflow/panels/structure_panel.js:handleStageChange()

Request Body:
{
    "post_id": integer,  # From URL parameter
    "stage": "structure"  # Fixed value for this page
}

Response:
{
    "success": boolean,
    "current_stage": string  # Updated post_development.current_stage
}
```

#### POST /api/v1/workflow/update_substage
```python
# app/api/routes.py:update_workflow_substage()
# Used by: static/js/workflow/panels/structure_panel.js:handleSubstageChange()

Request Body:
{
    "post_id": integer,  # From URL parameter
    "substage": "plan"  # Fixed value for this page
}

Response:
{
    "success": boolean,
    "current_substage": string  # Updated post_development.current_substage
}
```

### UI Components and Their Data Bindings

#### Input Fields
```html
<!-- templates/workflow/structure.html -->
<input type="text" id="title" name="title" 
       value="{{ post.title }}"  <!-- From post_development.provisional_title -->
       data-field="title"        <!-- Used in updateField() -->
       data-table="post_development">

<textarea id="idea" name="idea"
          data-field="idea"      <!-- Used in updateField() -->
          data-table="post_development">{{ post.basic_idea }}</textarea>  <!-- From post_development.basic_idea -->

<textarea id="facts" name="facts"
          data-field="facts"     <!-- Used in updateField() -->
          data-table="post_development">{{ post.interesting_facts }}</textarea>  <!-- From post_development.interesting_facts -->
```

#### Structure Display
```html
<!-- templates/workflow/components/structure_display.html -->
<div id="structure-display">
    {% for section in post.section_planning.sections %}  <!-- From post_development.section_planning -->
    <div class="section">
        <h3>{{ section.name }}</h3>  <!-- From post_development.section_planning.sections[].name -->
        <p>{{ section.description }}</p>  <!-- From post_development.section_planning.sections[].description -->
    </div>
    {% endfor %}
</div>
```

### JavaScript Event Handlers and Their Data Flow

```javascript
// static/js/workflow/panels/structure_panel.js

// Input change handlers
document.getElementById('title').addEventListener('change', (e) => {
    // Updates post_development.provisional_title
    updateField('title', e.target.value);
});

document.getElementById('idea').addEventListener('change', (e) => {
    // Updates post_development.basic_idea
    updateField('idea', e.target.value);
});

document.getElementById('facts').addEventListener('change', (e) => {
    // Updates post_development.interesting_facts
    updateField('facts', JSON.parse(e.target.value));
});

// Generate structure handler
document.getElementById('generate-structure').addEventListener('click', async () => {
    // Calls POST /api/v1/structure/plan
    // Updates post_development.section_planning
    const result = await generateStructure();
    updateStructureDisplay(result.sections);
});
```

### Database Queries Used

```sql
-- app/api/db.py:get_post_development()
-- Used in: app/api/routes.py:structure_stage()
SELECT id, provisional_title, basic_idea, interesting_facts, section_planning, current_stage, current_substage
FROM post_development
WHERE id = %s

-- app/api/db.py:update_post_development()
-- Used in: static/js/workflow/panels/structure_panel.js:updateField()
UPDATE post_development
SET {field} = %s,
    updated_at = CURRENT_TIMESTAMP
WHERE id = %s

-- app/api/db.py:update_post_structure()
-- Used in: app/api/routes.py:plan_structure()
UPDATE post_development
SET section_planning = %s,
    updated_at = CURRENT_TIMESTAMP
WHERE id = %s

-- app/api/db.py:update_workflow_stage()
-- Used in: static/js/workflow/panels/structure_panel.js:handleStageChange()
UPDATE post_development
SET current_stage = %s,
    updated_at = CURRENT_TIMESTAMP
WHERE id = %s

-- app/api/db.py:update_workflow_substage()
-- Used in: static/js/workflow/panels/structure_panel.js:handleSubstageChange()
UPDATE post_development
SET current_substage = %s,
    updated_at = CURRENT_TIMESTAMP
WHERE id = %s
``` 