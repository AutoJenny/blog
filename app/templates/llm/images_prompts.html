{% extends 'base.html' %}
{% block title %}LLM Image Prompts{% endblock %}
{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .nav-links {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--admin-border);
        padding-bottom: 0.5rem;
    }

    .nav-link {
        color: var(--admin-text-secondary);
        text-decoration: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-link:hover {
        color: var(--admin-text);
        background: rgba(99, 102, 241, 0.1);
    }

    .nav-link.active {
        color: var(--admin-accent);
        background: rgba(99, 102, 241, 0.1);
        border-bottom: 2px solid var(--admin-accent);
        margin-bottom: -1px;
    }

    .images-submenu {
        margin-top: -0.5rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 1.5rem;
        border-bottom: 1px solid var(--admin-border);
        padding-bottom: 0.5rem;
    }

    .images-tab {
        padding: 0.75rem 1.5rem;
        color: var(--admin-text-secondary);
        border: none;
        background: transparent;
        font-weight: 500;
        border-radius: 0.5rem 0.5rem 0 0;
        transition: all 0.2s;
        text-decoration: none;
    }

    .images-tab:hover {
        color: var(--admin-text);
        background: rgba(99, 102, 241, 0.08);
    }

    .images-tab-active {
        color: var(--admin-accent);
        background: rgba(99, 102, 241, 0.10);
        border-bottom: 2px solid var(--admin-accent);
    }

    .modal-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal {
        background: #23272F;
        border-radius: 1rem;
        padding: 2rem;
        min-width: 320px;
        max-width: 90vw;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    }

    .modal input,
    .modal textarea {
        width: 100%;
        margin-bottom: 1rem;
    }

    .modal .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }
</style>
{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto py-10">
    <div class="admin-card">
        <h1 class="admin-title mb-6">
            <i class="fas fa-robot mr-2"></i>
            LLM Management
        </h1>
        <div class="nav-links">
            <a href="/llm/templates" class="nav-link">
                <i class="fas fa-file-alt"></i>
                Prompt Templates
            </a>
            <a href="/llm/images" class="nav-link active">
                <i class="fas fa-image"></i>
                Images
            </a>
            <a href="/llm/config" class="nav-link">
                <i class="fas fa-cog"></i>
                Configuration
            </a>
        </div>
        <div class="images-submenu">
            <a href="/llm/images/prompts" class="images-tab images-tab-active">Image Prompts</a>
            <a href="/llm/images/previews" class="images-tab">Image Previews</a>
        </div>
        <form id="imagePromptForm" class="mb-10 bg-dark-bg p-6 rounded-lg shadow border border-dark-border">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                <div>
                    <label class="form-label block mb-2" for="promptDescription">Description</label>
                    <textarea id="promptDescription" name="description" class="form-textarea w-full" rows="3"
                        placeholder="Describe the image you want to generate..."></textarea>
                </div>
                <div>
                    <label class="form-label block mb-2" for="promptStyle">Style</label>
                    <div class="flex gap-2 items-center mb-2">
                        <select id="promptStyleSelect" name="style" class="form-input w-full">
                            <option value="">-- Select a Style --</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="newStyleBtn">
                            <i class="fas fa-plus"></i> New
                        </button>
                        <button type="button" class="btn btn-secondary" id="editStyleBtn" style="display:none;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteStyleBtn" style="display:none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="selectedStyleDisplay" class="text-sm text-gray-400 mt-1" style="min-height:1.5em;"></div>
                </div>
                <div>
                    <label class="form-label block mb-2" for="promptFormat">Format</label>
                    <div class="flex gap-2 items-center mb-2">
                        <select id="promptFormatSelect" name="format" class="form-input w-full">
                            <option value="">-- Select a Format --</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="newFormatBtn">
                            <i class="fas fa-plus"></i> New
                        </button>
                        <button type="button" class="btn btn-secondary" id="editFormatBtn" style="display:none;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteFormatBtn" style="display:none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="selectedFormatDisplay" class="text-sm text-gray-400 mt-1" style="min-height:1.5em;"></div>
                </div>
            </div>
            <div class="flex gap-4 mb-2">
                <button type="button" class="btn btn-secondary" id="importFromPostBtn">
                    <i class="fas fa-download"></i> Import from Post
                </button>
                <button type="button" class="btn btn-primary" id="testPromptBtn">
                    <i class="fas fa-vial"></i> Test
                </button>
            </div>
        </form>
        <div class="text-center text-lg text-gray-400 mt-12">
            <p>Image Prompts management coming soon.</p>
        </div>
    </div>
</div>
<!-- Style Modal -->
<div id="styleModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
        <h2 class="text-xl font-semibold mb-4" id="styleModalTitle">Add Style</h2>
        <input type="text" id="styleTitleInput" placeholder="Style Title" />
        <textarea id="styleDescInput" rows="3" placeholder="Style Description"></textarea>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelStyleBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveStyleBtn">Save</button>
        </div>
        <div id="styleModalError" class="text-red-400 mt-2"></div>
    </div>
</div>
<!-- Format Modal -->
<div id="formatModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
        <h2 class="text-xl font-semibold mb-4" id="formatModalTitle">Add Format</h2>
        <input type="text" id="formatTitleInput" placeholder="Format Title" />
        <textarea id="formatDescInput" rows="3" placeholder="Format Description"></textarea>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelFormatBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveFormatBtn">Save</button>
        </div>
        <div id="formatModalError" class="text-red-400 mt-2"></div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const styleSelect = document.getElementById('promptStyleSelect');
        const styleDisplay = document.getElementById('selectedStyleDisplay');
        const editStyleBtn = document.getElementById('editStyleBtn');
        const deleteStyleBtn = document.getElementById('deleteStyleBtn');
        let styleLibrary = {};
        // --- Modal elements ---
        const styleModalBg = document.getElementById('styleModalBg');
        const styleModalTitle = document.getElementById('styleModalTitle');
        const styleTitleInput = document.getElementById('styleTitleInput');
        const styleDescInput = document.getElementById('styleDescInput');
        const saveStyleBtn = document.getElementById('saveStyleBtn');
        const cancelStyleBtn = document.getElementById('cancelStyleBtn');
        const styleModalError = document.getElementById('styleModalError');
        let editingStyleId = null;

        // --- Format logic ---
        const formatSelect = document.getElementById('promptFormatSelect');
        const formatDisplay = document.getElementById('selectedFormatDisplay');
        const editFormatBtn = document.getElementById('editFormatBtn');
        const deleteFormatBtn = document.getElementById('deleteFormatBtn');
        let formatLibrary = {};
        // --- Modal elements ---
        const formatModalBg = document.getElementById('formatModalBg');
        const formatModalTitle = document.getElementById('formatModalTitle');
        const formatTitleInput = document.getElementById('formatTitleInput');
        const formatDescInput = document.getElementById('formatDescInput');
        const saveFormatBtn = document.getElementById('saveFormatBtn');
        const cancelFormatBtn = document.getElementById('cancelFormatBtn');
        const formatModalError = document.getElementById('formatModalError');
        let editingFormatId = null;

        // --- Fetch and populate styles ---
        async function loadStyles() {
            styleSelect.innerHTML = '<option value="">-- Select a Style --</option>';
            styleLibrary = {};
            try {
                const res = await fetch('/api/v1/images/styles');
                const styles = await res.json();
                styles.forEach(s => {
                    styleLibrary[s.id] = s;
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.title;
                    styleSelect.appendChild(opt);
                });
            } catch (e) {
                styleSelect.innerHTML = '<option value="">(Failed to load styles)</option>';
            }
            // Hide edit/delete if nothing selected
            editStyleBtn.style.display = 'none';
            deleteStyleBtn.style.display = 'none';
        }
        loadStyles();

        styleSelect.addEventListener('change', function () {
            const val = styleSelect.value;
            if (val && styleLibrary[val]) {
                styleDisplay.innerHTML = `<strong>${styleLibrary[val].title}</strong>: ${styleLibrary[val].description || ''}`;
                editStyleBtn.style.display = '';
                deleteStyleBtn.style.display = '';
            } else {
                styleDisplay.textContent = '';
                editStyleBtn.style.display = 'none';
                deleteStyleBtn.style.display = 'none';
            }
        });

        // --- Modal logic ---
        function openStyleModal(editId = null) {
            editingStyleId = editId;
            styleModalError.textContent = '';
            if (editId && styleLibrary[editId]) {
                styleModalTitle.textContent = 'Edit Style';
                styleTitleInput.value = styleLibrary[editId].title;
                styleDescInput.value = styleLibrary[editId].description || '';
            } else {
                styleModalTitle.textContent = 'Add Style';
                styleTitleInput.value = '';
                styleDescInput.value = '';
            }
            styleModalBg.style.display = '';
            styleTitleInput.focus();
        }
        function closeStyleModal() {
            styleModalBg.style.display = 'none';
        }
        document.getElementById('newStyleBtn').addEventListener('click', function () {
            openStyleModal();
        });
        editStyleBtn.addEventListener('click', function () {
            const val = styleSelect.value;
            if (val && styleLibrary[val]) openStyleModal(val);
        });
        deleteStyleBtn.addEventListener('click', async function () {
            const val = styleSelect.value;
            if (!val || !styleLibrary[val]) return;
            if (!confirm(`Delete style "${styleLibrary[val].title}"? This cannot be undone.`)) return;
            deleteStyleBtn.disabled = true;
            try {
                const res = await fetch(`/api/v1/images/styles/${val}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to delete style');
                }
                await loadStyles();
                styleSelect.value = '';
                styleSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                alert(e.message);
            } finally {
                deleteStyleBtn.disabled = false;
            }
        });
        cancelStyleBtn.addEventListener('click', closeStyleModal);
        styleModalBg.addEventListener('click', function (e) {
            if (e.target === styleModalBg) closeStyleModal();
        });
        // --- Save style (add or edit) ---
        saveStyleBtn.addEventListener('click', async function () {
            const title = styleTitleInput.value.trim();
            const description = styleDescInput.value.trim();
            if (!title) {
                styleModalError.textContent = 'Title is required.';
                return;
            }
            saveStyleBtn.disabled = true;
            try {
                let res, data;
                if (editingStyleId) {
                    res = await fetch(`/api/v1/images/styles/${editingStyleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                } else {
                    res = await fetch('/api/v1/images/styles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                }
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to save style');
                closeStyleModal();
                await loadStyles();
                // Optionally, select the new/edited style
                if (editingStyleId) {
                    styleSelect.value = editingStyleId;
                } else {
                    styleSelect.value = data.id;
                }
                styleSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                styleModalError.textContent = e.message;
            } finally {
                saveStyleBtn.disabled = false;
            }
        });

        // --- Fetch and populate formats ---
        async function loadFormats() {
            formatSelect.innerHTML = '<option value="">-- Select a Format --</option>';
            formatLibrary = {};
            try {
                const res = await fetch('/api/v1/images/formats');
                const formats = await res.json();
                formats.forEach(f => {
                    formatLibrary[f.id] = f;
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = f.title;
                    formatSelect.appendChild(opt);
                });
            } catch (e) {
                formatSelect.innerHTML = '<option value="">(Failed to load formats)</option>';
            }
            editFormatBtn.style.display = 'none';
            deleteFormatBtn.style.display = 'none';
        }
        loadFormats();

        formatSelect.addEventListener('change', function () {
            const val = formatSelect.value;
            if (val && formatLibrary[val]) {
                formatDisplay.innerHTML = `<strong>${formatLibrary[val].title}</strong>: ${formatLibrary[val].description || ''}`;
                editFormatBtn.style.display = '';
                deleteFormatBtn.style.display = '';
            } else {
                formatDisplay.textContent = '';
                editFormatBtn.style.display = 'none';
                deleteFormatBtn.style.display = 'none';
            }
        });

        // --- Format logic ---
        function openFormatModal(editId = null) {
            editingFormatId = editId;
            formatModalError.textContent = '';
            if (editId && formatLibrary[editId]) {
                formatModalTitle.textContent = 'Edit Format';
                formatTitleInput.value = formatLibrary[editId].title;
                formatDescInput.value = formatLibrary[editId].description || '';
            } else {
                formatModalTitle.textContent = 'Add Format';
                formatTitleInput.value = '';
                formatDescInput.value = '';
            }
            formatModalBg.style.display = '';
            formatTitleInput.focus();
        }
        function closeFormatModal() {
            formatModalBg.style.display = 'none';
        }
        document.getElementById('newFormatBtn').addEventListener('click', function () {
            openFormatModal();
        });
        editFormatBtn.addEventListener('click', function () {
            const val = formatSelect.value;
            if (val && formatLibrary[val]) openFormatModal(val);
        });
        deleteFormatBtn.addEventListener('click', async function () {
            const val = formatSelect.value;
            if (!val || !formatLibrary[val]) return;
            if (!confirm(`Delete format "${formatLibrary[val].title}"? This cannot be undone.`)) return;
            deleteFormatBtn.disabled = true;
            try {
                const res = await fetch(`/api/v1/images/formats/${val}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to delete format');
                }
                await loadFormats();
                formatSelect.value = '';
                formatSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                alert(e.message);
            } finally {
                deleteFormatBtn.disabled = false;
            }
        });
        cancelFormatBtn.addEventListener('click', closeFormatModal);
        formatModalBg.addEventListener('click', function (e) {
            if (e.target === formatModalBg) closeFormatModal();
        });
        saveFormatBtn.addEventListener('click', async function () {
            const title = formatTitleInput.value.trim();
            const description = formatDescInput.value.trim();
            if (!title) {
                formatModalError.textContent = 'Title is required.';
                return;
            }
            saveFormatBtn.disabled = true;
            try {
                let res, data;
                if (editingFormatId) {
                    res = await fetch(`/api/v1/images/formats/${editingFormatId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                } else {
                    res = await fetch('/api/v1/images/formats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                }
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to save format');
                closeFormatModal();
                await loadFormats();
                if (editingFormatId) {
                    formatSelect.value = editingFormatId;
                } else {
                    formatSelect.value = data.id;
                }
                formatSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                formatModalError.textContent = e.message;
            } finally {
                saveFormatBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}