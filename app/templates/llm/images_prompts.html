{% extends 'base.html' %}
{% block title %}LLM Image Prompts{% endblock %}
{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .nav-links {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--admin-border);
        padding-bottom: 0.5rem;
    }

    .nav-link {
        color: var(--admin-text-secondary);
        text-decoration: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-link:hover {
        color: var(--admin-text);
        background: rgba(99, 102, 241, 0.1);
    }

    .nav-link.active {
        color: var(--admin-accent);
        background: rgba(99, 102, 241, 0.1);
        border-bottom: 2px solid var(--admin-accent);
        margin-bottom: -1px;
    }

    .images-submenu {
        margin-top: -0.5rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 1.5rem;
        border-bottom: 1px solid var(--admin-border);
        padding-bottom: 0.5rem;
    }

    .images-tab {
        padding: 0.75rem 1.5rem;
        color: var(--admin-text-secondary);
        border: none;
        background: transparent;
        font-weight: 500;
        border-radius: 0.5rem 0.5rem 0 0;
        transition: all 0.2s;
        text-decoration: none;
    }

    .images-tab:hover {
        color: var(--admin-text);
        background: rgba(99, 102, 241, 0.08);
    }

    .images-tab-active {
        color: var(--admin-accent);
        background: rgba(99, 102, 241, 0.10);
        border-bottom: 2px solid var(--admin-accent);
    }

    .modal-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal {
        background: #23272F;
        border-radius: 1rem;
        padding: 2rem;
        min-width: 320px;
        max-width: 90vw;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    }

    .modal input,
    .modal textarea {
        width: 100%;
        margin-bottom: 1rem;
    }

    .modal .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .images-level2-tabs {
        display: flex;
        gap: 1.5rem;
        border-bottom: 2px solid var(--admin-border);
        margin-bottom: 2rem;
        padding-bottom: 0.5rem;
    }

    .images-level2-tab {
        padding: 0.75rem 1.5rem;
        color: var(--admin-text-secondary);
        border: none;
        background: transparent;
        font-weight: 600;
        border-radius: 0.5rem 0.5rem 0 0;
        font-size: 1.1rem;
        transition: all 0.2s;
        text-decoration: none;
        position: relative;
    }

    .images-level2-tab:hover {
        color: var(--admin-text);
        background: rgba(99, 102, 241, 0.08);
    }

    .images-level2-tab.active {
        color: var(--admin-accent);
        background: rgba(99, 102, 241, 0.10);
        border-bottom: 2.5px solid var(--admin-accent);
    }
</style>
{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto py-10">
    <div class="admin-card">
        <h1 class="admin-title mb-6">
            <i class="fas fa-robot mr-2"></i>
            LLM Image Tools
        </h1>
        <div class="images-level2-tabs">
            <a href="/llm/images/configs"
                class="images-level2-tab{% if active_tab == 'configs' %} active{% endif %}">Image Configs</a>
            <a href="/llm/images/prompts"
                class="images-level2-tab{% if active_tab == 'prompts' %} active{% endif %}">Image Prompts</a>
            <a href="/llm/images/previews"
                class="images-level2-tab{% if active_tab == 'previews' %} active{% endif %}">Image Previews</a>
        </div>
        <form id="imagePromptForm" class="mb-10 bg-dark-bg p-6 rounded-lg shadow border border-dark-border">
            <!-- PROVIDER MULTI-SELECT -->
            <div class="mb-6">
                <label class="form-label block mb-2">Providers</label>
                <div id="providerCheckboxes" class="flex gap-4">
                    <label><input type="checkbox" class="provider-checkbox" value="sd" checked> SD (local)</label>
                    <label><input type="checkbox" class="provider-checkbox" value="openai"> OpenAI DALL·E</label>
                    <!-- Add more providers as needed -->
                </div>
            </div>
            <!-- IMAGE SETTING MENU -->
            <div class="mb-6">
                <label class="form-label block mb-2" for="imageSettingSelect">Image Setting</label>
                <div class="flex gap-2 items-center mb-2">
                    <select id="imageSettingSelect" class="form-input w-full">
                        <option value="">-- Select an Image Setting --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" id="newImageSettingBtn">
                        <i class="fas fa-plus"></i> New
                    </button>
                    <button type="button" class="btn btn-secondary" id="editImageSettingBtn" style="display:none;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteImageSettingBtn" style="display:none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div id="selectedImageSettingDisplay" class="text-sm text-gray-400 mt-1" style="min-height:1.5em;">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                <div>
                    <label class="form-label block mb-2" for="promptDescription">Description</label>
                    <textarea id="promptDescription" name="description" class="form-textarea w-full" rows="3"
                        placeholder="Describe the image you want to generate..."></textarea>
                </div>
                <div>
                    <label class="form-label block mb-2" for="promptStyle">Style</label>
                    <div class="flex gap-2 items-center mb-2">
                        <select id="promptStyleSelect" name="style" class="form-input w-full">
                            <option value="">-- Select a Style --</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="newStyleBtn">
                            <i class="fas fa-plus"></i> New
                        </button>
                        <button type="button" class="btn btn-secondary" id="editStyleBtn" style="display:none;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteStyleBtn" style="display:none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="selectedStyleDisplay" class="text-sm text-gray-400 mt-1" style="min-height:1.5em;"></div>
                </div>
                <div>
                    <label class="form-label block mb-2" for="promptFormat">Format</label>
                    <div class="flex gap-2 items-center mb-2">
                        <select id="promptFormatSelect" name="format" class="form-input w-full">
                            <option value="">-- Select a Format --</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="newFormatBtn">
                            <i class="fas fa-plus"></i> New
                        </button>
                        <button type="button" class="btn btn-secondary" id="editFormatBtn" style="display:none;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteFormatBtn" style="display:none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div id="selectedFormatDisplay" class="text-sm text-gray-400 mt-1" style="min-height:1.5em;"></div>
                </div>
            </div>
            <div class="flex gap-4 mb-2">
                <button type="button" class="btn btn-secondary" id="importFromPostBtn">
                    <i class="fas fa-download"></i> Import from Post
                </button>
                <button type="button" class="btn btn-primary" id="testPromptBtn">
                    <i class="fas fa-vial"></i> Test
                </button>
            </div>
        </form>
        <div id="test-image-result" class="mt-6 text-center"></div>
        <div class="text-center text-lg text-gray-400 mt-12">
            <p>Image Prompts management coming soon.</p>
        </div>
    </div>
</div>
<!-- Style Modal -->
<div id="styleModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
        <h2 class="text-xl font-semibold mb-4" id="styleModalTitle">Add Style</h2>
        <input type="text" id="styleTitleInput" placeholder="Style Title" />
        <textarea id="styleDescInput" rows="3" placeholder="Style Description"></textarea>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelStyleBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveStyleBtn">Save</button>
        </div>
        <div id="styleModalError" class="text-red-400 mt-2"></div>
    </div>
</div>
<!-- Format Modal -->
<div id="formatModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
        <h2 class="text-xl font-semibold mb-4" id="formatModalTitle">Add Format</h2>
        <input type="text" id="formatTitleInput" placeholder="Format Title" />
        <textarea id="formatDescInput" rows="3" placeholder="Format Description"></textarea>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelFormatBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveFormatBtn">Save</button>
        </div>
        <div id="formatModalError" class="text-red-400 mt-2"></div>
    </div>
</div>
<!-- ImageSetting Modal -->
<div id="imageSettingModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
        <h2 class="text-xl font-semibold mb-4" id="imageSettingModalTitle">Add Image Setting</h2>
        <input type="text" id="imageSettingNameInput" placeholder="Setting Name" />
        <div class="mb-2">
            <label class="block text-sm mb-1">Style</label>
            <select id="imageSettingStyleInput" class="form-input w-full"></select>
        </div>
        <div class="mb-2">
            <label class="block text-sm mb-1">Format</label>
            <select id="imageSettingFormatInput" class="form-input w-full"></select>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelImageSettingBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveImageSettingBtn">Save</button>
        </div>
        <div id="imageSettingModalError" class="text-red-400 mt-2"></div>
    </div>
</div>
<!-- PROMPT EXAMPLE LIBRARY -->
<div class="admin-card mb-10">
    <h2 class="text-lg font-semibold mb-4">Prompt Example Library</h2>
    <div id="promptExampleList" class="mb-4"></div>
    <button type="button" class="btn btn-secondary mb-2" id="newPromptExampleBtn">
        <i class="fas fa-plus"></i> New Example
    </button>
    <button type="button" class="btn btn-secondary mb-2" id="editPromptExampleBtn" style="display:none;">
        <i class="fas fa-edit"></i> Edit Selected
    </button>
    <button type="button" class="btn btn-danger mb-2" id="deletePromptExampleBtn" style="display:none;">
        <i class="fas fa-trash"></i> Delete Selected
    </button>
</div>
<!-- PROMPT EXAMPLE MODAL -->
<div id="promptExampleModalBg" class="modal-bg" style="display:none;">
    <div class="modal">
        <h2 class="text-xl font-semibold mb-4" id="promptExampleModalTitle">Add Prompt Example</h2>
        <textarea id="promptExampleDescriptionInput" rows="2" placeholder="Image Description" class="mb-2"></textarea>
        <div class="mb-2">
            <label class="block text-sm mb-1">Style</label>
            <select id="promptExampleStyleInput" class="form-input w-full"></select>
        </div>
        <div class="mb-2">
            <label class="block text-sm mb-1">Format</label>
            <select id="promptExampleFormatInput" class="form-input w-full"></select>
        </div>
        <div class="mb-2">
            <label class="block text-sm mb-1">Provider</label>
            <select id="promptExampleProviderInput" class="form-input w-full">
                <option value="sd">Stable Diffusion (local)</option>
                <option value="openai">OpenAI DALL·E</option>
            </select>
        </div>
        <div class="mb-2">
            <label class="block text-sm mb-1">Image Setting (optional)</label>
            <select id="promptExampleImageSettingInput" class="form-input w-full"></select>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelPromptExampleBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="savePromptExampleBtn">Save</button>
        </div>
        <div id="promptExampleModalError" class="text-red-400 mt-2"></div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const styleSelect = document.getElementById('promptStyleSelect');
        const styleDisplay = document.getElementById('selectedStyleDisplay');
        const editStyleBtn = document.getElementById('editStyleBtn');
        const deleteStyleBtn = document.getElementById('deleteStyleBtn');
        let styleLibrary = {};
        // --- Modal elements ---
        const styleModalBg = document.getElementById('styleModalBg');
        const styleModalTitle = document.getElementById('styleModalTitle');
        const styleTitleInput = document.getElementById('styleTitleInput');
        const styleDescInput = document.getElementById('styleDescInput');
        const saveStyleBtn = document.getElementById('saveStyleBtn');
        const cancelStyleBtn = document.getElementById('cancelStyleBtn');
        const styleModalError = document.getElementById('styleModalError');
        let editingStyleId = null;

        // --- Format logic ---
        const formatSelect = document.getElementById('promptFormatSelect');
        const formatDisplay = document.getElementById('selectedFormatDisplay');
        const editFormatBtn = document.getElementById('editFormatBtn');
        const deleteFormatBtn = document.getElementById('deleteFormatBtn');
        let formatLibrary = {};
        // --- Modal elements ---
        const formatModalBg = document.getElementById('formatModalBg');
        const formatModalTitle = document.getElementById('formatModalTitle');
        const formatTitleInput = document.getElementById('formatTitleInput');
        const formatDescInput = document.getElementById('formatDescInput');
        const saveFormatBtn = document.getElementById('saveFormatBtn');
        const cancelFormatBtn = document.getElementById('cancelFormatBtn');
        const formatModalError = document.getElementById('formatModalError');
        let editingFormatId = null;

        // --- ImageSetting logic ---
        const imageSettingSelect = document.getElementById('imageSettingSelect');
        const newImageSettingBtn = document.getElementById('newImageSettingBtn');
        const editImageSettingBtn = document.getElementById('editImageSettingBtn');
        const deleteImageSettingBtn = document.getElementById('deleteImageSettingBtn');
        const selectedImageSettingDisplay = document.getElementById('selectedImageSettingDisplay');
        let imageSettingLibrary = {};
        // Modal elements
        const imageSettingModalBg = document.getElementById('imageSettingModalBg');
        const imageSettingModalTitle = document.getElementById('imageSettingModalTitle');
        const imageSettingNameInput = document.getElementById('imageSettingNameInput');
        const imageSettingStyleInput = document.getElementById('imageSettingStyleInput');
        const imageSettingFormatInput = document.getElementById('imageSettingFormatInput');
        const saveImageSettingBtn = document.getElementById('saveImageSettingBtn');
        const cancelImageSettingBtn = document.getElementById('cancelImageSettingBtn');
        const imageSettingModalError = document.getElementById('imageSettingModalError');
        let editingImageSettingId = null;

        // Populate style/format selects in modal
        function populateImageSettingStyleFormat() {
            imageSettingStyleInput.innerHTML = styleSelect.innerHTML;
            imageSettingFormatInput.innerHTML = formatSelect.innerHTML;
        }

        // --- Fetch and populate styles ---
        async function loadStyles() {
            styleSelect.innerHTML = '<option value="">-- Select a Style --</option>';
            styleLibrary = {};
            try {
                const res = await fetch('/api/v1/images/styles');
                const styles = await res.json();
                styles.forEach(s => {
                    styleLibrary[s.id] = s;
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.title;
                    styleSelect.appendChild(opt);
                });
            } catch (e) {
                styleSelect.innerHTML = '<option value="">(Failed to load styles)</option>';
            }
            // Hide edit/delete if nothing selected
            editStyleBtn.style.display = 'none';
            deleteStyleBtn.style.display = 'none';
        }
        loadStyles();

        styleSelect.addEventListener('change', function () {
            const val = styleSelect.value;
            if (val && styleLibrary[val]) {
                styleDisplay.innerHTML = `<strong>${styleLibrary[val].title}</strong>: ${styleLibrary[val].description || ''}`;
                editStyleBtn.style.display = '';
                deleteStyleBtn.style.display = '';
            } else {
                styleDisplay.textContent = '';
                editStyleBtn.style.display = 'none';
                deleteStyleBtn.style.display = 'none';
            }
        });

        // --- Modal logic ---
        function openStyleModal(editId = null) {
            editingStyleId = editId;
            styleModalError.textContent = '';
            if (editId && styleLibrary[editId]) {
                styleModalTitle.textContent = 'Edit Style';
                styleTitleInput.value = styleLibrary[editId].title;
                styleDescInput.value = styleLibrary[editId].description || '';
            } else {
                styleModalTitle.textContent = 'Add Style';
                styleTitleInput.value = '';
                styleDescInput.value = '';
            }
            styleModalBg.style.display = '';
            styleTitleInput.focus();
        }
        function closeStyleModal() {
            styleModalBg.style.display = 'none';
        }
        document.getElementById('newStyleBtn').addEventListener('click', function () {
            openStyleModal();
        });
        editStyleBtn.addEventListener('click', function () {
            const val = styleSelect.value;
            if (val && styleLibrary[val]) openStyleModal(val);
        });
        deleteStyleBtn.addEventListener('click', async function () {
            const val = styleSelect.value;
            if (!val || !styleLibrary[val]) return;
            if (!confirm(`Delete style "${styleLibrary[val].title}"? This cannot be undone.`)) return;
            deleteStyleBtn.disabled = true;
            try {
                const res = await fetch(`/api/v1/images/styles/${val}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to delete style');
                }
                await loadStyles();
                styleSelect.value = '';
                styleSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                alert(e.message);
            } finally {
                deleteStyleBtn.disabled = false;
            }
        });
        cancelStyleBtn.addEventListener('click', closeStyleModal);
        styleModalBg.addEventListener('click', function (e) {
            if (e.target === styleModalBg) closeStyleModal();
        });
        // --- Save style (add or edit) ---
        saveStyleBtn.addEventListener('click', async function () {
            const title = styleTitleInput.value.trim();
            const description = styleDescInput.value.trim();
            if (!title) {
                styleModalError.textContent = 'Title is required.';
                return;
            }
            saveStyleBtn.disabled = true;
            try {
                let res, data;
                if (editingStyleId) {
                    res = await fetch(`/api/v1/images/styles/${editingStyleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                } else {
                    res = await fetch('/api/v1/images/styles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                }
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to save style');
                closeStyleModal();
                await loadStyles();
                // Optionally, select the new/edited style
                if (editingStyleId) {
                    styleSelect.value = editingStyleId;
                } else {
                    styleSelect.value = data.id;
                }
                styleSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                styleModalError.textContent = e.message;
            } finally {
                saveStyleBtn.disabled = false;
            }
        });

        // --- Fetch and populate formats ---
        async function loadFormats() {
            formatSelect.innerHTML = '<option value="">-- Select a Format --</option>';
            formatLibrary = {};
            try {
                const res = await fetch('/api/v1/images/formats');
                const formats = await res.json();
                formats.forEach(f => {
                    formatLibrary[f.id] = f;
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = f.title;
                    formatSelect.appendChild(opt);
                });
            } catch (e) {
                formatSelect.innerHTML = '<option value="">(Failed to load formats)</option>';
            }
            editFormatBtn.style.display = 'none';
            deleteFormatBtn.style.display = 'none';
        }
        loadFormats();

        formatSelect.addEventListener('change', function () {
            const val = formatSelect.value;
            if (val && formatLibrary[val]) {
                formatDisplay.innerHTML = `<strong>${formatLibrary[val].title}</strong>: ${formatLibrary[val].description || ''}`;
                editFormatBtn.style.display = '';
                deleteFormatBtn.style.display = '';
            } else {
                formatDisplay.textContent = '';
                editFormatBtn.style.display = 'none';
                deleteFormatBtn.style.display = 'none';
            }
        });

        // --- Format logic ---
        function openFormatModal(editId = null) {
            editingFormatId = editId;
            formatModalError.textContent = '';
            if (editId && formatLibrary[editId]) {
                formatModalTitle.textContent = 'Edit Format';
                formatTitleInput.value = formatLibrary[editId].title;
                formatDescInput.value = formatLibrary[editId].description || '';
            } else {
                formatModalTitle.textContent = 'Add Format';
                formatTitleInput.value = '';
                formatDescInput.value = '';
            }
            formatModalBg.style.display = '';
            formatTitleInput.focus();
        }
        function closeFormatModal() {
            formatModalBg.style.display = 'none';
        }
        document.getElementById('newFormatBtn').addEventListener('click', function () {
            openFormatModal();
        });
        editFormatBtn.addEventListener('click', function () {
            const val = formatSelect.value;
            if (val && formatLibrary[val]) openFormatModal(val);
        });
        deleteFormatBtn.addEventListener('click', async function () {
            const val = formatSelect.value;
            if (!val || !formatLibrary[val]) return;
            if (!confirm(`Delete format "${formatLibrary[val].title}"? This cannot be undone.`)) return;
            deleteFormatBtn.disabled = true;
            try {
                const res = await fetch(`/api/v1/images/formats/${val}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to delete format');
                }
                await loadFormats();
                formatSelect.value = '';
                formatSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                alert(e.message);
            } finally {
                deleteFormatBtn.disabled = false;
            }
        });
        cancelFormatBtn.addEventListener('click', closeFormatModal);
        formatModalBg.addEventListener('click', function (e) {
            if (e.target === formatModalBg) closeFormatModal();
        });
        saveFormatBtn.addEventListener('click', async function () {
            const title = formatTitleInput.value.trim();
            const description = formatDescInput.value.trim();
            if (!title) {
                formatModalError.textContent = 'Title is required.';
                return;
            }
            saveFormatBtn.disabled = true;
            try {
                let res, data;
                if (editingFormatId) {
                    res = await fetch(`/api/v1/images/formats/${editingFormatId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                } else {
                    res = await fetch('/api/v1/images/formats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                }
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to save format');
                closeFormatModal();
                await loadFormats();
                if (editingFormatId) {
                    formatSelect.value = editingFormatId;
                } else {
                    formatSelect.value = data.id;
                }
                formatSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                formatModalError.textContent = e.message;
            } finally {
                saveFormatBtn.disabled = false;
            }
        });

        // --- Fetch and populate image settings ---
        async function loadImageSettings() {
            imageSettingSelect.innerHTML = '<option value="">-- Select an Image Setting --</option>';
            imageSettingLibrary = {};
            try {
                const res = await fetch('/api/v1/images/settings');
                const settings = await res.json();
                settings.forEach(s => {
                    imageSettingLibrary[s.id] = s;
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name + ' (' + (s.style?.title || '?') + ' / ' + (s.format?.title || '?') + ')';
                    imageSettingSelect.appendChild(opt);
                });
            } catch (e) {
                imageSettingSelect.innerHTML = '<option value="">(Failed to load settings)</option>';
            }
            editImageSettingBtn.style.display = 'none';
            deleteImageSettingBtn.style.display = 'none';
        }
        loadImageSettings();

        imageSettingSelect.addEventListener('change', function () {
            const val = imageSettingSelect.value;
            if (val && imageSettingLibrary[val]) {
                const s = imageSettingLibrary[val];
                selectedImageSettingDisplay.innerHTML = `<strong>${s.name}</strong>: Style = <em>${s.style?.title || ''}</em>, Format = <em>${s.format?.title || ''}</em>`;
                editImageSettingBtn.style.display = '';
                deleteImageSettingBtn.style.display = '';
                // Auto-select style/format
                if (s.style_id) styleSelect.value = s.style_id;
                if (s.format_id) formatSelect.value = s.format_id;
                styleSelect.dispatchEvent(new Event('change'));
                formatSelect.dispatchEvent(new Event('change'));
            } else {
                selectedImageSettingDisplay.textContent = '';
                editImageSettingBtn.style.display = 'none';
                deleteImageSettingBtn.style.display = 'none';
            }
        });

        // --- Modal logic ---
        function openImageSettingModal(editId = null) {
            editingImageSettingId = editId;
            imageSettingModalError.textContent = '';
            populateImageSettingStyleFormat();
            if (editId && imageSettingLibrary[editId]) {
                imageSettingModalTitle.textContent = 'Edit Image Setting';
                imageSettingNameInput.value = imageSettingLibrary[editId].name;
                imageSettingStyleInput.value = imageSettingLibrary[editId].style_id;
                imageSettingFormatInput.value = imageSettingLibrary[editId].format_id;
            } else {
                imageSettingModalTitle.textContent = 'Add Image Setting';
                imageSettingNameInput.value = '';
                imageSettingStyleInput.value = styleSelect.value;
                imageSettingFormatInput.value = formatSelect.value;
            }
            imageSettingModalBg.style.display = '';
            imageSettingNameInput.focus();
        }
        function closeImageSettingModal() {
            imageSettingModalBg.style.display = 'none';
        }
        newImageSettingBtn.addEventListener('click', function () {
            openImageSettingModal();
        });
        editImageSettingBtn.addEventListener('click', function () {
            const val = imageSettingSelect.value;
            if (val && imageSettingLibrary[val]) openImageSettingModal(val);
        });
        deleteImageSettingBtn.addEventListener('click', async function () {
            const val = imageSettingSelect.value;
            if (!val || !imageSettingLibrary[val]) return;
            if (!confirm(`Delete image setting "${imageSettingLibrary[val].name}"? This cannot be undone.`)) return;
            deleteImageSettingBtn.disabled = true;
            try {
                const res = await fetch(`/api/v1/images/settings/${val}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to delete image setting');
                }
                await loadImageSettings();
                imageSettingSelect.value = '';
                imageSettingSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                alert(e.message);
            } finally {
                deleteImageSettingBtn.disabled = false;
            }
        });
        cancelImageSettingBtn.addEventListener('click', closeImageSettingModal);
        imageSettingModalBg.addEventListener('click', function (e) {
            if (e.target === imageSettingModalBg) closeImageSettingModal();
        });
        // --- Save image setting (add or edit) ---
        saveImageSettingBtn.addEventListener('click', async function () {
            const name = imageSettingNameInput.value.trim();
            const style_id = imageSettingStyleInput.value;
            const format_id = imageSettingFormatInput.value;
            if (!name) {
                imageSettingModalError.textContent = 'Name is required.';
                return;
            }
            if (!style_id || !format_id) {
                imageSettingModalError.textContent = 'Style and Format are required.';
                return;
            }
            saveImageSettingBtn.disabled = true;
            try {
                let res, data;
                if (editingImageSettingId) {
                    res = await fetch(`/api/v1/images/settings/${editingImageSettingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, style_id, format_id })
                    });
                } else {
                    res = await fetch('/api/v1/images/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, style_id, format_id })
                    });
                }
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to save image setting');
                closeImageSettingModal();
                await loadImageSettings();
                // Optionally, select the new/edited setting
                if (editingImageSettingId) {
                    imageSettingSelect.value = editingImageSettingId;
                } else {
                    imageSettingSelect.value = data.id;
                }
                imageSettingSelect.dispatchEvent(new Event('change'));
            } catch (e) {
                imageSettingModalError.textContent = e.message;
            } finally {
                saveImageSettingBtn.disabled = false;
            }
        });

        // --- Add Test button image generation logic ---
        document.getElementById('testPromptBtn').addEventListener('click', async function () {
            const desc = document.getElementById('promptDescription').value.trim();
            const imageSettingId = document.getElementById('imageSettingSelect').value;
            const testResultDiv = document.getElementById('test-image-result');
            if (!desc) {
                testResultDiv.innerHTML = '<span class="text-red-400">Please enter a description.</span>';
                return;
            }
            if (!imageSettingId) {
                testResultDiv.innerHTML = '<span class="text-red-400">Please select an Image Setting.</span>';
                return;
            }
            // Get the selected Image Setting object
            const s = imageSettingLibrary[imageSettingId];
            let prompt = desc;
            if (s) {
                let style = s.style?.title || '';
                let format = s.format?.title || '';
                if (style && format) {
                    prompt = `${desc}, in the style of ${style}, ${format}`;
                } else if (style) {
                    prompt = `${desc}, in the style of ${style}`;
                } else if (format) {
                    prompt = `${desc}, ${format}`;
                }
            }
            let width = s?.width;
            let height = s?.height;
            let steps = s?.steps;
            let guidance_scale = s?.guidance_scale;
            let extra_settings = s?.extra_settings;
            // Get selected providers
            const providerCheckboxes = document.querySelectorAll('.provider-checkbox');
            const selectedProviders = Array.from(providerCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (!selectedProviders.length) {
                testResultDiv.innerHTML = '<span class="text-red-400">Please select at least one provider.</span>';
                return;
            }
            // Show loading states
            testResultDiv.innerHTML = selectedProviders.map(p => `<div id="result-${p}" class="mb-6"><span class="text-gray-400">Generating image with <b>${p}</b>...</span></div>`).join('');
            // For each provider, send request and update result
            selectedProviders.forEach(async provider => {
                const resultDiv = document.getElementById(`result-${provider}`);
                try {
                    const res = await fetch('/api/v1/images/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt,
                            provider,
                            image_setting_id: imageSettingId,
                            width,
                            height,
                            steps,
                            guidance_scale,
                            extra_settings
                        })
                    });
                    const data = await res.json();
                    if (data.image_url) {
                        const debugId = `debug-${provider}-${Date.now()}`;
                        let debugHtml = '';
                        if (data.debug_prompt || data.debug_settings || data.debug_workflow) {
                            debugHtml = `
                                <div class=\"mt-4 text-left\">
                                    <button class=\"btn btn-xs btn-secondary\" type=\"button\" onclick=\"const dbg=document.getElementById('${debugId}'); dbg.style.display=dbg.style.display==='none'?'block':'none';\">Show Debug</button>
                                    <div id=\"${debugId}\" style=\"display:none; background:#181c22; color:#b5b5b5; font-size:0.95em; margin-top:0.5em; padding:1em; border-radius:0.5em;\">
                                        <div><b>Prompt Sent:</b><pre style=\"white-space:pre-wrap;word-break:break-all;\">${data.debug_prompt ? data.debug_prompt : ''}</pre></div>
                                        <div><b>Settings:</b><pre style=\"white-space:pre-wrap;word-break:break-all;\">${data.debug_settings ? JSON.stringify(data.debug_settings, null, 2) : ''}</pre></div>
                                        <div><b>Workflow JSON:</b><pre style=\"white-space:pre-wrap;word-break:break-all;\">${data.debug_workflow ? JSON.stringify(data.debug_workflow, null, 2) : ''}</pre></div>
                                    </div>
                                </div>
                            `;
                        }
                        resultDiv.innerHTML = `
                            <div class="mb-2 text-sm text-gray-400">Provider: <b>${data.provider || provider}</b></div>
                            <img src="${data.image_url}" class="mx-auto rounded shadow mt-4" style="max-width:400px;" />
                            ${debugHtml}
                        `;
                    } else {
                        const debugId = `debug-${provider}-${Date.now()}`;
                        let debugHtml = '';
                        if (data.debug_prompt || data.debug_settings || data.debug_workflow) {
                            debugHtml = `
                                <div class=\"mt-4 text-left\">
                                    <button class=\"btn btn-xs btn-secondary\" type=\"button\" onclick=\"const dbg=document.getElementById('${debugId}'); dbg.style.display=dbg.style.display==='none'?'block':'none';\">Show Debug</button>
                                    <div id=\"${debugId}\" style=\"display:none; background:#181c22; color:#b5b5b5; font-size:0.95em; margin-top:0.5em; padding:1em; border-radius:0.5em;\">
                                        <div><b>Prompt Sent:</b><pre style=\"white-space:pre-wrap;word-break:break-all;\">${data.debug_prompt ? data.debug_prompt : ''}</pre></div>
                                        <div><b>Settings:</b><pre style=\"white-space:pre-wrap;word-break:break-all;\">${data.debug_settings ? JSON.stringify(data.debug_settings, null, 2) : ''}</pre></div>
                                        <div><b>Workflow JSON:</b><pre style=\"white-space:pre-wrap;word-break:break-all;\">${data.debug_workflow ? JSON.stringify(data.debug_workflow, null, 2) : ''}</pre></div>
                                    </div>
                                </div>
                            `;
                        }
                        resultDiv.innerHTML = `<span class="text-red-400">Error (${provider}): ${data.error || 'Unknown error'}</span>` + debugHtml;
                    }
                } catch (err) {
                    resultDiv.innerHTML = `<span class="text-red-400">Error (${provider}): ${err.message}</span>`;
                }
            });
        });

        // --- Prompt Example Library Logic ---
        let promptExampleLibrary = {};
        let selectedPromptExampleId = null;
        const promptExampleListDiv = document.getElementById('promptExampleList');
        const newPromptExampleBtn = document.getElementById('newPromptExampleBtn');
        const editPromptExampleBtn = document.getElementById('editPromptExampleBtn');
        const deletePromptExampleBtn = document.getElementById('deletePromptExampleBtn');
        const promptExampleModalBg = document.getElementById('promptExampleModalBg');
        const promptExampleModalTitle = document.getElementById('promptExampleModalTitle');
        const promptExampleDescriptionInput = document.getElementById('promptExampleDescriptionInput');
        const promptExampleStyleInput = document.getElementById('promptExampleStyleInput');
        const promptExampleFormatInput = document.getElementById('promptExampleFormatInput');
        const promptExampleProviderInput = document.getElementById('promptExampleProviderInput');
        const promptExampleImageSettingInput = document.getElementById('promptExampleImageSettingInput');
        const savePromptExampleBtn = document.getElementById('savePromptExampleBtn');
        const cancelPromptExampleBtn = document.getElementById('cancelPromptExampleBtn');
        const promptExampleModalError = document.getElementById('promptExampleModalError');
        let editingPromptExampleId = null;

        // Populate style/format/image setting selects in modal
        function populatePromptExampleSelects() {
            promptExampleStyleInput.innerHTML = styleSelect.innerHTML;
            promptExampleFormatInput.innerHTML = formatSelect.innerHTML;
            promptExampleImageSettingInput.innerHTML = imageSettingSelect.innerHTML;
        }

        async function loadPromptExamples() {
            promptExampleListDiv.innerHTML = 'Loading...';
            promptExampleLibrary = {};
            try {
                const res = await fetch('/api/v1/images/prompt_examples');
                const examples = await res.json();
                if (!Array.isArray(examples)) throw new Error('Invalid response');
                promptExampleListDiv.innerHTML = '';
                examples.forEach(e => {
                    promptExampleLibrary[e.id] = e;
                    const div = document.createElement('div');
                    div.className = 'prompt-example-item mb-2 p-2 rounded border cursor-pointer' + (selectedPromptExampleId === e.id ? ' border-blue-400 bg-blue-50' : ' border-gray-600 bg-gray-800');
                    div.textContent = `${e.description} [${e.provider}]`;
                    div.onclick = function () {
                        selectedPromptExampleId = e.id;
                        loadPromptExampleToForm(e.id);
                        updatePromptExampleButtons();
                        loadPromptExamples(); // Refresh highlight
                    };
                    promptExampleListDiv.appendChild(div);
                });
                if (!examples.length) promptExampleListDiv.innerHTML = '<span class="text-gray-400">No examples saved yet.</span>';
            } catch (e) {
                promptExampleListDiv.innerHTML = '<span class="text-red-400">Failed to load examples.</span>';
            }
            updatePromptExampleButtons();
        }
        function updatePromptExampleButtons() {
            if (selectedPromptExampleId) {
                editPromptExampleBtn.style.display = '';
                deletePromptExampleBtn.style.display = '';
            } else {
                editPromptExampleBtn.style.display = 'none';
                deletePromptExampleBtn.style.display = 'none';
            }
        }
        function loadPromptExampleToForm(id) {
            const e = promptExampleLibrary[id];
            if (!e) return;
            document.getElementById('promptDescription').value = e.description;
            styleSelect.value = e.style_id;
            formatSelect.value = e.format_id;
            document.getElementById('providerSelect').value = e.provider;
            if (e.image_setting_id) imageSettingSelect.value = e.image_setting_id;
            styleSelect.dispatchEvent(new Event('change'));
            formatSelect.dispatchEvent(new Event('change'));
            imageSettingSelect.dispatchEvent(new Event('change'));
        }
        function openPromptExampleModal(editId = null) {
            editingPromptExampleId = editId;
            promptExampleModalError.textContent = '';
            populatePromptExampleSelects();
            if (editId && promptExampleLibrary[editId]) {
                promptExampleModalTitle.textContent = 'Edit Prompt Example';
                const e = promptExampleLibrary[editId];
                promptExampleDescriptionInput.value = e.description;
                promptExampleStyleInput.value = e.style_id;
                promptExampleFormatInput.value = e.format_id;
                promptExampleProviderInput.value = e.provider;
                promptExampleImageSettingInput.value = e.image_setting_id || '';
            } else {
                promptExampleModalTitle.textContent = 'Add Prompt Example';
                promptExampleDescriptionInput.value = '';
                promptExampleStyleInput.value = styleSelect.value;
                promptExampleFormatInput.value = formatSelect.value;
                promptExampleProviderInput.value = document.getElementById('providerSelect').value;
                promptExampleImageSettingInput.value = imageSettingSelect.value;
            }
            promptExampleModalBg.style.display = '';
            promptExampleDescriptionInput.focus();
        }
        function closePromptExampleModal() {
            promptExampleModalBg.style.display = 'none';
        }
        newPromptExampleBtn.addEventListener('click', function () {
            openPromptExampleModal();
        });
        editPromptExampleBtn.addEventListener('click', function () {
            if (selectedPromptExampleId) openPromptExampleModal(selectedPromptExampleId);
        });
        deletePromptExampleBtn.addEventListener('click', async function () {
            if (!selectedPromptExampleId) return;
            if (!confirm('Delete this prompt example? This cannot be undone.')) return;
            deletePromptExampleBtn.disabled = true;
            try {
                const res = await fetch(`/api/v1/images/prompt_examples/${selectedPromptExampleId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete');
                selectedPromptExampleId = null;
                await loadPromptExamples();
            } catch (e) {
                alert(e.message);
            } finally {
                deletePromptExampleBtn.disabled = false;
            }
        });
        cancelPromptExampleBtn.addEventListener('click', closePromptExampleModal);
        promptExampleModalBg.addEventListener('click', function (e) {
            if (e.target === promptExampleModalBg) closePromptExampleModal();
        });
        savePromptExampleBtn.addEventListener('click', async function () {
            const description = promptExampleDescriptionInput.value.trim();
            const style_id = promptExampleStyleInput.value;
            const format_id = promptExampleFormatInput.value;
            const provider = promptExampleProviderInput.value;
            const image_setting_id = promptExampleImageSettingInput.value || null;
            if (!description || !style_id || !format_id || !provider) {
                promptExampleModalError.textContent = 'All fields except Image Setting are required.';
                return;
            }
            savePromptExampleBtn.disabled = true;
            try {
                let res, data;
                if (editingPromptExampleId) {
                    res = await fetch(`/api/v1/images/prompt_examples/${editingPromptExampleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ description, style_id, format_id, provider, image_setting_id })
                    });
                } else {
                    res = await fetch('/api/v1/images/prompt_examples', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ description, style_id, format_id, provider, image_setting_id })
                    });
                }
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to save prompt example');
                closePromptExampleModal();
                await loadPromptExamples();
                if (!editingPromptExampleId) selectedPromptExampleId = data.id;
            } catch (e) {
                promptExampleModalError.textContent = e.message;
            } finally {
                savePromptExampleBtn.disabled = false;
            }
        });
        // Load prompt examples on page load
        loadPromptExamples();
    });
</script>
{% endblock %}