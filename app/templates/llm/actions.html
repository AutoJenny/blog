{% extends "base.html" %}

{% block title %}LLM Actions{% endblock %}

{% block styles %}
<link href="/static/css/dist/main.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    body {
        background: #18181b;
    }

    .admin-card {
        background: #23272F;
        border-radius: 1rem;
        box-shadow: 0 6px 32px rgba(0, 0, 0, 0.18);
        padding: 2.5rem 2rem 2rem 2rem;
        margin-bottom: 2rem;
    }

    .action-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .action-accordion-item {
        background: #23273a;
        border: 1.5px solid #35395a;
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        transition: box-shadow 0.2s, border 0.2s, background 0.2s;
        box-shadow: 0 2px 8px rgba(56, 189, 248, 0.06);
        cursor: pointer;
    }

    .action-accordion-item:hover {
        border-color: #38bdf8;
        background: #23273aee;
        box-shadow: 0 4px 16px rgba(56, 189, 248, 0.13);
    }

    .action-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1.5rem;
    }

    .action-name {
        font-size: 1.15rem;
        font-weight: 700;
        color: #e0e0e0;
        letter-spacing: 0.01em;
    }

    .action-model {
        color: #a5b4fc;
        font-size: 1em;
        margin-left: 1.5rem;
        font-weight: 500;
    }

    .action-actions {
        display: flex;
        gap: 0.75rem;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1.4rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
        font-size: 0.95em;
    }

    .btn-primary {
        background: linear-gradient(90deg, #6366f1 0%, #38bdf8 100%);
        color: #fff;
        border: none;
        font-weight: 700;
    }

    .btn-primary:hover {
        background: linear-gradient(90deg, #38bdf8 0%, #6366f1 100%);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.18);
        color: #fff;
    }

    .btn-secondary {
        background: #23273a;
        border: 1.5px solid #35395a;
        color: #a5b4fc;
    }

    .btn-secondary:hover {
        background: #3730a3;
        border-color: #38bdf8;
        color: #fff;
    }

    .btn-danger {
        background: #DC2626;
        color: white;
        border: none;
    }

    .btn-danger:hover {
        background: #B91C1C;
        color: #fff;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        color: #a5b4fc;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.97em;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        background: #18181b;
        border: 1.5px solid #35395a;
        color: #e0e0e0;
        padding: 0.7rem 1rem;
        border-radius: 0.5rem;
        font-size: 1em;
        margin-bottom: 0.1rem;
        transition: border 0.2s, box-shadow 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
        border-color: #38bdf8;
        outline: none;
        box-shadow: 0 0 0 2px #38bdf8aa;
    }

    .form-textarea {
        min-height: 110px;
        font-family: 'Monaco', 'Menlo', monospace;
        line-height: 1.5;
        resize: vertical;
    }

    .flex.justify-end.gap-4 {
        margin-top: 2rem;
    }

    @media (max-width: 600px) {
        .admin-card {
            padding: 1.2rem;
        }

        .action-card {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block area_nav %}
{% include 'llm/_llm_nav.html' %}
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto py-10">
    <div class="admin-content">
        <div class="admin-card">
            <div class="flex items-center justify-between mb-6">
                <h1 class="admin-title"><i class="fas fa-bolt mr-2"></i>LLM Actions</h1>
                <button class="btn btn-primary" id="newActionBtn"><i class="fas fa-plus"></i> New Action</button>
            </div>
            <div class="action-list" id="actionAccordionList">
                {% for action in actions %}
                <div class="action-accordion-item" data-id="{{ action.id }}">
                    <div class="action-header">
                        <span class="action-name">{{ action.field_name }}</span>
                        <span class="action-model">Model: {{ action.llm_model }}</span>
                        <div class="action-actions">
                            <a href="/llm/actions/{{ action.id }}" class="btn btn-primary ml-2" title="View Details"><i
                                    class="fas fa-eye"></i> Details</a>
                            <button class="btn btn-secondary edit-action-btn ml-2" data-id="{{ action.id }}"><i
                                    class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-danger delete-action-btn ml-2" data-id="{{ action.id }}"><i
                                    class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Non-Modal Action Builder: Four Stages Always Visible -->
    <div class="admin-card mt-10" id="nonModalActionBuilder">
        <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-plus"></i> Create New Action
            (Builder)</h2>
        <form id="actionBuilderForm" autocomplete="off">
            <!-- Stage 1: Basic Info -->
            <div class="mb-8">
                <h3 class="font-bold text-md mb-2 flex items-center gap-2"><i class="fa-solid fa-info-circle"></i> 1.
                    Basic Info</h3>
                <div class="form-group">
                    <label class="form-label" for="builderFieldName">Field Name</label>
                    <input type="text" id="builderFieldName" name="field_name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="builderDescription">Description</label>
                    <input type="text" id="builderDescription" name="description" class="form-input">
                </div>
            </div>
            <!-- Stage 2: Model Settings -->
            <div class="mb-8">
                <h3 class="font-bold text-md mb-2 flex items-center gap-2"><i class="fa-solid fa-robot"></i> 2. Model
                    Settings</h3>
                <div class="form-group">
                    <label class="form-label" for="builderProvider">LLM Provider</label>
                    <select id="builderProvider" name="provider_id" class="form-input" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="builderModel">LLM Model</label>
                    <select id="builderModel" name="llm_model" class="form-input" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="builderTemperature">Temperature</label>
                    <input type="number" id="builderTemperature" name="temperature" class="form-input" min="0" max="2"
                        step="0.1" value="0.7">
                </div>
                <div class="form-group">
                    <label class="form-label" for="builderMaxTokens">Max Tokens</label>
                    <input type="number" id="builderMaxTokens" name="max_tokens" class="form-input" min="1" max="4096"
                        value="1000">
                </div>
            </div>
            <!-- Stage 3: Prompt Template -->
            <div class="mb-8">
                <h3 class="font-bold text-md mb-2 flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> 3.
                    Prompt Template</h3>
                <div class="form-group mb-4">
                    <label class="form-label" for="builderPromptTemplate">Prompt Template</label>
                    <select id="builderPromptTemplate" name="prompt_template_id" class="form-input" required></select>
                </div>
                <div class="bg-dark-card rounded p-4 mt-4 mb-2">
                    <h4 class="font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-eye"></i> Prompt Preview
                    </h4>
                    <div id="builderPromptPreview" class="whitespace-pre-line text-indigo-100 text-sm">{ ... select a
                        template ... }</div>
                    <div class="text-xs text-indigo-200 mt-1">This is how your full prompt will look to the AI, with
                        variables replaced at runtime.</div>
                </div>
            </div>
            <!-- Stage 4: Test & Save -->
            <div class="mb-8">
                <h3 class="font-bold text-md mb-2 flex items-center gap-2"><i class="fa-solid fa-vial"></i> 4. Test &
                    Save</h3>
                <div class="form-group">
                    <label class="form-label">Test Input</label>
                    <textarea id="builderTestInput" class="form-textarea" rows="2"></textarea>
                </div>
                <button type="button" class="btn btn-primary mb-2" id="builderRunTestBtn">Run Test</button>
                <div id="builderTestOutput" class="bg-dark-card rounded p-4 mt-2 text-indigo-100 text-sm"
                    style="white-space: pre-wrap; min-height: 2em;"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="submit" class="btn btn-primary">Save Action</button>
                </div>
            </div>
        </form>
        <div id="actionBuilderMsg" class="mt-2 text-sm"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Dropdown Population Logic ---
    async function loadProviders(selectedProviderId) {
        const providerSelect = document.getElementById('builderProvider');
        providerSelect.innerHTML = '<option value="">Loading...</option>';
        try {
            const resp = await fetch('/api/v1/llm/providers');
            const providers = await resp.json();
            providerSelect.innerHTML = providers.map(p => `<option value="${p.id}" ${selectedProviderId == p.id ? 'selected' : ''}>${p.name}</option>`).join('');
            // Auto-load models for first provider if none selected
            if (!selectedProviderId && providers.length > 0) {
                loadModels(providers[0].id);
            }
        } catch (e) {
            providerSelect.innerHTML = '<option value="">Failed to load providers</option>';
        }
    }
    async function loadModels(providerId, selectedModelId) {
        const modelSelect = document.getElementById('builderModel');
        modelSelect.innerHTML = '<option value="">Loading...</option>';
        try {
            const resp = await fetch('/api/v1/llm/models');
            const models = await resp.json();
            const filtered = models.filter(m => String(m.provider_id) === String(providerId));
            modelSelect.innerHTML = filtered.map(m => `<option value="${m.name}" data-model-id="${m.id}" ${selectedModelId == m.name ? 'selected' : ''}>${m.name} (${m.description || ''})</option>`).join('');
        } catch (e) {
            modelSelect.innerHTML = '<option value="">Failed to load models</option>';
        }
    }
    async function loadPromptTemplates(selectedId) {
        const select = document.getElementById('builderPromptTemplate');
        select.innerHTML = '<option value="">Loading...</option>';
        try {
            const resp = await fetch('/api/v1/llm/prompts');
            const prompts = await resp.json();
            select.innerHTML = prompts.map(p => `<option value="${p.id}" ${selectedId == p.id ? 'selected' : ''}>${p.name} (${p.description || ''})</option>`).join('');
            // Set preview if selected
            if (selectedId) {
                const selected = prompts.find(p => p.id == selectedId);
                document.getElementById('builderPromptPreview').textContent = selected ? selected.prompt_text : '{ ... select a template ... }';
            } else {
                document.getElementById('builderPromptPreview').textContent = '{ ... select a template ... }';
            }
        } catch (e) {
            select.innerHTML = '<option value="">Failed to load templates</option>';
            document.getElementById('builderPromptPreview').textContent = '{ ... error ... }';
        }
    }
    document.addEventListener('DOMContentLoaded', function () {
        loadProviders();
        loadPromptTemplates();
        document.getElementById('builderProvider').addEventListener('change', function () {
            loadModels(this.value);
        });
        document.getElementById('builderPromptTemplate').addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            if (selected && selected.value) {
                fetch(`/api/v1/llm/prompts/${selected.value}`)
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('builderPromptPreview').textContent = data.prompt_text || '{ ... select a template ... }';
                    });
            } else {
                document.getElementById('builderPromptPreview').textContent = '{ ... select a template ... }';
            }
        });

        // --- DELETE ACTION LOGIC (event delegation) ---
        document.getElementById('actionAccordionList').addEventListener('click', async function (e) {
            console.log('AccordionList clicked', e.target);
            const btn = e.target.closest('.delete-action-btn');
            if (!btn) return;
            console.log('Remove button clicked', btn);
            const actionId = btn.dataset.id;
            if (!actionId) return;
            if (!confirm('Are you sure you want to delete this action? This cannot be undone.')) return;
            btn.disabled = true;
            btn.textContent = 'Deleting...';
            try {
                const resp = await fetch(`/api/v1/llm/actions/${actionId}`, { method: 'DELETE' });
                const data = await resp.json();
                console.log('Remove response', resp, data);
                if (resp.ok && data.status === 'success') {
                    btn.closest('.action-accordion-item').remove();
                } else {
                    alert(data.error || 'Failed to delete action.');
                }
            } catch (e) {
                alert('Error deleting action: ' + e);
            }
            btn.disabled = false;
            btn.textContent = 'Delete';
        });
    });
    // --- Test & Save Logic ---
    document.getElementById('builderRunTestBtn').onclick = async function () {
        const testInput = document.getElementById('builderTestInput').value;
        const provider_id = document.getElementById('builderProvider').value;
        const llm_model = document.getElementById('builderModel').value;
        const prompt_template_id = document.getElementById('builderPromptTemplate').value;
        const temperature = parseFloat(document.getElementById('builderTemperature').value) || 0.7;
        const max_tokens = parseInt(document.getElementById('builderMaxTokens').value) || 1000;
        const outputDiv = document.getElementById('builderTestOutput');
        outputDiv.textContent = 'Running test...';
        if (!provider_id || !llm_model || !prompt_template_id) {
            outputDiv.textContent = 'Please select provider, model, and prompt template.';
            return;
        }
        try {
            const resp = await fetch('/api/v1/llm/actions/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider_id,
                    llm_model,
                    prompt_template_id,
                    temperature,
                    max_tokens,
                    input: testInput
                })
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'success') {
                outputDiv.textContent = data.output || '(No output)';
            } else {
                outputDiv.textContent = data.error || 'Error running test.';
            }
        } catch (e) {
            outputDiv.textContent = 'Error: ' + e;
        }
    };
    document.getElementById('actionBuilderForm').onsubmit = async function (e) {
        e.preventDefault();
        const msg = document.getElementById('actionBuilderMsg');
        msg.textContent = '';
        const field_name = document.getElementById('builderFieldName').value;
        const description = document.getElementById('builderDescription').value;
        const provider_id = document.getElementById('builderProvider').value;
        const llm_model = document.getElementById('builderModel').value;
        const prompt_template_id = document.getElementById('builderPromptTemplate').value;
        const temperature = parseFloat(document.getElementById('builderTemperature').value) || 0.7;
        const max_tokens = parseInt(document.getElementById('builderMaxTokens').value) || 1000;
        if (!field_name || !provider_id || !llm_model || !prompt_template_id) {
            msg.textContent = 'Please fill in all required fields.';
            msg.style.color = 'red';
            return;
        }
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        try {
            const resp = await fetch('/api/v1/llm/actions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    field_name,
                    description,
                    provider_id,
                    llm_model,
                    prompt_template_id,
                    temperature,
                    max_tokens
                })
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'success') {
                msg.textContent = 'Action created!';
                msg.style.color = 'green';
                setTimeout(() => { location.reload(); }, 800);
            } else {
                msg.textContent = data.error || 'Error creating action.';
                msg.style.color = 'red';
            }
        } catch (e) {
            msg.textContent = 'Error: ' + e;
            msg.style.color = 'red';
        }
        btn.disabled = false;
        btn.textContent = 'Save Action';
    };
</script>
{% endblock %}