{% extends "base.html" %}

{% block title %}LLM Actions{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    /* Tab Navigation */
    .tab-nav {
        border-bottom: 2px solid var(--admin-border, #404040);
        margin-bottom: 2rem;
    }

    .tab-button {
        position: relative;
        padding: 1rem 2rem;
        font-weight: 500;
        color: var(--admin-text-secondary, #9CA3AF);
        border: none;
        background: none;
        cursor: pointer;
        transition: color 0.2s;
    }

    .tab-button[aria-selected="true"] {
        color: var(--admin-text, #E0E0E0);
    }

    .tab-button[aria-selected="true"]::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--admin-primary, #1B4B73);
    }

    /* Action Cards */
    .action-card {
        background-color: var(--admin-bg-card, #23272F);
        color: var(--admin-text, #E0E0E0);
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--admin-border, #404040);
        padding: 2rem;
        margin-bottom: 1.5rem;
    }

    .action-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .action-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--admin-text, #E0E0E0);
    }

    .action-meta {
        font-size: 0.875rem;
        color: var(--admin-text-secondary, #9CA3AF);
    }

    .action-content {
        margin-bottom: 1.5rem;
    }

    .action-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .action-detail {
        display: flex;
        flex-direction: column;
    }

    .detail-label {
        font-size: 0.875rem;
        color: var(--admin-text-secondary, #9CA3AF);
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-size: 1rem;
        color: var(--admin-text, #E0E0E0);
    }

    /* Form Styling */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--admin-text, #E0E0E0);
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        background-color: var(--admin-bg-input, #2D333B);
        border: 1px solid var(--admin-border, #404040);
        border-radius: 0.5rem;
        color: var(--admin-text, #E0E0E0);
        transition: border-color 0.2s;
    }

    .form-input:focus {
        border-color: var(--admin-primary, #1B4B73);
        outline: none;
    }

    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn-primary {
        background-color: var(--admin-primary, #1B4B73);
        color: #fff;
        border: none;
    }

    .btn-primary:hover {
        background-color: var(--admin-primary-hover, #1a4469);
    }

    .btn-secondary {
        background-color: var(--admin-accent, #6366F1);
        color: #fff;
        border: none;
    }

    .btn-secondary:hover {
        background-color: var(--admin-accent-hover, #4F46E5);
    }

    .btn-danger {
        background-color: var(--admin-danger, #DC2626);
        color: #fff;
        border: none;
    }

    .btn-danger:hover {
        background-color: var(--admin-danger-hover, #B91C1C);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">LLM Actions Manager</h1>
        <button onclick="showNewActionModal()" class="btn btn-primary">
            <span class="mr-2">+</span> New Action
        </button>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <div class="flex" role="tablist">
            <button class="tab-button" id="actions-tab" data-tabs-target="#actions" type="button" role="tab"
                aria-controls="actions" aria-selected="true">
                Existing Actions
            </button>
            <button class="tab-button" id="builder-tab" data-tabs-target="#builder" type="button" role="tab"
                aria-controls="builder" aria-selected="false">
                Action Builder
            </button>
            <button class="tab-button" id="test-tab" data-tabs-target="#test" type="button" role="tab"
                aria-controls="test" aria-selected="false">
                Test Actions
            </button>
        </div>
    </div>

    <!-- Tab Content -->
    <div id="tab-content">
        <!-- Actions Tab -->
        <div class="hidden" id="actions" role="tabpanel" aria-labelledby="actions-tab">
            <div class="grid grid-cols-1 gap-6">
                {% for action in actions %}
                <div class="action-card">
                    <div class="action-header">
                        <h3 class="action-title">{{ action.field_name }}</h3>
                        <div class="flex space-x-4">
                            <button onclick="editAction('{{ action.id }}')" class="btn btn-secondary">
                                Edit
                            </button>
                            <button onclick="testAction('{{ action.id }}')" class="btn btn-primary">
                                Test
                            </button>
                            <button onclick="deleteAction('{{ action.id }}')" class="btn btn-danger">
                                Delete
                            </button>
                        </div>
                    </div>
                    <div class="action-details">
                        <div class="action-detail">
                            <span class="detail-label">Model</span>
                            <span class="detail-value">{{ action.llm_model }}</span>
                        </div>
                        <div class="action-detail">
                            <span class="detail-label">Temperature</span>
                            <span class="detail-value">{{ action.temperature }}</span>
                        </div>
                        <div class="action-detail">
                            <span class="detail-label">Max Tokens</span>
                            <span class="detail-value">{{ action.max_tokens }}</span>
                        </div>
                    </div>
                    <div class="action-content">
                        <span class="detail-label">Prompt Template</span>
                        <pre
                            class="mt-2 p-4 bg-gray-800 rounded-md text-sm overflow-x-auto whitespace-pre-wrap">{{ action.prompt_template }}</pre>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Builder Tab -->
        <div class="hidden" id="builder" role="tabpanel" aria-labelledby="builder-tab">
            <div class="max-w-3xl mx-auto">
                <form id="action-builder-form" class="space-y-6">
                    <div class="form-group">
                        <label class="form-label" for="field_name">Field Name</label>
                        <input type="text" name="field_name" id="field_name" class="form-input"
                            placeholder="Enter the field name">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="prompt_template_id">Prompt Template</label>
                        <select name="prompt_template_id" id="prompt_template_id" class="form-input">
                        </select>
                        <div id="prompt_preview" class="mt-2 p-4 bg-gray-800 rounded-md text-sm hidden"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="llm_model">LLM Model</label>
                        <select name="llm_model" id="llm_model" class="form-input">
                        </select>
                        <div id="model_status" class="mt-1 text-sm"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="form-label" for="temperature">Temperature</label>
                            <input type="number" name="temperature" id="temperature" min="0" max="2" step="0.1"
                                value="0.7" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="max_tokens">Max Tokens</label>
                            <input type="number" name="max_tokens" id="max_tokens" min="1" max="4096" value="1000"
                                class="form-input">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="submit" class="btn btn-primary">Save Action</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Test Tab -->
        <!-- (REMOVED) -->
    </div>
</div>

<!-- Action Modal -->
<div id="actionModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative z-10 max-w-lg mx-auto mt-20 bg-[#23272F] rounded-lg shadow-xl">
        <div class="p-6">
            <h2 class="text-xl font-semibold mb-4 text-white" id="modalTitle">New Action</h2>
            <form id="action-modal-form">
                <input type="hidden" id="action_id_modal" name="action_id">
                <div class="form-group">
                    <label class="form-label" for="field_name_modal">Field Name</label>
                    <input type="text" id="field_name_modal" name="field_name" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label" for="prompt_template_id_modal">Prompt Template</label>
                    <select id="prompt_template_id_modal" name="prompt_template_id" class="form-input"></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="llm_model_modal">LLM Model</label>
                    <select id="llm_model_modal" name="llm_model" class="form-input"></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="temperature_modal">Temperature</label>
                        <input type="number" id="temperature_modal" name="temperature" class="form-input" min="0"
                            max="2" step="0.1" value="0.7">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="max_tokens_modal">Max Tokens</label>
                        <input type="number" id="max_tokens_modal" name="max_tokens" class="form-input" min="1"
                            max="4096" value="1000">
                    </div>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="btn btn-secondary" onclick="closeActionModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentConfig = null;
    let availableModels = [];
    let availablePrompts = [];

    async function initializeData() {
        try {
            // Load configuration
            const configResponse = await fetch('/api/v1/llm/config');
            currentConfig = await configResponse.json();

            // Load models
            const modelsResponse = await fetch('/api/v1/llm/models/ollama');
            const modelsData = await modelsResponse.json();
            availableModels = modelsData.models || [];
            updateModelSelects(currentConfig, modelsData);

            // Load prompts
            const promptsResponse = await fetch('/api/v1/llm/prompts');
            availablePrompts = await promptsResponse.json();
            updatePromptSelect(availablePrompts);

        } catch (error) {
            handleFetchError(error, 'Error initializing data');
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize data
        initializeData();

        // Tab functionality
        const tabs = document.querySelectorAll('[role="tab"]');
        const tabPanels = document.querySelectorAll('[role="tabpanel"]');

        tabs.forEach(tab => {
            tab.addEventListener('click', function (e) {
                tabs.forEach(t => {
                    t.setAttribute('aria-selected', 'false');
                });

                tabPanels.forEach(p => p.classList.add('hidden'));

                this.setAttribute('aria-selected', 'true');

                const panelId = this.getAttribute('data-tabs-target').substring(1);
                document.getElementById(panelId).classList.remove('hidden');
            });
        });

        // Activate first tab by default
        tabs[0].click();

        // Form submission handler
        const builderForm = document.getElementById('action-builder-form');
        if (builderForm) {
            builderForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const submitButton = builderForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Saving...';
                const formData = new FormData(this);
                const data = {
                    field_name: formData.get('field_name'),
                    prompt_template_id: formData.get('prompt_template_id'),
                    llm_model: formData.get('llm_model'),
                    temperature: parseFloat(formData.get('temperature')),
                    max_tokens: parseInt(formData.get('max_tokens'))
                };
                const actionId = formData.get('action_id');
                const method = actionId ? 'PUT' : 'POST';
                const url = actionId ? `/api/v1/llm/actions/${actionId}` : '/api/v1/llm/actions';
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    console.log('Action save result:', result);
                    if (result.status === 'success') {
                        window.location.reload();
                        return;
                    }
                    alert('Error saving action: ' + (result.error || 'Unknown error'));
                    submitButton.disabled = false;
                    submitButton.textContent = 'Save Action';
                } catch (error) {
                    console.error('Error saving action:', error);
                    alert('Error saving action: ' + error.message);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Save Action';
                }
            }, { once: true });
        }

        // Modal form submission handler
        const modalForm = document.getElementById('action-modal-form');
        if (modalForm) {
            // Remove any previous handler
            if (window._modalFormHandler) {
                modalForm.removeEventListener('submit', window._modalFormHandler);
            }
            window._modalFormHandler = async function (e) {
                e.preventDefault();
                const submitButton = modalForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Saving...';
                const formData = new FormData(this);
                const data = {
                    field_name: formData.get('field_name'),
                    prompt_template_id: formData.get('prompt_template_id'),
                    llm_model: formData.get('llm_model'),
                    temperature: parseFloat(formData.get('temperature')),
                    max_tokens: parseInt(formData.get('max_tokens'))
                };
                const actionId = formData.get('action_id');
                const method = actionId ? 'PUT' : 'POST';
                const url = actionId ? `/api/v1/llm/actions/${actionId}` : '/api/v1/llm/actions';
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    console.log('Action save result:', result);
                    if (result.status === 'success') {
                        window.location.reload();
                        return;
                    }
                    alert('Error saving action: ' + (result.error || 'Unknown error'));
                    submitButton.disabled = false;
                    submitButton.textContent = 'Save';
                } catch (error) {
                    console.error('Error saving action:', error);
                    alert('Error saving action: ' + error.message);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Save';
                }
            };
            modalForm.addEventListener('submit', window._modalFormHandler);
        }
    });

    // Helper functions
    function updateModelSelects(config, modelsData) {
        const modelSelects = document.querySelectorAll('select[name="llm_model"]');
        modelSelects.forEach(select => {
            select.innerHTML = '';
            modelsData.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.text = model;
                if (model === config.model_name) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });
    }

    function updatePromptSelect(prompts) {
        const promptSelects = document.querySelectorAll('select[name="prompt_template_id"]');
        promptSelects.forEach(select => {
            select.innerHTML = '';
            prompts.forEach(prompt => {
                const option = document.createElement('option');
                option.value = prompt.id;
                option.text = prompt.name;
                option.dataset.prompt = prompt.prompt_text;
                select.appendChild(option);
            });
        });
    }

    function handleFetchError(error, message) {
        console.error(message, error);
        alert(message + ': ' + error.message);
    }

    // Modal management functions
    function showNewActionModal() {
        document.getElementById('modalTitle').textContent = 'New Action';
        document.getElementById('action_id_modal').value = '';
        document.getElementById('action-modal-form').reset();
        document.getElementById('actionModal').classList.remove('hidden');

        // Populate LLM Model select in modal
        const llmModelSelect = document.getElementById('llm_model_modal');
        llmModelSelect.innerHTML = '';
        (availableModels || []).forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.text = model;
            llmModelSelect.appendChild(option);
        });

        // Populate Prompt Template select in modal
        const promptTemplateSelect = document.getElementById('prompt_template_id_modal');
        promptTemplateSelect.innerHTML = '';
        (availablePrompts || []).forEach(prompt => {
            const option = document.createElement('option');
            option.value = prompt.id;
            option.text = prompt.name;
            promptTemplateSelect.appendChild(option);
        });
    }

    async function editAction(actionId) {
        try {
            const response = await fetch(`/api/v1/llm/actions/${actionId}`);
            const data = await response.json();

            // Switch to builder tab
            document.getElementById('builder-tab').click();

            // Fill form with action data
            document.getElementById('field_name').value = data.field_name;
            document.getElementById('prompt_template_id').value = data.prompt_template_id;
            document.getElementById('llm_model').value = data.llm_model;
            document.getElementById('temperature').value = data.temperature;
            document.getElementById('max_tokens').value = data.max_tokens;

            // Add action ID to form for update instead of create
            const form = document.getElementById('action-builder-form');
            if (!form.dataset.actionId) {
                const actionIdInput = document.createElement('input');
                actionIdInput.type = 'hidden';
                actionIdInput.name = 'action_id';
                actionIdInput.value = actionId;
                form.appendChild(actionIdInput);
            } else {
                form.dataset.actionId = actionId;
            }

            // Update submit button text
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.textContent = 'Update Action';
        } catch (error) {
            handleFetchError(error, 'Error loading action data');
        }
    }

    async function deleteAction(actionId) {
        if (!confirm('Are you sure you want to delete this action?')) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/llm/actions/${actionId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Remove the action card from the UI
                const actionCard = document.querySelector(`[data-action-id="${actionId}"]`);
                if (actionCard) {
                    actionCard.remove();
                }
                // Reload the page to update the lists
                window.location.reload();
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Failed to delete action');
            }
        } catch (error) {
            handleFetchError(error, 'Error deleting action');
        }
    }

    function closeActionModal() {
        document.getElementById('actionModal').classList.add('hidden');
    }

    function testAction(actionId) {
        document.getElementById('test-tab').click();
        document.getElementById('test-action').value = actionId;
        document.getElementById('test-input').focus();
    }
</script>
{% endblock %}