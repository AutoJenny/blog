{% extends "base.html" %}

{% block title %}LLM Actions{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
    .action-card {
        background-color: var(--admin-bg-card, #23272F);
        color: var(--admin-text, #E0E0E0);
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--admin-border, #404040);
        padding: 2rem;
        margin-bottom: 1.5rem;
    }

    .action-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .action-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--admin-text, #E0E0E0);
    }

    .action-meta {
        font-size: 0.875rem;
        color: var(--admin-text-secondary, #9CA3AF);
    }

    .action-content {
        margin-bottom: 1.5rem;
    }

    .action-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .action-button {
        background-color: var(--admin-primary, #1B4B73);
        color: #fff;
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .action-button:hover {
        background-color: var(--admin-primary-hover, #1a4469);
    }

    .action-button-secondary {
        background-color: var(--admin-accent, #6366F1);
    }

    .action-button-secondary:hover {
        background-color: var(--admin-accent-hover, #4F46E5);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">LLM Actions</h1>

    <!-- Tab Navigation -->
    <div class="mb-4 border-b border-gray-200">
        <ul class="flex flex-wrap -mb-px" role="tablist">
            <li class="mr-2" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="actions-tab" data-tabs-target="#actions"
                    type="button" role="tab" aria-controls="actions" aria-selected="true">
                    Actions
                </button>
            </li>
            <li class="mr-2" role="presentation">
                <button
                    class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
                    id="builder-tab" data-tabs-target="#builder" type="button" role="tab" aria-controls="builder"
                    aria-selected="false">
                    Builder
                </button>
            </li>
            <li class="mr-2" role="presentation">
                <button
                    class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
                    id="test-tab" data-tabs-target="#test" type="button" role="tab" aria-controls="test"
                    aria-selected="false">
                    Test
                </button>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div id="tab-content">
        <!-- Actions Tab -->
        <div class="hidden p-4 rounded-lg bg-gray-50" id="actions" role="tabpanel" aria-labelledby="actions-tab">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for action in actions %}
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-2">{{ action.title }}</h3>
                    <p class="text-gray-600 mb-4">{{ action.description }}</p>
                    <div class="flex space-x-4">
                        <button onclick="showEditActionModal('{{ action.id }}')"
                            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                            Edit
                        </button>
                        <button onclick="testAction('{{ action.id }}')"
                            class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Test
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Builder Tab -->
        <div class="hidden p-4 rounded-lg bg-gray-50" id="builder" role="tabpanel" aria-labelledby="builder-tab">
            <div class="max-w-3xl mx-auto">
                <form id="action-builder-form" class="space-y-6">
                    <div>
                        <label for="field_name" class="block text-sm font-medium text-gray-700">Field Name</label>
                        <input type="text" name="field_name" id="field_name"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <div>
                        <label for="source_field" class="block text-sm font-medium text-gray-700">Source Field</label>
                        <select name="source_field" id="source_field"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            {% for stage, fields in workflow_fields.items() %}
                            <optgroup label="{{ stage }}">
                                {% for wf in fields %}
                                <option value="{{ wf }}">{{ wf.replace('_', ' ').title() }}</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="prompt_template_id" class="block text-sm font-medium text-gray-700">Prompt
                            Template</label>
                        <select name="prompt_template_id" id="prompt_template_id"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </select>
                        <div id="prompt_preview" class="mt-2 p-3 bg-gray-100 rounded-md font-mono text-sm hidden"></div>
                    </div>

                    <div>
                        <label for="llm_model" class="block text-sm font-medium text-gray-700">LLM Model</label>
                        <select name="llm_model" id="llm_model"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </select>
                        <div id="model_status" class="mt-1 text-sm"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="temperature" class="block text-sm font-medium text-gray-700">Temperature</label>
                            <input type="number" name="temperature" id="temperature" min="0" max="2" step="0.1"
                                value="0.7"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="max_tokens" class="block text-sm font-medium text-gray-700">Max Tokens</label>
                            <input type="number" name="max_tokens" id="max_tokens" min="1" max="4096" value="1000"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label for="test_input" class="block text-sm font-medium text-gray-700">Test Input</label>
                        <textarea name="test_input" id="test_input" rows="3"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                    <div>
                        <button type="button" id="test_action" class="btn btn-secondary mr-2">Test</button>
                        <button type="submit" class="btn btn-primary">Save Action</button>
                    </div>

                    <div id="test_result" class="mt-4 p-4 bg-gray-100 rounded-md hidden">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Test Result:</h4>
                        <pre id="test_output" class="whitespace-pre-wrap font-mono text-sm"></pre>
                    </div>
                </form>
            </div>
        </div>

        <!-- Test Tab -->
        <div class="hidden p-4 rounded-lg bg-gray-50" id="test" role="tabpanel" aria-labelledby="test-tab">
            <div class="max-w-3xl mx-auto">
                <div class="mb-6">
                    <label for="test-action" class="block text-sm font-medium text-gray-700">Select Action</label>
                    <select name="test-action" id="test-action"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        {% for action in actions %}
                        <option value="{{ action.id }}">{{ action.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-6">
                    <label for="test-input" class="block text-sm font-medium text-gray-700">Test Input</label>
                    <textarea name="test-input" id="test-input" rows="4"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex justify-end mb-6">
                    <button type="button" id="run-test"
                        class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Run Test
                    </button>
                </div>

                <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Test Output</h4>
                    <pre id="test-output"
                        class="bg-gray-800 text-white p-4 rounded-md overflow-x-auto min-h-[200px]"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New/Edit Action Modal -->
<div id="actionModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative z-10 max-w-lg mx-auto mt-20 bg-[#23272F] rounded-lg shadow-xl">
        <div class="p-6">
            <h2 class="text-xl font-semibold mb-4" id="modalTitle">New Action</h2>
            <form id="actionForm">
                <input type="hidden" id="actionId" name="actionId">
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Field Name</label>
                    <input type="text" id="fieldName" name="fieldName" class="admin-textarea w-full">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Stage Name</label>
                    <input type="text" id="stageName" name="stageName" class="admin-textarea w-full">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Source Field</label>
                    <input type="text" id="sourceField" name="sourceField" class="admin-textarea w-full">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Prompt Template</label>
                    <textarea id="promptTemplate" name="promptTemplate" class="admin-textarea w-full"
                        rows="3"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">LLM Model</label>
                    <select id="llmModel" name="llmModel" class="admin-textarea w-full"></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Temperature</label>
                    <input type="number" id="temperature" name="temperature" class="admin-textarea w-full" min="0"
                        max="2" step="0.1" value="0.7">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Max Tokens</label>
                    <input type="number" id="maxTokens" name="maxTokens" class="admin-textarea w-full" min="1"
                        max="4096" value="1000">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="action-button-secondary" onclick="closeActionModal()">Cancel</button>
                    <button type="submit" class="action-button">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative z-10 max-w-4xl mx-auto mt-20 bg-[#23272F] rounded-lg shadow-xl">
        <div class="p-6">
            <h2 class="text-xl font-semibold mb-4">Action History</h2>
            <div id="historyContent" class="max-h-[60vh] overflow-y-auto">
                <!-- History items will be loaded here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button type="button" class="action-button" onclick="closeHistoryModal()">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // State management
    let currentConfig = null;
    let availableModels = [];
    let availablePrompts = [];

    // Utility functions
    function handleFetchError(error, message) {
        console.error(message, error);
        alert(`${message}: ${error.message}`);
    }

    function updateModelSelects(config, data) {
        ['llm_model', 'llmModel'].forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;

            select.innerHTML = ''; // Clear existing options
            if (data.models && data.models.length) {
                data.models.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = m + (data.loaded && data.loaded.includes(m) ? ' (loaded)' : '');
                    if (data.loaded && data.loaded.includes(m)) {
                        option.style.fontWeight = 'bold';
                    }
                    if (m === config.model_name) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        });
    }

    function updatePromptSelect(prompts) {
        const select = document.getElementById('prompt_template_id');
        if (!select) return;

        select.innerHTML = ''; // Clear existing options

        // Add a default empty option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Select a template --';
        select.appendChild(defaultOption);

        prompts.forEach(prompt => {
            const option = document.createElement('option');
            option.value = prompt.id;
            option.textContent = prompt.name;
            option.dataset.prompt = prompt.prompt_text;
            select.appendChild(option);
        });

        // Set up preview functionality
        select.addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            const preview = document.getElementById('prompt_preview');
            if (selected && selected.dataset.prompt) {
                preview.textContent = selected.dataset.prompt;
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        });
    }

    // Initialize data
    async function initializeData() {
        try {
            // Load configuration
            const configResponse = await fetch('/api/v1/llm/config');
            currentConfig = await configResponse.json();

            // Load models
            const modelsResponse = await fetch('/api/v1/llm/models/ollama');
            const modelsData = await modelsResponse.json();
            availableModels = modelsData.models || [];
            updateModelSelects(currentConfig, modelsData);

            // Load prompts
            const promptsResponse = await fetch('/api/v1/llm/prompts');
            availablePrompts = await promptsResponse.json();
            updatePromptSelect(availablePrompts);

        } catch (error) {
            handleFetchError(error, 'Error initializing data');
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize data
        initializeData();

        // Tab functionality
        const tabs = document.querySelectorAll('[role="tab"]');
        const tabPanels = document.querySelectorAll('[role="tabpanel"]');

        tabs.forEach(tab => {
            tab.addEventListener('click', function (e) {
                tabs.forEach(t => {
                    t.setAttribute('aria-selected', 'false');
                    t.classList.remove('border-blue-600', 'text-blue-600');
                    t.classList.add('border-transparent');
                });

                tabPanels.forEach(p => p.classList.add('hidden'));

                this.setAttribute('aria-selected', 'true');
                this.classList.remove('border-transparent');
                this.classList.add('border-blue-600', 'text-blue-600');

                const panelId = this.getAttribute('data-tabs-target').substring(1);
                document.getElementById(panelId).classList.remove('hidden');
            });
        });

        // Activate first tab by default
        tabs[0].click();

        // Form handling
        const actionForm = document.getElementById('actionForm');
        if (actionForm) {
            actionForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const actionId = document.getElementById('actionId').value;
                const data = {
                    field_name: document.getElementById('fieldName').value,
                    stage_name: document.getElementById('stageName').value,
                    source_field: document.getElementById('sourceField').value,
                    prompt_template: document.getElementById('promptTemplate').value,
                    llm_model: document.getElementById('llmModel').value,
                    temperature: parseFloat(document.getElementById('temperature').value),
                    max_tokens: parseInt(document.getElementById('maxTokens').value)
                };

                try {
                    const response = await fetch(`/api/v1/llm/actions${actionId ? '/' + actionId : ''}`, {
                        method: actionId ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error saving action: ' + result.error);
                    }
                } catch (error) {
                    handleFetchError(error, 'Error saving action');
                }
            });
        }

        // Test action functionality
        const testActionButton = document.getElementById('test_action');
        if (testActionButton) {
            testActionButton.addEventListener('click', async function () {
                const data = {
                    prompt: document.getElementById('prompt_template_id').options[
                        document.getElementById('prompt_template_id').selectedIndex
                    ].dataset.prompt,
                    model_name: document.getElementById('llm_model').value,
                    temperature: parseFloat(document.getElementById('temperature').value),
                    max_tokens: parseInt(document.getElementById('max_tokens').value),
                    input: document.getElementById('test_input').value
                };

                try {
                    const response = await fetch('/api/v1/llm/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    const resultContainer = document.getElementById('test_result');
                    const output = document.getElementById('test_output');
                    output.textContent = result.result;
                    resultContainer.classList.remove('hidden');
                } catch (error) {
                    handleFetchError(error, 'Error testing action');
                }
            });
        }
    });

    // Modal management functions
    function showNewActionModal() {
        document.getElementById('modalTitle').textContent = 'New Action';
        document.getElementById('actionId').value = '';
        document.getElementById('actionForm').reset();
        document.getElementById('actionModal').classList.remove('hidden');
    }

    async function showEditActionModal(actionId) {
        document.getElementById('modalTitle').textContent = 'Edit Action';
        document.getElementById('actionId').value = actionId;

        try {
            const response = await fetch(`/api/v1/llm/actions/${actionId}`);
            const data = await response.json();
            document.getElementById('fieldName').value = data.field_name;
            document.getElementById('stageName').value = data.stage_name;
            document.getElementById('sourceField').value = data.source_field;
            document.getElementById('promptTemplate').value = data.prompt_template;
            document.getElementById('llmModel').value = data.llm_model;
            document.getElementById('temperature').value = data.temperature;
            document.getElementById('maxTokens').value = data.max_tokens;
        } catch (error) {
            handleFetchError(error, 'Error loading action data');
        }

        document.getElementById('actionModal').classList.remove('hidden');
    }

    function closeActionModal() {
        document.getElementById('actionModal').classList.add('hidden');
    }

    function testAction(actionId) {
        document.getElementById('test-tab').click();
        document.getElementById('test-action').value = actionId;
        document.getElementById('test-input').focus();
    }
</script>
{% endblock %}