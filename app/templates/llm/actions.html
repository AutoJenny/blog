{% extends "base.html" %}

{% block title %}LLM Actions{% endblock %}

{% block styles %}
<link href="/static/css/dist/main.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    body {
        background: #18181b;
    }

    .admin-card {
        background: #23272F;
        border-radius: 1rem;
        box-shadow: 0 6px 32px rgba(0, 0, 0, 0.18);
        padding: 2.5rem 2rem 2rem 2rem;
        margin-bottom: 2rem;
    }

    .action-card {
        background: #26293a;
        border: 1.5px solid #35395a;
        border-radius: 1rem;
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 12px rgba(56, 189, 248, 0.08);
    }

    .action-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .action-accordion-item {
        background: #23273a;
        border: 1.5px solid #35395a;
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        transition: box-shadow 0.2s, border 0.2s, background 0.2s;
        box-shadow: 0 2px 8px rgba(56, 189, 248, 0.06);
        cursor: pointer;
    }

    .action-accordion-item:hover {
        border-color: #38bdf8;
        background: #23273aee;
        box-shadow: 0 4px 16px rgba(56, 189, 248, 0.13);
    }

    .action-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1.5rem;
    }

    .action-name {
        font-size: 1.15rem;
        font-weight: 700;
        color: #e0e0e0;
        letter-spacing: 0.01em;
    }

    .action-model {
        color: #a5b4fc;
        font-size: 1em;
        margin-left: 1.5rem;
        font-weight: 500;
    }

    .action-actions {
        display: flex;
        gap: 0.75rem;
    }

    .action-prompt {
        font-family: 'Monaco', 'Menlo', monospace;
        background: #18181b;
        padding: 1.1rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.95em;
        line-height: 1.6;
        white-space: pre-wrap;
        color: #e0e0e0;
        border: 1px solid #35395a;
        margin-top: 0.5rem;
    }

    .action-accordion-content {
        margin-top: 1rem;
        display: none;
    }

    .action-accordion-content.active,
    .action-accordion-content[style*='block'] {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1.4rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
        font-size: 0.95em;
    }

    .btn-primary {
        background: linear-gradient(90deg, #6366f1 0%, #38bdf8 100%);
        color: #fff;
        border: none;
        font-weight: 700;
    }

    .btn-primary:hover {
        background: linear-gradient(90deg, #38bdf8 0%, #6366f1 100%);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.18);
        color: #fff;
    }

    .btn-secondary {
        background: #23273a;
        border: 1.5px solid #35395a;
        color: #a5b4fc;
    }

    .btn-secondary:hover {
        background: #3730a3;
        border-color: #38bdf8;
        color: #fff;
    }

    .btn-danger {
        background: #DC2626;
        color: white;
        border: none;
    }

    .btn-danger:hover {
        background: #B91C1C;
        color: #fff;
    }

    .sortable-ghost {
        opacity: 0.4;
        background: #6366F1 !important;
    }

    .sortable-chosen {
        border-top: 6px solid #6366F1 !important;
        margin-top: -6px;
        box-shadow: 0 0 0 2px #6366F1;
        transition: border 0.2s, box-shadow 0.2s;
    }

    /* Modal Styling */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #23273a;
        border-radius: 1rem;
        padding: 2.5rem 2rem 2rem 2rem;
        width: 100%;
        max-width: 480px;
        box-shadow: 0 8px 32px rgba(56, 189, 248, 0.18);
        border: 1.5px solid #35395a;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #35395a;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #e0e0e0;
    }

    .modal-close {
        background: none;
        border: none;
        color: #a5b4fc;
        cursor: pointer;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 1.5rem;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: #3730a3;
        color: #fff;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        color: #a5b4fc;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.97em;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        background: #18181b;
        border: 1.5px solid #35395a;
        color: #e0e0e0;
        padding: 0.7rem 1rem;
        border-radius: 0.5rem;
        font-size: 1em;
        margin-bottom: 0.1rem;
        transition: border 0.2s, box-shadow 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
        border-color: #38bdf8;
        outline: none;
        box-shadow: 0 0 0 2px #38bdf8aa;
    }

    .form-textarea {
        min-height: 110px;
        font-family: 'Monaco', 'Menlo', monospace;
        line-height: 1.5;
        resize: vertical;
    }

    .flex.justify-end.gap-4 {
        margin-top: 2rem;
    }

    @media (max-width: 600px) {

        .admin-card,
        .modal-content {
            padding: 1.2rem;
        }

        .action-card {
            padding: 1rem;
        }
    }

    .example-btn {
        display: inline-block;
        background: #6366f1;
        color: #fff;
        border-radius: 0.3em;
        padding: 0.1em 0.6em;
        font-size: 0.95em;
        font-weight: 500;
        margin: 0 0.1em;
        cursor: default;
        box-shadow: none;
        border: none;
        vertical-align: middle;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block area_nav %}
{% include 'llm/_llm_nav.html' %}
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto py-10">
    <div class="admin-content">
        <div class="bg-indigo-900/80 text-indigo-100 rounded-xl p-6 mb-8 shadow-lg">
            <h2 class="text-xl font-bold mb-2 flex items-center gap-2">
                <i class="fa-solid fa-circle-info"></i> How to Create and Use LLM Actions
            </h2>
            <ol class="list-decimal ml-6 mb-2">
                <li><b>Add a New Action:</b> Click <span class="example-btn"><i class="fa-solid fa-plus"></i> New
                        Action</span> and fill in the basic settings (field name, model, etc.).</li>
                <li><b>Edit Prompt Parts:</b> Click <span class="example-btn"><i class="fa-solid fa-layer-group"></i>
                        Prompt Parts</span> to build your prompt from multiple parts. <span class="text-indigo-200">(See
                        below for detailed instructions.)</span></li>
                <li><b>Test Your Action:</b> Click <span class="example-btn"><i class="fa-solid fa-play"></i>
                        Run/Test</span> to try it out with sample input.</li>
                <li><b>Use in Posts:</b> Select your action in the post editor and click <b>Generate</b> to use it for
                    real content.</li>
            </ol>
            <div class="text-sm text-indigo-200">Tip: Use <b>Prompt Parts</b> to break your prompt into logical steps
                (system, user, assistant, etc.) for better LLM results. You can use variables like
                <code>{{input}}</code> or <code>{{idea_seed}}</code> in your prompt parts.</div>
        </div>
        <div class="admin-card">
            <div class="flex items-center justify-between mb-6">
                <h1 class="admin-title">
                    <i class="fas fa-bolt mr-2"></i>
                    LLM Actions
                </h1>
                <button class="btn btn-primary" id="newActionBtn">
                    <i class="fas fa-plus"></i>
                    New Action
                </button>
            </div>
            <div class="action-card">
                <div class="action-list" id="actionAccordionList">
                    {% for action in actions %}
                    <div class="action-accordion-item" data-id="{{ action.id }}" draggable="true">
                        <div class="action-header flex items-center justify-between select-none">
                            <span class="flex items-center">
                                <span class="drag-handle mr-2" title="Drag to reorder"
                                    style="cursor:grab;font-size:1.2em;">☰</span>
                                <span class="chevron mr-2" style="transition:transform 0.2s;">&#9654;</span>
                                <span class="action-name">{{ action.field_name }}</span>
                                <span class="action-model">Model: {{ action.llm_model }}</span>
                            </span>
                            <div class="action-actions">
                                <a href="/llm/actions/{{ action.id }}" class="btn btn-primary ml-2"
                                    title="View Details">
                                    <i class="fas fa-eye"></i> Details
                                </a>
                                <button class="btn btn-secondary edit-action-btn ml-2" data-id="{{ action.id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-secondary prompt-parts-btn ml-2" data-id="{{ action.id }}">
                                    <i class="fas fa-layer-group"></i> Prompt Parts
                                </button>
                                <button class="btn btn-danger delete-action-btn ml-2" data-id="{{ action.id }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="action-accordion-content">
                            <div class="action-prompt"><strong>Prompt Template:</strong><br>{{ action.prompt_template }}
                            </div>
                            <div class="text-xs text-gray-500 mt-2">Temperature: {{ action.temperature }}, Max Tokens:
                                {{ action.max_tokens }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- New/Edit Action Modal -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalActionTitle">New Action</h2>
                <button type="button" class="modal-close" id="modalActionCloseBtn">×</button>
            </div>
            <form id="actionForm">
                <input type="hidden" id="actionId" name="id">
                <div class="form-group">
                    <label class="form-label" for="actionFieldName">Field Name</label>
                    <input type="text" id="actionFieldName" name="field_name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionProvider">LLM Provider</label>
                    <select id="actionProvider" name="provider_id" class="form-input" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionModel">LLM Model</label>
                    <select id="actionModel" name="llm_model" class="form-input" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionPromptTemplateId">Prompt Template</label>
                    <select id="actionPromptTemplateId" name="prompt_template_id" class="form-input" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionPromptTemplate">Prompt Template Text (preview only)</label>
                    <textarea id="actionPromptTemplate" name="prompt_template" class="form-textarea"
                        readonly></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionTemperature">Temperature</label>
                    <input type="number" id="actionTemperature" name="temperature" class="form-input" min="0" max="2"
                        step="0.1" value="0.7">
                </div>
                <div class="form-group">
                    <label class="form-label" for="actionMaxTokens">Max Tokens</label>
                    <input type="number" id="actionMaxTokens" name="max_tokens" class="form-input" min="1" max="4096"
                        value="1000">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="btn btn-secondary" id="cancelActionBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Action</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Details Modal (Prompt Parts Management) -->
    <div id="actionDetailsModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="bg-indigo-800/90 text-indigo-100 rounded-lg p-4 mb-4">
                <h3 class="font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> Prompt Parts
                    Editor</h3>
                <ul class="list-disc ml-6 text-sm">
                    <li><b>Prompt Parts</b> are the building blocks of your LLM prompt. Each part can be a <b>System</b>
                        (instructions), <b>User</b> (input), or <b>Assistant</b> (expected response).</li>
                    <li><b>Add</b> parts in the order you want them sent to the AI. Use <b>System</b> for instructions,
                        <b>User</b> for the main request, and <b>Assistant</b> for expected responses (optional).
                    </li>
                    <li>You can use variables like <code>{{input}}</code> or <code>{{idea_seed}}</code> to insert data
                        from your post.</li>
                    <li><b>Drag</b> parts to reorder, or use the up/down arrows.</li>
                    <li>The <b>Preview</b> panel shows how your full prompt will look to the AI.</li>
                </ul>
                <div class="mt-2 text-xs text-indigo-200">Need help? Hover over any <i
                        class="fa-solid fa-circle-question"></i> icon for more info.</div>
            </div>
            <span class="close" id="closeActionDetails">&times;</span>
            <h2>Action Details: <span id="detailsActionName"></span></h2>
            <div>
                <label>Input Field:</label> <span id="detailsInputField"></span><br>
                <label>Output Field:</label> <span id="detailsOutputField"></span>
            </div>
            <h3>Prompt Parts</h3>
            <ul id="promptPartsList" class="draggable-list"></ul>
            <button id="addPromptPartBtn">+ Add Prompt Part</button>
            <div id="promptPartEditForm" style="display:none;">
                <h4 id="promptPartFormTitle">Add/Edit Prompt Part</h4>
                <form>
                    <label class="form-label flex items-center gap-1">Type <i
                            class="fa-solid fa-circle-question text-indigo-300"
                            title="System: sets AI behavior. User: main instruction. Assistant: (optional) expected response."></i></label>
                    <label class="form-label flex items-center gap-1">Role:
                        <select id="promptPartRole">
                            <option value="system">system</option>
                            <option value="user">user</option>
                            <option value="assistant">assistant</option>
                            <option value="tool">tool</option>
                            <option value="function">function</option>
                            <option value="other">other</option>
                        </select>
                    </label>
                    <label class="form-label flex items-center gap-1">Content <i
                            class="fa-solid fa-circle-question text-indigo-300"
                            title="Write what you want this part to say. Use variables like {{input}} or {{idea_seed}}."></i></label>
                    <label class="form-label flex items-center gap-1">Description:<br>
                        <input id="promptPartDescription" type="text" />
                    </label>
                    <label class="form-label flex items-center gap-1">Tags:<br>
                        <input id="promptPartTags" type="text" placeholder="Comma-separated" />
                    </label>
                    <button type="button" id="savePromptPartBtn">Save</button>
                    <button type="button" id="cancelPromptPartBtn">Cancel</button>
                </form>
            </div>
            <div style="margin-top:1em;">
                <button id="savePromptPartsOrderBtn">Save Order</button>
            </div>
            <hr>
            <h3>Test Action</h3>
            <label>Test Input:<br><textarea id="testActionInput" rows="2"></textarea></label>
            <button id="testActionBtn">Run Test</button>
            <div id="testActionOutput" style="margin-top:1em;"></div>
            <div class="bg-dark-card rounded p-4 mt-4 mb-2">
                <h4 class="font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-eye"></i> Prompt Preview</h4>
                <div id="promptPreview" class="whitespace-pre-line text-indigo-100 text-sm">{ ... message preview ... }
                </div>
                <div class="text-xs text-indigo-200 mt-1">This is how your full prompt will look to the AI, with
                    variables replaced at runtime.</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script>
        async function loadProviders(selectedProviderId) {
            const providerSelect = document.getElementById('actionProvider');
            providerSelect.innerHTML = '<option value="">Loading...</option>';
            const resp = await fetch('/api/v1/llm/providers');
            const providers = await resp.json();
            providerSelect.innerHTML = providers.map(p => `<option value="${p.id}" ${selectedProviderId == p.id ? 'selected' : ''}>${p.name}</option>`).join('');
        }
        async function loadModels(providerId, selectedModelId) {
            const modelSelect = document.getElementById('actionModel');
            modelSelect.innerHTML = '<option value="">Loading...</option>';
            const resp = await fetch('/api/v1/llm/models');
            const models = await resp.json();
            const filtered = models.filter(m => m.provider_id == providerId);
            modelSelect.innerHTML = filtered.map(m => `<option value="${m.name}" data-model-id="${m.id}" ${selectedModelId == m.name ? 'selected' : ''}>${m.name} (${m.description || ''})</option>`).join('');
        }
        async function loadPromptTemplates(selectedId) {
            const select = document.getElementById('actionPromptTemplateId');
            select.innerHTML = '<option value="">Loading...</option>';
            const resp = await fetch('/api/v1/llm/prompts');
            const prompts = await resp.json();
            select.innerHTML = prompts.map(p => `<option value="${p.id}" ${selectedId == p.id ? 'selected' : ''}>${p.name} (${p.description || ''})</option>`).join('');
            // Set preview textarea to selected prompt text
            select.addEventListener('change', function () {
                const prompt = prompts.find(p => p.id == select.value);
                document.getElementById('actionPromptTemplate').value = prompt ? prompt.prompt_text : '';
            });
            // Set initial preview
            if (selectedId) {
                const prompt = prompts.find(p => p.id == selectedId);
                document.getElementById('actionPromptTemplate').value = prompt ? prompt.prompt_text : '';
            } else {
                document.getElementById('actionPromptTemplate').value = '';
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // Accordion logic
            document.querySelectorAll('.action-header').forEach(header => {
                header.addEventListener('click', function (e) {
                    if (e.target.closest('.edit-action-btn') || e.target.closest('.delete-action-btn')) return;
                    const item = header.parentElement;
                    const content = item.querySelector('.action-accordion-content');
                    const chevron = header.querySelector('.chevron');
                    const isOpen = content.classList.contains('active') || content.style.display === 'block';
                    document.querySelectorAll('.action-accordion-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.chevron').forEach(ch => ch.style.transform = 'rotate(0deg)');
                    if (!isOpen) {
                        content.classList.add('active');
                        chevron.style.transform = 'rotate(90deg)';
                    }
                });
            });
            // Drag-and-drop with SortableJS
            const el = document.getElementById('actionAccordionList');
            if (el) {
                new Sortable(el, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        const ids = Array.from(el.querySelectorAll('.action-accordion-item')).map(item => item.dataset.id);
                        fetch('/api/v1/llm/actions/order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order: ids })
                        }).then(r => r.json()).then(data => {
                            if (!data.success) {
                                alert('Failed to save order: ' + (data.error || 'Unknown error'));
                            }
                        }).catch(err => {
                            alert('Error saving order: ' + err);
                        });
                    }
                });
            }
            // Modal logic
            const actionModal = document.getElementById('actionModal');
            const newActionBtn = document.getElementById('newActionBtn');
            const modalActionCloseBtn = document.getElementById('modalActionCloseBtn');
            const cancelActionBtn = document.getElementById('cancelActionBtn');
            const actionForm = document.getElementById('actionForm');
            newActionBtn.addEventListener('click', function () {
                document.getElementById('modalActionTitle').textContent = 'New Action';
                actionForm.reset();
                document.getElementById('actionId').value = '';
                loadProviders().then(() => {
                    const providerId = document.getElementById('actionProvider').value;
                    loadModels(providerId);
                });
                loadPromptTemplates();
                actionModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            document.getElementById('actionProvider').addEventListener('change', function () {
                loadModels(this.value);
            });
            modalActionCloseBtn.addEventListener('click', function () {
                actionModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            cancelActionBtn.addEventListener('click', function () {
                actionModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            // Edit Action
            document.querySelectorAll('.edit-action-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    const response = await fetch(`/api/v1/llm/actions/${id}`);
                    if (!response.ok) return alert('Failed to load action');
                    const data = await response.json();
                    document.getElementById('modalActionTitle').textContent = 'Edit Action';
                    document.getElementById('actionId').value = data.action.id;
                    document.getElementById('actionFieldName').value = data.action.field_name;
                    // Find model and provider
                    const modelName = data.action.llm_model;
                    const resp = await fetch('/api/v1/llm/models');
                    const models = await resp.json();
                    const model = models.find(m => m.name === modelName);
                    const providerId = model ? model.provider_id : '';
                    await loadProviders(providerId);
                    await loadModels(providerId, modelName);
                    document.getElementById('actionProvider').value = providerId;
                    document.getElementById('actionModel').value = modelName;
                    // Load prompt templates and set selected
                    await loadPromptTemplates(data.action.prompt_template_id);
                    document.getElementById('actionPromptTemplateId').value = data.action.prompt_template_id;
                    document.getElementById('actionPromptTemplate').value = data.action.prompt_template;
                    document.getElementById('actionTemperature').value = data.action.temperature;
                    document.getElementById('actionMaxTokens').value = data.action.max_tokens;
                    actionModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
            });
            // Delete Action
            document.querySelectorAll('.delete-action-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    if (!confirm('Are you sure you want to delete this action?')) return;
                    const id = btn.dataset.id;
                    const response = await fetch(`/api/v1/llm/actions/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete action');
                    }
                });
            });
            // Form submit
            actionForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const actionId = document.getElementById('actionId').value;
                const method = actionId ? 'PUT' : 'POST';
                const url = actionId ? `/api/v1/llm/actions/${actionId}` : '/api/v1/llm/actions';
                // Always collect all fields, even if empty
                const field_name = document.getElementById('actionFieldName').value || '';
                const llm_model = document.getElementById('actionModel').value || '';
                const prompt_template_id = parseInt(document.getElementById('actionPromptTemplateId').value) || null;
                const temperature = parseFloat(document.getElementById('actionTemperature').value) || 0.7;
                const max_tokens = parseInt(document.getElementById('actionMaxTokens').value) || 1000;
                if (!prompt_template_id) {
                    alert('Please select a prompt template.');
                    return;
                }
                // Defensive: always send all required fields
                const payload = {
                    field_name,
                    llm_model,
                    prompt_template_id,
                    temperature,
                    max_tokens
                };
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        const err = await response.json().catch(() => ({}));
                        throw new Error('Failed to save action: ' + (err.error || response.statusText));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving action: ' + (error.message || error));
                }
            });
            // Close modal when clicking outside
            actionModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    actionModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            // Prompt Parts modal open/close logic
            function closeActionDetailsModal() {
                document.getElementById('actionDetailsModal').style.display = 'none';
                document.getElementById('promptPartEditForm').style.display = 'none';
                document.getElementById('testActionOutput').textContent = '';
            }
            document.getElementById('closeActionDetails').onclick = closeActionDetailsModal;
            document.getElementById('actionDetailsModal').onclick = function (e) {
                if (e.target === this) closeActionDetailsModal();
            };
            document.querySelectorAll('.prompt-parts-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    openActionDetails(btn.dataset.id);
                });
            });
            // Prompt Part CRUD logic
            function refreshPromptParts(actionId) {
                fetch(`/api/v1/llm/actions/${actionId}`)
                    .then(r => r.json())
                    .then(data => {
                        const action = data.action || data;
                        const list = document.getElementById('promptPartsList');
                        list.innerHTML = '';
                        (action.prompt_parts || []).forEach((part, idx) => {
                            const li = document.createElement('li');
                            li.draggable = true;
                            li.dataset.id = part.id;
                            li.dataset.order = part.order;
                            li.innerHTML = `<b>${part.type}</b> [${part.role}]<br>${part.content}<br><button type='button' class='btn btn-secondary btn-xs' onclick='editPromptPart(${actionId},${part.id})'>Edit</button> <button type='button' class='btn btn-danger btn-xs' onclick='removePromptPart(${actionId},${part.id})'>Remove</button>`;
                            list.appendChild(li);
                        });
                    });
            }
            window.editPromptPart = function (actionId, partId) {
                fetch(`/api/v1/llm/prompt_parts/${partId}`)
                    .then(r => r.json())
                    .then(part => {
                        document.getElementById('promptPartType').value = part.type;
                        document.getElementById('promptPartRole').value = part.role;
                        document.getElementById('promptPartContent').value = part.content;
                        document.getElementById('promptPartDescription').value = part.description || '';
                        document.getElementById('promptPartTags').value = (part.tags || []).join(', ');
                        document.getElementById('promptPartEditForm').style.display = 'block';
                        document.getElementById('promptPartEditForm').dataset.editing = partId;
                        document.getElementById('promptPartEditForm').dataset.actionId = actionId;
                    });
            };
            window.removePromptPart = function (actionId, partId) {
                if (!confirm('Remove this prompt part from the action?')) return;
                fetch(`/api/v1/llm/actions/${actionId}/prompt_parts/${partId}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(() => refreshPromptParts(actionId));
            };
            document.getElementById('addPromptPartBtn').onclick = function () {
                document.getElementById('promptPartType').value = 'system';
                document.getElementById('promptPartRole').value = 'user';
                document.getElementById('promptPartContent').value = '';
                document.getElementById('promptPartDescription').value = '';
                document.getElementById('promptPartTags').value = '';
                document.getElementById('promptPartEditForm').style.display = 'block';
                document.getElementById('promptPartEditForm').dataset.editing = '';
                document.getElementById('promptPartEditForm').dataset.actionId = document.getElementById('actionDetailsModal').dataset.actionId;
            };
            document.getElementById('cancelPromptPartBtn').onclick = function () {
                document.getElementById('promptPartEditForm').style.display = 'none';
            };
            document.getElementById('savePromptPartBtn').onclick = function () {
                const type = document.getElementById('promptPartType').value;
                const role = document.getElementById('promptPartRole').value;
                const content = document.getElementById('promptPartContent').value;
                const description = document.getElementById('promptPartDescription').value;
                const tags = document.getElementById('promptPartTags').value.split(',').map(t => t.trim()).filter(Boolean);
                const editing = document.getElementById('promptPartEditForm').dataset.editing;
                const actionId = document.getElementById('promptPartEditForm').dataset.actionId;
                let url, method, body;
                if (editing) {
                    url = `/api/v1/llm/prompt_parts/${editing}`;
                    method = 'PUT';
                    body = JSON.stringify({ type, role, content, description, tags });
                } else {
                    url = `/api/v1/llm/prompt_parts`;
                    method = 'POST';
                    body = JSON.stringify({ type, role, content, description, tags });
                }
                fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body })
                    .then(r => r.json())
                    .then(part => {
                        if (!editing) {
                            // Link to action
                            fetch(`/api/v1/llm/actions/${actionId}/prompt_parts`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ prompt_part_id: part.id })
                            }).then(() => refreshPromptParts(actionId));
                        } else {
                            refreshPromptParts(actionId);
                        }
                        document.getElementById('promptPartEditForm').style.display = 'none';
                    });
            };
            // Drag-and-drop reordering for prompt parts
            new Sortable(document.getElementById('promptPartsList'), {
                animation: 150,
                onEnd: function (evt) {
                    const actionId = document.getElementById('actionDetailsModal').dataset.actionId;
                    const ids = Array.from(document.getElementById('promptPartsList').children).map(li => li.dataset.id);
                    fetch(`/api/v1/llm/actions/${actionId}/prompt_parts/order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order: ids })
                    }).then(r => r.json()).then(data => {
                        if (!data.success) alert('Failed to save prompt part order: ' + (data.error || 'Unknown error'));
                    });
                }
            });
            document.getElementById('savePromptPartsOrderBtn').onclick = function () {
                const actionId = document.getElementById('actionDetailsModal').dataset.actionId;
                const ids = Array.from(document.getElementById('promptPartsList').children).map(li => li.dataset.id);
                fetch(`/api/v1/llm/actions/${actionId}/prompt_parts/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order: ids })
                }).then(r => r.json()).then(data => {
                    if (!data.success) alert('Failed to save prompt part order: ' + (data.error || 'Unknown error'));
                });
            };
            // Test Action logic
            document.getElementById('testActionBtn').onclick = function () {
                const actionId = document.getElementById('actionDetailsModal').dataset.actionId;
                const input = document.getElementById('testActionInput').value;
                document.getElementById('testActionOutput').textContent = 'Running...';
                fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input })
                })
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('testActionOutput').textContent = data.output || data.result || JSON.stringify(data);
                    })
                    .catch(err => {
                        document.getElementById('testActionOutput').textContent = 'Error: ' + err;
                    });
            };
            function openActionDetails(actionId) {
                // Open the modal and load action details
                const modal = document.getElementById('actionDetailsModal');
                modal.style.display = 'flex';
                modal.dataset.actionId = actionId;
                // Fetch action details and populate modal fields
                fetch(`/api/v1/llm/actions/${actionId}`)
                    .then(r => r.json())
                    .then(data => {
                        const action = data.action || {};
                        document.getElementById('detailsActionName').textContent = action.field_name || '';
                        document.getElementById('detailsInputField').textContent = action.input_field || '';
                        document.getElementById('detailsOutputField').textContent = action.output_field || '';
                        // Populate prompt parts list
                        const list = document.getElementById('promptPartsList');
                        list.innerHTML = '';
                        (action.prompt_parts || []).forEach((part, idx) => {
                            const li = document.createElement('li');
                            li.draggable = true;
                            li.dataset.id = part.id;
                            li.dataset.order = part.order;
                            li.innerHTML = `<b>${part.type}</b> [${part.role || ''}]<br>${part.content}<br>`;
                            list.appendChild(li);
                        });
                    });
            }
        });
    </script>
</div>
{% endblock %}