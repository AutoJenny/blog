{% extends "base.html" %}

{% block title %}LLM Management{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .config-card {
        background: var(--dark-bg-secondary);
        border: 1px solid var(--dark-border);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .config-section {
        margin-bottom: 2rem;
        background: var(--dark-bg-primary);
        padding: 1.5rem;
        border-radius: 6px;
    }

    .config-form {
        display: grid;
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        color: var(--dark-text-primary);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .form-input,
    .form-select {
        background: var(--dark-bg-secondary);
        border: 1px solid var(--dark-border);
        color: var(--dark-text-primary);
        padding: 0.75rem;
        border-radius: 6px;
        width: 100%;
    }

    .form-input:focus,
    .form-select:focus {
        border-color: var(--dark-accent);
        outline: none;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
    }

    .form-select option {
        background: var(--dark-bg-secondary);
        color: var(--dark-text-primary);
    }

    .test-prompt {
        min-height: 120px;
        resize: vertical;
    }

    .result-container {
        background: var(--dark-bg-secondary);
        border: 1px solid var(--dark-border);
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .result-pre {
        color: var(--dark-text-primary);
        white-space: pre-wrap;
        font-family: monospace;
        margin: 0;
        background: var(--dark-bg-primary);
        padding: 1rem;
        border-radius: 4px;
    }

    .template-card {
        background: var(--dark-bg-secondary);
        border: 1px solid var(--dark-border);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .template-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .template-title {
        color: var(--dark-text-primary);
        font-weight: 600;
        font-size: 1.125rem;
    }

    .template-content {
        color: var(--dark-text-primary);
        font-family: monospace;
        white-space: pre-wrap;
        background: var(--dark-bg-primary);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .btn {
        background: var(--dark-accent);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 120px;
    }

    .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn:active {
        transform: translateY(0);
        box-shadow: none;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: var(--dark-bg-primary);
        border: 1px solid var(--dark-border);
        color: var(--dark-text-primary);
    }

    .btn-secondary:hover {
        background: var(--dark-bg-hover);
    }

    .section-title {
        color: var(--dark-text-primary);
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--dark-accent);
        padding-bottom: 0.5rem;
    }

    .subsection-title {
        color: var(--dark-text-primary);
        font-size: 1.25rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-content">
    <div class="admin-card">
        <h1 class="admin-title mb-6">LLM Management</h1>

        <!-- Configuration Section -->
        <div class="config-card">
            <h2 class="text-xl font-semibold text-dark-text mb-4">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="config-section">
                    <h3 class="text-lg font-medium text-dark-text mb-3">Current Settings</h3>
                    <div class="result-container">
                        <p class="mb-2"><strong>Provider:</strong> <span id="current-provider">{{
                                config.provider_type|default('ollama') }}</span></p>
                        <p class="mb-2"><strong>Model:</strong> <span id="current-model">{{
                                config.model_name|default('mistral') }}</span></p>
                        <p class="mb-0"><strong>API Base:</strong> <span id="current-api-base">{{
                                config.api_base|default('http://localhost:11434') }}</span></p>
                    </div>
                </div>
                <div class="config-section">
                    <h3 class="text-lg font-medium text-dark-text mb-3">Update Settings</h3>
                    <form id="config-form" class="config-form">
                        <div class="form-group">
                            <label class="form-label">Provider Type</label>
                            <select name="provider_type" class="form-select" id="llm-provider-select">
                                <option value="ollama" {% if config.provider_type=='ollama' %}selected{% endif %}>Ollama
                                </option>
                                <option value="openai" {% if config.provider_type=='openai' %}selected{% endif %}>OpenAI
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Model</label>
                            <div id="llm-model-list"></div>
                            <div id="llm-model-note" style="font-size:0.95em; color:#a3e635; margin-top:0.25em;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Base URL</label>
                            <input type="text" name="api_base" class="form-input"
                                value="{{ config.api_base|default('http://localhost:11434') }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Authentication Token</label>
                            <input type="password" name="auth_token" class="form-input"
                                placeholder="Leave blank to keep current">
                            <small class="text-muted">Provider authentication token for API access</small>
                        </div>
                        <button type="submit" class="btn">Update Configuration</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Test Interface -->
        <div class="config-card">
            <h2 class="text-xl font-semibold text-dark-text mb-4">Test Interface</h2>
            <form id="test-form">
                <div class="form-group">
                    <label class="form-label">Test Prompt</label>
                    <textarea name="prompt" class="form-input test-prompt"
                        placeholder="Enter a test prompt here..."></textarea>
                </div>
                <button type="submit" class="btn mt-4">Test LLM</button>
            </form>
            <div id="test-result" class="result-container mt-4" style="display: none;">
                <h3 class="text-lg font-medium text-dark-text mb-2">Result:</h3>
                <pre class="result-pre"></pre>
            </div>
        </div>

        <!-- Prompt Templates -->
        <div class="config-card">
            <h2 class="text-xl font-semibold text-dark-text mb-4">Prompt Templates</h2>
            <div class="space-y-4">
                {% for name, content in prompts.items() %}
                <div class="template-card">
                    <div class="template-header">
                        <h3 class="template-title">{{ name }}</h3>
                        <button class="btn btn-secondary">Edit Template</button>
                    </div>
                    <div class="template-content">{{ content }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script>
    document.getElementById('config-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const response = await fetch('/api/v1/llm/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(Object.fromEntries(formData)),
            });
            const result = await response.json();
            if (result.success) {
                // Update displayed values
                document.getElementById('current-provider').textContent = formData.get('provider_type');
                document.getElementById('current-model').textContent = formData.get('model_name');
                document.getElementById('current-api-base').textContent = formData.get('api_base');
                alert('Configuration updated successfully');
            } else {
                alert('Error updating configuration: ' + result.error);
            }
        } catch (error) {
            alert('Error updating configuration: ' + error.message);
        }
    });

    document.getElementById('test-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const submitButton = e.target.querySelector('button[type="submit"]');
        const resultContainer = document.getElementById('test-result');
        const resultPre = resultContainer.querySelector('.result-pre');

        // Get selected model from radio buttons
        const modelRadio = document.querySelector('#llm-model-list input[name="llm_model"]:checked');
        const modelName = modelRadio ? modelRadio.value : null;

        try {
            submitButton.disabled = true;
            submitButton.textContent = 'Testing...';

            const response = await fetch('/api/v1/llm/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: formData.get('prompt'),
                    model_name: modelName
                }),
            });
            const result = await response.json();

            resultContainer.style.display = 'block';
            if (result.result) {
                resultPre.textContent = result.result + (result.model_used ? `\n\n(Model used: ${result.model_used})` : '');
                resultPre.style.color = 'var(--dark-text-primary)';
            } else if (result.error) {
                resultPre.textContent = 'Error: ' + result.error;
                resultPre.style.color = 'var(--error-text)';
            } else {
                resultPre.textContent = 'No result.';
                resultPre.style.color = 'var(--error-text)';
            }
        } catch (error) {
            resultContainer.style.display = 'block';
            resultPre.textContent = 'Error: ' + error.message;
            resultPre.style.color = 'var(--error-text)';
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Test LLM';
        }
    });

    // Template editing functionality will be added in a future update
    document.querySelectorAll('.btn-secondary').forEach(btn => {
        btn.addEventListener('click', () => {
            alert('Template editing will be available in a future update');
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        function renderModelList(models, loaded, selectedModel) {
            const listDiv = document.getElementById('llm-model-list');
            listDiv.innerHTML = '';
            if (!models.length) {
                listDiv.innerHTML = '<div style="color:#fbbf24;">No models found</div>';
                return;
            }
            models.forEach(m => {
                const isLoaded = loaded.includes(m);
                const wrapper = document.createElement('label');
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.marginBottom = '0.5em';
                wrapper.style.padding = '0.5em 1em';
                wrapper.style.borderRadius = '0.5em';
                wrapper.style.cursor = 'pointer';
                wrapper.style.background = isLoaded ? '#166534' : '#fbbf24';
                wrapper.style.color = isLoaded ? '#fff' : '#23272F';
                wrapper.style.fontWeight = isLoaded ? 'bold' : 'normal';
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'llm_model';
                radio.value = m;
                radio.style.marginRight = '0.75em';
                if (selectedModel === m) radio.checked = true;
                wrapper.appendChild(radio);
                wrapper.appendChild(document.createTextNode(m + (isLoaded ? ' (loaded)' : '')));
                // Preload button
                const preloadBtn = document.createElement('button');
                preloadBtn.type = 'button';
                preloadBtn.textContent = isLoaded ? 'Loaded' : 'Preload';
                preloadBtn.disabled = isLoaded;
                preloadBtn.style.marginLeft = 'auto';
                preloadBtn.style.background = isLoaded ? '#22c55e' : '#6366F1';
                preloadBtn.style.color = '#fff';
                preloadBtn.style.border = 'none';
                preloadBtn.style.borderRadius = '0.375em';
                preloadBtn.style.padding = '0.25em 0.75em';
                preloadBtn.style.fontWeight = 'bold';
                preloadBtn.style.cursor = isLoaded ? 'default' : 'pointer';
                preloadBtn.addEventListener('click', function () {
                    preloadBtn.textContent = 'Loading...';
                    preloadBtn.disabled = true;
                    fetch('/api/v1/llm/preload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: m })
                    })
                        .then(r => r.json())
                        .then(() => {
                            setTimeout(() => loadOllamaModels(selectedModel), 1000);
                        });
                });
                wrapper.appendChild(preloadBtn);
                listDiv.appendChild(wrapper);
            });
        }
        function loadOllamaModels(selectedModel) {
            const note = document.getElementById('llm-model-note');
            fetch('/api/v1/llm/models/ollama')
                .then(r => r.json())
                .then(data => {
                    renderModelList(data.models || [], data.loaded || [], selectedModel);
                    note.textContent = 'Green = loaded in memory. Amber = downloaded and ready to use.';
                })
                .catch(() => {
                    renderModelList([], [], null);
                    note.textContent = '';
                });
        }
        function loadProviderModels() {
            const provider = document.getElementById('llm-provider-select').value;
            if (provider === 'ollama') {
                loadOllamaModels();
            } else {
                // Placeholder for OpenAI or other providers
                const listDiv = document.getElementById('llm-model-list');
                listDiv.innerHTML = '';
                ['gpt-3.5-turbo', 'gpt-4'].forEach(m => {
                    const wrapper = document.createElement('label');
                    wrapper.style.display = 'block';
                    wrapper.style.marginBottom = '0.5em';
                    wrapper.style.padding = '0.5em 1em';
                    wrapper.style.borderRadius = '0.5em';
                    wrapper.style.cursor = 'pointer';
                    wrapper.style.background = '#fbbf24';
                    wrapper.style.color = '#23272F';
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'llm_model';
                    radio.value = m;
                    radio.style.marginRight = '0.75em';
                    wrapper.appendChild(radio);
                    wrapper.appendChild(document.createTextNode(m));
                    listDiv.appendChild(wrapper);
                });
                document.getElementById('llm-model-note').textContent = 'OpenAI models are selected from the API.';
            }
        }
        document.getElementById('llm-provider-select').addEventListener('change', loadProviderModels);
        loadProviderModels();
        // When a model is selected, update the test field below
        document.getElementById('llm-model-list').addEventListener('change', function (e) {
            if (e.target && e.target.name === 'llm_model') {
                document.getElementById('current-model').textContent = e.target.value;
            }
        });
    });
</script>
{% endblock %}
{% endblock %}