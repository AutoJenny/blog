{% extends "base.html" %}

{% block title %}Test Prompts{% endblock %}

{% block styles %}
<style>
    .container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .card {
        background: var(--admin-bg-card, #23272F);
        border: 1px solid var(--admin-border, #404040);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--admin-text, #E0E0E0);
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        background: var(--admin-bg-input, #2D333B);
        border: 1px solid var(--admin-border, #404040);
        border-radius: 0.5rem;
        color: var(--admin-text, #E0E0E0);
        font-size: 1rem;
        line-height: 1.5;
    }

    .form-input:focus {
        border-color: var(--admin-primary, #1B4B73);
        outline: none;
    }

    .btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
        text-align: center;
        border-radius: 0.5rem;
        cursor: pointer;
        background: var(--admin-primary, #1B4B73);
        color: white;
        border: none;
    }

    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .error {
        color: #DC2626;
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }

    #output {
        white-space: pre-wrap;
        font-family: monospace;
        min-height: 200px;
    }

    .prompt-preview {
        font-family: monospace;
        margin-top: 0.5rem;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 0.25rem;
        font-size: 0.875rem;
        white-space: pre-wrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-2xl font-bold mb-6">Test Prompts</h1>

    <div class="card">
        <form id="testForm" class="space-y-6">
            <div class="form-group">
                <label class="form-label" for="prompt_id">1. Select a Prompt Template</label>
                <select id="prompt_id" name="prompt_id" class="form-input" required>
                    <option value="">Choose a prompt template...</option>
                    {% for prompt in prompts %}
                    <option value="{{ prompt.id }}" data-prompt="{{ prompt.prompt_text }}">
                        {{ prompt.name }}
                    </option>
                    {% endfor %}
                </select>
                <div id="promptPreview" class="prompt-preview mt-2">Select a prompt to see its template...</div>
            </div>

            <div class="form-group">
                <label class="form-label" for="input">2. Enter Your Input</label>
                <textarea id="input" name="input" rows="3" class="form-input" required
                    placeholder="This text will replace {{input}} in the template..."></textarea>
            </div>

            <button type="submit" id="submitBtn" class="btn">
                Test Prompt
            </button>
        </form>
    </div>

    <div class="card">
        <h2 class="text-xl font-semibold mb-4">Result</h2>
        <pre id="output" class="form-input">Response will appear here...</pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('testForm');
        const submitBtn = document.getElementById('submitBtn');
        const output = document.getElementById('output');
        const promptSelect = document.getElementById('prompt_id');
        const promptPreview = document.getElementById('promptPreview');

        // Show the selected prompt template
        promptSelect.addEventListener('change', function () {
            const selectedOption = promptSelect.options[promptSelect.selectedIndex];
            const promptText = selectedOption.dataset.prompt || '';
            promptPreview.textContent = promptText;
        });

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const promptId = promptSelect.value;
            const input = document.getElementById('input').value.trim();

            if (!promptId || !input) {
                output.textContent = 'Error: Please select a prompt and provide input text.';
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Testing...';
            output.textContent = 'Generating response...';

            try {
                const response = await fetch('/llm/api/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt_id: promptId,
                        input: input,
                        model: '{{ config.model_name }}'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    output.textContent = data.response;
                } else {
                    output.textContent = `Error: ${data.error || 'Failed to generate response'}`;
                }
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Test Prompt';
            }
        });
    });
</script>
{% endblock %}