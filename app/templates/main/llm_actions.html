{% extends 'base.html' %}
{% block content %}
<style>
    .action-status {
        display: inline-block;
        padding: 0.25em 0.75em;
        border-radius: 9999px;
        font-size: 0.95em;
        font-weight: 600;
        background: #6366f1;
        color: #fff;
    }

    .action-btn {
        @apply text-indigo-400 hover:text-indigo-200 px-2;
    }

    .action-btn[disabled] {
        opacity: 0.5;
        pointer-events: none;
    }

    .modal-bg {
        background: rgba(24, 28, 42, 0.85);
    }
</style>
<div class="container mx-auto py-10 px-4">
    <div class="flex justify-between items-center mb-8">
        <div class="text-2xl font-bold text-indigo-300 flex items-center gap-3">
            <i class="fa-solid fa-bolt"></i> LLM Actions & Tasks
        </div>
        <button id="addActionBtn"
            class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded shadow flex items-center gap-2">
            <i class="fa-solid fa-plus"></i> New Action
        </button>
    </div>
    <div class="bg-dark-card rounded-xl p-6 shadow mb-8 overflow-x-auto">
        <table class="min-w-full text-left">
            <thead>
                <tr class="text-indigo-200 border-b border-dark-border">
                    <th class="py-2 px-3">Name</th>
                    <th class="py-2 px-3">Prompt</th>
                    <th class="py-2 px-3">Model</th>
                    <th class="py-2 px-3">Status</th>
                    <th class="py-2 px-3">Last Run</th>
                    <th class="py-2 px-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for action in actions %}
                <tr class="border-b border-dark-border hover:bg-indigo-950/30">
                    <td class="py-2 px-3 font-semibold text-white">{{ action.field_name }}</td>
                    <td class="py-2 px-3">{{ action.prompt_name }}</td>
                    <td class="py-2 px-3">{{ action.llm_model }}</td>
                    <td class="py-2 px-3"><span class="action-status">{{ action.status }}</span></td>
                    <td class="py-2 px-3">{{ action.last_run or '' }}</td>
                    <td class="py-2 px-3 flex gap-2">
                        <button class="action-btn" title="Edit"><i class="fa-solid fa-pen"></i></button>
                        <button class="action-btn" title="Run/Test"><i class="fa-solid fa-play"></i></button>
                        <button class="action-btn" title="History"><i
                                class="fa-solid fa-clock-rotate-left"></i></button>
                        <button class="action-btn delete-action-btn" data-id="{{ action.id }}" title="Delete"><i
                                class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Wizard Modal for Action Creation/Editing -->
    <div id="actionWizardModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <button id="closeActionWizard" class="absolute top-3 right-3 text-indigo-400 hover:text-indigo-200"
                style="right:1.5rem;top:1.5rem;"><i class="fa-solid fa-xmark fa-lg"></i></button>
            <div id="wizardProgress" class="mb-4 flex items-center justify-between text-indigo-200 text-sm">
                <span id="wizardStep1" class="wizard-step">1. Basic Info</span>
                <span id="wizardStep2" class="wizard-step">2. Model</span>
                <span id="wizardStep3" class="wizard-step">3. Prompt Template</span>
                <span id="wizardStep4" class="wizard-step">4. Test & Save</span>
            </div>
            <form id="actionWizardForm">
                <!-- Step 1: Basic Info -->
                <div class="wizard-section" id="wizardSection1">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-info-circle"></i>
                        Step 1: Basic Info</h2>
                    <div class="mb-4 text-indigo-200">Give your action a name and (optionally) a description. This helps
                        you find it later.</div>
                    <div class="form-group">
                        <label class="form-label" for="wizFieldName">Field Name <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="The field this action will fill, e.g. 'summary'."></i></label>
                        <input type="text" id="wizFieldName" name="field_name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizDescription">Description <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="Describe what this action does."></i></label>
                        <input type="text" id="wizDescription" name="description" class="form-input">
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" class="btn btn-primary" id="wizNext1">Next →</button>
                    </div>
                </div>
                <!-- Step 2: Model Settings -->
                <div class="wizard-section" id="wizardSection2" style="display:none;">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-robot"></i> Step 2:
                        Model Settings</h2>
                    <div class="mb-4 text-indigo-200">Choose the AI model and prompt template. Adjust creativity and
                        output length as needed.</div>
                    <div class="form-group">
                        <label class="form-label" for="wizProvider">LLM Provider</label>
                        <select id="wizProvider" name="provider_id" class="form-input" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizModel">LLM Model</label>
                        <select id="wizModel" name="llm_model" class="form-input" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizTemperature">Temperature <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="Higher = more creative, lower = more predictable."></i></label>
                        <input type="number" id="wizTemperature" name="temperature" class="form-input" min="0" max="2"
                            step="0.1" value="0.7">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizMaxTokens">Max Tokens <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="Maximum length of the AI's response."></i></label>
                        <input type="number" id="wizMaxTokens" name="max_tokens" class="form-input" min="1" max="4096"
                            value="1000">
                    </div>
                    <div class="flex justify-between gap-4 mt-6">
                        <button type="button" class="btn btn-secondary" id="wizBack2">← Back</button>
                        <button type="button" class="btn btn-primary" id="wizNext2">Next →</button>
                    </div>
                </div>
                <!-- Step 3: Prompt Template -->
                <div class="wizard-section" id="wizardSection3" style="display:none;">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-layer-group"></i>
                        Step 3: Prompt Template</h2>
                    <div class="mb-4 text-indigo-200">Select the prompt template this action will use. You can manage
                        templates on the Prompts page.</div>
                    <div class="form-group mb-4">
                        <label class="form-label" for="wizPromptTemplate">Prompt Template</label>
                        <select id="wizPromptTemplate" name="prompt_template_id" class="form-input" required></select>
                    </div>
                    <div class="bg-dark-card rounded p-4 mt-4 mb-2">
                        <h4 class="font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-eye"></i> Prompt
                            Preview</h4>
                        <div id="wizPromptPreview" class="whitespace-pre-line text-indigo-100 text-sm">{ ... select a
                            template ... }</div>
                        <div class="text-xs text-indigo-200 mt-1">This is how your full prompt will look to the AI, with
                            variables replaced at runtime.</div>
                    </div>
                    <div class="flex justify-between gap-4 mt-6">
                        <button type="button" class="btn btn-secondary" id="wizBack3">← Back</button>
                        <button type="button" class="btn btn-primary" id="wizNext3">Next →</button>
                    </div>
                </div>
                <!-- Step 4: Test & Save -->
                <div class="wizard-section" id="wizardSection4" style="display:none;">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-vial"></i> Step 4:
                        Test & Save</h2>
                    <div class="mb-4 text-indigo-200">Try out your action! Enter some sample input and see what the AI
                        generates. If you're happy, save your action.</div>
                    <div class="form-group">
                        <label class="form-label">Test Input</label>
                        <textarea id="wizTestInput" class="form-textarea" rows="2"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary mb-2" id="wizRunTestBtn">Run Test</button>
                    <div id="wizTestOutput" class="bg-dark-card rounded p-4 mt-2 text-indigo-100 text-sm"
                        style="white-space: pre-wrap; min-height: 2em;"></div>
                    <div class="flex justify-between gap-4 mt-6">
                        <button type="button" class="btn btn-secondary" id="wizBack4">← Back</button>
                        <button type="submit" class="btn btn-primary">Save Action</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- Action Run Modal (placeholder) -->
    <div id="runActionModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-bg">
        <div class="bg-dark-card rounded-xl shadow-lg p-8 w-full max-w-md relative">
            <button id="closeRunAction" class="absolute top-3 right-3 text-indigo-400 hover:text-indigo-200"><i
                    class="fa-solid fa-xmark fa-lg"></i></button>
            <div class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2"><i class="fa-solid fa-play"></i>
                Run/Test Action</div>
            <div class="mb-4 text-dark-accent">(Action run/test result will appear here)</div>
            <div class="flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded shadow">Close</button>
            </div>
        </div>
    </div>
    <!-- Action History Modal (placeholder) -->
    <div id="actionHistoryModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-bg">
        <div class="bg-dark-card rounded-xl shadow-lg p-8 w-full max-w-md relative">
            <button id="closeActionHistory" class="absolute top-3 right-3 text-indigo-400 hover:text-indigo-200"><i
                    class="fa-solid fa-xmark fa-lg"></i></button>
            <div class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2"><i
                    class="fa-solid fa-clock-rotate-left"></i> Action History</div>
            <div class="mb-4 text-dark-accent">(Action history will appear here)</div>
            <div class="flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded shadow">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    // --- Action Wizard Modal Logic ---
    (function () {
        // Modal open/close
        const actionWizardModal = document.getElementById('actionWizardModal');
        const addActionBtn = document.getElementById('addActionBtn');
        // --- Provider/Model Dropdown Logic ---
        const wizProvider = document.getElementById('wizProvider');
        const wizModel = document.getElementById('wizModel');
        async function loadProviders(selectedProviderId) {
            wizProvider.innerHTML = '<option value="">Loading...</option>';
            try {
                const resp = await fetch('/api/v1/llm/providers');
                const providers = await resp.json();
                wizProvider.innerHTML = providers.map(p => `<option value="${p.id}" ${selectedProviderId == p.id ? 'selected' : ''}>${p.name}</option>`).join('');
            } catch (e) {
                wizProvider.innerHTML = '<option value="">Failed to load providers</option>';
            }
        }
        async function loadModels(providerId, selectedModelName) {
            wizModel.innerHTML = '<option value="">Loading...</option>';
            try {
                const resp = await fetch('/api/v1/llm/models');
                const models = await resp.json();
                const filtered = models.filter(m => String(m.provider_id) === String(providerId));
                wizModel.innerHTML = filtered.map(m => `<option value="${m.name}" ${selectedModelName == m.name ? 'selected' : ''}>${m.name} (${m.description || ''})</option>`).join('');
            } catch (e) {
                wizModel.innerHTML = '<option value="">Failed to load models</option>';
            }
        }
        // On modal open, load providers and models
        addActionBtn.onclick = function () {
            actionWizardModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            showWizardStep(1);
            loadProviders().then(() => {
                // If only one provider, auto-select and load models
                if (wizProvider.options.length === 1 || (wizProvider.options.length === 2 && wizProvider.options[0].value === '')) {
                    wizProvider.selectedIndex = wizProvider.options[0].value === '' ? 1 : 0;
                }
                loadModels(wizProvider.value);
            });
        };
        // When provider changes, load models
        wizProvider.addEventListener('change', function () {
            loadModels(this.value);
        });
        // Step navigation
        const wizardSections = [
            null,
            document.getElementById('wizardSection1'),
            document.getElementById('wizardSection2'),
            document.getElementById('wizardSection3'),
            document.getElementById('wizardSection4')
        ];
        function showWizardStep(idx) {
            for (let i = 1; i <= 4; i++) {
                wizardSections[i].style.display = (i === idx) ? '' : 'none';
                document.getElementById('wizardStep' + i).classList.toggle('font-bold', i === idx);
            }
        }
        window.showWizardStep = showWizardStep;
        document.getElementById('wizNext1').onclick = function () { showWizardStep(2); };
        document.getElementById('wizBack2').onclick = function () { showWizardStep(1); };
        document.getElementById('wizNext2').onclick = function () { showWizardStep(3); };
        document.getElementById('wizBack3').onclick = function () { showWizardStep(2); };
        document.getElementById('wizNext3').onclick = function () { showWizardStep(4); };
        document.getElementById('wizBack4').onclick = function () { showWizardStep(3); };
        // Wizard Step 3: Populate Prompt Template dropdown and preview
        const wizPromptTemplate = document.getElementById('wizPromptTemplate');
        const wizPromptPreview = document.getElementById('wizPromptPreview');
        async function loadPromptTemplates(selectedId) {
            wizPromptTemplate.innerHTML = '<option value="">Loading...</option>';
            try {
                const resp = await fetch('/api/v1/llm/prompts');
                const templates = await resp.json();
                wizPromptTemplate.innerHTML = templates.map(t => `<option value="${t.id}" ${selectedId == t.id ? 'selected' : ''}>${t.name}</option>`).join('');
                if (selectedId) {
                    const selected = templates.find(t => t.id == selectedId);
                    wizPromptPreview.textContent = selected ? selected.prompt_text : '{ ... select a template ... }';
                } else {
                    wizPromptPreview.textContent = '{ ... select a template ... }';
                }
            } catch (e) {
                wizPromptTemplate.innerHTML = '<option value="">Error loading templates</option>';
                wizPromptPreview.textContent = '{ ... error ... }';
            }
        }
        wizPromptTemplate && wizPromptTemplate.addEventListener('change', function () {
            const selected = this.options[this.selectedIndex];
            if (selected && selected.value) {
                fetch(`/api/v1/llm/prompts/${selected.value}`)
                    .then(r => r.json())
                    .then(data => {
                        wizPromptPreview.textContent = data.prompt_text || '{ ... select a template ... }';
                    });
            } else {
                wizPromptPreview.textContent = '{ ... select a template ... }';
            }
        });
        // Call loadPromptTemplates() when entering Step 3
        const wizNext2 = document.getElementById('wizNext2');
        if (wizNext2) {
            wizNext2.addEventListener('click', function () {
                loadPromptTemplates();
            });
        }
        // Wizard Save Action logic
        const actionWizardForm = document.getElementById('actionWizardForm');
        actionWizardForm.onsubmit = async function (e) {
            e.preventDefault();
            // Gather all fields
            const field_name = document.getElementById('wizFieldName').value;
            const description = document.getElementById('wizDescription').value;
            const provider_id = document.getElementById('wizProvider').value;
            const llm_model = document.getElementById('wizModel').value;
            const temperature = parseFloat(document.getElementById('wizTemperature').value) || 0.7;
            const max_tokens = parseInt(document.getElementById('wizMaxTokens').value) || 1000;
            const prompt_template_id = document.getElementById('wizPromptTemplate').value;
            // POST to backend
            const btn = actionWizardForm.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            try {
                const resp = await fetch('/api/v1/llm/actions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        field_name,
                        description,
                        provider_id,
                        llm_model,
                        temperature,
                        max_tokens,
                        prompt_template_id
                    })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    btn.textContent = 'Saved!';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'Save Action';
                        actionWizardModal.classList.remove('active');
                        document.body.style.overflow = '';
                        location.reload();
                    }, 800);
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Save Action';
                    alert(data.error || 'Error saving action');
                }
            } catch (e) {
                btn.disabled = false;
                btn.textContent = 'Save Action';
                alert('Error: ' + e);
            }
        };
    })();
    // Modal open/close logic (placeholder)
    document.getElementById('closeRunAction').onclick = function () {
        document.getElementById('runActionModal').classList.add('hidden');
    };
    document.getElementById('closeActionHistory').onclick = function () {
        document.getElementById('actionHistoryModal').classList.add('hidden');
    };
    // Delete action logic
    document.querySelectorAll('.delete-action-btn').forEach(btn => {
        btn.onclick = function () {
            const actionId = this.dataset.id;
            if (!confirm('Delete this action?')) return;
            fetch(`/api/v1/llm/actions/${actionId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Failed to delete action: ' + (data.error || 'Unknown error'));
                    }
                });
        };
    });
    const closeActionWizard = document.getElementById('closeActionWizard');
    closeActionWizard.onclick = function () {
        actionWizardModal.classList.remove('active');
        document.body.style.overflow = '';
    };
</script>
{% endblock %}