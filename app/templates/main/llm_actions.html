{% extends 'base.html' %}
{% block content %}
<style>
    .action-status {
        display: inline-block;
        padding: 0.25em 0.75em;
        border-radius: 9999px;
        font-size: 0.95em;
        font-weight: 600;
        background: #6366f1;
        color: #fff;
    }

    .action-btn {
        @apply text-indigo-400 hover:text-indigo-200 px-2;
    }

    .action-btn[disabled] {
        opacity: 0.5;
        pointer-events: none;
    }

    .modal-bg {
        background: rgba(24, 28, 42, 0.85);
    }
</style>
<div class="container mx-auto py-10 px-4">
    <div class="flex justify-between items-center mb-8">
        <div class="text-2xl font-bold text-indigo-300 flex items-center gap-3">
            <i class="fa-solid fa-bolt"></i> LLM Actions & Tasks
        </div>
        <button id="addActionBtn"
            class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded shadow flex items-center gap-2">
            <i class="fa-solid fa-plus"></i> New Action
        </button>
    </div>
    <div class="bg-dark-card rounded-xl p-6 shadow mb-8 overflow-x-auto">
        <table class="min-w-full text-left">
            <thead>
                <tr class="text-indigo-200 border-b border-dark-border">
                    <th class="py-2 px-3">Name</th>
                    <th class="py-2 px-3">Input → Output</th>
                    <th class="py-2 px-3">Prompt</th>
                    <th class="py-2 px-3">Model</th>
                    <th class="py-2 px-3">Status</th>
                    <th class="py-2 px-3">Last Run</th>
                    <th class="py-2 px-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for action in actions %}
                <tr class="border-b border-dark-border hover:bg-indigo-950/30">
                    <td class="py-2 px-3 font-semibold text-white">{{ action.field_name }}</td>
                    <td class="py-2 px-3">{{ action.input_field }} → {{ action.output_field }}</td>
                    <td class="py-2 px-3">{{ action.prompt_name }}</td>
                    <td class="py-2 px-3">{{ action.llm_model }}</td>
                    <td class="py-2 px-3"><span class="action-status">{{ action.status }}</span></td>
                    <td class="py-2 px-3">{{ action.last_run or '' }}</td>
                    <td class="py-2 px-3 flex gap-2">
                        <button class="action-btn" title="Edit"><i class="fa-solid fa-pen"></i></button>
                        <button class="action-btn" title="Run/Test"><i class="fa-solid fa-play"></i></button>
                        <button class="action-btn" title="History"><i
                                class="fa-solid fa-clock-rotate-left"></i></button>
                        <button class="action-btn delete-action-btn" data-id="{{ action.id }}" title="Delete"><i
                                class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Wizard Modal for Action Creation/Editing -->
    <div id="actionWizardModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <div id="wizardProgress" class="mb-4 flex items-center justify-between text-indigo-200 text-sm">
                <span id="wizardStep1" class="wizard-step">1. Basic Info</span>
                <span id="wizardStep2" class="wizard-step">2. Model</span>
                <span id="wizardStep3" class="wizard-step">3. Prompt Parts</span>
                <span id="wizardStep4" class="wizard-step">4. Test & Save</span>
            </div>
            <form id="actionWizardForm">
                <!-- Step 1: Basic Info -->
                <div class="wizard-section" id="wizardSection1">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-info-circle"></i>
                        Step 1: Basic Info</h2>
                    <div class="mb-4 text-indigo-200">Give your action a name and (optionally) a description. This helps
                        you find it later.</div>
                    <div class="form-group">
                        <label class="form-label" for="wizFieldName">Field Name <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="The field this action will fill, e.g. 'summary'."></i></label>
                        <input type="text" id="wizFieldName" name="field_name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizDescription">Description <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="Describe what this action does."></i></label>
                        <input type="text" id="wizDescription" name="description" class="form-input">
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" class="btn btn-primary" id="wizNext1">Next →</button>
                    </div>
                </div>
                <!-- Step 2: Model Settings -->
                <div class="wizard-section" id="wizardSection2" style="display:none;">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-robot"></i> Step 2:
                        Model Settings</h2>
                    <div class="mb-4 text-indigo-200">Choose the AI model and prompt template. Adjust creativity and
                        output length as needed.</div>
                    <div class="form-group">
                        <label class="form-label" for="wizProvider">LLM Provider</label>
                        <select id="wizProvider" name="provider_id" class="form-input" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizModel">LLM Model</label>
                        <select id="wizModel" name="llm_model" class="form-input" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizPromptTemplateId">Prompt Template</label>
                        <select id="wizPromptTemplateId" name="prompt_template_id" class="form-input" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizTemperature">Temperature <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="Higher = more creative, lower = more predictable."></i></label>
                        <input type="number" id="wizTemperature" name="temperature" class="form-input" min="0" max="2"
                            step="0.1" value="0.7">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="wizMaxTokens">Max Tokens <i
                                class="fa-solid fa-circle-question text-indigo-300"
                                title="Maximum length of the AI's response."></i></label>
                        <input type="number" id="wizMaxTokens" name="max_tokens" class="form-input" min="1" max="4096"
                            value="1000">
                    </div>
                    <div class="flex justify-between gap-4 mt-6">
                        <button type="button" class="btn btn-secondary" id="wizBack2">← Back</button>
                        <button type="button" class="btn btn-primary" id="wizNext2">Next →</button>
                    </div>
                </div>
                <!-- Step 3: Prompt Parts -->
                <div class="wizard-section" id="wizardSection3" style="display:none;">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-layer-group"></i>
                        Step 3: Prompt Parts</h2>
                    <div class="mb-4 text-indigo-200">Build your prompt from multiple parts. Each part is a message to
                        the AI. Add them in the order you want. Use variables like <code>{{input}}</code> or
                        <code>{{idea_seed}}</code>.
                    </div>
                    <div id="wizPromptPartsList" class="mb-4"></div>
                    <button type="button" class="btn btn-secondary mb-2" id="wizAddPromptPartBtn">+ Add Prompt
                        Part</button>
                    <div id="wizPromptPartForm" style="display:none;" class="bg-dark-card rounded p-4 mb-4">
                        <h4 class="font-bold mb-2">Add/Edit Prompt Part</h4>
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select id="wizPromptPartType" class="form-input">
                                <option value="system">System</option>
                                <option value="user">User</option>
                                <option value="assistant">Assistant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Content</label>
                            <textarea id="wizPromptPartContent" class="form-textarea" rows="3"></textarea>
                        </div>
                        <div class="flex justify-end gap-4">
                            <button type="button" class="btn btn-secondary" id="wizCancelPromptPartBtn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="wizSavePromptPartBtn">Save Part</button>
                        </div>
                    </div>
                    <div class="bg-dark-card rounded p-4 mt-4 mb-2">
                        <h4 class="font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-eye"></i> Prompt
                            Preview</h4>
                        <div id="wizPromptPreview" class="whitespace-pre-line text-indigo-100 text-sm">{ ... message
                            preview ... }</div>
                        <div class="text-xs text-indigo-200 mt-1">This is how your full prompt will look to the AI, with
                            variables replaced at runtime.</div>
                    </div>
                    <div class="flex justify-between gap-4 mt-6">
                        <button type="button" class="btn btn-secondary" id="wizBack3">← Back</button>
                        <button type="button" class="btn btn-primary" id="wizNext3">Next →</button>
                    </div>
                </div>
                <!-- Step 4: Test & Save -->
                <div class="wizard-section" id="wizardSection4" style="display:none;">
                    <h2 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-vial"></i> Step 4:
                        Test & Save</h2>
                    <div class="mb-4 text-indigo-200">Try out your action! Enter some sample input and see what the AI
                        generates. If you're happy, save your action.</div>
                    <div class="form-group">
                        <label class="form-label">Test Input</label>
                        <textarea id="wizTestInput" class="form-textarea" rows="2"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary mb-2" id="wizRunTestBtn">Run Test</button>
                    <div id="wizTestOutput" class="bg-dark-card rounded p-4 mt-2 text-indigo-100 text-sm"
                        style="white-space: pre-wrap; min-height: 2em;"></div>
                    <div class="flex justify-between gap-4 mt-6">
                        <button type="button" class="btn btn-secondary" id="wizBack4">← Back</button>
                        <button type="submit" class="btn btn-primary">Save Action</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- Action Run Modal (placeholder) -->
    <div id="runActionModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-bg">
        <div class="bg-dark-card rounded-xl shadow-lg p-8 w-full max-w-md relative">
            <button id="closeRunAction" class="absolute top-3 right-3 text-indigo-400 hover:text-indigo-200"><i
                    class="fa-solid fa-xmark fa-lg"></i></button>
            <div class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2"><i class="fa-solid fa-play"></i>
                Run/Test Action</div>
            <div class="mb-4 text-dark-accent">(Action run/test result will appear here)</div>
            <div class="flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded shadow">Close</button>
            </div>
        </div>
    </div>
    <!-- Action History Modal (placeholder) -->
    <div id="actionHistoryModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-bg">
        <div class="bg-dark-card rounded-xl shadow-lg p-8 w-full max-w-md relative">
            <button id="closeActionHistory" class="absolute top-3 right-3 text-indigo-400 hover:text-indigo-200"><i
                    class="fa-solid fa-xmark fa-lg"></i></button>
            <div class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2"><i
                    class="fa-solid fa-clock-rotate-left"></i> Action History</div>
            <div class="mb-4 text-dark-accent">(Action history will appear here)</div>
            <div class="flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded shadow">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    // Modal open/close logic (placeholder)
    document.getElementById('addActionBtn').onclick = function () {
        document.getElementById('actionWizardModal').classList.remove('hidden');
    };
    document.getElementById('closeRunAction').onclick = function () {
        document.getElementById('runActionModal').classList.add('hidden');
    };
    document.getElementById('closeActionHistory').onclick = function () {
        document.getElementById('actionHistoryModal').classList.add('hidden');
    };
    // Add more modal logic as needed
    // Delete action logic
    document.querySelectorAll('.delete-action-btn').forEach(btn => {
        btn.onclick = function () {
            const actionId = this.dataset.id;
            if (!confirm('Delete this action?')) return;
            fetch(`/api/v1/llm/actions/${actionId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Failed to delete action: ' + (data.error || 'Unknown error'));
                    }
                });
        };
    });
</script>
{% endblock %}