{% extends 'base.html' %}

{% block title %}Format Templates{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-title">Format Templates</h1>
        <button type="button" class="btn btn-primary" id="newFormatBtn">
            <i class="fas fa-plus"></i> New Format
        </button>
    </div>

    <div class="admin-content">
        <!-- Format Templates List -->
        <div class="admin-card mb-6">
            <div class="admin-card-header">
                <h2 class="admin-card-title">Available Templates</h2>
            </div>
            <div class="admin-card-body">
                <div id="formatTemplatesList" class="grid gap-4">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Format Template Modal -->
<div id="formatModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">New Format Template</h2>
            <button type="button" class="modal-close" id="modalCloseBtn">&times;</button>
        </div>
        <form id="formatForm">
            <input type="hidden" id="formatId" name="id">

            <div class="form-group">
                <label class="form-label" for="formatName">Template Name</label>
                <input type="text" id="formatName" name="name" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="formatType">Format Type</label>
                <select id="formatType" name="format_type" class="form-select" required>
                    <option value="">Select Format Type...</option>
                    <option value="input">Input Format</option>
                    <option value="output">Output Format</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="formatSpec">Format Specification (JSON Schema)</label>
                <div class="format-editor">
                    <textarea id="formatSpec" name="format_spec" class="form-textarea" required
                        placeholder="Enter JSON Schema specification..."></textarea>
                </div>
                <p class="admin-help-text">
                    Define the format using JSON Schema. Include property types, descriptions, and validation rules.
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">Format Preview</label>
                <div id="formatPreview" class="format-preview">
                    <div class="preview-content">
                        <pre><code id="previewCode">Select a format to preview...</code></pre>
                    </div>
                    <div class="preview-validation">
                        <div id="validationStatus" class="validation-status">
                            <!-- Validation status will be shown here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-4">
                <button type="button" class="btn btn-secondary" id="testFormatBtn">Test Format</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Format</button>
            </div>
        </form>
    </div>
</div>

<!-- Test Format Modal -->
<div id="testModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Test Format</h2>
            <button type="button" class="modal-close" id="testModalCloseBtn">&times;</button>
        </div>
        <form id="testForm">
            <div class="form-group">
                <label class="form-label" for="testInput">Test Data (JSON)</label>
                <textarea id="testInput" class="form-textarea" required
                    placeholder="Enter test data in JSON format..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Validation Result</label>
                <div id="testResult" class="test-result">
                    <!-- Test results will be shown here -->
                </div>
            </div>

            <div class="flex justify-end gap-4">
                <button type="button" class="btn btn-secondary" id="closeTestBtn">Close</button>
                <button type="submit" class="btn btn-primary">Validate</button>
            </div>
        </form>
    </div>
</div>

<style>
    .format-editor {
        position: relative;
    }

    .form-textarea {
        min-height: 200px;
        font-family: 'Monaco', 'Menlo', monospace;
        line-height: 1.6;
        resize: vertical;
    }

    .format-preview {
        background: var(--admin-bg-card);
        border: 1px solid var(--admin-border);
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .preview-content {
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .preview-content pre {
        margin: 0;
        white-space: pre-wrap;
    }

    .preview-validation {
        border-top: 1px solid var(--admin-border);
        padding: 0.5rem 1rem;
        background: var(--admin-bg-row-odd);
    }

    .validation-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-height: 1.5rem;
    }

    .validation-status.valid {
        color: var(--admin-success);
    }

    .validation-status.invalid {
        color: var(--admin-error);
    }

    .test-result {
        background: var(--admin-bg-card);
        border: 1px solid var(--admin-border);
        border-radius: 0.5rem;
        padding: 1rem;
        min-height: 100px;
        max-height: 200px;
        overflow-y: auto;
    }

    .test-result.valid {
        border-color: var(--admin-success);
    }

    .test-result.invalid {
        border-color: var(--admin-error);
    }

    #formatTemplatesList .format-card {
        background: var(--admin-bg-card);
        border: 1px solid var(--admin-border);
        border-radius: 0.5rem;
        padding: 1rem;
    }

    #formatTemplatesList .format-card:hover {
        border-color: var(--admin-accent);
    }

    .format-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .format-card-title {
        font-weight: 600;
        color: var(--admin-text);
    }

    .format-card-type {
        font-size: 0.875rem;
        color: var(--admin-text-secondary);
        padding: 0.25rem 0.5rem;
        background: var(--admin-bg-row-odd);
        border-radius: 0.25rem;
    }

    .format-card-actions {
        display: flex;
        gap: 0.5rem;
    }
</style>

<script>
    // Format template management
    let currentFormatId = null;

    // Load format templates
    async function loadFormatTemplates() {
        const list = document.getElementById('formatTemplatesList');
        try {
            const response = await fetch('/api/formats/templates');
            const templates = await response.json();

            list.innerHTML = templates.map(template => `
                <div class="format-card" data-id="${template.id}">
                    <div class="format-card-header">
                        <h3 class="format-card-title">${template.name}</h3>
                        <span class="format-card-type">${template.format_type}</span>
                    </div>
                    <div class="format-card-actions">
                        <button class="btn btn-secondary btn-sm edit-format" data-id="${template.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-format" data-id="${template.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Add event listeners
            list.querySelectorAll('.edit-format').forEach(btn => {
                btn.addEventListener('click', () => editFormat(btn.dataset.id));
            });
            list.querySelectorAll('.delete-format').forEach(btn => {
                btn.addEventListener('click', () => deleteFormat(btn.dataset.id));
            });
        } catch (error) {
            list.innerHTML = '<div class="error">Failed to load format templates</div>';
        }
    }

    // Show format modal
    function showFormatModal(isNew = true) {
        const modal = document.getElementById('formatModal');
        const form = document.getElementById('formatForm');
        const title = document.getElementById('modalTitle');

        title.textContent = isNew ? 'New Format Template' : 'Edit Format Template';
        if (isNew) {
            form.reset();
            document.getElementById('formatId').value = '';
            currentFormatId = null;
        }

        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // Edit format
    async function editFormat(id) {
        try {
            const response = await fetch(`/api/formats/templates/${id}`);
            const format = await response.json();

            document.getElementById('formatId').value = format.id;
            document.getElementById('formatName').value = format.name;
            document.getElementById('formatType').value = format.format_type;
            document.getElementById('formatSpec').value = JSON.stringify(JSON.parse(format.format_spec), null, 2);

            currentFormatId = id;
            showFormatModal(false);
            updatePreview();
        } catch (error) {
            alert('Failed to load format template');
        }
    }

    // Delete format
    async function deleteFormat(id) {
        if (!confirm('Are you sure you want to delete this format template?')) return;

        try {
            await fetch(`/api/formats/templates/${id}`, { method: 'DELETE' });
            loadFormatTemplates();
        } catch (error) {
            alert('Failed to delete format template');
        }
    }

    // Update preview
    function updatePreview() {
        const spec = document.getElementById('formatSpec').value;
        const preview = document.getElementById('previewCode');
        const status = document.getElementById('validationStatus');

        try {
            const formatted = JSON.stringify(JSON.parse(spec), null, 2);
            preview.textContent = formatted;
            status.innerHTML = '<i class="fas fa-check"></i> Valid JSON Schema';
            status.className = 'validation-status valid';
        } catch (error) {
            preview.textContent = spec;
            status.innerHTML = `<i class="fas fa-times"></i> ${error.message}`;
            status.className = 'validation-status invalid';
        }
    }

    // Test format
    async function testFormat() {
        const testModal = document.getElementById('testModal');
        const spec = document.getElementById('formatSpec').value;

        try {
            JSON.parse(spec); // Validate JSON first
            testModal.classList.add('active');
        } catch (error) {
            alert('Please fix the JSON Schema errors before testing');
        }
    }

    // Validate test data
    async function validateTestData(event) {
        event.preventDefault();
        const testInput = document.getElementById('testInput').value;
        const spec = document.getElementById('formatSpec').value;
        const result = document.getElementById('testResult');

        try {
            const response = await fetch('/api/formats/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    format_spec: spec,
                    test_data: JSON.parse(testInput)
                })
            });
            const validation = await response.json();

            if (validation.valid) {
                result.innerHTML = '<i class="fas fa-check"></i> Data is valid';
                result.className = 'test-result valid';
            } else {
                result.innerHTML = `<i class="fas fa-times"></i> Validation errors:<br>${validation.errors.join('<br>')}`;
                result.className = 'test-result invalid';
            }
        } catch (error) {
            result.innerHTML = `<i class="fas fa-times"></i> Error: ${error.message}`;
            result.className = 'test-result invalid';
        }
    }

    // Event Listeners
    document.getElementById('newFormatBtn').addEventListener('click', () => showFormatModal(true));
    document.getElementById('formatSpec').addEventListener('input', updatePreview);
    document.getElementById('testFormatBtn').addEventListener('click', testFormat);
    document.getElementById('formatForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = {
            name: formData.get('name'),
            format_type: formData.get('format_type'),
            format_spec: formData.get('format_spec')
        };

        try {
            const method = currentFormatId ? 'PATCH' : 'POST';
            const url = currentFormatId
                ? `/api/formats/templates/${currentFormatId}`
                : '/api/formats/templates';

            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            document.getElementById('formatModal').classList.remove('active');
            document.body.style.overflow = '';
            loadFormatTemplates();
        } catch (error) {
            alert('Failed to save format template');
        }
    });

    document.getElementById('testForm').addEventListener('submit', validateTestData);
    document.getElementById('cancelBtn').addEventListener('click', () => {
        document.getElementById('formatModal').classList.remove('active');
        document.body.style.overflow = '';
    });
    document.getElementById('closeTestBtn').addEventListener('click', () => {
        document.getElementById('testModal').classList.remove('active');
    });
    document.getElementById('modalCloseBtn').addEventListener('click', () => {
        document.getElementById('formatModal').classList.remove('active');
        document.body.style.overflow = '';
    });
    document.getElementById('testModalCloseBtn').addEventListener('click', () => {
        document.getElementById('testModal').classList.remove('active');
    });

    // Initial load
    loadFormatTemplates();
</script>
{% endblock %}