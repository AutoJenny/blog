{% extends "base.html" %}

{% block title %}Settings - Field Mapping{% endblock %}

{% block styles %}
<style>
    /* Modal overlay covers the entire viewport */
    #stepModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(20, 22, 34, 0.85);
        /* semi-opaque dark overlay */
        display: none;
        /* hidden by default, toggled by JS */
        align-items: center;
        justify-content: center;
        z-index: 99999 !important;
    }

    #stepModal.active {
        display: flex !important;
    }

    /* Modal content is centered and visually distinct */
    #stepModal .modal-content {
        background: #23273a;
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);
        border: 1px solid #31364a;
        padding: 2rem;
        max-width: 600px;
        width: 100%;
        color: #fff;
        position: relative;
    }

    #stepModal input[type="text"] {
        background-color: #23273a !important;
        border: 1px solid #31364a !important;
        color: #ffffff !important;
        border-radius: 0.25rem !important;
        padding: 0.5rem 0.75rem !important;
    }

    #stepModal input[type="text"]:focus {
        border-color: #6366f1 !important;
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
    }

    #stepModal .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: #fff;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-8 bg-dark-bg border border-dark-border rounded-xl shadow-lg p-8">
    <h1 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <i class="fa-solid fa-gear text-indigo-400"></i> Settings: Workflow Field Mapping
    </h1>
    <p class="text-dark-text mb-6">
        View and edit field mappings for each workflow step. These mappings determine which database fields are used for
        inputs and outputs.
    </p>

    <div class="space-y-8">
        {% for stage in stages %}
        <div class="bg-[#1a1d2d] rounded-lg border border-dark-border overflow-hidden">
            <!-- Stage Header -->
            <div class="bg-[#23273a] p-4 flex items-center gap-3">
                <i class="fa-solid fa-layer-group text-indigo-400 text-lg"></i>
                <h2 class="text-xl font-semibold text-white">{{ stage.name }}</h2>
            </div>

            <!-- Stage Content -->
            <div class="p-6 space-y-6">
                {% for substage in substages if substage.stage_id == stage.id %}
                <div class="bg-[#23273a] rounded-lg border border-dark-border overflow-hidden">
                    <!-- Substage Header -->
                    <div class="bg-[#2a2f47] p-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-folder text-indigo-300"></i>
                            <h3 class="text-lg font-medium text-white">{{ substage.substage_name }}</h3>
                        </div>
                        <button onclick="addStep({{ substage.substage_id }})"
                            class="text-indigo-300 hover:text-indigo-100 px-2 py-1 rounded">
                            <i class="fa-solid fa-plus"></i> Add Step
                        </button>
                    </div>

                    <!-- Substage Content -->
                    <div class="divide-y divide-dark-border" id="substage-{{ substage.substage_id }}-steps">
                        {% for step in steps if step.substage_id == substage.substage_id %}
                        <div class="p-4 step-container" data-step-id="{{ step.id }}" draggable="true">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-grip-vertical text-dark-text cursor-move"></i>
                                    <i class="fa-solid fa-file-lines text-indigo-200"></i>
                                    <h4 class="text-md font-medium text-white">{{ step.name }}</h4>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="editStep({{ step.id }})"
                                        class="text-indigo-300 hover:text-indigo-100 px-2 py-1 rounded">
                                        <i class="fa-solid fa-edit"></i>
                                    </button>
                                    <button onclick="deleteStep({{ step.id }})"
                                        class="text-red-400 hover:text-red-300 px-2 py-1 rounded">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>

                            {% if step.config %}
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Input Fields -->
                                <div class="bg-[#1a1d2d] rounded p-3">
                                    <h5 class="text-sm font-medium text-indigo-300 mb-2 flex items-center gap-1">
                                        <i class="fa-solid fa-arrow-right-to-bracket"></i> Input Fields
                                    </h5>
                                    {% if step.config.inputs %}
                                    <ul class="space-y-2">
                                        {% for field_name, field_config in step.config.inputs.items() %}
                                        <li class="text-dark-text">
                                            <span class="text-indigo-200">{{ field_name }}:</span> {{
                                            field_config.db_field }}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p class="text-dark-text text-sm italic">No input fields configured</p>
                                    {% endif %}
                                </div>

                                <!-- Output Fields -->
                                <div class="bg-[#1a1d2d] rounded p-3">
                                    <h5 class="text-sm font-medium text-indigo-300 mb-2 flex items-center gap-1">
                                        <i class="fa-solid fa-arrow-right-from-bracket"></i> Output Fields
                                    </h5>
                                    {% if step.config.outputs %}
                                    <ul class="space-y-2">
                                        {% for field_name, field_config in step.config.outputs.items() %}
                                        <li class="text-dark-text">
                                            <span class="text-indigo-200">{{ field_name }}:</span> {{
                                            field_config.db_field }}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p class="text-dark-text text-sm italic">No output fields configured</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <p class="text-dark-text text-sm italic">No field mappings configured</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Step Edit Modal -->
<div id="stepModal">
    <div class="modal-content">
        <button onclick="closeModal()" class="close-btn" aria-label="Close">&times;</button>
        <h3 class="text-xl font-semibold mb-4">Edit Step</h3>
        <form id="stepForm" class="space-y-6">
            <input type="hidden" id="stepId" name="stepId">
            <div>
                <label for="stepName" class="block text-sm font-medium mb-2">Step Name</label>
                <input type="text" id="stepName" name="name">
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeModal()"
                    class="bg-gray-700 text-white px-4 py-2 rounded">Cancel</button>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Save
                    Changes</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Drag and drop functionality
    document.addEventListener('DOMContentLoaded', function () {
        const stepContainers = document.querySelectorAll('.step-container');

        stepContainers.forEach(container => {
            container.addEventListener('dragstart', handleDragStart);
            container.addEventListener('dragover', handleDragOver);
            container.addEventListener('drop', handleDrop);
        });
    });

    let draggedElement = null;

    function handleDragStart(e) {
        draggedElement = e.target;
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    async function handleDrop(e) {
        e.preventDefault();
        const container = e.target.closest('.step-container');
        if (!container || container === draggedElement) return;

        const substageSteps = container.parentElement;
        const steps = Array.from(substageSteps.children);
        const fromIndex = steps.indexOf(draggedElement);
        const toIndex = steps.indexOf(container);

        if (fromIndex < toIndex) {
            container.parentNode.insertBefore(draggedElement, container.nextSibling);
        } else {
            container.parentNode.insertBefore(draggedElement, container);
        }

        // Update step order using canonical PUT endpoint
        try {
            const stepId = draggedElement.dataset.stepId;
            const response = await fetch(`/api/workflow/steps/${stepId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    step_order: toIndex + 1  // Convert 0-based index to 1-based step_order
                })
            });

            if (!response.ok) {
                throw new Error('Failed to update step order');
            }
        } catch (error) {
            console.error('Error updating step order:', error);
            // Revert the DOM change on error
            if (fromIndex < toIndex) {
                container.parentNode.insertBefore(container, draggedElement);
            } else {
                container.parentNode.insertBefore(container, draggedElement.nextSibling);
            }
        }
    }

    // Step management functions
    async function addStep(substageId) {
        document.getElementById('stepId').value = '';
        document.getElementById('stepName').value = '';
        document.getElementById('stepModal').style.display = 'flex';
    }

    async function editStep(stepId) {
        try {
            const response = await fetch(`/api/workflow/steps/${stepId}`);
            const step = await response.json();
            document.getElementById('stepId').value = stepId;
            document.getElementById('stepName').value = step.name || '';
            document.getElementById('stepModal').style.display = 'flex';
        } catch (error) {
            console.error('Error fetching step details:', error);
        }
    }

    async function deleteStep(stepId) {
        if (!confirm('Are you sure you want to delete this step?')) return;

        try {
            const response = await fetch(`/api/workflow/steps/${stepId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete step');
            }

            // Remove the step from the DOM
            const stepElement = document.querySelector(`[data-step-id="${stepId}"]`);
            stepElement.remove();
        } catch (error) {
            console.error('Error deleting step:', error);
        }
    }

    function closeModal() {
        document.getElementById('stepModal').classList.remove('active');
        document.getElementById('stepModal').style.display = 'none';
    }

    // Ensure modal is hidden on page load
    window.onload = function () {
        document.getElementById('stepModal').classList.remove('active');
        document.getElementById('stepModal').style.display = 'none';
    };

    // Form submission
    document.getElementById('stepForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const stepId = document.getElementById('stepId').value;
        const formData = new FormData(this);

        // Build the step configuration
        const config = {
            inputs: {},
            outputs: {}
        };

        // Process input fields
        const inputNames = formData.getAll('inputNames[]');
        const inputDbFields = formData.getAll('inputDbFields[]');
        inputNames.forEach((name, i) => {
            if (name && inputDbFields[i]) {
                config.inputs[name] = {
                    db_field: inputDbFields[i]
                };
            }
        });

        // Process output fields
        const outputNames = formData.getAll('outputNames[]');
        const outputDbFields = formData.getAll('outputDbFields[]');
        outputNames.forEach((name, i) => {
            if (name && outputDbFields[i]) {
                config.outputs[name] = {
                    db_field: outputDbFields[i]
                };
            }
        });

        try {
            const response = await fetch(`/api/workflow/steps${stepId ? `/${stepId}` : ''}`, {
                method: stepId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: formData.get('name'),
                    config: config,
                    substageId: stepId ? null : formData.get('substageId')
                })
            });

            if (!response.ok) {
                throw new Error('Failed to save step');
            }

            // Reload the page to show the updated step
            window.location.reload();
        } catch (error) {
            console.error('Error saving step:', error);
        }
    });
</script>
{% endblock %}