{% extends "base.html" %}

{% block title %}Latest Posts{% endblock %}

{% block content %}
<div class="blog-posts">
    <header class="blog-header">
        <h1>Latest Posts</h1>
        <a href="{{ url_for('blog.create') }}" class="create-post-btn">Create New Post</a>
    </header>

    {% if posts %}
    <div class="posts-grid">
        {% for post in posts %}
        <article class="post-card">
            <div class="post-card__image">
                {% if post.header_image and post.header_image.path %}
                <img src="{{ url_for('static', filename=post.header_image.path) }}"
                    alt="{{ post.header_image.alt_text }}" class="post-thumbnail">
                {% else %}
                <div class="post-thumbnail post-thumbnail--placeholder">
                    <span>No Image Available</span>
                </div>
                {% endif %}
            </div>
            <div class="post-card__content">
                <header class="post-card__header">
                    <h2 class="post-title">
                        <a href="{{ url_for('blog.post', slug=post.slug) }}">{{ post.title }}</a>
                    </h2>
                    {% if post.subtitle %}
                    <p class="post-subtitle">{{ post.subtitle }}</p>
                    {% endif %}
                </header>

                <div class="post-meta">
                    <time datetime="{{ post.created_at.isoformat() }}">
                        Created {{ post.created_at.strftime('%B %d, %Y') }}
                    </time>
                    <span class="post-meta__separator">|</span>
                    <span class="post-meta__stage">{{ post.workflow_status.current_stage.value }}</span>
                </div>

                {% if post.basic_idea %}
                <p class="post-description">{{ post.basic_idea | truncate(150) }}</p>
                {% endif %}

                <div class="post-actions">
                    <a href="{{ url_for('blog.edit', slug=post.slug) }}" class="edit-btn">Edit</a>
                    {% if not post.published %}
                    <form action="{{ url_for('blog.publish', slug=post.slug) }}" method="POST" class="inline">
                        <button type="submit" class="publish-btn">Publish</button>
                    </form>
                    {% else %}
                    <form action="{{ url_for('blog.unpublish', slug=post.slug) }}" method="POST" class="inline">
                        <button type="submit" class="unpublish-btn">Unpublish</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </article>
        {% endfor %}
    </div>

    {% if posts.has_prev or posts.has_next %}
    <nav class="pagination">
        {% if posts.has_prev %}
        <a href="{{ url_for('blog.latest', page=posts.prev_num) }}" class="prev-page">&larr; Previous</a>
        {% endif %}

        <span class="current-page">Page {{ posts.page }} of {{ posts.pages }}</span>

        {% if posts.has_next %}
        <a href="{{ url_for('blog.latest', page=posts.next_num) }}" class="next-page">Next &rarr;</a>
        {% endif %}
    </nav>
    {% endif %}

    {% else %}
    <div class="no-posts">
        <p>No posts found.</p>
        <a href="{{ url_for('blog.create') }}" class="create-post-btn">Create Your First Post</a>
    </div>
    {% endif %}
</div>

<!-- Modal trigger button -->
<div class="fixed bottom-4 right-4">
    <button onclick="openModal()"
        class="bg-tartan-blue text-white rounded-full p-4 shadow-lg hover:bg-tartan-blue-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>
</div>

<!-- Modal -->
<div id="createPostModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">New Blog Post Idea</h3>
            <div class="mt-2 px-7 py-3">
                <textarea id="basic-idea"
                    class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:border-tartan-blue"
                    rows="4" placeholder="What's your blog post idea?"></textarea>
            </div>
            <div class="items-center px-4 py-3">
                <button id="createButton"
                    class="px-4 py-2 bg-tartan-blue text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-tartan-blue-700 focus:outline-none focus:ring-2 focus:ring-tartan-blue">
                    Create Post
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById('createPostModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('createPostModal').classList.add('hidden');
        document.getElementById('basic-idea').value = '';
    }

    document.getElementById('createPostModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeModal();
        }
    });

    document.getElementById('createButton').addEventListener('click', function () {
        const basicIdea = document.getElementById('basic-idea').value.trim();

        if (!basicIdea) {
            alert('Please enter your blog post idea');
            return;
        }

        fetch('{{ url_for("blog.create") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                basic_idea: basicIdea
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to create post. Please try again.');
            });
    });
</script>

<style>
    .blog-posts {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .blog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .blog-header h1 {
        font-size: 2rem;
        font-weight: bold;
        color: #1a202c;
    }

    .posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }

    .post-card {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
        background: white;
        transition: transform 0.2s;
    }

    .post-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .post-card__content {
        padding: 1.5rem;
    }

    .post-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }

    .post-title a {
        text-decoration: none;
        color: inherit;
    }

    .post-meta {
        font-size: 0.875rem;
        color: #718096;
        margin-bottom: 1rem;
    }

    .post-meta__separator {
        margin: 0 0.5rem;
    }

    .post-description {
        color: #4a5568;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .post-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .edit-btn,
    .publish-btn,
    .unpublish-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: background-color 0.2s;
    }

    .edit-btn {
        background-color: #edf2f7;
        color: #2d3748;
    }

    .edit-btn:hover {
        background-color: #e2e8f0;
    }

    .publish-btn {
        background-color: #48bb78;
        color: white;
        border: none;
        cursor: pointer;
    }

    .publish-btn:hover {
        background-color: #38a169;
    }

    .unpublish-btn {
        background-color: #f56565;
        color: white;
        border: none;
        cursor: pointer;
    }

    .unpublish-btn:hover {
        background-color: #e53e3e;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 2rem;
        gap: 1rem;
    }

    .prev-page,
    .next-page {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.25rem;
        text-decoration: none;
        color: #4a5568;
        transition: background-color 0.2s;
    }

    .prev-page:hover,
    .next-page:hover {
        background-color: #f7fafc;
    }

    .current-page {
        color: #718096;
    }

    .no-posts {
        text-align: center;
        padding: 2rem;
        color: #718096;
    }
</style>
{% endblock %}