{% extends "base.html" %}

{% block title %}Develop Post (New){% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog.css') }}">
<style>
    .accordion-panel {
        border-radius: 1rem;
        background: #23272F;
        margin-bottom: 1.5rem;
    }

    .accordion-header {
        width: 100%;
        background: #6366F1;
        color: #fff;
        font-size: 1.2rem;
        font-weight: 600;
        padding: 1rem 2rem;
        border: none;
        cursor: pointer;
    }

    .accordion-content {
        display: none;
        padding: 1.5rem 2rem 2rem 2rem;
    }

    .accordion-content.active {
        display: block;
    }

    .accordion-field {
        margin-bottom: 1.5rem;
    }

    .admin-button {
        background: #1B4B73;
        color: #fff;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
    <h1>Develop Post (New)</h1>
    <div id="stage-accordion" class="space-y-4">
        <!-- IDEA STAGE -->
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="idea">Idea Stage</button>
            <div class="accordion-content">
                <div class="accordion-field">
                    <label for="basic_idea">Basic Idea</label>
                    <textarea id="basic_idea" class="admin-textarea" rows="2">{{ dev.basic_idea or '' }}</textarea>
                    <button type="button" class="admin-button" onclick="saveGlobalField('basic_idea')">Save</button>
                </div>
                <div class="accordion-field">
                    <label for="idea_scope">Idea Scope</label>
                    <textarea id="idea_scope" class="admin-textarea" rows="2">{{ dev.idea_scope or '' }}</textarea>
                    <select id="llm-action-select-idea-scope" class="admin-textarea" style="max-width: 220px;"></select>
                    <button type="button" class="admin-button" id="generate-idea-scope-btn">Generate</button>
                    <button type="button" class="admin-button" onclick="saveGlobalField('idea_scope')">Save</button>
                </div>
                <div class="accordion-field">
                    <label for="provisional_title">Provisional Title</label>
                    <textarea id="provisional_title" class="admin-textarea"
                        rows="2">{{ dev.provisional_title or '' }}</textarea>
                    <select id="llm-action-select-provisional-title" class="admin-textarea"
                        style="max-width: 220px;"></select>
                    <button type="button" class="admin-button" id="generate-provisional-title-btn">Generate</button>
                    <button type="button" class="admin-button"
                        onclick="saveGlobalField('provisional_title')">Save</button>
                </div>
            </div>
        </div>
        <!-- Add more stages as needed, e.g. Research, Outlining, etc. -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Accordion logic
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.accordion-header').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const content = btn.nextElementSibling;
                content.classList.toggle('active');
            });
        });
        // LLM action dropdowns
        fetch('/api/v1/llm/actions').then(r => r.json()).then(actions => {
            const select1 = document.getElementById('llm-action-select-idea-scope');
            const select2 = document.getElementById('llm-action-select-provisional-title');
            [select1, select2].forEach(select => {
                select.innerHTML = '<option value="">-- Select Action --</option>';
                actions.forEach(action => {
                    const option = document.createElement('option');
                    option.value = action.id;
                    option.text = action.field_name;
                    select.appendChild(option);
                });
            });
        });
        // LLM generate buttons
        document.getElementById('generate-idea-scope-btn').addEventListener('click', async function () {
            const select = document.getElementById('llm-action-select-idea-scope');
            const actionId = select.value;
            const textarea = document.getElementById('idea_scope');
            if (!actionId) { alert('Please select an LLM Action.'); return; }
            const inputText = textarea.value;
            const postId = {{ post.id }
        };
        this.disabled = true;
        this.textContent = 'Generating...';
        try {
            const response = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input_text: inputText, post_id: postId })
            });
            const result = await response.json();
            if (result && result.response) textarea.value = result.response;
            else if (result && result.data && result.data.content) textarea.value = result.data.content;
            else alert('No response from LLM.');
        } catch (e) { alert('Error generating content: ' + e.message); }
        finally { this.disabled = false; this.textContent = 'Generate'; }
    });
    document.getElementById('generate-provisional-title-btn').addEventListener('click', async function () {
        const select = document.getElementById('llm-action-select-provisional-title');
        const actionId = select.value;
        const textarea = document.getElementById('provisional_title');
        if (!actionId) { alert('Please select an LLM Action.'); return; }
        const inputText = textarea.value;
        const postId = {{ post.id }
    };
    this.disabled = true;
    this.textContent = 'Generating...';
    try {
        const response = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input_text: inputText, post_id: postId })
        });
        const result = await response.json();
        if (result && result.response) textarea.value = result.response;
        else if (result && result.data && result.data.content) textarea.value = result.data.content;
        else alert('No response from LLM.');
    } catch (e) { alert('Error generating content: ' + e.message); }
    finally { this.disabled = false; this.textContent = 'Generate'; }
        });
    });
    // Save field function
    function saveGlobalField(field) {
        const value = document.getElementById(field).value;
        const postId = {{ post.id }
    };
    fetch(`/api/v1/posts/${postId}/fields/${field}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ value })
    })
        .then(r => r.json())
        .then(data => { if (data.status === 'success') alert('Saved!'); else alert('Save failed'); })
        .catch(() => { alert('Save failed'); });
    }
</script>
{% endblock %}