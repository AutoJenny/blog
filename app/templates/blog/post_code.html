{% extends "blog/post_base.html" %}

{% block post_content %}
<div class="container mt-4">
    <h1 class="text-center mb-4">{{ post.title }}</h1>

    <div class="accordion" id="postAccordion">
        <!-- Navigation -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="navigationHeading">
                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navigationCollapse" aria-expanded="true" aria-controls="navigationCollapse">
                    Navigation
                </button>
            </h2>
            <div id="navigationCollapse" class="accordion-collapse collapse show" aria-labelledby="navigationHeading">
                <div class="accordion-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p><strong>Slug:</strong> {{ post.slug }}</p>
                            <p><strong>Categories:</strong> {{ post.categories|map(attribute='name')|join(', ') }}</p>
                            <p><strong>Tags:</strong> {{ post.tags|map(attribute='name')|join(', ') }}</p>
                        </div>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('blog.edit', slug=post.slug) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit"></i> Edit Post
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headerHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#headerCollapse" aria-expanded="false" aria-controls="headerCollapse">
                    Header
                </button>
            </h2>
            <div id="headerCollapse" class="accordion-collapse collapse" aria-labelledby="headerHeading">
                <div class="accordion-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p><strong>Header Image:</strong> {{ post.header_image.path if post.header_image else 'None'
                                }}</p>
                            <p><strong>Title:</strong> {{ post.title }}</p>
                            <p><strong>Subtitle:</strong> {{ post.subtitle if post.subtitle else 'None' }}</p>
                            <p><strong>Description:</strong> {{ post.description if post.description else 'None' }}</p>
                            <p><strong>Author:</strong> {{ post.author.username if post.author else 'Unknown' }}</p>
                            <p><strong>Time to Read:</strong> {{ post.reading_time }} minutes</p>
                        </div>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('blog.edit', slug=post.slug) }}#header"
                                class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit"></i> Edit Header
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sections -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="sectionsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#sectionsCollapse" aria-expanded="false" aria-controls="sectionsCollapse">
                    Sections
                </button>
            </h2>
            <div id="sectionsCollapse" class="accordion-collapse collapse" aria-labelledby="sectionsHeading">
                <div class="accordion-body">
                    {% for section in post.sections %}
                    <div class="section-block mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">Section {{ loop.index }}</h4>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('blog.edit_section', section_id=section.id) }}"
                                    class="btn btn-outline-primary btn-sm me-2">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <a href="{{ url_for('blog.edit_section_sql', section_id=section.id) }}"
                                    class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-database"></i> SQL
                                </a>
                            </div>
                        </div>

                        <!-- SQL Editor -->
                        <div class="sql-editor mb-3">
                            <form method="POST" action="{{ url_for('blog.update_section_sql', section_id=section.id) }}"
                                class="mb-3">
                                <div class="form-group">
                                    <textarea name="sql_query" class="form-control font-monospace" rows="6">UPDATE post_section 
SET title = '{{ section.title }}',
    subtitle = '{{ section.subtitle }}',
    content = '{{ section.content | replace("'", "''") }}',
    position = {{ section.position }},
    content_type = '{{ section.content_type }}'
WHERE id = {{ section.id }};</textarea>
                                </div>
                                <div class="alert alert-warning my-2">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Warning: Be careful with SQL queries. Incorrect queries may damage your data.
                                </div>
                                <button type="submit" class="btn btn-primary">Execute SQL</button>
                            </form>
                        </div>

                        <!-- Section Data -->
                        <div class="section-data">
                            <p><strong>Heading:</strong> {{ section.title }}</p>
                            <p><strong>Content:</strong><br>{{ section.content }}</p>
                            <p><strong>Image:</strong> {{ section.image.path if section.image else 'None' }}</p>
                            <p><strong>Image Description:</strong> {{ section.image.alt_text if section.image else
                                'None' }}</p>
                            <p><strong>Image Caption:</strong> {{ section.image.caption if section.image else 'None' }}
                            </p>
                            {% if section.section_metadata %}
                            <p><strong>Section Metadata:</strong><br>{{ section.section_metadata|tojson(indent=2) }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Meta -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="metaHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#metaCollapse" aria-expanded="false" aria-controls="metaCollapse">
                    Meta
                </button>
            </h2>
            <div id="metaCollapse" class="accordion-collapse collapse" aria-labelledby="metaHeading">
                <div class="accordion-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p><strong>SEO Metadata:</strong><br>{{ post.seo_metadata|tojson(indent=2) if
                                post.seo_metadata else
                                'None' }}</p>
                            <p><strong>LLM Metadata:</strong><br>{{ post.llm_metadata|tojson(indent=2) if
                                post.llm_metadata else
                                'None' }}</p>
                        </div>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('blog.edit', slug=post.slug) }}#meta"
                                class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit"></i> Edit Meta
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Publication -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="publicationHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#publicationCollapse" aria-expanded="false" aria-controls="publicationCollapse">
                    Publication
                </button>
            </h2>
            <div id="publicationCollapse" class="accordion-collapse collapse" aria-labelledby="publicationHeading">
                <div class="accordion-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p><strong>Created Date:</strong> {{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') if
                                post.created_at else 'None' }}</p>
                            <p><strong>Updated Date:</strong> {{ post.updated_at.strftime('%Y-%m-%d %H:%M:%S') if
                                post.updated_at else 'None' }}</p>
                            <p><strong>Publication Date:</strong> {{ post.published_at.strftime('%Y-%m-%d %H:%M:%S') if
                                post.published_at else 'Not published' }}</p>
                            <p><strong>Status:</strong> {{ post.workflow_status.current_stage if post.workflow_status
                                else
                                'Draft' }}</p>
                            <p><strong>Clan.com ID:</strong> {{ post.clan_com_post_id if post.clan_com_post_id else 'Not
                                published' }}</p>
                        </div>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('blog.edit', slug=post.slug) }}#publication"
                                class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit"></i> Edit Status
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleSqlEditor(sectionId) {
        const editor = document.getElementById('sql-editor-' + sectionId);
        if (editor.style.display === 'none') {
            editor.style.display = 'block';
        } else {
            editor.style.display = 'none';
        }
    }
</script>

<style>
    .sql-editor textarea {
        font-family: monospace;
        font-size: 14px;
        tab-size: 4;
    }
</style>
{% endblock %}