{% extends "blog/post_base.html" %}

{% block post_content %}
<article class="blog-post">
    <!-- Navigation -->
    <nav class="post-navigation">
        <a href="{{ url_for('blog.latest') }}" class="back-link">← Back to Blog Index</a>
    </nav>

    <!-- Header -->
    <header class="blog-post__header">
        <h1 class="blog-post__title">{{ post.title }}</h1>
        {% if post.subtitle %}
        <p class="blog-post__subtitle">{{ post.subtitle }}</p>
        {% endif %}

        <div class="blog-post__meta">
            <span class="meta-item">
                <time
                    datetime="{{ post.published_at.isoformat() if post.published_at else post.created_at.isoformat() }}">
                    {{ post.published_at.strftime('%B %d, %Y') if post.published_at else post.created_at.strftime('%B
                    %d, %Y') }}
                </time>
            </span>
            <span class="meta-separator">•</span>
            <span class="meta-item">By {{ post.author.name }}</span>
        </div>

        {% if post.description %}
        <div class="blog-post__description">
            <p>{{ post.description }}</p>
        </div>
        {% endif %}

        {% if post.header_image %}
        <figure class="blog-post__image">
            <img src="{{ url_for('static', filename=post.header_image.path) }}" alt="{{ post.header_image.alt_text }}"
                class="featured-image">
            {% if post.header_image.caption %}
            <figcaption class="image-caption">{{ post.header_image.caption }}</figcaption>
            {% endif %}
        </figure>
        {% endif %}
    </header>

    {% if post.sections %}
    <!-- Table of Contents -->
    <nav class="blog-post__toc">
        <h2 class="toc-title">Table of Contents</h2>
        <ul class="toc-list">
            {% for section in post.sections %}
            {% if section.title %}
            <li><a href="#section-{{ loop.index }}" class="toc-link">{{ section.title }}</a></li>
            {% endif %}
            {% endfor %}
        </ul>
    </nav>

    <!-- Post sections -->
    <div class="blog-post__content">
        {% for section in post.sections %}
        <section id="section-{{ loop.index }}" class="content-section">
            {% if section.title %}
            <h2 class="section-title">{{ section.title }}</h2>
            {% endif %}

            {% if section.subtitle %}
            <p class="section-subtitle">{{ section.subtitle }}</p>
            {% endif %}

            <div class="section-content">
                {{ section.content | safe }}
            </div>

            {% if section.image %}
            <figure class="section-image">
                <img src="{{ url_for('static', filename=section.image.path) }}" alt="{{ section.image.alt_text }}"
                    class="content-image">
                {% if section.image.caption %}
                <figcaption class="image-caption">{{ section.image.caption }}</figcaption>
                {% endif %}
            </figure>
            {% endif %}
        </section>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Tags -->
    {% if post.tags %}
    <div class="blog-post__tags">
        <span class="tags-label">Tags:</span>
        {% for tag in post.tags %}
        <a href="{{ url_for('blog.tag', tag=tag.slug) }}" class="tag-link">{{ tag.name }}</a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Action buttons for author/admin -->
    {% if current_user.is_authenticated and (current_user.id == post.author_id or current_user.is_admin) %}
    <div class="blog-post__actions">
        {% if not post.published %}
        <button onclick="publishPost('{{ post.slug }}')" class="action-button publish-button">
            Publish
        </button>
        {% else %}
        <button onclick="unpublishPost('{{ post.slug }}')" class="action-button unpublish-button">
            Unpublish
        </button>
        {% endif %}
        {% if current_user.is_admin %}
        <button onclick="deletePost('{{ post.slug }}')" class="action-button delete-button">
            Delete
        </button>
        {% endif %}
    </div>
    {% endif %}
</article>
{% endblock %}

{% block scripts %}
<script>
    function publishPost(slug) {
        if (!confirm('Are you sure you want to publish this post?')) return;
        fetch(`/blog/post/${slug}/publish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while publishing the post');
            });
    }

    function unpublishPost(slug) {
        if (!confirm('Are you sure you want to unpublish this post?')) return;
        fetch(`/blog/post/${slug}/unpublish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while unpublishing the post');
            });
    }

    function deletePost(slug) {
        if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;
        fetch(`/blog/post/${slug}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.href = '{{ url_for("blog.latest") }}';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the post');
            });
    }
</script>
{% endblock %}