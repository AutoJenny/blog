{% extends "blog/post_base.html" %}

{% block post_content %}
<article class="blog-post">
    <nav class="blog-nav">
        <a href="{{ url_for('blog.latest') }}" class="nav-link">← Back to All Posts</a>
    </nav>

    <header class="blog-post__header">
        <h1 class="blog-post__title">{{ post.title }}</h1>
        {% if post.subtitle %}
        <h2 class="blog-post__subtitle">{{ post.subtitle }}</h2>
        {% endif %}

        <div class="blog-post__meta">
            <time datetime="{{ post.published_at or post.created_at }}">
                {{ post.published_at.strftime('%B %d, %Y') if post.published_at else post.created_at.strftime('%B %d,
                %Y') }}
            </time>
            {% if post.author %}
            <span class="meta-separator">·</span>
            <span class="author">{{ post.author.name }}</span>
            {% endif %}
            {% if post.reading_time %}
            <span class="meta-separator">·</span>
            <span class="reading-time">{{ post.reading_time }} min read</span>
            {% endif %}
        </div>

        {% if post.description %}
        <p class="blog-post__description">{{ post.description }}</p>
        {% endif %}

        {% if post.header_image %}
        <figure class="blog-post__image">
            <img src="{{ url_for('static', filename=post.header_image.path) }}" alt="{{ post.header_image.alt_text }}">
            {% if post.header_image.caption %}
            <figcaption>{{ post.header_image.caption }}</figcaption>
            {% endif %}
        </figure>
        {% endif %}
    </header>

    {% if post.sections %}
    <nav class="blog-post__toc">
        <h2>Table of Contents</h2>
        <ul>
            {% for section in post.sections %}
            <li><a href="#section-{{ loop.index }}">{{ section.title }}</a></li>
            {% endfor %}
        </ul>
    </nav>
    {% endif %}

    <div class="blog-post__content">
        {% for section in post.sections %}
        <section id="section-{{ loop.index }}" class="blog-section">
            <h2 class="blog-section__title">{{ section.title }}</h2>
            {% if section.subtitle %}
            <h3 class="blog-section__subtitle">{{ section.subtitle }}</h3>
            {% endif %}
            {% if section.image %}
            <figure class="blog-section__image">
                <img src="{{ url_for('static', filename=section.image.path) }}" alt="{{ section.image.alt_text }}">
                {% if section.image.caption %}
                <figcaption>{{ section.image.caption }}</figcaption>
                {% endif %}
            </figure>
            {% endif %}
            <div class="blog-section__content">
                {{ section.content | safe }}
            </div>
        </section>
        {% endfor %}
    </div>

    {% if post.tags %}
    <footer class="blog-post__footer">
        <div class="blog-post__tags">
            {% for tag in post.tags %}
            <a href="{{ url_for('blog.tag', tag=tag.slug) }}" class="blog-tag">{{ tag.name }}</a>
            {% endfor %}
        </div>
    </footer>
    {% endif %}

    {% if current_user.is_authenticated and current_user.is_author %}
    <div class="blog-post__actions">
        <button onclick="publishPost('{{ post.slug }}')" class="action-btn publish-btn" {% if post.published
            %}disabled{% endif %}>
            Publish
        </button>
        <button onclick="unpublishPost('{{ post.slug }}')" class="action-btn unpublish-btn" {% if not post.published
            %}disabled{% endif %}>
            Unpublish
        </button>
        <button onclick="deletePost('{{ post.slug }}')" class="action-btn delete-btn">
            Delete
        </button>
    </div>
    {% endif %}
</article>

<script>
    async function publishPost(slug) {
        if (confirm('Are you sure you want to publish this post?')) {
            try {
                const response = await fetch(`/blog/post/${slug}/publish`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to publish post');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while publishing the post');
            }
        }
    }

    async function unpublishPost(slug) {
        if (confirm('Are you sure you want to unpublish this post?')) {
            try {
                const response = await fetch(`/blog/post/${slug}/unpublish`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to unpublish post');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while unpublishing the post');
            }
        }
    }

    async function deletePost(slug) {
        if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
            try {
                const response = await fetch(`/blog/post/${slug}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    window.location.href = "{{ url_for('blog.latest') }}";
                } else {
                    alert('Failed to delete post');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while deleting the post');
            }
        }
    }
</script>
{% endblock %}