{% extends "base.html" %}

{% block title %}Develop Post (New){% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog.css') }}">
<style>
    .blog-card,
    .admin-card {
        background-color: var(--admin-bg-card, #23272F) !important;
        color: var(--admin-text, #E0E0E0) !important;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--admin-border, #404040);
        padding: 2rem;
    }

    .blog-card__title {
        color: var(--admin-text, #E0E0E0) !important;
    }

    .badge-published {
        background: #166534 !important;
        color: #bbf7d0 !important;
    }

    .badge-draft {
        background: #374151 !important;
        color: #d1d5db !important;
    }

    .badge-deleted {
        background: #7f1d1d !important;
        color: #fecaca !important;
    }

    .admin-button,
    .admin-button-secondary {
        background-color: var(--admin-primary, #1B4B73) !important;
        color: #fff !important;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
    }

    .admin-button-secondary {
        background-color: var(--admin-accent, #6366F1) !important;
    }

    .admin-button:disabled,
    .admin-button-secondary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .accordion-panel {
        border-radius: 1rem;
        overflow: hidden;
        background: var(--admin-bg-card, #23272F);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        border: 1px solid var(--admin-border, #404040);
    }

    .accordion-header {
        width: 100%;
        text-align: left;
        background: var(--admin-accent, #6366F1);
        color: #fff;
        font-size: 1.2rem;
        font-weight: 600;
        padding: 1rem 2rem;
        border: none;
        outline: none;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid var(--admin-border, #404040);
    }

    .accordion-header:hover,
    .accordion-header:focus {
        background: #4f46e5;
    }

    .accordion-header.active {
        background: #312e81;
    }

    .accordion-content {
        display: none;
        padding: 1.5rem 2rem 2rem 2rem;
        background: transparent;
    }

    .accordion-content.active {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .accordion-field {
        margin-bottom: 1.5rem;
    }

    .section-block {
        margin-bottom: 2rem;
        border: 1px solid var(--admin-border, #404040);
        background: #23272F;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        padding: 1.5rem;
    }

    .section-accordion-header {
        transition: background 0.2s, border 0.2s;
        position: relative;
        user-select: none;
    }

    .section-accordion-header:hover {
        background: #3730a3 !important;
        border-color: #6366F1;
    }

    .section-accordion-header.active {
        background: #312e81 !important;
        border-left: 4px solid #a5b4fc;
    }

    .chevron {
        transition: transform 0.3s;
        display: inline-block;
        margin-right: 0.5em;
        font-size: 1.2em;
        color: #a5b4fc;
    }

    .chevron.open {
        transform: rotate(90deg);
    }

    .section-accordion-content {
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s;
        overflow: hidden;
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        display: block !important;
    }

    .section-accordion-content.active {
        max-height: 2000px;
        padding-top: 1.5rem;
        padding-bottom: 2rem;
    }

    .section-content-zone {
        background: #23244d;
        border-left: 4px solid #6366F1;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(60, 60, 120, 0.15);
    }

    .section-images-zone {
        background: #1a2636;
        border-left: 4px solid #3b82f6;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(30, 60, 120, 0.18);
    }

    .section-meta-zone {
        background: #111827;
        border-left: 4px solid #a78bfa;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(80, 60, 120, 0.12);
    }
</style>
{% endblock %}

{% block content %}
{% from "blog/_post_header.html" import post_header %}
<div class="max-w-3xl mx-auto py-8">
    {{ post_header(post, active_view) }}
    <div id="stage-accordion" class="space-y-4" data-post-id="{{ post.id }}">

        {# IDEA STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="idea">Idea Stage</button>
            <div class="accordion-content">
                {% for field in ['basic_idea', 'idea_scope', 'provisional_title'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>

                    {% if field == 'idea_scope' %}
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-idea-scope" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-idea-scope-btn" class="admin-button">Generate</button>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            fetch('/api/v1/llm/actions')
                                .then(r => r.json())
                                .then(actions => {
                                    const sel = document.getElementById('llm-action-select-idea-scope');
                                    sel.innerHTML = '<option value="">-- Select Action --</option>';
                                    actions.forEach(a => {
                                        const opt = document.createElement('option');
                                        opt.value = a.id;
                                        opt.text = a.field_name;
                                        sel.appendChild(opt);
                                    });
                                });
                            document.getElementById('generate-idea-scope-btn').addEventListener('click', async function () {
                                const sel = document.getElementById('llm-action-select-idea-scope');
                                const actionId = sel.value;
                                const ta = document.getElementById('idea_scope');
                                if (!actionId) { alert('Please select an LLM Action.'); return; }
                                const postId = document.getElementById('stage-accordion').dataset.postId;
                                this.disabled = true;
                                this.textContent = 'Generating...';
                                try {
                                    const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ input_text: ta.value, post_id: postId })
                                    });
                                    const js = await res.json();
                                    console.log('LLM response:', js);
                                    const newValue = typeof js === 'string' ? js : js.response || js.data?.content || '';
                                    if (!newValue) {
                                        return;
                                    }
                                    ta.value = newValue;
                                    console.log('About to save:', newValue);
                                    try {
                                        const saveRes = await fetch(`/blog/api/v1/posts/${postId}/fields/idea_scope`, {
                                            method: 'PUT',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ value: newValue })
                                        });
                                        const saveJs = await saveRes.json();
                                        console.log('Save result:', saveJs);
                                    } catch (saveErr) {
                                        console.error('Save call failed:', saveErr);
                                    }
                                } catch (e) {
                                    alert('Error: ' + e.message);
                                    console.error('Error:', e);
                                } finally {
                                    this.disabled = false;
                                    this.textContent = 'Generate';
                                }
                            });
                        });
                    </script>
                    {% endif %}

                    {% if field == 'provisional_title' %}
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-provisional-title" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-provisional-title-btn" class="admin-button">Generate</button>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            fetch('/api/v1/llm/actions')
                                .then(r => r.json())
                                .then(actions => {
                                    const sel = document.getElementById('llm-action-select-provisional-title');
                                    sel.innerHTML = '<option value="">-- Select Action --</option>';
                                    actions.forEach(a => {
                                        const opt = document.createElement('option');
                                        opt.value = a.id;
                                        opt.text = a.field_name;
                                        sel.appendChild(opt);
                                    });
                                });
                            document.getElementById('generate-provisional-title-btn').addEventListener('click', async function () {
                                const sel = document.getElementById('llm-action-select-provisional-title');
                                const actionId = sel.value;
                                const ta = document.getElementById('provisional_title');
                                if (!actionId) { alert('Please select an LLM Action.'); return; }
                                const postId = document.getElementById('stage-accordion').dataset.postId;
                                this.disabled = true;
                                this.textContent = 'Generating...';
                                try {
                                    const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ input_text: ta.value, post_id: postId })
                                    });
                                    const js = await res.json();
                                    ta.value = js.response || js.data?.content || ta.value;
                                } catch (e) {
                                    alert('Error generating content: ' + e.message);
                                } finally {
                                    this.disabled = false;
                                    this.textContent = 'Generate';
                                }
                            });
                        });
                    </script>
                    {% endif %}

                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# RESEARCH STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="research">Research Stage</button>
            <div class="accordion-content">
                {% for field in ['topics_to_cover', 'interesting_facts', 'tartans_products'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# OUTLINING STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="outlining">Outlining Stage</button>
            <div class="accordion-content">
                {% for field in ['section_planning', 'section_headings'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
                {% if 'section_order' in dev.__dict__ %}
                <div class="accordion-field">
                    <label class="block text-sm font-semibold mb-2">Section Order</label>
                    <button type="button" class="admin-button mb-2" id="grab-headings-btn">Grab Headings</button>
                    <div id="section-order-label" class="text-xs text-gray-400 mb-1">Drag to reorder</div>
                    <div id="section-order-list" class="mb-2"></div>
                    <div id="section-order-empty" class="text-gray-500 text-sm mb-2" style="display:none;">No section
                        order yet. Click 'Grab Headings' to start.</div>
                    <button type="button" class="admin-button" id="save-section-order-btn">Save</button>
                    <textarea id="section_order" name="section_order" class="admin-textarea" rows="2"
                        style="display:none;">{{ dev.section_order or '' }}</textarea>
                </div>
                {% endif %}
            </div>
        </div>

        {# AUTHORING (SECTIONS) STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="authoring">Authoring Stage (Sections)</button>
            <div class="accordion-content">
                <div class="flex justify-end mb-4">
                    <button type="button" class="admin-button" id="allocate-ideas-btn">Allocate Ideas</button>
                    <button type="button" class="admin-button" id="allocate-facts-btn">Allocate Facts</button>
                </div>
                <div id="sections">
                    {% for section in sections %}
                    <div class="section-block rounded-lg p-4 mb-6 shadow" data-section-id="{{ section.id }}">
                        <div class="section-accordion-header flex items-center justify-between cursor-pointer select-none bg-gray-900 px-4 py-2 rounded"
                            style="color: var(--admin-accent);">
                            <span class="flex items-center">
                                <span class="chevron">&#9654;</span>
                                Section {{ loop.index }}: {{ section.section_heading or '' }}
                            </span>
                            <button class="delete-section-btn text-red-400 hover:text-red-600 ml-2"
                                data-section-id="{{ section.id }}" title="Delete Section"
                                style="background:none;border:none;font-size:1.2em;cursor:pointer;">&#128465;</button>
                        </div>
                        <div class="section-accordion-content">
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1"
                                    style="color: var(--admin-text-secondary);">
                                    Section Heading
                                </label>
                                <textarea id="section_heading_{{ section.id }}"
                                    class="admin-textarea mb-2">{{ section.section_heading or '' }}</textarea>
                                <button type="button" class="admin-button mb-2"
                                    onclick="saveSectionField({{ section.id }}, 'section_heading')">Save</button>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1"
                                    style="color: var(--admin-text-secondary);">
                                    Ideas to include
                                </label>
                                <textarea id="ideas_to_include_{{ section.id }}"
                                    class="admin-textarea mb-2">{{ section.ideas_to_include or '' }}</textarea>
                                <button type="button" class="admin-button mb-2"
                                    onclick="saveSectionField({{ section.id }}, 'ideas_to_include')">Save</button>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1"
                                    style="color: var(--admin-text-secondary);">
                                    Facts to include
                                </label>
                                <textarea id="facts_to_include_{{ section.id }}"
                                    class="admin-textarea mb-2">{{ section.facts_to_include or '' }}</textarea>
                                <button type="button" class="admin-button mb-2"
                                    onclick="saveSectionField({{ section.id }}, 'facts_to_include')">Save</button>
                            </div>
                            <div class="section-content-zone">
                                <div class="font-semibold text-indigo-300 mb-2">Content</div>
                                {% for field in ['first_draft', 'uk_british', 'highlighting', 'generation',
                                'optimization'] %}
                                {% if field in section.__dict__ %}
                                <label for="{{ field }}_{{ section.id }}" class="block text-sm font-semibold mb-1"
                                    style="color: var(--admin-text-secondary);">
                                    {{ field.replace('_', ' ').title() }}
                                </label>
                                <div class="flex items-center gap-2 mb-2">
                                    <textarea id="{{ field }}_{{ section.id }}"
                                        class="admin-textarea">{{ section.__dict__[field] or '' }}</textarea>
                                    <select id="llm-action-select-{{ field }}-{{ section.id }}" class="admin-textarea"
                                        style="max-width:220px;"></select>
                                    <button type="button" class="admin-button generate-section-content-btn"
                                        data-section-id="{{ section.id }}" data-field="{{ field }}">Generate</button>
                                </div>
                                <button type="button" class="admin-button mb-2"
                                    onclick="saveSectionField({{ section.id }}, '{{ field }}')">Save</button><br>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <div class="section-images-zone">
                                <div class="font-semibold text-blue-300 mb-2">Images</div>
                                {% for field in ['image_concepts', 'image_prompts', 'watermarking',
                                'image_meta_descriptions', 'image_captions'] %}
                                {% if field in section.__dict__ %}
                                <label for="{{ field }}_{{ section.id }}" class="block text-sm font-semibold mb-1"
                                    style="color: var(--admin-text-secondary);">
                                    {{ field.replace('_', ' ').title() }}
                                </label>
                                <textarea id="{{ field }}_{{ section.id }}"
                                    class="admin-textarea mb-2">{{ section.__dict__[field] or '' }}</textarea>
                                <button type="button" class="admin-button mb-2"
                                    onclick="saveSectionField({{ section.id }}, '{{ field }}')">Save</button><br>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <div class="section-meta-zone">
                                <div class="font-semibold text-purple-300 mb-2">Meta</div>
                                {% for field in ['highlighting', 'optimization'] %}
                                {% if field in section.__dict__ %}
                                <label for="{{ field }}_{{ section.id }}" class="block text-sm font-semibold mb-1"
                                    style="color: var(--admin-text-secondary);">
                                    {{ field.replace('_', ' ').title() }}
                                </label>
                                <textarea id="{{ field }}_{{ section.id }}"
                                    class="admin-textarea mb-2">{{ section.__dict__[field] or '' }}</textarea>
                                <button type="button" class="admin-button mb-2"
                                    onclick="saveSectionField({{ section.id }}, '{{ field }}')">Save</button><br>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="flex justify-center mt-6 gap-2">
                    <button type="button" class="admin-button" onclick="addSection()">Add Section</button>
                    <button type="button" class="admin-button" id="import-headings-btn">Import Headings</button>
                </div>
            </div>
        </div>

        {# TOP & TAIL STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="topntail">Top & Tail Stage</button>
            <div class="accordion-content">
                {% for field in ['main_title', 'subtitle', 'intro_blurb', 'conclusion'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# METADATA STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="metadata">Metadata Stage</button>
            <div class="accordion-content">
                {% for field in ['basic_metadata', 'tags', 'categories', 'image_captions', 'seo_optimization'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# REVIEW STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="review">Review Stage</button>
            <div class="accordion-content">
                {% for field in ['self_review', 'peer_review', 'final_check'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# PUBLISHING STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="publishing">Publishing Stage</button>
            <div class="accordion-content">
                {% for field in ['scheduling', 'deployment', 'verification'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# UPDATES STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="updates">Updates Stage</button>
            <div class="accordion-content">
                {% for field in ['feedback_collection', 'content_updates', 'version_control'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# SYNDICATION STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="syndication">Syndication Stage</button>
            <div class="accordion-content">
                {% for field in ['platform_selection', 'content_adaptation', 'distribution', 'engagement_tracking'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<div id="llmActionModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="bg-[#23272F] rounded-lg shadow-lg p-8 w-full max-w-lg relative">
        <h2 class="text-xl font-semibold mb-4">Configure LLM Action</h2>
        <form id="llmActionForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Source Field</label>
                <select name="source_field" class="admin-textarea w-full">
                    {% for stage, fields in workflow_fields.items() %}
                    <optgroup label="{{ stage }}">
                        {% for wf in fields %}
                        <option value="{{ wf }}" {% if wf==field %}selected{% endif %}>{{ wf.replace('_', ' ').title()
                            }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Prompt Template</label>
                <textarea name="prompt_template" class="admin-textarea w-full"
                    rows="3">Suggest a catchy title for: {{ basic_idea }}</textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">LLM Model</label>
                <select name="llm_model" class="admin-textarea w-full">
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                    <option value="mistral">mistral</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Temperature</label>
                <input type="number" name="temperature" class="admin-textarea w-full" min="0" max="2" step="0.01"
                    value="0.7">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Max Tokens</label>
                <input type="number" name="max_tokens" class="admin-textarea w-full" min="1" max="2048" value="64">
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="llmActionCancel" class="admin-button-secondary">Cancel</button>
                <button type="submit" class="admin-button">Save</button>
                <button type="button" id="llmActionTestBtn" class="admin-button" style="margin-left:1rem;">Test</button>
            </div>
        </form>
        <div id="llmActionTestResult" style="margin-top:1rem; color:#a3e635; display:none;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 'updated-ago' formatter
        document.querySelectorAll('.updated-ago').forEach(el => {
            const iso = el.dataset.updated;
            if (!iso) return;
            const diff = Math.floor((new Date() - new Date(iso)) / 1000);
            let str = diff < 60 ? `${diff} seconds ago`
                : diff < 3600 ? `${Math.floor(diff / 60)} minutes ago`
                    : diff < 86400 ? `${Math.floor(diff / 3600)} hours ago`
                        : diff < 2592000 ? `${Math.floor(diff / 86400)} days ago`
                            : diff < 31536000 ? `${Math.floor(diff / 2592000)} months ago`
                                : `${Math.floor(diff / 31536000)} years ago`;
            el.textContent = str;
        });

        // Accordion toggle
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const open = content.classList.toggle('active');
                header.classList.toggle('active', open);
            });
        });

        // LLM Action selector and Generate button for all fields
        fetch('/api/v1/llm/actions')
            .then(r => r.json())
            .then(actions => {
                const allFields = [
                    'topics_to_cover', 'interesting_facts', 'tartans_products',
                    'section_planning', 'section_headings', 'section_order',
                    'main_title', 'subtitle', 'intro_blurb', 'conclusion',
                    'basic_metadata', 'tags', 'categories', 'image_captions', 'seo_optimization',
                    'self_review', 'peer_review', 'final_check',
                    'scheduling', 'deployment', 'verification',
                    'feedback_collection', 'content_updates', 'version_control',
                    'platform_selection', 'content_adaptation', 'distribution', 'engagement_tracking'
                ];
                allFields.forEach(field => {
                    const sel = document.getElementById('llm-action-select-' + field);
                    const btn = document.getElementById('generate-' + field + '-btn');
                    if (sel && btn) {
                        sel.innerHTML = '<option value="">-- Select Action --</option>';
                        actions.forEach(a => {
                            const opt = document.createElement('option');
                            opt.value = a.id;
                            opt.text = a.field_name;
                            sel.appendChild(opt);
                        });
                        btn.addEventListener('click', async function () {
                            const actionId = sel.value;
                            const ta = document.getElementById(field);
                            if (!actionId) { alert('Please select an LLM Action.'); return; }
                            btn.disabled = true;
                            btn.textContent = 'Generating...';
                            try {
                                const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ input_text: ta.value, post_id: postId })
                                });
                                const js = await res.json();
                                const newValue = typeof js === 'string' ? js : js.response || js.data?.content || '';
                                ta.value = newValue;
                                console.log('LLM response:', js);
                                if (!newValue) {
                                    return;
                                }
                                ta.value = newValue;
                                console.log('About to save:', newValue);
                                try {
                                    const saveRes = await fetch(`/blog/api/v1/posts/${postId}/fields/${field}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ value: newValue })
                                    });
                                    const saveJs = await saveRes.json();
                                    console.log('Save result:', saveJs);
                                } catch (saveErr) {
                                    console.error('Save call failed:', saveErr);
                                }
                            } catch (e) {
                                alert('Error: ' + e.message);
                                console.error('Error:', e);
                            } finally {
                                btn.disabled = false;
                                btn.textContent = 'Generate';
                            }
                        });
                    }
                });
            });

        // Section Order drag-and-drop logic
        const grabBtn = document.getElementById('grab-headings-btn');
        const listDiv = document.getElementById('section-order-list');
        const saveBtn = document.getElementById('save-section-order-btn');
        const sectionOrderTextarea = document.getElementById('section_order');
        const emptyMsg = document.getElementById('section-order-empty');
        const label = document.getElementById('section-order-label');
        if (grabBtn && listDiv && saveBtn && sectionOrderTextarea) {
            let orderArr = [];
            function renderList() {
                listDiv.innerHTML = '';
                if (!orderArr.length) {
                    emptyMsg.style.display = '';
                    label.style.display = 'none';
                    return;
                }
                emptyMsg.style.display = 'none';
                label.style.display = '';
                orderArr.forEach((item, idx) => {
                    const el = document.createElement('div');
                    el.className = 'draggable-item flex items-center gap-2 mb-1 p-2 rounded shadow bg-gray-800 hover:bg-gray-700 transition-all';
                    el.draggable = true;
                    // Drag handle
                    const handle = document.createElement('span');
                    handle.textContent = '☰';
                    handle.className = 'cursor-move text-lg text-gray-400 mr-2';
                    el.appendChild(handle);
                    // Item text
                    const text = document.createElement('span');
                    text.textContent = item;
                    text.className = 'flex-1';
                    el.appendChild(text);
                    // Drag events
                    el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', idx); el.style.opacity = '0.5'; });
                    el.addEventListener('dragend', e => { el.style.opacity = '1'; });
                    el.addEventListener('dragover', e => { e.preventDefault(); el.style.background = '#6366F1'; });
                    el.addEventListener('dragleave', e => { el.style.background = '#1e293b'; });
                    el.addEventListener('drop', e => {
                        e.preventDefault();
                        el.style.background = '#1e293b';
                        const from = +e.dataTransfer.getData('text/plain');
                        if (from !== idx) {
                            const moved = orderArr.splice(from, 1)[0];
                            orderArr.splice(idx, 0, moved);
                            renderList();
                        }
                    });
                    listDiv.appendChild(el);
                });
            }
            // On page load, render from section_order if present
            try {
                const val = sectionOrderTextarea.value.trim();
                if (val) {
                    const arr = JSON.parse(val);
                    if (Array.isArray(arr)) {
                        orderArr = arr.slice();
                        renderList();
                    }
                } else {
                    emptyMsg.style.display = '';
                    label.style.display = 'none';
                }
            } catch (e) {
                emptyMsg.style.display = '';
                label.style.display = 'none';
            }
            grabBtn.onclick = function () {
                try {
                    const headings = JSON.parse(document.getElementById('section_headings').value);
                    if (!Array.isArray(headings)) throw new Error('Not an array');
                    orderArr = headings.slice();
                    renderList();
                } catch (e) {
                    alert('Invalid JSON in Section Headings: ' + e.message);
                }
            };
            saveBtn.onclick = function () {
                sectionOrderTextarea.value = JSON.stringify(orderArr);
                saveGlobalField('section_order');
            };
        }

        // Import Headings logic
        const importBtn = document.getElementById('import-headings-btn');
        if (importBtn) {
            importBtn.onclick = async function () {
                const postId = document.getElementById('stage-accordion').dataset.postId;
                let headings;
                try {
                    headings = JSON.parse(document.getElementById('section_order').value);
                    if (!Array.isArray(headings)) throw new Error('Not an array');
                } catch (e) {
                    alert('Invalid JSON in Section Order: ' + e.message);
                    return;
                }
                if (!headings.length) { alert('No headings to import.'); return; }
                importBtn.disabled = true;
                importBtn.textContent = 'Importing...';
                try {
                    for (let i = 0; i < headings.length; i++) {
                        await fetch(`/blog/api/v1/post/${postId}/sections`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ section_order: i, section_heading: headings[i] })
                        });
                    }
                    location.reload();
                } catch (e) {
                    alert('Failed to import headings: ' + e.message);
                } finally {
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import Headings';
                }
            };
        }

        // Accordion and delete logic for sections
        document.querySelectorAll('.section-block').forEach(block => {
            const header = block.querySelector('.section-accordion-header');
            const content = block.querySelector('.section-accordion-content');
            const chevron = header.querySelector('.chevron');
            if (header && content) {
                content.classList.remove('active');
                header.classList.remove('active');
                chevron.classList.remove('open');
                header.addEventListener('click', function (e) {
                    if (e.target.classList.contains('delete-section-btn')) return;
                    const isOpen = content.classList.contains('active');
                    document.querySelectorAll('.section-accordion-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.section-accordion-header').forEach(h => h.classList.remove('active'));
                    document.querySelectorAll('.chevron').forEach(ch => ch.classList.remove('open'));
                    if (!isOpen) {
                        content.classList.add('active');
                        header.classList.add('active');
                        chevron.classList.add('open');
                    }
                });
            }
            // Delete button logic
            const delBtn = block.querySelector('.delete-section-btn');
            if (delBtn) {
                delBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    if (!confirm('Delete this section?')) return;
                    const sectionId = delBtn.getAttribute('data-section-id');
                    fetch(`/blog/api/v1/section/${sectionId}`, { method: 'DELETE' })
                        .then(r => {
                            if (r.ok) location.reload();
                            else alert('Failed to delete section');
                        })
                        .catch(() => alert('Failed to delete section'));
                });
            }
        });

        // Allocate Ideas to Sections (save as JSON array)
        const allocateBtn = document.getElementById('allocate-ideas-btn');
        if (allocateBtn) {
            allocateBtn.addEventListener('click', async function () {
                try {
                    const actions = await fetch('/api/v1/llm/actions').then(r => r.json());
                    const action = actions.find(a => a.field_name && a.field_name.toLowerCase().includes('allocate ideas'));
                    if (!action) { alert('No Allocate Ideas action found.'); return; }
                    const actionId = action.id;
                    const ideaScope = document.getElementById('idea_scope').value;
                    const sectionOrder = document.getElementById('section_order').value;
                    if (!ideaScope || !sectionOrder) { alert('Missing idea_scope or section_order.'); return; }
                    const postId = document.getElementById('stage-accordion').dataset.postId;
                    const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ input_text: ideaScope, post_id: postId, section_order: sectionOrder })
                    });
                    const js = await res.json();
                    const allocation = typeof js === 'string' ? js : js.response || js.data?.content || '';
                    let parsed;
                    try {
                        parsed = typeof allocation === 'string' ? JSON.parse(allocation) : allocation;
                    } catch (e) {
                        alert('Failed to parse LLM response as JSON.');
                        return;
                    }
                    let anyMatched = false;
                    document.querySelectorAll('.section-block').forEach(block => {
                        const sectionId = block.getAttribute('data-section-id');
                        const heading = block.querySelector('textarea[id^="section_heading_"]').value.trim();
                        const ideas = parsed[heading];
                        if (ideas && Array.isArray(ideas)) {
                            anyMatched = true;
                            const ta = block.querySelector('textarea[id^="ideas_to_include_"]');
                            if (ta) {
                                ta.value = JSON.stringify(ideas, null, 2);
                                fetch(`/blog/api/v1/posts/${postId}/sections/${sectionId}/fields/ideas_to_include`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ value: ta.value })
                                });
                            }
                        }
                    });
                    if (!anyMatched) alert('No section headings matched in LLM response.');
                } catch (err) {
                    alert('Error allocating ideas: ' + err.message);
                }
            });
        }
        // Allocate Facts to Sections (save as JSON array)
        const allocateFactsBtn = document.getElementById('allocate-facts-btn');
        if (allocateFactsBtn) {
            allocateFactsBtn.addEventListener('click', async function () {
                try {
                    const actions = await fetch('/api/v1/llm/actions').then(r => r.json());
                    const action = actions.find(a => a.field_name && a.field_name.toLowerCase().includes('allocate facts'));
                    if (!action) { alert('No Allocate Facts action found.'); return; }
                    const actionId = action.id;
                    const facts = document.getElementById('interesting_facts').value;
                    const sectionOrder = document.getElementById('section_order').value;
                    if (!facts || !sectionOrder) { alert('Missing interesting_facts or section_order.'); return; }
                    const postId = document.getElementById('stage-accordion').dataset.postId;
                    const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ input_text: facts, post_id: postId, section_order: sectionOrder })
                    });
                    const js = await res.json();
                    const allocation = typeof js === 'string' ? js : js.response || js.data?.content || '';
                    let parsed;
                    try {
                        parsed = typeof allocation === 'string' ? JSON.parse(allocation) : allocation;
                    } catch (e) {
                        alert('Failed to parse LLM response as JSON.');
                        return;
                    }
                    let anyMatched = false;
                    document.querySelectorAll('.section-block').forEach(block => {
                        const sectionId = block.getAttribute('data-section-id');
                        const heading = block.querySelector('textarea[id^="section_heading_"]').value.trim();
                        const factsArr = parsed[heading];
                        if (factsArr && Array.isArray(factsArr)) {
                            anyMatched = true;
                            const ta = block.querySelector('textarea[id^="facts_to_include_"]');
                            if (ta) {
                                ta.value = JSON.stringify(factsArr, null, 2);
                                fetch(`/blog/api/v1/posts/${postId}/sections/${sectionId}/fields/facts_to_include`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ value: ta.value })
                                });
                            }
                        }
                    });
                    if (!anyMatched) alert('No section headings matched in LLM response.');
                } catch (err) {
                    alert('Error allocating facts: ' + err.message);
                }
            });
        }

        // Add JS for section content generation
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/api/v1/llm/actions')
                .then(r => r.json())
                .then(actions => {
                    document.querySelectorAll('.generate-section-content-btn').forEach(btn => {
                        const sectionId = btn.getAttribute('data-section-id');
                        const field = btn.getAttribute('data-field');
                        const sel = document.getElementById(`llm-action-select-${field}-${sectionId}`);
                        if (sel) {
                            sel.innerHTML = '<option value="">-- Select Action --</option>';
                            actions.forEach(a => {
                                const opt = document.createElement('option');
                                opt.value = a.id;
                                opt.text = a.field_name;
                                sel.appendChild(opt);
                            });
                        }
                        btn.addEventListener('click', async function () {
                            if (!sel) { alert('No LLM Action selector found.'); return; }
                            const actionId = sel.value;
                            const postId = document.getElementById('stage-accordion').dataset.postId;
                            // Gather global fields
                            const globalFields = {};
                            document.querySelectorAll('.accordion-field textarea').forEach(ta => {
                                globalFields[ta.id] = ta.value;
                            });
                            // Gather section fields
                            const sectionBlock = btn.closest('.section-block');
                            const sectionFields = {};
                            sectionBlock.querySelectorAll('textarea').forEach(ta => {
                                // Remove _<sectionId> from id for key
                                const key = ta.id.replace(/_\d+$/, '');
                                sectionFields[key] = ta.value;
                            });
                            if (!actionId) { alert('Please select an LLM Action.'); return; }
                            // POST to LLM action
                            try {
                                const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        input_text: sectionFields[field] || '',
                                        post_id: postId,
                                        section_id: sectionId,
                                        fields: globalFields,
                                        section_fields: sectionFields
                                    })
                                });
                                const js = await res.json();
                                const newValue = typeof js === 'string' ? js : js.response || js.data?.content || '';
                                if (!newValue) { alert('No content generated.'); return; }
                                sectionBlock.querySelector(`#${field}_${sectionId}`).value = newValue;
                                // Auto-save
                                saveSectionField(sectionId, field);
                            } catch (err) {
                                alert('Error generating content: ' + err.message);
                            }
                        });
                    });
                });
        });
    });

    // Helpers
    const postId = document.getElementById('stage-accordion').dataset.postId;
    function saveGlobalField(field) {
        const value = document.getElementById(field).value;
        fetch(`/blog/api/v1/posts/${postId}/fields/${field}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ value })
        })
            .then(r => r.json())
            .then(d => alert(d.status === 'success' ? 'Saved!' : 'Save failed'))
            .catch(() => alert('Save failed'));
    }

    function saveSectionField(sectionId, field) {
        const el = document.getElementById(`${field}_${sectionId}`);
        const value = el ? el.value : '';
        fetch(`/blog/api/v1/posts/${postId}/sections/${sectionId}/fields/${field}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ value })
        })
            .then(r => r.json())
            .then(d => alert(d.status === 'success' ? 'Saved!' : 'Save failed'))
            .catch(() => alert('Save failed'));
    }

    function addSection() {
        const postId = document.getElementById('stage-accordion').dataset.postId;
        // Find the current number of sections to set the order
        const sectionBlocks = document.querySelectorAll('.section-block');
        const nextOrder = sectionBlocks.length;
        fetch(`/blog/api/v1/post/${postId}/sections`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ section_order: nextOrder, section_heading: 'New Section' })
        })
            .then(r => r.json())
            .then(data => {
                if (data.id) {
                    location.reload();
                } else {
                    alert('Failed to add section');
                }
            })
            .catch(() => alert('Failed to add section'));
    }
</script>
{% endblock %}