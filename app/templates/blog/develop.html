{% extends "base.html" %}

{% block title %}Develop Post{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog.css') }}">
<style>
    .blog-card,
    .admin-card {
        background-color: var(--admin-bg-card, #23272F) !important;
        color: var(--admin-text, #E0E0E0) !important;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--admin-border, #404040);
        padding: 2rem;
    }

    .blog-card__title {
        color: var(--admin-text, #E0E0E0) !important;
    }

    .badge-published {
        background: #166534 !important;
        color: #bbf7d0 !important;
    }

    .badge-draft {
        background: #374151 !important;
        color: #d1d5db !important;
    }

    .badge-deleted {
        background: #7f1d1d !important;
        color: #fecaca !important;
    }

    .admin-button,
    .admin-button-secondary {
        background-color: var(--admin-primary, #1B4B73) !important;
        color: #fff !important;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
    }

    .admin-button-secondary {
        background-color: var(--admin-accent, #6366F1) !important;
    }

    .admin-button:disabled,
    .admin-button-secondary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
    <!-- Card-style header row -->
    <div class="blog-card mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
            <div class="flex-1 min-w-0">
                <a href="{{ url_for('blog.develop', post_id=post.id) }}"
                    class="blog-card__title text-2xl font-bold truncate hover:underline focus:underline"
                    title="Go to Develop">
                    {{ post.title or 'Untitled Post' }}
                </a>
                <div class="flex items-center space-x-2 mt-2">
                    {% if post.published %}
                    <span class="badge-published px-2 py-1 rounded text-xs font-semibold">Published</span>
                    {% else %}
                    <span class="badge-draft px-2 py-1 rounded text-xs font-semibold">Draft</span>
                    {% endif %}
                    {% if post.deleted %}
                    <span class="badge-deleted px-2 py-1 rounded text-xs font-semibold ml-1">Deleted</span>
                    {% endif %}
                </div>
            </div>
            <div class="flex flex-col items-start md:items-end gap-1">
                <div class="text-sm text-gray-400">Created: {{ post.created_at.strftime('%Y-%m-%d') }}</div>
                <div class="text-sm text-gray-400">Updated: <span class="updated-ago"
                        data-updated="{{ post.updated_at.isoformat() if post.updated_at else '' }}">{{
                        post.updated_at.strftime('%Y-%m-%d') if post.updated_at else '' }}</span></div>
            </div>
        </div>
        <div class="flex items-center gap-2 mt-2">
            <a href="{{ url_for('blog.develop', post_id=post.id) }}" class="admin-button" title="Develop">
                <svg class="w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Develop
            </a>
            <a href="{{ url_for('blog.get_post', slug=post.slug) }}" class="admin-button admin-button-secondary"
                title="JSON">
                <svg class="w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 17v-2a2 2 0 012-2h2a2 2 0 012 2v2m-6 4h6a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                JSON
            </a>
        </div>
    </div>

    <!-- Main content (global fields, sections, etc.) -->
    <form id="global-fields-form" class="mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for field, value in dev.__dict__.items() if field not in ['id', 'post_id', '_sa_instance_state'] %}
            <div class="bg-[#23272F] rounded-lg p-4 mb-4 shadow">
                <label for="{{ field }}" class="block text-sm font-semibold mb-2"
                    style="color: var(--admin-text-secondary);">{{ field.replace('_', ' ').title() }}</label>
                <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                    rows="2">{{ value or '' }}</textarea>
                <button type="button" class="admin-button mt-2" onclick="saveGlobalField('{{ field }}')">Save</button>
            </div>
            {% endfor %}
        </div>
    </form>
    <!-- Sections, etc. remain unchanged -->
    <h2 class="text-xl font-semibold mb-4 mt-8 text-center" style="color: var(--admin-text);">Sections</h2>
    {% block sections %}{% endblock %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Format updated date as 'ago'
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.updated-ago').forEach(function (el) {
            const iso = el.dataset.updated;
            if (!iso) return;
            const date = new Date(iso);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            let str = '';
            if (diff < 60) str = diff + ' seconds ago';
            else if (diff < 3600) str = Math.floor(diff / 60) + ' minutes ago';
            else if (diff < 86400) str = Math.floor(diff / 3600) + ' hours ago';
            else if (diff < 2592000) str = Math.floor(diff / 86400) + ' days ago';
            else if (diff < 31536000) str = Math.floor(diff / 2592000) + ' months ago';
            else str = Math.floor(diff / 31536000) + ' years ago';
            el.textContent = str;
        });
    });
</script>
{% endblock %}