{% extends "base.html" %}

{% block title %}Develop Post{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog.css') }}">
<style>
    .blog-card,
    .admin-card {
        background-color: var(--admin-bg-card, #23272F) !important;
        color: var(--admin-text, #E0E0E0) !important;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--admin-border, #404040);
        padding: 2rem;
    }

    .blog-card__title {
        color: var(--admin-text, #E0E0E0) !important;
    }

    .badge-published {
        background: #166534 !important;
        color: #bbf7d0 !important;
    }

    .badge-draft {
        background: #374151 !important;
        color: #d1d5db !important;
    }

    .badge-deleted {
        background: #7f1d1d !important;
        color: #fecaca !important;
    }

    .admin-button,
    .admin-button-secondary {
        background-color: var(--admin-primary, #1B4B73) !important;
        color: #fff !important;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
    }

    .admin-button-secondary {
        background-color: var(--admin-accent, #6366F1) !important;
    }

    .admin-button:disabled,
    .admin-button-secondary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
{% from "blog/_post_header.html" import post_header %}
<div class="max-w-3xl mx-auto py-8">
    <!-- Card-style header row -->
    {{ post_header(post, active_view) }}

    <!-- Main content (global fields, sections, etc.) -->
    <form id="global-fields-form" class="mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for field, value in dev.__dict__.items() if field not in ['id', 'post_id', '_sa_instance_state'] %}
            <div class="bg-[#23272F] rounded-lg p-4 mb-4 shadow">
                <label for="{{ field }}" class="block text-sm font-semibold mb-2"
                    style="color: var(--admin-text-secondary);">{{ field.replace('_', ' ').title() }}</label>
                <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                    rows="2">{{ value or '' }}</textarea>
                <button type="button" class="admin-button mt-2" onclick="saveGlobalField('{{ field }}')">Save</button>
            </div>
            {% endfor %}
        </div>
    </form>
    <!-- Sections, etc. remain unchanged -->
    <h2 class="text-xl font-semibold mb-4 mt-8 text-center" style="color: var(--admin-text);">Sections</h2>
    {% block sections %}{% endblock %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Format updated date as 'ago'
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.updated-ago').forEach(function (el) {
            const iso = el.dataset.updated;
            if (!iso) return;
            const date = new Date(iso);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            let str = '';
            if (diff < 60) str = diff + ' seconds ago';
            else if (diff < 3600) str = Math.floor(diff / 60) + ' minutes ago';
            else if (diff < 86400) str = Math.floor(diff / 3600) + ' hours ago';
            else if (diff < 2592000) str = Math.floor(diff / 86400) + ' days ago';
            else if (diff < 31536000) str = Math.floor(diff / 2592000) + ' months ago';
            else str = Math.floor(diff / 31536000) + ' years ago';
            el.textContent = str;
        });
    });
    // Add missing saveGlobalField, saveSectionField, addSection
    const postId = {{ post.id }};
    function saveGlobalField(field) {
        const value = document.getElementById(field).value;
        fetch(`/blog/api/v1/post/${postId}/development`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: value })
        }).then(r => r.json()).then(data => {
            alert('Saved!');
            if (data.updated_at) {
                document.querySelectorAll('.updated-ago').forEach(function (updatedEl) {
                    updatedEl.dataset.updated = data.updated_at;
                    // Re-run the ago formatting logic
                    const iso = data.updated_at;
                    const date = new Date(iso);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000);
                    let str = '';
                    if (diff < 60) str = diff + ' seconds ago';
                    else if (diff < 3600) str = Math.floor(diff / 60) + ' minutes ago';
                    else if (diff < 86400) str = Math.floor(diff / 3600) + ' hours ago';
                    else if (diff < 2592000) str = Math.floor(diff / 86400) + ' days ago';
                    else if (diff < 31536000) str = Math.floor(diff / 2592000) + ' months ago';
                    else str = Math.floor(diff / 31536000) + ' years ago';
                    updatedEl.textContent = str;
                });
            }
        });
    }
    function saveSectionField(sectionId, field) {
        const value = document.getElementById(`${field}_${sectionId}`).value;
        fetch(`/blog/api/v1/section/${sectionId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: value })
        }).then(r => r.json()).then(data => {
            alert('Saved!');
        });
    }
    function addSection() {
        fetch(`/blog/api/v1/post/${postId}/sections`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        }).then(r => r.json()).then(data => {
            location.reload();
        });
    }
</script>
{% endblock %}