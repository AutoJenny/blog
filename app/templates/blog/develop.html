{% extends "base.html" %}

{% block title %}Develop Post (New){% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog.css') }}">
<style>
    .blog-card,
    .admin-card {
        background-color: var(--admin-bg-card, #23272F) !important;
        color: var(--admin-text, #E0E0E0) !important;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--admin-border, #404040);
        padding: 2rem;
    }

    .blog-card__title {
        color: var(--admin-text, #E0E0E0) !important;
    }

    .badge-published {
        background: #166534 !important;
        color: #bbf7d0 !important;
    }

    .badge-draft {
        background: #374151 !important;
        color: #d1d5db !important;
    }

    .badge-deleted {
        background: #7f1d1d !important;
        color: #fecaca !important;
    }

    .admin-button,
    .admin-button-secondary {
        background-color: var(--admin-primary, #1B4B73) !important;
        color: #fff !important;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
    }

    .admin-button-secondary {
        background-color: var(--admin-accent, #6366F1) !important;
    }

    .admin-button:disabled,
    .admin-button-secondary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .accordion-panel {
        border-radius: 1rem;
        overflow: hidden;
        background: var(--admin-bg-card, #23272F);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        border: 1px solid var(--admin-border, #404040);
    }

    .accordion-header {
        width: 100%;
        text-align: left;
        background: var(--admin-accent, #6366F1);
        color: #fff;
        font-size: 1.2rem;
        font-weight: 600;
        padding: 1rem 2rem;
        border: none;
        outline: none;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid var(--admin-border, #404040);
    }

    .accordion-header:hover,
    .accordion-header:focus {
        background: #4f46e5;
    }

    .accordion-header.active {
        background: #312e81;
    }

    .accordion-content {
        display: none;
        padding: 1.5rem 2rem 2rem 2rem;
        background: transparent;
    }

    .accordion-content.active {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .accordion-field {
        margin-bottom: 1.5rem;
    }

    .section-block {
        margin-bottom: 2rem;
        border: 1px solid var(--admin-border, #404040);
        background: #23272F;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
{% from "blog/_post_header.html" import post_header %}
<div class="max-w-3xl mx-auto py-8">
    {{ post_header(post, active_view) }}
    <div id="stage-accordion" class="space-y-4" data-post-id="{{ post.id }}">

        {# IDEA STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="idea">Idea Stage</button>
            <div class="accordion-content">
                {% for field in ['basic_idea', 'idea_scope', 'provisional_title'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>

                    {% if field == 'idea_scope' %}
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-idea-scope" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-idea-scope-btn" class="admin-button">Generate</button>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            fetch('/api/v1/llm/actions')
                                .then(r => r.json())
                                .then(actions => {
                                    const sel = document.getElementById('llm-action-select-idea-scope');
                                    sel.innerHTML = '<option value="">-- Select Action --</option>';
                                    actions.forEach(a => {
                                        const opt = document.createElement('option');
                                        opt.value = a.id;
                                        opt.text = a.field_name;
                                        sel.appendChild(opt);
                                    });
                                });
                            document.getElementById('generate-idea-scope-btn').addEventListener('click', async function () {
                                const sel = document.getElementById('llm-action-select-idea-scope');
                                const actionId = sel.value;
                                const ta = document.getElementById('idea_scope');
                                if (!actionId) { alert('Please select an LLM Action.'); return; }
                                const postId = document.getElementById('stage-accordion').dataset.postId;
                                this.disabled = true;
                                this.textContent = 'Generating...';
                                try {
                                    const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ input_text: ta.value, post_id: postId })
                                    });
                                    const js = await res.json();
                                    ta.value = js.response || js.data?.content || ta.value;
                                } catch (e) {
                                    alert('Error generating content: ' + e.message);
                                } finally {
                                    this.disabled = false;
                                    this.textContent = 'Generate';
                                }
                            });
                        });
                    </script>
                    {% endif %}

                    {% if field == 'provisional_title' %}
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-provisional-title" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-provisional-title-btn" class="admin-button">Generate</button>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            fetch('/api/v1/llm/actions')
                                .then(r => r.json())
                                .then(actions => {
                                    const sel = document.getElementById('llm-action-select-provisional-title');
                                    sel.innerHTML = '<option value="">-- Select Action --</option>';
                                    actions.forEach(a => {
                                        const opt = document.createElement('option');
                                        opt.value = a.id;
                                        opt.text = a.field_name;
                                        sel.appendChild(opt);
                                    });
                                });
                            document.getElementById('generate-provisional-title-btn').addEventListener('click', async function () {
                                const sel = document.getElementById('llm-action-select-provisional-title');
                                const actionId = sel.value;
                                const ta = document.getElementById('provisional_title');
                                if (!actionId) { alert('Please select an LLM Action.'); return; }
                                const postId = document.getElementById('stage-accordion').dataset.postId;
                                this.disabled = true;
                                this.textContent = 'Generating...';
                                try {
                                    const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ input_text: ta.value, post_id: postId })
                                    });
                                    const js = await res.json();
                                    ta.value = js.response || js.data?.content || ta.value;
                                } catch (e) {
                                    alert('Error generating content: ' + e.message);
                                } finally {
                                    this.disabled = false;
                                    this.textContent = 'Generate';
                                }
                            });
                        });
                    </script>
                    {% endif %}

                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# RESEARCH STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="research">Research Stage</button>
            <div class="accordion-content">
                {% for field in ['topics_to_cover', 'interesting_facts', 'tartans_products'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# OUTLINING STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="outlining">Outlining Stage</button>
            <div class="accordion-content">
                {% for field in ['section_planning', 'section_headings'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
                {% if 'section_order' in dev.__dict__ %}
                <div class="accordion-field">
                    <label class="block text-sm font-semibold mb-2">Section Order</label>
                    <button type="button" class="admin-button mb-2" id="grab-headings-btn">Grab Headings</button>
                    <div id="section-order-label" class="text-xs text-gray-400 mb-1">Drag to reorder</div>
                    <div id="section-order-list" class="mb-2"></div>
                    <div id="section-order-empty" class="text-gray-500 text-sm mb-2" style="display:none;">No section
                        order yet. Click 'Grab Headings' to start.</div>
                    <button type="button" class="admin-button" id="save-section-order-btn">Save</button>
                    <textarea id="section_order" name="section_order" class="admin-textarea" rows="2"
                        style="display:none;">{{ dev.section_order or '' }}</textarea>
                </div>
                {% endif %}
            </div>
        </div>

        {# AUTHORING (SECTIONS) STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="authoring">Authoring Stage (Sections)</button>
            <div class="accordion-content">
                <div id="sections">
                    {% for section in sections %}
                    <div class="section-block rounded-lg p-4 mb-6 shadow" data-section-id="{{ section.id }}">
                        <h3 class="text-lg font-semibold mb-2" style="color: var(--admin-accent);">
                            Section {{ loop.index }}: {{ section.section_heading or '' }}
                        </h3>
                        <label class="block text-sm font-semibold mb-1" style="color: var(--admin-text-secondary);">
                            Section Heading
                        </label>
                        <textarea id="section_heading_{{ section.id }}"
                            class="admin-textarea mb-2">{{ section.section_heading or '' }}</textarea>
                        <button type="button" class="admin-button mb-2"
                            onclick="saveSectionField({{ section.id }}, 'section_heading')">Save</button><br>
                        {% for field in ['first_draft', 'uk_british', 'highlighting', 'image_concepts', 'image_prompts',
                        'generation', 'optimization', 'watermarking', 'image_meta_descriptions', 'image_captions'] %}
                        {% if field in section.__dict__ %}
                        <label for="{{ field }}_{{ section.id }}" class="block text-sm font-semibold mb-1"
                            style="color: var(--admin-text-secondary);">
                            {{ field.replace('_', ' ').title() }}
                        </label>
                        <textarea id="{{ field }}_{{ section.id }}"
                            class="admin-textarea mb-2">{{ section.__dict__[field] or '' }}</textarea>
                        <button type="button" class="admin-button mb-2"
                            onclick="saveSectionField({{ section.id }}, '{{ field }}')">Save</button><br>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                <div class="flex justify-center mt-6">
                    <button type="button" class="admin-button" onclick="addSection()">Add Section</button>
                </div>
            </div>
        </div>

        {# TOP & TAIL STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="topntail">Top & Tail Stage</button>
            <div class="accordion-content">
                {% for field in ['main_title', 'subtitle', 'intro_blurb', 'conclusion'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# METADATA STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="metadata">Metadata Stage</button>
            <div class="accordion-content">
                {% for field in ['basic_metadata', 'tags', 'categories', 'image_captions', 'seo_optimization'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# REVIEW STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="review">Review Stage</button>
            <div class="accordion-content">
                {% for field in ['self_review', 'peer_review', 'final_check'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# PUBLISHING STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="publishing">Publishing Stage</button>
            <div class="accordion-content">
                {% for field in ['scheduling', 'deployment', 'verification'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# UPDATES STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="updates">Updates Stage</button>
            <div class="accordion-content">
                {% for field in ['feedback_collection', 'content_updates', 'version_control'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        {# SYNDICATION STAGE #}
        <div class="accordion-panel">
            <button class="accordion-header" data-accordion="syndication">Syndication Stage</button>
            <div class="accordion-content">
                {% for field in ['platform_selection', 'content_adaptation', 'distribution', 'engagement_tracking'] %}
                {% if field in dev.__dict__ %}
                <div class="accordion-field">
                    <label for="{{ field }}" class="block text-sm font-semibold mb-2">
                        {{ field.replace('_', ' ').title() }}
                    </label>
                    <textarea id="{{ field }}" name="{{ field }}" class="admin-textarea"
                        rows="2">{{ dev.__dict__[field] or '' }}</textarea>
                    <div class="flex gap-2 items-center mt-2">
                        <select id="llm-action-select-{{ field }}" class="admin-textarea"
                            style="max-width:220px;"></select>
                        <button type="button" id="generate-{{ field }}-btn" class="admin-button">Generate</button>
                    </div>
                    <button type="button" class="admin-button mt-2"
                        onclick="saveGlobalField('{{ field }}')">Save</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<div id="llmActionModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="bg-[#23272F] rounded-lg shadow-lg p-8 w-full max-w-lg relative">
        <h2 class="text-xl font-semibold mb-4">Configure LLM Action</h2>
        <form id="llmActionForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Source Field</label>
                <select name="source_field" class="admin-textarea w-full">
                    {% for stage, fields in workflow_fields.items() %}
                    <optgroup label="{{ stage }}">
                        {% for wf in fields %}
                        <option value="{{ wf }}" {% if wf==field %}selected{% endif %}>{{ wf.replace('_', ' ').title()
                            }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Prompt Template</label>
                <textarea name="prompt_template" class="admin-textarea w-full"
                    rows="3">Suggest a catchy title for: {{ basic_idea }}</textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">LLM Model</label>
                <select name="llm_model" class="admin-textarea w-full">
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                    <option value="mistral">mistral</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Temperature</label>
                <input type="number" name="temperature" class="admin-textarea w-full" min="0" max="2" step="0.01"
                    value="0.7">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-1">Max Tokens</label>
                <input type="number" name="max_tokens" class="admin-textarea w-full" min="1" max="2048" value="64">
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="llmActionCancel" class="admin-button-secondary">Cancel</button>
                <button type="submit" class="admin-button">Save</button>
                <button type="button" id="llmActionTestBtn" class="admin-button" style="margin-left:1rem;">Test</button>
            </div>
        </form>
        <div id="llmActionTestResult" style="margin-top:1rem; color:#a3e635; display:none;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 'updated-ago' formatter
        document.querySelectorAll('.updated-ago').forEach(el => {
            const iso = el.dataset.updated;
            if (!iso) return;
            const diff = Math.floor((new Date() - new Date(iso)) / 1000);
            let str = diff < 60 ? `${diff} seconds ago`
                : diff < 3600 ? `${Math.floor(diff / 60)} minutes ago`
                    : diff < 86400 ? `${Math.floor(diff / 3600)} hours ago`
                        : diff < 2592000 ? `${Math.floor(diff / 86400)} days ago`
                            : diff < 31536000 ? `${Math.floor(diff / 2592000)} months ago`
                                : `${Math.floor(diff / 31536000)} years ago`;
            el.textContent = str;
        });

        // Accordion toggle
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const open = content.classList.toggle('active');
                header.classList.toggle('active', open);
            });
        });

        // LLM Action selector and Generate button for all fields
        fetch('/api/v1/llm/actions')
            .then(r => r.json())
            .then(actions => {
                const allFields = [
                    'topics_to_cover', 'interesting_facts', 'tartans_products',
                    'section_planning', 'section_headings', 'section_order',
                    'main_title', 'subtitle', 'intro_blurb', 'conclusion',
                    'basic_metadata', 'tags', 'categories', 'image_captions', 'seo_optimization',
                    'self_review', 'peer_review', 'final_check',
                    'scheduling', 'deployment', 'verification',
                    'feedback_collection', 'content_updates', 'version_control',
                    'platform_selection', 'content_adaptation', 'distribution', 'engagement_tracking'
                ];
                allFields.forEach(field => {
                    const sel = document.getElementById('llm-action-select-' + field);
                    const btn = document.getElementById('generate-' + field + '-btn');
                    if (sel && btn) {
                        sel.innerHTML = '<option value="">-- Select Action --</option>';
                        actions.forEach(a => {
                            const opt = document.createElement('option');
                            opt.value = a.id;
                            opt.text = a.field_name;
                            sel.appendChild(opt);
                        });
                        btn.addEventListener('click', async function () {
                            const actionId = sel.value;
                            const ta = document.getElementById(field);
                            if (!actionId) { alert('Please select an LLM Action.'); return; }
                            btn.disabled = true;
                            btn.textContent = 'Generating...';
                            try {
                                const res = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ input_text: ta.value, post_id: postId })
                                });
                                const js = await res.json();
                                ta.value = js.response || js.data?.content || ta.value;
                                saveGlobalField(field);
                            } catch (e) {
                                alert('Error generating content: ' + e.message);
                            } finally {
                                btn.disabled = false;
                                btn.textContent = 'Generate';
                            }
                        });
                    }
                });
            });

        // Section Order drag-and-drop logic
        const grabBtn = document.getElementById('grab-headings-btn');
        const listDiv = document.getElementById('section-order-list');
        const saveBtn = document.getElementById('save-section-order-btn');
        const sectionOrderTextarea = document.getElementById('section_order');
        const emptyMsg = document.getElementById('section-order-empty');
        const label = document.getElementById('section-order-label');
        if (grabBtn && listDiv && saveBtn && sectionOrderTextarea) {
            let orderArr = [];
            function renderList() {
                listDiv.innerHTML = '';
                if (!orderArr.length) {
                    emptyMsg.style.display = '';
                    label.style.display = 'none';
                    return;
                }
                emptyMsg.style.display = 'none';
                label.style.display = '';
                orderArr.forEach((item, idx) => {
                    const el = document.createElement('div');
                    el.className = 'draggable-item flex items-center gap-2 mb-1 p-2 rounded shadow bg-gray-800 hover:bg-gray-700 transition-all';
                    el.draggable = true;
                    // Drag handle
                    const handle = document.createElement('span');
                    handle.textContent = '☰';
                    handle.className = 'cursor-move text-lg text-gray-400 mr-2';
                    el.appendChild(handle);
                    // Item text
                    const text = document.createElement('span');
                    text.textContent = item;
                    text.className = 'flex-1';
                    el.appendChild(text);
                    // Drag events
                    el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', idx); el.style.opacity = '0.5'; });
                    el.addEventListener('dragend', e => { el.style.opacity = '1'; });
                    el.addEventListener('dragover', e => { e.preventDefault(); el.style.background = '#6366F1'; });
                    el.addEventListener('dragleave', e => { el.style.background = '#1e293b'; });
                    el.addEventListener('drop', e => {
                        e.preventDefault();
                        el.style.background = '#1e293b';
                        const from = +e.dataTransfer.getData('text/plain');
                        if (from !== idx) {
                            const moved = orderArr.splice(from, 1)[0];
                            orderArr.splice(idx, 0, moved);
                            renderList();
                        }
                    });
                    listDiv.appendChild(el);
                });
            }
            // On page load, render from section_order if present
            try {
                const val = sectionOrderTextarea.value.trim();
                if (val) {
                    const arr = JSON.parse(val);
                    if (Array.isArray(arr)) {
                        orderArr = arr.slice();
                        renderList();
                    }
                } else {
                    emptyMsg.style.display = '';
                    label.style.display = 'none';
                }
            } catch (e) {
                emptyMsg.style.display = '';
                label.style.display = 'none';
            }
            grabBtn.onclick = function () {
                try {
                    const headings = JSON.parse(document.getElementById('section_headings').value);
                    if (!Array.isArray(headings)) throw new Error('Not an array');
                    orderArr = headings.slice();
                    renderList();
                } catch (e) {
                    alert('Invalid JSON in Section Headings: ' + e.message);
                }
            };
            saveBtn.onclick = function () {
                sectionOrderTextarea.value = JSON.stringify(orderArr);
                saveGlobalField('section_order');
            };
        }
    });

    // Helpers
    const postId = document.getElementById('stage-accordion').dataset.postId;
    function saveGlobalField(field) {
        const value = document.getElementById(field).value;
        fetch(`/blog/api/v1/posts/${postId}/fields/${field}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ value })
        })
            .then(r => r.json())
            .then(d => alert(d.status === 'success' ? 'Saved!' : 'Save failed'))
            .catch(() => alert('Save failed'));
    }

    function saveSectionField(sectionId, field) {
        const el = document.getElementById(`${field}_${sectionId}`);
        const value = el ? el.value : '';
        fetch(`/blog/api/v1/posts/${postId}/sections/${sectionId}/fields/${field}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ value })
        })
            .then(r => r.json())
            .then(d => alert(d.status === 'success' ? 'Saved!' : 'Save failed'))
            .catch(() => alert('Save failed'));
    }

    function addSection() {
        // Implementation left as before
    }
</script>
{% endblock %}