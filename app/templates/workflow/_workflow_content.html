<!-- Workflow Content Module -->
<div class="space-y-4">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-dark-text">
            {% block step_heading %}{{ step_config.title }}{% endblock %}
        </h2>
        <button id="run-llm" class="bg-dark-accent text-white px-4 py-2 rounded-lg hover:bg-dark-hover transition">
            Run LLM
        </button>
    </div>

    {% block step_description %}
    {% if step_config.description %}
    <p class="text-gray-400 mb-6">{{ step_config.description }}</p>
    {% endif %}
    {% endblock %}

    <!-- Inputs Accordion -->
    <div class="border border-dark-border rounded-lg overflow-hidden">
        <button class="w-full flex justify-between items-center p-4 bg-dark-bg hover:bg-dark-hover focus:outline-none"
            onclick="document.getElementById('inputs-content').classList.toggle('hidden'); document.getElementById('inputs-icon').classList.toggle('rotate-180');">
            <span class="font-medium text-dark-text">Inputs</span>
            <span class="text-gray-400" id="inputs-summary">
                {% if step_config.inputs %}
                {% set ns = namespace(summary='') %}
                {% for input_id, input_config in step_config.inputs.items() %}
                {% set val = input_values[input_id] if input_values and input_id in input_values else 'â€”' %}
                {% if not loop.first %}{% set ns.summary = ns.summary + ', ' %}{% endif %}
                {% set first_line = val.split('\n')[0] if val else '' %}
                {% set ns.summary = ns.summary + '<span class=\"text-blue-500\">[' + input_id + ']</span>: ' +
                first_line %}
                {% endfor %}
                {{ ns.summary|safe }}
                {% else %}
                No inputs configured
                {% endif %}
            </span>
            <svg class="w-5 h-5 transform transition-transform" id="inputs-icon" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        <div id="inputs-content" class="hidden p-4 bg-dark-bg text-dark-text">
            {% if step_config.inputs %}
            {% for input_id, input_config in step_config.inputs.items() %}
            <div class="mb-4">
                <label for="{{ input_id }}" class="block text-sm font-medium text-blue-500 mb-2">
                    [{{ input_id }}] {{ input_config.label }}
                </label>
                <div class="text-xs text-gray-400 mb-1">
                    Type: {{ input_config.type }}{% if input_config.db_field %}, DB Field: {{ input_config.db_field }}{%
                    endif %}{% if input_config.db_table %}, Table: {{ input_config.db_table }}{% endif %}{% if
                    input_config.required %}, Required{% endif %}
                </div>
                {% if input_config.type == 'textarea' %}
                <textarea id="{{ input_id }}" name="{{ input_id }}"
                    class="w-full h-32 bg-gray-900 text-gray-200 rounded-lg p-4 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    data-db-field="{{ input_config.db_field }}"
                    data-db-table="{{ input_config.db_table }}">{{ input_values[input_id] if input_values and input_id in input_values else '' }}</textarea>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400">No inputs configured for this step.</p>
            {% endif %}
        </div>
    </div>

    <!-- Prompt Accordion -->
    <div class="border border-dark-border rounded-lg overflow-hidden">
        <button class="w-full flex justify-between items-center p-4 bg-dark-bg hover:bg-dark-hover focus:outline-none"
            onclick="document.getElementById('prompt-content').classList.toggle('hidden'); document.getElementById('prompt-icon').classList.toggle('rotate-180');">
            <span class="font-medium text-dark-text">Prompt</span>
            <span class="text-gray-400" id="prompt-summary">
                {% if step_config.settings and step_config.settings.llm and step_config.settings.llm.task_prompt %}
                {{ step_config.settings.llm.task_prompt.split('\n')[0]|truncate(50) }}
                {% elif step_config.prompt and step_config.prompt.template %}
                {{ step_config.prompt.template.split('\n')[0]|truncate(50) }}
                {% else %}
                No prompt configured
                {% endif %}
            </span>
            <svg class="w-5 h-5 transform transition-transform" id="prompt-icon" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        <div id="prompt-content" class="hidden p-4 bg-dark-bg text-dark-text">
            {% set llm = step_config.settings.llm if step_config.settings and step_config.settings.llm else None %}
            {% if llm %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-blue-500 mb-2">System Prompt</label>
                <textarea id="system-prompt"
                    class="w-full h-32 bg-gray-900 text-gray-200 rounded-lg p-4 mb-4">{{ llm.system_prompt }}</textarea>
                <label class="block text-sm font-medium text-blue-500 mb-2">Task Prompt</label>
                <textarea id="task-prompt"
                    class="w-full h-32 bg-gray-900 text-gray-200 rounded-lg p-4">{{ llm.task_prompt }}</textarea>
                <button id="save-prompt" class="btn btn-primary mt-4">Save Prompt</button>
            </div>
            {% elif step_config.prompt and step_config.prompt.template %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-blue-500 mb-2">Prompt Template</label>
                <textarea id="prompt-template"
                    class="w-full h-32 bg-gray-900 text-gray-200 rounded-lg p-4">{{ step_config.prompt.template }}</textarea>
                <button id="save-prompt" class="btn btn-primary mt-4">Save Prompt</button>
            </div>
            {% else %}
            <p class="text-gray-400">No prompt configured for this step.</p>
            {% endif %}
        </div>
    </div>

    <!-- Settings Accordion -->
    <div class="border border-dark-border rounded-lg overflow-hidden">
        <button class="w-full flex justify-between items-center p-4 bg-dark-bg hover:bg-dark-hover focus:outline-none"
            onclick="document.getElementById('settings-content').classList.toggle('hidden'); document.getElementById('settings-icon').classList.toggle('rotate-180');">
            <span class="font-medium text-dark-text">Settings</span>
            <span class="text-gray-400" id="settings-summary">
                {% if step_config.settings and step_config.settings.llm %}
                <span class="text-blue-500">Provider:</span> {{ step_config.settings.llm.provider }},
                <span class="text-blue-500">Model:</span> {{ step_config.settings.llm.model }}
                {% if step_config.settings.llm.parameters %}
                , <span class="text-blue-500">Temp:</span> {{ step_config.settings.llm.parameters.temperature }},
                <span class="text-blue-500">Max tokens:</span> {{ step_config.settings.llm.parameters.max_tokens }}
                {% endif %}
                {% elif step_config.settings %}
                {{ step_config.settings|length }} setting{{ 's' if step_config.settings|length != 1 else '' }}
                configured
                {% else %}
                No settings configured
                {% endif %}
            </span>
            <svg class="w-5 h-5 transform transition-transform" id="settings-icon" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        <div id="settings-content" class="hidden p-4 bg-dark-bg text-dark-text">
            {% if step_config.settings and step_config.settings.llm %}
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-blue-500">Provider</label>
                    <input type="text" value="{{ step_config.settings.llm.provider }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-500">Model</label>
                    <input type="text" value="{{ step_config.settings.llm.model }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                {% if step_config.settings.llm.parameters %}
                <div>
                    <label class="block text-sm font-medium text-blue-500">Temperature</label>
                    <input type="text" value="{{ step_config.settings.llm.parameters.temperature }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-500">Max tokens</label>
                    <input type="text" value="{{ step_config.settings.llm.parameters.max_tokens }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-500">Top P</label>
                    <input type="text" value="{{ step_config.settings.llm.parameters.top_p }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-500">Frequency Penalty</label>
                    <input type="text" value="{{ step_config.settings.llm.parameters.frequency_penalty }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-500">Presence Penalty</label>
                    <input type="text" value="{{ step_config.settings.llm.parameters.presence_penalty }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                {% endif %}
            </div>
            {% elif step_config.settings %}
            <div class="grid grid-cols-2 gap-4">
                {% for setting, value in step_config.settings.items() %}
                <div>
                    <label class="block text-sm font-medium text-blue-500">{{ setting }}</label>
                    <input type="text" value="{{ value }}"
                        class="mt-1 bg-dark-bg border border-dark-border rounded p-2 w-full text-dark-text" readonly>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-400">No settings configured for this step.</p>
            {% endif %}
        </div>
    </div>

    <!-- Outputs Accordion (summary is truncated, not first line) -->
    <div class="border border-dark-border rounded-lg overflow-hidden">
        <button class="w-full flex justify-between items-center p-4 bg-dark-bg hover:bg-dark-hover focus:outline-none"
            onclick="document.getElementById('outputs-content-unique').classList.toggle('hidden'); document.getElementById('outputs-icon-unique').classList.toggle('rotate-180');">
            <span class="font-medium text-dark-text">Outputs</span>
            <span class="text-gray-400" id="outputs-summary-unique">
                {% set val = output_values['basic_idea'] if output_values and 'basic_idea' in output_values else 'â€”' %}
                {% set summary = val[:80] ~ ('...' if val|length > 80 else '') %}
                <span class="text-blue-500">[basic_idea]</span>: {{ summary }}
            </span>
            <svg class="w-5 h-5 transform transition-transform" id="outputs-icon-unique" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        <div id="outputs-content-unique" class="hidden p-4 bg-dark-bg text-dark-text">
            <div class="mb-4">
                <label for="basic_idea" class="block text-sm font-medium text-blue-500 mb-2">
                    [basic_idea] Basic Idea
                </label>
                <div class="text-xs text-gray-400 mb-1">
                    Type: text, DB Field: basic_idea, Table: post_development
                </div>
                <div class="bg-gray-900 text-gray-200 rounded-lg p-4 border border-gray-300 whitespace-pre-wrap">
                    {{ output_values['basic_idea'] if output_values and 'basic_idea' in output_values else '' }}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    window.postId = {{ post_id | tojson }};
    window.currentStep = {{ current_step | tojson }};
    window.currentSubstage = {{ current_substage | tojson }};
    window.currentStage = {{ current_stage | tojson }};
    window.originalPrompt = {{ (step_config.prompt.template if step_config.prompt and step_config.prompt.template else step_config.settings.llm.task_prompt if step_config.settings and step_config.settings.llm and step_config.settings.llm.task_prompt else "")| tojson }};

    // Save prompt changes
    document.getElementById('save-prompt').addEventListener('click', function () {
        const systemPrompt = document.getElementById('system-prompt').value;
        const taskPrompt = document.getElementById('task-prompt').value;
        savePrompt(systemPrompt, taskPrompt);
    });

    function savePrompt(systemPrompt, taskPrompt) {
        fetch(`/workflow/{{ post_id }}/{{ current_stage }}/{{ current_substage }}/{{ current_step }}/save_prompt`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                system_prompt: systemPrompt,
                task_prompt: taskPrompt
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the summary text
                    document.getElementById('prompt-summary').textContent = taskPrompt.split('\n')[0].substring(0, 50) + '...';
                    // Show success message
                    alert('Prompt saved successfully');
                } else {
                    alert('Error saving prompt: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving prompt');
            });
    }

    function toggleOutputAccordion(outputId) {
        // Close all
        document.querySelectorAll('[id^="output-content-"]').forEach(function (el) {
            el.classList.add('hidden');
        });
        document.querySelectorAll('[id^="icon-"]').forEach(function (icon) {
            icon.classList.remove('rotate-180');
        });
        // Open selected
        var content = document.getElementById('output-content-' + outputId);
        var icon = document.getElementById('icon-' + outputId);
        if (content && content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            if (icon) icon.classList.add('rotate-180');
        }
    }
</script>
<script src="{{ url_for('static', filename='js/workflow.js') }}"></script>