{% extends "workflow/steps/planning_step.html" %}

{% block step_heading %}
<h1 class="text-3xl font-bold mb-6 text-dark-text">
    Planning: Provisional Title{% if post and post.title %}: {{ post.title }}{% endif %}
</h1>
{% endblock %}

{% block step_description %}
<p class="text-gray-400 mb-6">Generate and select a provisional title for your post.</p>
{% endblock %}

{% block workflow_scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}

{% block step_content %}
<div class="space-y-6">
    <!-- Output List -->
    <div class="bg-gray-900 rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-4 text-dark-text">Generated Titles</h3>
        <ul id="output-list" class="space-y-2">
            {% if output_titles %}
            {% for title in output_titles %}
            <li
                class="flex items-center space-x-2 p-2 bg-gray-800 rounded cursor-move {% if loop.first %}font-bold text-green-400{% endif %}">
                <span class="handle cursor-move text-gray-400">⋮⋮</span>
                <span class="title-text flex-grow">{{ title }}</span>
                <span class="primary-label text-sm text-gray-400">{% if loop.first %}(Primary){% endif %}</span>
            </li>
            {% endfor %}
            {% else %}
            <li class="text-gray-400">No titles generated yet. Click "Run LLM" to generate titles.</li>
            {% endif %}
        </ul>
    </div>

    <!-- Run LLM Button -->
    <button onclick="runLLM()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Run LLM
    </button>
</div>

<script>
    function runLLM() {
        const postId = {{ post_id| tojson
    }};
    const stageName = {{ current_stage| tojson }};
    const substageName = {{ current_substage| tojson }};
    const stepName = {{ current_step| tojson }};
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Running...';
    fetch('/workflow/api/run_llm/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            post_id: postId,
            stage_name: stageName,
            substage_name: substageName,
            step_name: stepName
        })
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('LLM error: ' + (data.error || 'Unknown error'));
                btn.disabled = false;
                btn.textContent = 'Run LLM';
            }
        })
        .catch(err => {
            alert('Request failed: ' + err);
            btn.disabled = false;
            btn.textContent = 'Run LLM';
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        var el = document.getElementById('output-list');
        if (el) {
            var sortable = Sortable.create(el, {
                handle: '.handle',
                animation: 150,
                onEnd: function () {
                    var items = Array.from(el.children).map(li => li.querySelector('.title-text').textContent);
                    fetch('/workflow/api/update_title_order/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            post_id: {{ post_id| tojson }},
                titles: items
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Update the primary label
                el.querySelectorAll('li').forEach((li, index) => {
                    if (index === 0) {
                        li.classList.add('font-bold', 'text-green-400');
                        li.querySelector('.primary-label').textContent = '(Primary)';
                    } else {
                        li.classList.remove('font-bold', 'text-green-400');
                        li.querySelector('.primary-label').textContent = '';
                    }
                });
            } else {
                alert('Error saving order: ' + (data.error || 'Unknown error'));
            }
        });
                }
            });
        }
    });
</script>
{% endblock %}