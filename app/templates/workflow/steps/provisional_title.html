{% extends "workflow/steps/planning_step.html" %}

{% block step_heading %}
<h1 class="text-3xl font-bold mb-6 text-dark-text">
    Planning: Provisional Title{% if post and post.title %}: {{ post.title }}{% endif %}
</h1>
{% endblock %}

{% block step_description %}
<p class="text-gray-400 mb-6">Generate and select a provisional title for your post.</p>
{% endblock %}

<script>
    function runLLM() {
        const postId = {{ post_id| tojson
    }};
    const stageName = {{ current_stage| tojson }};
    const substageName = {{ current_substage| tojson }};
    const stepName = {{ current_step| tojson }};
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Running...';
    fetch('/workflow/api/run_llm/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            post_id: postId,
            stage_name: stageName,
            substage_name: substageName,
            step_name: stepName
        })
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('LLM error: ' + (data.error || 'Unknown error'));
                btn.disabled = false;
                btn.textContent = 'Run LLM';
            }
        })
        .catch(err => {
            alert('Request failed: ' + err);
            btn.disabled = false;
            btn.textContent = 'Run LLM';
        });
    }

    function saveTitleOrder() {
        var el = document.getElementById('output-list');
        if (el) {
            var items = Array.from(el.children).map(li => li.querySelector('.title-text').textContent);
            fetch('/workflow/api/update_title_order/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    post_id: 22,
                    titles: items
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Order saved successfully!');
                    } else {
                        alert('Error saving order: ' + (data.error || 'Unknown error'));
                    }
                });
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        var el = document.getElementById('output-list');
        if (el) {
            var sortable = Sortable.create(el, {
                handle: '.handle',
                animation: 150,
                onEnd: function () {
                    var items = Array.from(el.children).map(li => li.querySelector('.title-text').textContent);
                    fetch('/workflow/api/update_title_order/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            post_id: 22,
                            titles: items
                        })
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Update the primary label
                                el.querySelectorAll('li').forEach((li, index) => {
                                    if (index === 0) {
                                        li.classList.add('font-bold', 'text-green-400');
                                        li.querySelector('.primary-label').textContent = '(Primary)';
                                    } else {
                                        li.classList.remove('font-bold', 'text-green-400');
                                        li.querySelector('.primary-label').textContent = '';
                                    }
                                });
                            } else {
                                alert('Error saving order: ' + (data.error || 'Unknown error'));
                            }
                        });
                }
            });
        }
    });
</script>