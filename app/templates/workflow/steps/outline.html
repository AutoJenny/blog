<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Existing code for populateFieldSelectors, etc.

        // Add event listener for the save-prompt button
        const savePromptButton = document.getElementById('save-prompt');
        if (savePromptButton) {
            savePromptButton.addEventListener('click', function () {
                const systemPrompt = document.getElementById('system-prompt').value;
                const taskPrompt = document.getElementById('task-prompt').value;

                // Get the current URL path and extract the components
                const pathParts = window.location.pathname.split('/');
                const postId = pathParts[2];
                const stageName = pathParts[3];
                const substageName = pathParts[4];
                const stepName = pathParts[5];

                fetch(`/workflow/${postId}/${stageName}/${substageName}/${stepName}/save_prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system_prompt: systemPrompt,
                        task_prompt: taskPrompt
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update the summary text
                            document.getElementById('prompt-summary').textContent = taskPrompt.split('\n')[0].substring(0, 50) + '...';
                            // Show success message
                            const message = document.createElement('div');
                            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg';
                            message.textContent = 'Prompt saved successfully!';
                            document.body.appendChild(message);
                            setTimeout(() => message.remove(), 3000);
                        } else {
                            throw new Error(data.error || 'Failed to save prompt');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving prompt:', error);
                        const message = document.createElement('div');
                        message.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg';
                        message.textContent = 'Error saving prompt: ' + error.message;
                        document.body.appendChild(message);
                        setTimeout(() => message.remove(), 3000);
                    });
            });
        }
    });
</script>