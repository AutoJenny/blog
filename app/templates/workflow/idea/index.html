<!-- LLM DEBUG MARKER -->
<div id="llm-debug-marker" style="background: #ffe; color: #a00; padding: 4px; font-weight: bold;">
    LLM DEBUG PANEL SHOULD BE VISIBLE BELOW
</div>

<!-- LLM WORKFLOW ROOT WITH FIELD MAPPING -->
<div id="llm-workflow-root" data-seed="idea-seed-input" data-summary="summary-panel">
    <!-- IDEA SEED PANEL -->
    <div id="idea-seed-panel">
        <input id="idea-seed-input" type="text" class="form-input" placeholder="Enter your idea seed here">
    </div>

    <!-- LLM ACTION BUTTON -->
    <div class="flex justify-center my-6">
        <a href="/llm/actions/1" class="llm-action-btn" id="generate-summary-btn">
            <i class="fa-solid fa-bolt mr-2"></i> Generate Summary from Idea Seed
        </a>
    </div>

    <!-- SUMMARY PANEL -->
    <div id="summary-panel">
        <!-- ... existing summary content ... -->
    </div>

    <!-- DEBUG JSON PANEL -->
    <div id="debug-json-panel" class="mt-8 p-4 bg-gray-100 rounded-lg hidden">
        <h3 class="text-lg font-semibold mb-2">Debug: LLM Request JSON (Frontend)</h3>
        <pre id="debug-json-content" class="bg-white p-4 rounded overflow-x-auto"></pre>
    </div>
    <div id="debug-json-llm-panel" class="mt-4 p-4 bg-gray-200 rounded-lg hidden">
        <h3 class="text-lg font-semibold mb-2">Debug: LLM Request JSON (Backend to LLM)</h3>
        <pre id="debug-json-llm-content" class="bg-white p-4 rounded overflow-x-auto"></pre>
    </div>

    <button id="run-action-btn" class="btn btn-primary">Run Action</button>
    <div id="action-result"></div>
    <div id="action-debug"></div>
    <div id="llm-prompt-display" style="margin-top:2em;"></div>
</div>

<script>
    // --- CONFIG ---
    const postId = new URLSearchParams(window.location.search).get('post_id');
    const substage = 'idea'; // This template is for the 'idea' substage
    const inputField = 'idea_seed'; // DB field for input
    const outputField = 'summary'; // DB field for output

    // --- Helper: Show Start Ollama Button ---
    function showStartOllamaButton(container) {
        container.innerHTML += `
            <div class="mt-4 p-4 bg-yellow-100 rounded">
                <b>Ollama is not running.</b>
                <button id="start-ollama-btn" class="ml-2 px-3 py-1 bg-green-600 text-white rounded">
                    <i class="fa-solid fa-play"></i> Start Ollama
                </button>
            </div>
        `;
        document.getElementById('start-ollama-btn').onclick = async function () {
            this.disabled = true;
            this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Starting...';
            try {
                const resp = await fetch('/api/v1/llm/providers/start', { method: 'POST' });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    this.innerHTML = '<i class="fa-solid fa-check"></i> Started';
                } else {
                    this.innerHTML = '<i class="fa-solid fa-play"></i> Start Ollama';
                    alert(data.error || 'Failed to start Ollama');
                }
            } catch (e) {
                this.innerHTML = '<i class="fa-solid fa-play"></i> Start Ollama';
                alert('Error starting Ollama: ' + e);
            }
            setTimeout(() => {
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-play"></i> Start Ollama';
            }, 2000);
        };
    }

    document.addEventListener('DOMContentLoaded', async function () {
        // --- Load input/output fields from backend ---
        if (postId) {
            // Load post_development fields
            const devResp = await fetch(`/api/v1/post/${postId}/development`);
            if (devResp.ok) {
                const dev = await devResp.json();
                if (dev.hasOwnProperty(inputField)) {
                    document.getElementById('idea-seed-input').value = dev[inputField] ?? '';
                }
                if (dev.hasOwnProperty(outputField)) {
                    document.getElementById('summary-panel').innerHTML = `<div class='p-4'>${dev[outputField] ?? ''}</div>`;
                }
            }
            // Load selected action for this substage
            const psaResp = await fetch(`/api/v1/llm/post_substage_actions?post_id=${postId}&substage=${substage}`);
            if (psaResp.ok) {
                const actions = await psaResp.json();
                if (actions.length > 0) {
                    const actionId = actions[0].action_id;
                    // Highlight the selected action button if present
                    const lastBtn = document.querySelector(`.llm-action-btn[href$='/${actionId}']`);
                    if (lastBtn) lastBtn.classList.add('ring', 'ring-blue-400');
                }
            }
        }

        // --- Persist input field to backend on change ---
        document.getElementById('idea-seed-input').addEventListener('change', async function () {
            if (!postId) return;
            const value = this.value;
            await fetch(`/api/v1/post/${postId}/development`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [inputField]: value })
            });
        });

        // --- Action button logic ---
        const actionButtons = document.querySelectorAll('.llm-action-btn');
        actionButtons.forEach(btn => {
            btn.addEventListener('click', async function (e) {
                e.preventDefault();
                const actionId = this.getAttribute('href').split('/').pop();
                // Persist action selection for this substage
                if (postId) {
                    await fetch('/api/v1/llm/post_substage_actions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ post_id: postId, substage, action_id: actionId })
                    });
                }
                // --- Per-page field mapping ---
                let fieldMap = {};
                const root = document.getElementById('llm-workflow-root');
                if (root) {
                    for (const attr of root.attributes) {
                        if (attr.name.startsWith('data-')) {
                            fieldMap[attr.name.replace('data-', '')] = attr.value;
                        }
                    }
                }
                // Find input value dynamically
                let inputValue = document.getElementById('idea-seed-input').value;
                // Always save input value to DB before running action
                if (postId) {
                    try {
                        const inputSaveResp = await fetch(`/api/v1/post/${postId}/development`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ [inputField]: inputValue })
                        });
                        const inputSaveData = await inputSaveResp.json();
                        console.log('[LLM] Input save payload:', { [inputField]: inputValue });
                        console.log('[LLM] Input save response:', inputSaveData);
                        if (!inputSaveResp.ok || inputSaveData.status !== 'success') {
                            alert('Failed to save input field: ' + (inputSaveData.error || inputSaveResp.status));
                        }
                    } catch (err) {
                        console.error('[LLM] Error saving input field:', err);
                        alert('Error saving input field: ' + err);
                    }
                }
                // Fetch action definition
                const actionResponse = await fetch(`/api/v1/llm/actions/${actionId}`);
                const action = await actionResponse.json();
                // Run the action
                const debugDiv = document.getElementById('action-debug');
                debugDiv.innerHTML = '';
                try {
                    const resp = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            post_id: postId,
                            input_field: inputField,
                            input_text: inputValue,
                            debug: true
                        })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw { response: resp, data };
                    document.getElementById('action-result').innerHTML = `<div class='p-4'>${data.result || ''}</div>`;
                    debugDiv.innerHTML = '';
                } catch (err) {
                    let errorText = '';
                    if (err.data && (err.data.error || err.data.message)) {
                        errorText = err.data.error || err.data.message;
                    } else if (err.response) {
                        try {
                            const errJson = await err.response.json();
                            errorText = errJson.error || errJson.message || err.response.statusText;
                        } catch {
                            errorText = err.response.statusText || 'Unknown error';
                        }
                    } else if (err.message) {
                        errorText = err.message;
                    } else {
                        errorText = 'Unknown error';
                    }
                    debugDiv.innerHTML = `<div class="text-red-600">${errorText}</div>`;
                    if (errorText.includes('Failed to establish a new connection') || errorText.includes('Connection refused')) {
                        showStartOllamaButton(debugDiv);
                    }
                }
            });
        });
    });
</script>