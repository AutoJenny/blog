<!-- Workflow Navigation Wireframe -->
<div class="bg-dark-bg border-b border-dark-border py-4">
    <div class="container mx-auto px-4">
        <!-- Line 1: Breadcrumbs and Post Selector -->
        <div class="flex justify-between items-center mb-6">
            <nav class="text-sm text-gray-400">
                <a href="{{ url_for('workflow.index') }}" class="hover:text-dark-text">Workflow</a>
                {% if current_stage %}
                <span class="mx-2">/</span>
                <a href="{{ url_for('workflow.stage', post_id=post_id, stage_name=current_stage) }}"
                    class="hover:text-dark-text">{{ current_stage|title }}</a>
                {% endif %}
                {% if current_substage %}
                <span class="mx-2">/</span>
                <span class="text-dark-text">{{ current_substage|title }}</span>
                {% endif %}
            </nav>
            <div class="relative">
                <select id="post-selector"
                    class="bg-dark-bg border border-dark-border rounded-lg px-4 py-2 text-dark-text">
                    {% for p in all_posts %}
                    <option value="{{ p.id }}" {% if p.id==post_id %}selected{% endif %}>{{ p.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Second line: All sub-stages as named icons in groups by stage -->
        <div class="flex justify-center gap-8 mb-6">
            {% for stage in nav_context.stages %}
            <div class="flex flex-col items-center">
                <span class="text-xs text-gray-400 mb-1">{{ stage.name|title }}</span>
                <div class="flex gap-4">
                    {% for substage in nav_context.substages if substage.stage_id == stage.id %}
                    {% set first_step = nav_context.steps|selectattr('sub_stage_id', 'equalto', substage.id)|first %}
                    <a href="{{ url_for('workflow.step', post_id=post_id, stage_name=stage.name, substage_name=substage.name, step_name=first_step.name) }}"
                        class="p-4 bg-dark-bg border border-dark-border rounded-lg hover:bg-dark-hover {% if current_stage == stage.name and current_substage == substage.name %}border-blue-500{% endif %}">
                        <i
                            class="fas fa-{{ substage_icons[substage.name]|default('circle') }} text-2xl mb-2 text-dark-text"></i>
                        <div class="text-sm text-dark-text">{{ substage.name|title }}</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Line 3: Tabs for steps in the current sub-stage -->
        {% if current_substage %}
        <div class="border-b border-dark-border mb-6">
            <div class="flex space-x-4">
                {% for step in steps %}
                <a href="{{ url_for('workflow.step', post_id=post_id, stage_name=current_stage, substage_name=current_substage, step_name=step.name) }}"
                    class="px-4 py-2 border-b-2 {% if current_step == step.name %}border-blue-500 text-blue-500{% else %}border-transparent text-gray-400 hover:text-dark-text{% endif %}">
                    {{ step.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.getElementById('post-selector')?.addEventListener('change', function () {
        const newPostId = this.value;
        // Build the new URL, preserving stage/substage/step
        let path = window.location.pathname.split('/').filter(Boolean);
        // path: ["workflow", post_id, stage, substage, step]
        if (path.length >= 2) {
            path[1] = newPostId;
            window.location.pathname = '/' + path.join('/') + '/';
        }
    });
</script>