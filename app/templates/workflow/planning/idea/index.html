<!-- TELLTALE: THIS IS THE REAL app/templates/workflow/planning/idea/index.html -->
{% extends "base.html" %}
{% import "workflow/workflow_indicator.html" as indicator %}
{% import "blog/_post_header.html" as blog_macros %}

{% block title %}Planning: Idea{% endblock %}

{% block content %}
<!-- LLM DEBUG MARKER -->
<div id="llm-debug-marker" style="background: #222; color: #ff0; padding: 4px; font-weight: bold;">
    LLM DEBUG PANEL SHOULD BE VISIBLE BELOW
</div>

<!-- DEBUG JSON PANEL -->
<div id="debug-json-panel" class="mt-8 p-4 bg-gray-800 text-gray-100 rounded-lg">
    <h3 class="text-lg font-semibold mb-2">Debug: LLM Request JSON (Frontend)</h3>
    <pre id="debug-json-content" class="bg-gray-900 text-gray-100 p-4 rounded overflow-x-auto"></pre>
</div>
<div id="debug-json-llm-panel" class="mt-4 p-4 bg-gray-800 text-gray-100 rounded-lg">
    <h3 class="text-lg font-semibold mb-2">Debug: LLM Request JSON (Backend to LLM)</h3>
    <pre id="debug-json-llm-content" class="bg-gray-900 text-gray-100 p-4 rounded overflow-x-auto"></pre>
</div>

<div class="container mx-auto px-6 py-8">
    {{ blog_macros.post_header(post) }}
    {{ indicator.process_indicator(substages, stages, current_substage_id) }}
    <!-- Modular LLM Workflow Panels for Idea Stage -->
    <div class="max-w-5xl mx-auto py-10 flex flex-col gap-8">
        <!-- Input Panel -->
        <div class="panel bg-gray-800 rounded-lg p-6 mb-4">
            <h2 class="text-lg font-bold mb-2">Input</h2>
            <label for="inputFieldSelect" class="block mb-1">Select Input Field</label>
            <select id="inputFieldSelect" class="w-full mb-2"></select>
            <div id="inputFieldValue" class="bg-gray-900 text-gray-200 rounded p-3 min-h-[2rem]">Select a field to view
                its content.</div>
        </div>
        <!-- Actions Panel -->
        <div class="panel bg-gray-800 rounded-lg p-6 mb-4">
            <h2 class="text-lg font-bold mb-2">Actions</h2>
            <div class="flex gap-2 items-center mb-2">
                <label for="actionSelect" class="mr-2">Select Action</label>
                <select id="actionSelect" class="mb-0"></select>
                <button id="runActionBtn" class="btn btn-primary">Run Action</button>
            </div>
            <div id="actionPromptPanel" class="bg-gray-900 text-gray-200 rounded p-3 min-h-[2rem]">Select an action to
                view its prompt/template.</div>
        </div>
        <!-- Output Panel -->
        <div class="panel bg-gray-800 rounded-lg p-6 mb-4">
            <h2 class="text-lg font-bold mb-2">Output</h2>
            <label for="outputFieldSelect" class="block mb-1">Select Output Field</label>
            <select id="outputFieldSelect" class="w-full mb-2"></select>
            <div id="outputFieldValue" class="bg-gray-900 text-gray-200 rounded p-3 min-h-[2rem]">Select a field to view
                its content.</div>
            <div id="actionOutputPanel" class="bg-gray-900 text-green-200 rounded p-3 min-h-[2rem] mt-2">Run an action
                to see output here.</div>
            <button id="saveOutputBtn" class="btn btn-success mt-2">Save Output to Field</button>
        </div>
        <!-- Post Development Fields Panel -->
        <div class="panel bg-gray-800 rounded-lg p-6 mb-4">
            <h2 class="text-lg font-bold mb-2">Post Development Fields</h2>
            <div id="postDevFieldsPanel"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    console.log('[LLM] Debug script loaded.');
    // Force debug panels visible for diagnosis
    window.addEventListener('DOMContentLoaded', function () {
        document.getElementById('debug-json-panel')?.classList.remove('hidden');
        document.getElementById('debug-json-llm-panel')?.classList.remove('hidden');
    });

    document.addEventListener('DOMContentLoaded', function () {
        // --- 0. Setup postId and debug panel ---
        const postIdStr = '{{ post.id if post else "" }}';
        const postId = postIdStr ? parseInt(postIdStr, 10) : null;
        const debugPanel = document.getElementById('debug-json-panel');
        const debugContent = document.getElementById('debug-json-content');

        // --- 1. Load Actions Dropdown (always, independently) ---
        const select = document.getElementById('actionSelect');
        const storageKey = postId ? `llm_action_selected_${postId}` : null;
        async function loadActions() {
            try {
                const res = await fetch('/api/v1/llm/actions');
                const actions = await res.json();
                select.innerHTML = '<option value="">Select Action...</option>' +
                    actions.map(a => `<option value="${a.id}">${a.field_name} (${a.llm_model})</option>`).join('');
                if (storageKey) {
                    const saved = localStorage.getItem(storageKey);
                    if (saved) select.value = saved;
                }
            } catch (e) {
                select.innerHTML = '<option value="">Failed to load actions</option>';
            }
        }
        if (select) {
            loadActions();
            if (postId) {
                select.addEventListener('change', function () {
                    localStorage.setItem(storageKey, select.value);
                });
                select.addEventListener('change', async function () {
                    const actionId = select.value;
                    if (!actionId || isNaN(Number(actionId))) return;
                    const payload = {
                        post_id: postId,
                        substage: 'idea',
                        action_id: actionId,
                        button_label: 'Action',
                        button_order: 0
                    };
                    try {
                        await fetch('/api/v1/llm/post_substage_actions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                    } catch (e) { }
                });
            }
        }

        // --- 2. Populate Input/Output Field Dropdowns from post_development schema and values ---
        const inputFieldSelect = document.getElementById('inputFieldSelect');
        const outputFieldSelect = document.getElementById('outputFieldSelect');
        const inputFieldValue = document.getElementById('inputFieldValue');
        const outputFieldValue = document.getElementById('outputFieldValue');
        let allFields = [];
        let fieldValues = {};
        async function loadFieldsAndValues() {
            // Fetch all possible fields
            let fieldsRes = await fetch('/api/v1/post_development/fields');
            let fieldsData = await fieldsRes.json();
            allFields = fieldsData.fields || [];
            // Fetch values for this post
            let valuesRes = await fetch(`/api/v1/post/${postId}/development`);
            let valuesData = await valuesRes.json();
            fieldValues = valuesData || {};
            // Populate dropdowns
            function populateFieldDropdown(selectElem, fields) {
                selectElem.innerHTML = '<option value="">Select field...</option>' +
                    fields.map(f => `<option value="${f}">${f}</option>`).join('');
            }
            if (inputFieldSelect) populateFieldDropdown(inputFieldSelect, allFields);
            if (outputFieldSelect) populateFieldDropdown(outputFieldSelect, allFields);
            // Update value panels on selection
            if (inputFieldSelect && inputFieldValue) {
                inputFieldSelect.addEventListener('change', function () {
                    const val = fieldValues[this.value] || '';
                    inputFieldValue.textContent = val;
                });
            }
            if (outputFieldSelect && outputFieldValue) {
                outputFieldSelect.addEventListener('change', function () {
                    const val = fieldValues[this.value] || '';
                    outputFieldValue.textContent = val;
                });
            }
            // Set initial value panels (blank if nothing selected)
            if (inputFieldSelect && inputFieldValue && inputFieldSelect.value) {
                inputFieldValue.textContent = fieldValues[inputFieldSelect.value] || '';
            } else if (inputFieldValue) {
                inputFieldValue.textContent = '';
            }
            if (outputFieldSelect && outputFieldValue && outputFieldSelect.value) {
                outputFieldValue.textContent = fieldValues[outputFieldSelect.value] || '';
            } else if (outputFieldValue) {
                outputFieldValue.textContent = '';
            }
        }
        loadFieldsAndValues();

        // --- 3. Action Execution and Debug Panels ---
        const runBtn = document.getElementById('runActionBtn');
        const actionOutputPanel = document.getElementById('actionOutputPanel');
        if (runBtn && select && inputFieldSelect) {
            runBtn.addEventListener('click', async function () {
                const actionId = select.value;
                const inputField = inputFieldSelect.value;
                const inputValue = fieldValues[inputField] || '';
                if (!actionId) {
                    alert('Please select an action.');
                    return;
                }
                if (!inputField) {
                    alert('Please select an input field.');
                    return;
                }
                // Set loading state
                runBtn.disabled = true;
                const originalText = runBtn.textContent;
                runBtn.textContent = 'Running...';
                // Fetch action details
                let actionData = null;
                try {
                    const resp = await fetch(`/api/v1/llm/actions/${actionId}`);
                    actionData = await resp.json();
                    if (!actionData.action) throw new Error('Action not found');
                } catch (e) {
                    alert('Failed to fetch action details: ' + e);
                    runBtn.disabled = false;
                    runBtn.textContent = originalText;
                    return;
                }
                // Prepare frontend JSON
                const frontendJson = {
                    model: actionData.action.llm_model,
                    temperature: actionData.action.temperature,
                    max_tokens: actionData.action.max_tokens,
                    prompt: actionData.action.prompt_template.replace(/\[.*?\]/g, '').trim(),
                    input: inputValue
                };
                // Show frontend JSON in debug panel
                const debugPanel = document.getElementById('debug-json-panel');
                const debugContent = document.getElementById('debug-json-content');
                if (debugPanel && debugContent) {
                    debugPanel.classList.remove('hidden');
                    debugContent.textContent = JSON.stringify(frontendJson, null, 2);
                }
                // Run the action (with debug flag)
                let backendJson = null;
                let output = '';
                try {
                    const resp = await fetch(`/api/v1/llm/actions/${actionId}/execute`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ post_id: postId, input_field: inputField, input_text: inputValue, debug: true })
                    });
                    const data = await resp.json();
                    backendJson = data.llm_request_json || null;
                    output = data.output || data.response || '';
                    // Show backend JSON in debug panel
                    const debugLLMPanel = document.getElementById('debug-json-llm-panel');
                    const debugLLMContent = document.getElementById('debug-json-llm-content');
                    if (debugLLMPanel && debugLLMContent) {
                        debugLLMPanel.classList.remove('hidden');
                        debugLLMContent.textContent = backendJson ? JSON.stringify(backendJson, null, 2) : 'No backend LLM JSON.';
                    }
                    if (actionOutputPanel) actionOutputPanel.textContent = output;
                } catch (e) {
                    const debugLLMPanel = document.getElementById('debug-json-llm-panel');
                    const debugLLMContent = document.getElementById('debug-json-llm-content');
                    if (debugLLMPanel && debugLLMContent) {
                        debugLLMPanel.classList.remove('hidden');
                        debugLLMContent.textContent = 'Error: ' + e;
                    }
                    if (actionOutputPanel) actionOutputPanel.textContent = 'Error: ' + e;
                } finally {
                    runBtn.disabled = false;
                    runBtn.textContent = originalText;
                }
            });
        }
    });
</script>
{% endblock %}