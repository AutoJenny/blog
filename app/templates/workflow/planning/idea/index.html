{% extends "base.html" %}
{% import "workflow/workflow_indicator.html" as indicator %}
{% from "blog/_post_header.html" import post_header %}

{% block title %}Planning: Idea{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    {{ indicator.process_indicator(substages, stages, current_substage_id) }}
    <h1 class="text-2xl font-bold text-white mb-2 flex items-center gap-2"><i
            class="fa fa-lightbulb text-yellow-400"></i> Idea</h1>
    <p class="text-dark-accent mb-6">Describe the core idea for your post. What is it about? Why does it matter?</p>
    {% if post %}
    <div class="mb-8">
        {{ post_header(post, None) }}
    </div>
    <!-- LLM Action Controls -->
    <div id="llm-action-controls" class="flex flex-col md:flex-row items-center gap-4 mb-8 justify-center">
        <select id="llm-action-select"
            class="form-input px-4 py-2 rounded border border-gray-600 bg-dark-card text-white focus:ring-2 focus:ring-green-400">
            <option value="">Select Action...</option>
        </select>
        <button id="llm-action-run"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow transition duration-150 ease-in-out flex items-center gap-2"
            style="background:#22c55e !important; border:none;">
            <i class="fa-solid fa-bolt"></i> Run Action
        </button>
    </div>
    <div class="mb-8">
        <div class="rounded-xl p-6 shadow-lg" style="background: #23273a; border: 1.5px solid #31364a;">
            <h2 class="text-lg font-bold text-indigo-300 mb-2 flex items-center gap-2">
                <i class="fa-solid fa-align-left text-indigo-400"></i> Summary
            </h2>
            <div class="text-gray-200 text-base whitespace-pre-line">{{ post.summary|safe if post.summary else 'No
                summary yet.' }}</div>
        </div>
    </div>
    {% endif %}
</div>
<script>
    (function () {
        // Use post_id for per-post persistence
        const postIdStr = '{{ post.id if post else "" }}';
        const postId = postIdStr ? parseInt(postIdStr, 10) : null;
        const select = document.getElementById('llm-action-select');
        const storageKey = postId ? `llm_action_selected_${postId}` : null;
        // Fetch and populate actions
        async function loadActions() {
            try {
                const res = await fetch('/api/v1/llm/actions');
                const actions = await res.json();
                select.innerHTML = '<option value="">Select Action...</option>' +
                    actions.map(a => `<option value="${a.id}">${a.field_name} (${a.llm_model})</option>`).join('');
                // Restore selection
                if (storageKey) {
                    const saved = localStorage.getItem(storageKey);
                    if (saved) select.value = saved;
                }
            } catch (e) {
                select.innerHTML = '<option value="">Failed to load actions</option>';
            }
        }
        if (select && postId) {
            loadActions();
            // Save on change (localStorage)
            select.addEventListener('change', function () {
                localStorage.setItem(storageKey, select.value);
            });
            // Save on change (backend)
            select.addEventListener('change', async function () {
                const actionId = select.value;
                if (!actionId || isNaN(Number(actionId))) return;
                const payload = {
                    post_id: postId,
                    substage: 'idea',
                    action_id: actionId,
                    button_label: 'Action',
                    button_order: 0
                };
                try {
                    const res = await fetch('/api/v1/llm/post_substage_actions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (res.ok) {
                        showToast('Action selection saved.', 'success');
                    } else {
                        showToast('Failed to save action: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    showToast('Failed to save action: ' + e, 'error');
                }
            });
        }
        // Toast helper
        function showToast(msg, type) {
            let toast = document.getElementById('llm-action-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'llm-action-toast';
                toast.className = 'fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg text-white';
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.style.background = type === 'success' ? '#22c55e' : '#ef4444';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }
        const runBtn = document.getElementById('llm-action-run');
        const summaryPanel = document.querySelector('#summary-panel .text-gray-200');
        if (runBtn && select && postId) {
            runBtn.addEventListener('click', async function () {
                const actionId = select.value;
                if (!actionId || isNaN(Number(actionId))) {
                    showToast('Please select an action.', 'error');
                    return;
                }
                // Get idea seed (from post or prompt user)
                let ideaSeed = '';
                {% if post and post.idea_seed %}
                ideaSeed = `{{ post.idea_seed|e }}`;
                {% else %}
                ideaSeed = prompt('Enter the idea seed to use:');
                if (!ideaSeed) return;
                {% endif %}
                runBtn.disabled = true;
                runBtn.textContent = 'Running...';
                summaryPanel.textContent = 'Running LLM action...';
                try {
                    // Fetch action to get prompt template
                    const actionResp = await fetch(`/api/v1/llm/actions/${actionId}`);
                    const actionData = await actionResp.json();
                    if (!actionData.action) throw new Error('Action not found');
                    const prompt = actionData.action.prompt_template;
                    // Extract [data:var] from prompt
                    const match = prompt.match(/\[data:([a-zA-Z0-9_]+)\]/);
                    let inputPayload = {};
                    if (match) {
                        inputPayload[match[1]] = ideaSeed;
                    } else {
                        inputPayload['input'] = ideaSeed;
                    }
                    // Run test
                    const resp = await fetch(`/api/v1/llm/actions/${actionId}/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ input: inputPayload })
                    });
                    const data = await resp.json();
                    if (resp.ok && data.result) {
                        summaryPanel.textContent = data.result.output || JSON.stringify(data.result);
                        showToast('LLM action complete.', 'success');
                    } else if (data.error) {
                        summaryPanel.textContent = data.error;
                        showToast('LLM error: ' + data.error, 'error');
                    } else {
                        summaryPanel.textContent = 'Error running action.';
                        showToast('Unknown error running action.', 'error');
                    }
                } catch (e) {
                    summaryPanel.textContent = 'Error: ' + e;
                    showToast('Error: ' + e, 'error');
                } finally {
                    runBtn.disabled = false;
                    runBtn.textContent = 'Run Action';
                }
            });
        }
    })();
</script>
{% endblock %}