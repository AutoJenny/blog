{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col min-h-screen">
    {# Navigation area #}
    <div id="workflow-nav" class="mb-0">
        {% include 'nav/workflow_nav.html' %}
    </div>

    {# Content area #}
    <div class="flex-grow">
        {% if current_stage == 'planning' %}
        {# Full-width LLM actions panel for Planning stage #}
        <div class="px-6 -mt-20">
            <div id="workflow-llm-actions" style="background-color: #2D0A50; width: 100%; min-height: 400px;"
                class="rounded-lg p-6 shadow-lg">
                {% include 'workflow/_modular_llm_panels.html' %}
            </div>
        </div>
        {% elif current_stage == 'writing' %}
        {# Conditional layout: Two-column for content/meta_info, Three-column for images #}
        <div class="px-6 -mt-20">
            {% if current_substage == 'images' %}
            {# Three-column layout for Images stage #}
            <div class="flex gap-6" style="min-height: 400px;">
                {# Left column - LLM Actions (33%) #}
                <div id="workflow-llm-actions" style="background-color: #2D0A50; width: 33%;"
                    class="rounded-lg p-6 shadow-lg transition-all duration-300">
                    {% include 'workflow/_modular_llm_panels.html' %}
                </div>
                {# Middle column - Sections (33%) #}
                <div id="workflow-sections" style="background-color: #013828; width: 33%;"
                    class="rounded-lg p-6 shadow-lg transition-all duration-300">
                    <div id="sections-panel-content" class="text-gray-200">
                        <p>Loading sections...</p>
                    </div>
                </div>
                {# Right column - Image Management (33%) #}
                <div id="workflow-images" style="background-color: #1a365d; width: 33%;"
                    class="rounded-lg p-6 shadow-lg transition-all duration-300">
                    {% include 'workflow/_image_management_panel.html' %}
                </div>
            </div>
            {% else %}
            {# Two-column layout for other Writing stages #}
            <div class="flex gap-6" style="min-height: 400px;">
                {# Left column - LLM Actions #}
                <div id="workflow-llm-actions" style="background-color: #2D0A50; width: 50%;"
                    class="rounded-lg p-6 shadow-lg">
                    {% include 'workflow/_modular_llm_panels.html' %}
                </div>
                {# Right column - Sections #}
                <div id="workflow-sections" style="background-color: #013828; width: 50%;"
                    class="rounded-lg p-6 shadow-lg">
                    <div id="sections-panel-content" class="text-gray-200">
                        <p>Loading sections...</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <script type="module">
            import sectionPanel from '/static/js/workflow/template_view.js';
            document.addEventListener('DOMContentLoaded', async () => {
                // Get postId from URL
                const pathParts = window.location.pathname.split('/');
                const postId = pathParts[3];
                const apiUrl = `/api/workflow/posts/${postId}/sections`;
                const panel = document.getElementById('sections-panel-content');
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Failed to fetch sections');
                    const data = await response.json();
                    // Structure expected by renderStructure: { post: {id}, sections: [...] }
                    const structure = { post: { id: postId }, sections: data.sections || [] };
                    panel.innerHTML = sectionPanel.renderStructure(structure);
                    sectionPanel.initAccordions();
                    sectionPanel.initSectionSelectionUI();
                    // Dynamically import SectionDragDrop after rendering
                    const { default: SectionDragDrop } = await import('/static/js/workflow/section_drag_drop.js');
                    const dragDrop = new SectionDragDrop();
                    dragDrop.init('sections-sortable-container', postId, structure.sections);
                } catch (e) {
                    panel.innerHTML = `<div class='text-red-400'>Error loading sections: ${e.message}</div>`;
                }
            });
        </script>

        {% if current_substage == 'images' %}
        <script type="module">
            import ImageManagement from '/static/js/workflow/image_management.js';
            document.addEventListener('DOMContentLoaded', async () => {
                // Get postId from URL
                const pathParts = window.location.pathname.split('/');
                const postId = pathParts[3];

                // Initialize image management
                const imageManagement = new ImageManagement(postId);

                // Make it globally available for section selection
                window.imageManagement = imageManagement;

                console.log('Image management initialized for post:', postId);
            });
        </script>
        {% endif %}
        {% else %}
        <div class="px-6 -mt-20 text-white">
            <p>Current stage: {{ current_stage }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='modules/llm_panel/css/panels.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/image_management.css') }}">
<style>
    #workflow-llm-actions {
        background-color: #2D0A50 !important;
    }

    #workflow-sections {
        background-color: #013828 !important;
    }

    #workflow-images {
        background-color: #1a365d !important;
    }

    /* Smooth transitions for panel resizing */
    .transition-all {
        transition: all 0.3s ease-in-out;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- No additional scripts needed here - they are included in _modular_llm_panels.html -->
{% endblock %}