# New Image System Reference

## Overview
The new image system provides robust, modular support for image upload, generation, optimization, watermarking, and integration with the workflow and publishing systems. It is designed to be extensible, maintainable, and fully integrated with the existing blog workflow and database schema.

**Project Architecture:** This system is designed to work across three interconnected projects:
- **/blog** (Core/Shared): Database, docs, modules, shared infrastructure
- **/blog-workflow** (Content Creation): Text generation, planning, writing stages
- **/blog-images** (Visual Production): Image generation, processing, management

---

## Architecture
- **Direct PostgreSQL integration** (no SQLAlchemy)
- **Multi-provider image generation**: ComfyUI (Local), OpenAI DALL-E, Stable Diffusion
- **Image processing**: Supports both uploaded and LLM-generated images
- **Watermarking**: Automated, configurable watermarking pipeline
- **Format optimization**: Images are optimized for web (e.g., WEBP, JPEG)
- **Workflow integration**: Images are linked to post sections and tracked through all workflow stages
- **Publishing integration**: Images are prepared for CDN upload and public URLs are managed
- **Preview integration**: Images display in preview templates with graceful error handling
- **Cross-project communication**: Shared database with clean API boundaries

---

## Database Tables
The following tables are central to the image system (see `/docs/reference/database/schema.md` for full schema):

### Core Image Tables
- `image` - Main image storage with metadata
- `image_style` - Predefined image styles for generation
- `image_format` - Supported output formats
- `image_setting` - Global image processing settings
- `image_prompt_example` - Example prompts for different content types

### Workflow Integration Tables
- `post_section` - Contains image-related fields for text generation
- `workflow_step_entity` - Tracks image processing through workflow stages
- `llm_action` - Contains image generation prompts and settings

### Database Field Relationships

#### `post_section` Image Fields
- `image_id` - References `image.id` (legacy system)
- `generated_image_url` - Direct file path (new system)
- `image_captions` - Image caption text (generated by /blog-workflow)
- `image_prompts` - Generation prompt used (generated by /blog-workflow)
- `image_meta_descriptions` - Additional image notes (generated by /blog-workflow)
- `image_prompt_example_id` - References `image_prompt_example.id`

#### `image` Table Fields
- `id` - Primary key
- `path` - File system path
- `alt_text` - Alt text for accessibility
- `caption` - Image caption
- `prompt` - Generation prompt
- `metadata` - JSON metadata
- `style_id` - References `image_style.id`
- `format_id` - References `image_format.id`
- `created_at` - Generation timestamp
- `file_size` - File size in bytes
- `dimensions` - Image dimensions (width x height)

Refer to `/docs/reference/database/schema.md` for field-level details and relationships.

---

## File System Structure
```
static/
├── uploads/
│   └── images/                    # Generated and uploaded images
│       └── section_<id>_<timestamp>_<hash>.png
├── images/
│   ├── posts/                     # Legacy post images
│   ├── site/                      # Site header/footer images
│   └── watermarked/               # Watermarked versions
├── comfyui_output/                # ComfyUI generated images
│   └── [timestamped files]
```

**Important:** The `static/uploads/images/` directory is created automatically and is the canonical location for all generated and uploaded images.

---

## API Endpoints

### Core Image Generation
**Endpoint:** `POST /api/images/generate`
**Project:** `/blog-images`
**Purpose:** Generate images using various LLM providers

**Request Body:**
```json
{
  "prompt": "Scottish highland landscape with misty mountains",
  "style_id": 1,
  "format_id": 1,
  "provider": "comfyui",
  "section_id": 123,
  "post_id": 456
}
```

**Response:**
```json
{
  "success": true,
  "image_url": "/static/uploads/images/section_123_20250717_174327_abc123.png",
  "filename": "section_123_20250717_174327_abc123.png",
  "metadata": {
    "prompt": "Scottish highland landscape with misty mountains",
    "style": "Realistic",
    "format": "PNG",
    "provider": "comfyui",
    "generation_time": "2025-07-17T17:43:27.438876"
  }
}
```

### Image Settings Management
**Endpoints:** `GET/POST/PUT/DELETE /api/images/settings`
**Project:** `/blog-images`
**Purpose:** Manage global image processing settings

**GET Response:**
```json
{
  "watermark_enabled": true,
  "watermark_path": "/static/images/site/clan-watermark.png",
  "watermark_position": "bottom-right",
  "watermark_opacity": 0.7,
  "default_quality": 85,
  "max_width": 1200,
  "auto_optimize": true
}
```

### Image Styles and Formats
**Endpoints:** `GET /api/images/styles`, `GET /api/images/formats`
**Project:** `/blog-images`
**Purpose:** Retrieve available styles and formats for UI dropdowns

**Styles Response:**
```json
[
  {"id": 1, "name": "Realistic", "description": "Photorealistic style"},
  {"id": 2, "name": "Artistic", "description": "Painterly artistic style"},
  {"id": 3, "name": "Minimalist", "description": "Clean, simple style"}
]
```

### Prompt Examples
**Endpoint:** `GET /api/images/prompt_examples`
**Project:** `/blog-images`
**Purpose:** Provide example prompts for different content types

**Response:**
```json
[
  {
    "id": 1,
    "category": "landscape",
    "prompt": "Scottish highland landscape with misty mountains and heather",
    "description": "Highland scenery"
  }
]
```

### Image Upload
**Endpoint:** `POST /api/images/upload`
**Project:** `/blog-images`
**Purpose:** Upload images for specific sections

**Request:** `multipart/form-data`
- `image`: the image file
- `section_id`: the section to associate the image with
- `post_id`: the post containing the section

**Response:**
```json
{
  "success": true,
  "image_url": "/static/uploads/images/section_123_20250717_174327_abc123.png",
  "filename": "section_123_20250717_174327_abc123.png",
  "section_id": 123,
  "post_id": 456
}
```

### Workflow Integration Endpoints

#### Section Dropdown API
**Endpoint:** `GET /api/workflow/posts/<post_id>/sections`
**Project:** `/blog-workflow`
**Purpose:** Populate section dropdown in image management panel

**Response:**
```json
[
  {
    "id": 123,
    "title": "Introduction",
    "content": "Section content...",
    "image_captions": "Generated caption text",
    "image_prompts": "Generated prompt text",
    "generated_image_url": "/static/uploads/images/section_123_20250717_174327_abc123.png"
  }
]
```

#### Section Update API
**Endpoint:** `PUT /api/workflow/posts/<post_id>/sections/<section_id>`
**Project:** `/blog-workflow`
**Purpose:** Update section with new image information

**Request Body:**
```json
{
  "generated_image_url": "/static/uploads/images/section_123_20250717_174327_abc123.png",
  "image_captions": "Updated caption text",
  "image_prompts": "Updated prompt text"
}
```

### Legacy Endpoints (Deprecated)
- `/api/v1/images/*` - All v1 endpoints are deprecated
- `/api/posts/<post_id>/generate_images` - Use individual generation instead

---

## LLM Provider Integration

### ComfyUI (Local) Integration
**Provider:** `comfyui`
**Project:** `/blog-images`
**Configuration:** Sourced from database `llm_action` table
**Features:**
- Local image generation
- Custom workflow support
- Real-time progress tracking
- Batch processing capabilities

### OpenAI DALL-E Integration
**Provider:** `dalle`
**Project:** `/blog-images`
**Configuration:** API key from environment variables
**Features:**
- High-quality image generation
- Multiple model versions
- Size and quality options
- Prompt optimization

### Stable Diffusion Integration
**Provider:** `stable_diffusion`
**Project:** `/blog-images`
**Configuration:** Local model paths and settings
**Features:**
- Open-source model support
- Custom model fine-tuning
- Parameter control
- Style transfer capabilities

---

## Preview System Integration

### Image Display in Preview
**Template:** `app/templates/preview_post.html`
**Route:** `/preview/<post_id>/`
**Project:** `/blog-workflow`
**Image Processing:** `app/preview/__init__.py` - `get_post_sections_with_images()`

### Image Field Mapping
The preview system handles two image field types:
1. **`image_id`** → Fetches from `image` table → Creates `section.image` object
2. **`generated_image_url`** → Direct URL → Creates `section.image` object with `path` and `alt_text`

### Template Image Rendering
```html
{% if section.image %}
<div class="section-image">
    <img src="{{ section.image.path }}" alt="{{ section.image.alt_text or 'Section image' }}" 
         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
    <div class="image-error" style="display: none;">
        <small><strong>Image not found:</strong> {{ section.image.path }}</small>
    </div>
    {% if section.image_captions %}
    <div class="image-caption">
        <p>{{ section.image_captions }}</p>
    </div>
    {% endif %}
    {% if section.image_prompts %}
    <div class="image-prompt-info">
        <small><strong>Prompt:</strong> {{ section.image_prompts }}</small>
    </div>
    {% endif %}
</div>
{% endif %}
```

### Error Handling
- **Missing Images:** Graceful error display with image path for debugging
- **Broken URLs:** `onerror` handler hides broken images and shows error message
- **File System:** `static/uploads/images/` directory created automatically
- **Database Errors:** Fallback to default image handling

---

## Workflow UI Integration

### Image Management Panel
**Template:** `app/templates/workflow/_image_management_panel.html`
**JavaScript:** `app/static/js/workflow/image_management.js`
**Project:** `/blog-images`
**Integration:** `app/templates/workflow/index.html` (three-column layout for images substage)

### UI Components

#### 1. **Section Context Dropdown**
- **Purpose:** Select which section to manage images for
- **API:** `GET /api/workflow/posts/<post_id>/sections`
- **Features:** Auto-populates with all post sections, auto-selects first section
- **Bug Fix:** JS error in `setSectionId` fixed with null check

#### 2. **Tabbed Interface**
- **Generate Tab:** Image generation with provider, style, and format selection
- **Upload Tab:** Drag & drop file upload with preview
- **Manage Tab:** Image management with optimization, watermarking, and metadata

#### 3. **Generate Tab Features**
- **Provider Selection:** ComfyUI (Local), DALL-E (OpenAI), Stable Diffusion
- **Style Dropdown:** Populated from `/api/images/styles`
- **Format Dropdown:** Populated from `/api/images/formats`
- **Generate Button:** Creates image using `/api/images/generate`
- **Generate Prompt Button:** AI-assisted prompt generation

#### 4. **Upload Tab Features**
- **Drag & Drop Area:** Visual upload interface
- **File Browser:** Traditional file selection
- **Preview:** Image preview before upload
- **Upload to Section:** Associates image with selected section

#### 5. **Manage Tab Features**
- **Image Grid:** Displays all section images
- **Image Selection:** Click to select and view metadata
- **Action Buttons:** Optimize, Watermark, Download, Delete
- **Metadata Display:** Prompt, style, generation time, file size

#### 6. **Modal Components**
- **Image Preview Modal:** Full-size image viewing
- **Loading Overlay:** Progress indication during operations

### JavaScript Functionality

#### Core Methods
- `ImageManagement(postId, sectionId)` - Main class constructor
- `init()` - Initialize all components and load data
- `loadSectionsDropdown()` - Populate section selector
- `loadSectionImages()` - Load images for selected section
- `generateImage()` - Generate new image
- `uploadImageToSection()` - Upload file to section
- `updateSectionWithImage()` - Update section with new image

#### Event Handling
- **Tab Switching:** Smooth tab transitions
- **Drag & Drop:** File upload with visual feedback
- **Section Selection:** Context switching between sections
- **Image Selection:** Metadata display and action enabling

#### API Integration
- **Settings Loading:** `/api/images/settings`
- **Styles Loading:** `/api/images/styles`
- **Formats Loading:** `/api/images/formats`
- **Image Generation:** `/api/images/generate`
- **Image Upload:** `/api/images/upload`
- **Section Updates:** `/api/workflow/posts/<post_id>/sections/<section_id>`

### CSS Styling
**File:** `app/static/css/panels.css`
- **Dark Theme:** Consistent with existing workflow panels
- **Responsive Design:** Adapts to three-column layout
- **Interactive Elements:** Hover states and visual feedback
- **Loading States:** Spinner and progress indicators

---

## Cross-Project Communication

### Database Sharing
- All projects connect to the same PostgreSQL database
- Shared schema ensures data consistency
- No data duplication or sync issues
- Single source of truth for all content

### API Boundaries
- **Text Generation:** `/blog-workflow` handles all text content (captions, prompts, concepts)
- **Visual Generation:** `/blog-images` handles all image creation and processing
- **Preview System:** `/blog-workflow` handles content display and preview
- **Core Infrastructure:** `/blog` provides shared utilities and database access

### Import Dependencies
```python
# /blog-workflow imports from /blog
from app.db import get_db_conn
from app.utils.shared import common_utilities

# /blog-images imports from /blog
from app.db import get_db_conn
from app.services.shared import image_utilities
```

### Configuration Management
- Shared environment variables for database connections
- Project-specific settings in each project's config
- Centralized documentation in `/blog/docs`
- Consistent API patterns across all projects

---

## Usage Patterns

### Text Generation (blog-workflow)
- Generate image concepts and prompts using LLM
- Create captions and metadata for images
- Store text content in `post_section` table
- Provide text content to image generation system

### Visual Generation (blog-images)
- Upload or generate images via the workflow UI or API
- Configure settings (style, format, watermark) using the settings endpoints
- Link images to post sections using the `post_section` table fields
- Track image status through workflow and publishing stages
- Publish images to CDN as part of the post publishing process
- Preview images in the preview system with proper error handling
- Manage images through the comprehensive workflow UI

### Preview Integration (blog-workflow)
- Display images with captions and metadata
- Handle missing or broken images gracefully
- Provide responsive image layouts
- Support image optimization and lazy loading

---

## Error Handling and Logging

### Diagnostic Logging
**File:** `logs/workflow_diagnostic_llm_response.txt`
**Format:** Structured logging with timestamps and context
**Content:** LLM requests, responses, and processing steps

### Error Recovery
- **Network Failures:** Retry mechanisms with exponential backoff
- **File System Errors:** Automatic directory creation and permission handling
- **Database Errors:** Transaction rollback and error reporting
- **API Failures:** Graceful degradation and user feedback

### Monitoring
- **Generation Success Rates:** Track successful vs failed generations
- **Performance Metrics:** Generation time, file size, quality metrics
- **User Activity:** Track usage patterns and popular features
- **System Health:** Monitor disk space, database connections, API limits

---

## Legacy System Reference
For a detailed comparison and migration notes, see:
- `/docs/reference/images/legacy_image_pipeline.md`

---

## Further Reading
- **API Reference**: `/docs/reference/api/current/`
- **Database Schema**: `/docs/reference/database/schema.md`
- **Workflow Integration**: `/docs/reference/workflow/`
- **Preview System**: `/docs/reference/workflow/preview.md`
- **Project Architecture**: `/docs/ARCHITECTURE.md`

---

**Note:** For any new development, always check the above references to avoid duplication and ensure consistency with the canonical image system. The three-project architecture ensures clean separation of concerns while maintaining data consistency through shared database access. 