<!-- Channel Requirements Accordion Component -->
<div class="requirements-display" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
    <h5 class="text-white mb-3">
        <i class="fas fa-cog text-info me-2"></i>
        {{ platform.display_name }} {{ channel_type.display_name }} Requirements
    </h5>
    <p class="text-light mb-3">
        <strong>Database-Driven Rules:</strong> These are the stored rules that will guide the LLM in rewriting blog posts for {{ platform.display_name }} {{ channel_type.display_name }}.
    </p>
    
    <!-- Requirements Accordion -->
    <div class="accordion" id="mvpRequirementsAccordion">
        {% set categories = {} %}
        {% for requirement in requirements %}
            {% if requirement.requirement_category not in categories %}
                {% set _ = categories.update({requirement.requirement_category: []}) %}
            {% endif %}
            {% set _ = categories[requirement.requirement_category].append(requirement) %}
        {% endfor %}
        
        {% for category, category_requirements in categories.items() %}
        <div class="accordion-item" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 0.5rem;">
            <h2 class="accordion-header" id="heading{{ category|replace(' ', '')|replace('-', '')|replace('_', '') }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse{{ category|replace(' ', '')|replace('-', '')|replace('_', '') }}" 
                        aria-expanded="false" 
                        aria-controls="collapse{{ category|replace(' ', '')|replace('-', '')|replace('_', '') }}"
                        style="background: rgba(59, 130, 246, 0.1); color: white; border: none;">
                    <div class="d-flex align-items-center w-100">
                        <i class="fas fa-cog me-3 text-info"></i>
                        <span class="flex-grow-1">{{ category|title }}</span>
                        <div class="requirement-indicator">
                            <span class="badge bg-info me-2">{{ category_requirements|length }} Rules</span>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                    </div>
                </button>
            </h2>
            <div id="collapse{{ category|replace(' ', '')|replace('-', '')|replace('_', '') }}" 
                 class="accordion-collapse collapse" 
                 aria-labelledby="heading{{ category|replace(' ', '')|replace('-', '')|replace('_', '') }}" 
                 data-bs-parent="#mvpRequirementsAccordion">
                <div class="accordion-body" style="background: rgba(255, 255, 255, 0.02); padding: 1rem;">
                    {% for requirement in category_requirements %}
                    <div class="requirement-item" style="background: rgba(255, 255, 255, 0.05); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                        <div class="row">
                            <div class="col-md-3">
                                <span class="badge bg-primary">{{ requirement.requirement_key }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong class="text-white">{{ requirement.requirement_value }}</strong>
                            </div>
                            <div class="col-md-6">
                                <small class="text-light">{{ requirement.description }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- LLM Settings Panel -->
<div class="llm-settings-panel" style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 1.5rem; margin-top: 2rem;">
    <h5 class="text-white mb-3">
        <i class="fas fa-brain text-success me-2"></i>
        LLM Settings
    </h5>
    <p class="text-light mb-3">
        <strong>AI Configuration:</strong> Configure the language model settings for content conversion.
    </p>
    
    <!-- LLM Settings Accordion -->
    <div class="accordion" id="llmSettingsAccordion">
        <!-- Model Configuration -->
        <div class="accordion-item" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(34, 197, 94, 0.3); margin-bottom: 0.5rem;">
            <h2 class="accordion-header" id="headingModelConfig">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapseModelConfig" 
                        aria-expanded="false" 
                        aria-controls="collapseModelConfig"
                        style="background: rgba(34, 197, 94, 0.1); color: white; border: none;">
                    <div class="d-flex align-items-center w-100">
                        <i class="fas fa-cog me-3 text-success"></i>
                        <span class="flex-grow-1">Model Configuration</span>
                        <div class="requirement-indicator">
                            <span class="badge bg-success me-2">3 Settings</span>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                    </div>
                </button>
            </h2>
            <div id="collapseModelConfig" 
                 class="accordion-collapse collapse" 
                 aria-labelledby="headingModelConfig" 
                 data-bs-parent="#llmSettingsAccordion">
                <div class="accordion-body" style="background: rgba(255, 255, 255, 0.02); padding: 1rem;">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Model Provider:</label>
                                <select class="form-select bg-dark text-white border-success" id="llmProviderSelect">
                                    <option value="">Loading providers...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Model Name:</label>
                                <select class="form-select bg-dark text-white border-success" id="llmModelSelect" disabled>
                                    <option value="">Select a provider first</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Temperature:</label>
                                <input type="range" class="form-range" min="0" max="2" step="0.1" value="0.7" id="llmTemperature">
                                <div class="d-flex justify-content-between text-light">
                                    <small>Precise (0.0)</small>
                                    <small id="temperatureValue">0.7</small>
                                    <small>Creative (2.0)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Prompt Configuration -->
        <div class="accordion-item" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(34, 197, 94, 0.3); margin-bottom: 0.5rem;">
            <h2 class="accordion-header" id="headingPromptConfig">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapsePromptConfig" 
                        aria-expanded="false" 
                        aria-controls="collapsePromptConfig"
                        style="background: rgba(34, 197, 94, 0.1); color: white; border: none;">
                    <div class="d-flex align-items-center w-100">
                        <i class="fas fa-comment-dots me-3 text-success"></i>
                        <span class="flex-grow-1">Prompt Configuration</span>
                        <div class="requirement-indicator">
                            <span class="badge bg-success me-2">4 Settings</span>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                    </div>
                </button>
            </h2>
            <div id="collapsePromptConfig" 
                 class="accordion-collapse collapse" 
                 aria-labelledby="headingPromptConfig" 
                 data-bs-parent="#llmSettingsAccordion">
                <div class="accordion-body" style="background: rgba(255, 255, 255, 0.02); padding: 1rem;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">System Prompt:</label>
                                <textarea class="form-control bg-dark text-white border-success" rows="3" placeholder="Enter the system prompt that defines the AI's role...">You are a social media content specialist. Convert blog post sections into engaging social media posts following the specified platform requirements.</textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">User Prompt Template:</label>
                                <textarea class="form-control bg-dark text-white border-success" rows="3" placeholder="Enter the user prompt template...">Convert this blog post section into a {platform} {channel_type} post. Follow these requirements: {requirements}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Max Tokens:</label>
                                <input type="number" class="form-control bg-dark text-white border-success" value="1000" min="100" max="4000" id="llmMaxTokens">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Stop Sequences:</label>
                                <input type="text" class="form-control bg-dark text-white border-success" placeholder="Enter stop sequences separated by commas">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Execution Settings -->
        <div class="accordion-item" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(34, 197, 94, 0.3); margin-bottom: 0.5rem;">
            <h2 class="accordion-header" id="headingExecutionConfig">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapseExecutionConfig" 
                        aria-expanded="false" 
                        aria-controls="collapseExecutionConfig"
                        style="background: rgba(34, 197, 94, 0.1); color: white; border: none;">
                    <div class="d-flex align-items-center w-100">
                        <i class="fas fa-play-circle me-3 text-success"></i>
                        <span class="flex-grow-1">Execution Settings</span>
                        <div class="requirement-indicator">
                            <span class="badge bg-success me-2">2 Settings</span>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                    </div>
                </button>
            </h2>
            <div id="collapseExecutionConfig" 
                 class="accordion-collapse collapse" 
                 aria-labelledby="headingExecutionConfig" 
                 data-bs-parent="#llmSettingsAccordion">
                <div class="accordion-body" style="background: rgba(255, 255, 255, 0.02); padding: 1rem;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Batch Processing:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batchProcessing" checked>
                                    <label class="form-check-label text-white" for="batchProcessing">
                                        Process multiple sections simultaneously
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Retry on Failure:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="llmRetryOnFailure" checked>
                                    <label class="form-check-label text-white" for="llmRetryOnFailure">
                                        Automatically retry failed conversions
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Timeout (seconds):</label>
                                <input type="number" class="form-control bg-dark text-white border-success" value="30" min="10" max="120">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="setting-item mb-3">
                                <label class="form-label text-white">Max Retries:</label>
                                <input type="number" class="form-control bg-dark text-white border-success" value="3" min="1" max="5">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Indicator -->
    <div class="mt-3 p-3 bg-success bg-opacity-25 rounded border border-success">
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle text-success me-2"></i>
            <span class="text-white">LLM Settings configured and ready for content conversion.</span>
        </div>
    </div>
</div>

<!-- LLM Configuration JavaScript -->
<script>
// Load LLM providers on page load
document.addEventListener("DOMContentLoaded", function() {
    loadLLMProviders();
});

async function loadLLMProviders() {
    try {
        const response = await fetch("/api/syndication/llm/providers");
        const data = await response.json();
        
        const providerSelect = document.getElementById("llmProviderSelect");
        providerSelect.innerHTML = "<option value=\"\">Select a provider...</option>";
        
        data.providers.forEach(provider => {
            const option = document.createElement("option");
            option.value = provider.id;
            option.textContent = provider.name;
            option.title = provider.description || "";
            providerSelect.appendChild(option);
        });
        
        // Attempt to pre-select Ollama (local) if available
        const ollamaLocalOption = Array.from(providerSelect.options).find(opt => opt.textContent.includes('Ollama (local)'));
        if (ollamaLocalOption) {
            providerSelect.value = ollamaLocalOption.value;
            loadLLMModels(ollamaLocalOption.value);
        } else if (data.providers.length > 0) {
            // If Ollama not found, select the first provider and load its models
            providerSelect.value = data.providers[0].id;
            loadLLMModels(data.providers[0].id);
        } else {
            fallbackToHardcodedProviders();
        }

    } catch (error) {
        console.error("Failed to load LLM providers:", error);
        fallbackToHardcodedProviders();
    }
}

async function loadLLMModels(providerId) {
    try {
        const response = await fetch(`/api/syndication/llm/models/${providerId}`);
        const data = await response.json();
        
        const modelSelect = document.getElementById("llmModelSelect");
        modelSelect.innerHTML = "<option value=\"\">Select a model...</option>";
        modelSelect.disabled = false;
        
        data.models.forEach(model => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = model.name;
            option.title = `Description: ${model.description || 'N/A'}\nStrengths: ${model.strengths || 'N/A'}\nWeaknesses: ${model.weaknesses || 'N/A'}`; // Tooltip for model details
            modelSelect.appendChild(option);
        });

        if (data.models.length > 0) {
            modelSelect.value = data.models[0].id; // Select the first model by default
        }

    } catch (error) {
        console.error("Failed to load LLM models:", error);
        fallbackToHardcodedModels();
    }
}

// Event listener for provider change
document.getElementById('llmProviderSelect').addEventListener('change', function() {
    const providerId = this.value;
    if (providerId) {
        loadLLMModels(providerId);
    } else {
        document.getElementById('llmModelSelect').innerHTML = '<option value="">Select a provider first</option>';
        document.getElementById('llmModelSelect').disabled = true;
    }
});

// Fallback functions (keep existing hardcoded options as backup)
function fallbackToHardcodedProviders() {
    const providerSelect = document.getElementById("llmProviderSelect");
    providerSelect.innerHTML = `
        <option value="ollama">Ollama (Local)</option>
        <option value="openai">OpenAI</option>
        <option value="anthropic">Anthropic</option>
        <option value="google">Google</option>
    `;
    providerSelect.value = "ollama"; // Default to Ollama
    loadLLMModels(providerSelect.value); // Load hardcoded models for Ollama
}

function fallbackToHardcodedModels() {
    const modelSelect = document.getElementById("llmModelSelect");
    modelSelect.innerHTML = `
        <option value="llama2">Llama 2 (7B)</option>
        <option value="llama3">Llama 3 (8B)</option>
        <option value="gpt4">GPT-4</option>
        <option value="claude">Claude 3</option>
    `;
    modelSelect.disabled = false;
    modelSelect.value = "llama3"; // Default to Llama 3
}

// LLM Settings Persistence Functions
async function saveLLMSettings() {
    try {
        const settings = {
            provider_id: document.getElementById('llmProviderSelect').value,
            model_id: document.getElementById('llmModelSelect').value,
            temperature: document.getElementById('llmTemperature').value,
            max_tokens: document.getElementById('llmMaxTokens').value,
            retry_on_failure: document.getElementById('llmRetryOnFailure').checked
        };

        const response = await fetch('/api/syndication/llm/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });

        const data = await response.json();
        if (data.success) {
            console.log('LLM settings saved successfully');
        } else {
            console.error('Failed to save LLM settings:', data.error);
        }
    } catch (error) {
        console.error('Error saving LLM settings:', error);
    }
}

async function loadLLMSettings() {
    try {
        const response = await fetch('/api/syndication/llm/settings');
        const data = await response.json();
        
        if (data.settings) {
            // Restore provider selection
            if (data.settings.provider_id && data.settings.provider_id.value) {
                const providerSelect = document.getElementById('llmProviderSelect');
                providerSelect.value = data.settings.provider_id.value;
                
                // Load models for the selected provider
                await loadLLMModels(data.settings.provider_id.value);
                
                // Restore model selection after models are loaded
                setTimeout(() => {
                    if (data.settings.model_id && data.settings.model_id.value) {
                        const modelSelect = document.getElementById('llmModelSelect');
                        modelSelect.value = data.settings.model_id.value;
                    }
                }, 100);
            }
            
            // Restore other settings
            if (data.settings.temperature && data.settings.temperature.value) {
                document.getElementById('llmTemperature').value = data.settings.temperature.value;
                document.getElementById('temperatureValue').textContent = data.settings.temperature.value;
            }
            
            if (data.settings.max_tokens && data.settings.max_tokens.value) {
                document.getElementById('llmMaxTokens').value = data.settings.max_tokens.value;
            }
            
            if (data.settings.retry_on_failure && data.settings.retry_on_failure.value) {
                document.getElementById('llmRetryOnFailure').checked = data.settings.retry_on_failure.value === 'true';
            }
        }
    } catch (error) {
        console.error('Error loading LLM settings:', error);
    }
}

// Event listeners for automatic saving
document.getElementById('llmProviderSelect').addEventListener('change', function() {
    const providerId = this.value;
    if (providerId) {
        loadLLMModels(providerId);
        // Save settings after a short delay to allow models to load
        setTimeout(saveLLMSettings, 200);
    } else {
        document.getElementById('llmModelSelect').innerHTML = '<option value="">Select a provider first</option>';
        document.getElementById('llmModelSelect').disabled = true;
    }
});

document.getElementById('llmModelSelect').addEventListener('change', function() {
    saveLLMSettings();
});

document.getElementById('llmTemperature').addEventListener('change', function() {
    document.getElementById('temperatureValue').textContent = this.value;
    saveLLMSettings();
});

document.getElementById('llmMaxTokens').addEventListener('change', saveLLMSettings);
document.getElementById('llmRetryOnFailure').addEventListener('change', saveLLMSettings);

// Load settings when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadLLMProviders();
    // Load saved LLM settings after providers are loaded
    setTimeout(loadLLMSettings, 500);
});
</script>
