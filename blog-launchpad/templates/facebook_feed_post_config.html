<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ platform.display_name }} {{ channel_type.display_name }} Configuration - Blog Launchpad</title>
    <!-- Tailwind CSS for header -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/launchpad.css') }}">
    <style>
        /* Channel config specific styles */
        .channel-header {
            background: linear-gradient(135deg, #1877f2 0%, #0d6efd 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
        }
        
        .config-section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            color: #e0e0e0;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .config-card {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .config-card.channel-specific {
            border-left: 6px solid #06b6d4;
        }
        
        .config-card.platform-wide {
            border-left: 6px solid #8b5cf6;
        }
        
        .card-header {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid #4a5568;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568;
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-name {
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .config-value {
            color: #a0aec0;
            font-family: monospace;
        }
        
        .config-description {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        /* Accordion Styles for Channel Requirements */
        .accordion-item.config-card {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .accordion-button {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border: none;
            color: #e0e0e0;
            padding: 1.25rem;
            font-weight: 600;
            box-shadow: none;
        }
        
        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(6, 182, 212, 0.25);
            border-color: #06b6d4;
        }
        
        .accordion-button::after {
            display: none;
        }
        
        .requirement-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .requirement-indicator .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }
        
        .requirement-indicator .fa-chevron-down {
            transition: transform 0.3s ease;
        }
        
        .accordion-collapse {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
        }
        
        .accordion-body {
            padding: 1.5rem;
            border-top: 1px solid #4a5568;
        }
        
        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .requirement-category {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .category-title {
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #4a5568;
        }
        
        .requirement-category .config-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568;
        }
        
        .requirement-category .config-item:last-child {
            border-bottom: none;
        }
        
        .breadcrumb-nav {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .breadcrumb {
            display: flex;
            flex-wrap: wrap;
            padding: 0;
            margin: 0;
            list-style: none;
            background: transparent;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            color: #a0aec0;
        }
        
        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
            color: #6b7280;
            margin: 0 0.5rem;
        }
        
        .breadcrumb-item.active {
            color: #e0e0e0;
        }
        
        .breadcrumb-item a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb-item a:hover {
            color: #a5b4fc;
        }
        
        /* Accordion Styles for Blog Posts */
        .section-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            user-select: none;
            padding: 30px;
            margin: 0;
            transition: background-color 0.2s ease;
        }
        
        .section-title.with-right-content {
            justify-content: space-between;
        }
        
        .section-title-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .section-title-right {
            display: flex;
            align-items: center;
            text-align: right;
        }
        
        .section-title:hover {
            background-color: #334155;
        }
        
        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        .section-content.expanded {
            max-height: 2000px;
            padding: 0 30px 30px 30px;
        }
        
        .accordion-chevron {
            transition: transform 0.3s ease;
        }
        
        .accordion-chevron.expanded {
            transform: rotate(90deg);
        }
        
        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #10b981;
            color: white;
        }
        
        .status-limited {
            background: #f59e0b;
            color: white;
        }
        
        .status-draft {
            background: #6b7280;
            color: white;
        }
        
        .priority-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .priority-high {
            background: #dc2626;
            color: white;
        }
        
        .priority-medium {
            background: #ea580c;
            color: white;
        }
        
        .priority-low {
            background: #16a34a;
            color: white;
        }
        
        /* Header styling overrides for this page */
        .header-gradient {
            background: linear-gradient(90deg, #181c2a 0%, #23273a 100%) !important;
            border-bottom: 1px solid #31364a !important;
        }
        
        .header-gradient .nav-link {
            color: #e0e0e0 !important;
        }
        
        .header-gradient .nav-link:hover {
            color: #ffffff !important;
        }
        
        .header-gradient .dropdown-menu {
            background: #23273a !important;
            border: 1px solid #31364a !important;
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.45) !important;
        }
        
        .header-gradient .dropdown-item {
            color: #e0e0e0 !important;
        }
        
        .header-gradient .dropdown-item:hover {
            background: #31364a !important;
            color: #ffffff !important;
        }
        
        /* Ensure header is above other content */
        .header-gradient {
            position: relative;
            z-index: 1000;
        }
        
        /* Body styling to match daily product posts */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        /* Container styling to match daily product posts */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Additional header-related classes */
        .nav-dropdown {
            background: #23273a;
            border: 1px solid #31364a;
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.45);
        }
        .nav-dropdown a {
            color: #e0e0e0;
        }
        .nav-dropdown a:hover {
            background: #23273a;
            color: #a5b4fc;
        }
        .text-dark-text {
            color: #e0e0e0;
        }
        .text-dark-accent {
            color: #a5b4fc;
        }
        .hover\:text-dark-accent:hover {
            color: #a5b4fc;
        }
        .hover\:bg-dark-bg:hover {
            background: #23273a;
        }
        .bg-dark-accent {
            background: #a5b4fc;
        }
        .bg-dark-bg {
            background: #23273a;
        }
    </style>
</head>
<body>
    {% include 'shared/header.html' %}
    
    <div class="container">
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb-nav">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="/syndication"><i class="fas fa-home me-1"></i>Syndication</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/syndication/dashboard"><i class="fab fa-{{ platform.name|lower }} me-1"></i>{{ platform.display_name }}</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i class="fas fa-newspaper me-1"></i>{{ channel_type.display_name }} Configuration
                    </li>
                </ol>
            </nav>
        </div>
        
        <!-- Page Header -->
        <div class="header">
            <h1>ðŸ“° Blog Posts</h1>
            <p>Automated Facebook posts featuring blog content and articles</p>
        </div>
        
        <!-- Blog Post Management Accordions -->
        <!-- Item Selection Section -->
        <div class="section-card">
            <div class="section-title" onclick="toggleAccordion('item-selection')">
                <i class="fas fa-chevron-right accordion-chevron" id="item-selection-chevron"></i>
                <i class="fas fa-newspaper"></i>
                Item Selection
            </div>
            <div class="section-content" id="item-selection-content">
                <!-- Post Selection -->
                <div class="mb-4">
                    <label for="postSelector" class="form-label text-white">Choose a published post:</label>
                    <select class="form-select bg-dark text-white border-secondary" id="postSelector">
                        <option value="">Loading posts...</option>
                    </select>
                </div>
                
                <!-- Selected Post Details -->
                <div id="postDetails" class="d-none">
                    <hr class="border-secondary">
                    <h6 class="text-info mb-3">Post Details</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Title:</strong> <span id="postTitle"></span></p>
                            <p><strong>Created Date:</strong> <span id="postCreatedAt"></span></p>
                            <p><strong>Last Updated:</strong> <span id="postUpdatedAt"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Post ID:</strong> <span id="postId"></span></p>
                            <p><strong>Status:</strong> <span id="postStatus"></span></p>
                            <p><strong>Slug:</strong> <span id="postSlug"></span></p>
                            <p><strong>Number of Sections:</strong> <span id="postSectionCount"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Post Sections List -->
                <div id="sectionsList" class="d-none">
                    <hr class="border-secondary">
                    <h6 class="text-info mb-3">Post Sections</h6>
                    <div id="sectionsContainer">
                        <!-- Section titles will be populated here -->
                    </div>
                    
                    <!-- Generate All Sections Button -->
                    <div class="mt-4 text-center">
                        <button id="generateAllSectionsBtn" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-magic me-2"></i>Generate all <span id="sectionCount">0</span> sections
                        </button>
                        <div id="generationProgress" class="mt-3 d-none">
                            <div class="progress mb-2">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="progressText">Preparing...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Content Generation Section -->
        <div class="section-card">
            <div class="section-title" onclick="toggleAccordion('content-generation')">
                <i class="fas fa-chevron-right accordion-chevron" id="content-generation-chevron"></i>
                <i class="fas fa-robot"></i>
                AI Content Generation
            </div>
            <div class="section-content" id="content-generation-content">
                <!-- Generated Content Results -->
                <div id="generatedContentResults" class="d-none">
                    <h6 class="text-info mb-3">
                        <i class="fas fa-check-circle me-2"></i>Generated Facebook Posts
                    </h6>
                    <div id="generatedPostsContainer">
                        <!-- Generated posts will be displayed here -->
                    </div>
                </div>
                
                <!-- Placeholder when no content generated -->
                <div id="contentGenerationPlaceholder">
                    <div style="text-align: center; color: #94a3b8; padding: 40px 20px; font-style: italic;">
                        <i class="fas fa-robot" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        Select a post and click "Generate all sections" to create Facebook posts from your blog content.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Posting Control Section -->
        <div class="section-card">
            <div class="section-title with-right-content" onclick="toggleAccordion('posting-control')">
                <div class="section-title-left">
                    <i class="fas fa-chevron-right accordion-chevron" id="posting-control-chevron"></i>
                    <i class="fas fa-paper-plane"></i>
                    Posting Control
                </div>
                <div class="section-title-right" id="next-posts-info" style="font-size: 0.9rem; color: #94a3b8;">
                    Loading...
                </div>
            </div>
            <div class="section-content" id="posting-control-content">
                <div style="text-align: center; color: #94a3b8; padding: 40px 20px; font-style: italic;">
                    <i class="fas fa-paper-plane" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    Posting control functionality will be implemented here
                </div>
            </div>
        </div>
        
        <!-- Posting Queue Section -->
        <div class="section-card" data-accordion="posting-queue">
            <div class="section-title with-right-content" onclick="toggleAccordion('posting-queue')">
                <div class="section-title-left">
                    <i class="fas fa-chevron-right accordion-chevron" id="posting-queue-chevron"></i>
                    <i class="fas fa-list-alt"></i>
                    Posting Queue
                </div>
                <div class="section-title-right">
                    <span id="queue-count" class="badge" style="background: #f59e0b; color: #0f172a;">0</span>
                </div>
            </div>
            <div class="section-content" id="posting-queue-content">
                <div style="text-align: center; color: #94a3b8; padding: 40px 20px; font-style: italic;">
                    <i class="fas fa-list-alt" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    Posting queue functionality will be implemented here
                </div>
            </div>
        </div>
        
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function toggleAccordion(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const chevron = document.getElementById(sectionId + '-chevron');
            
            if (content.classList.contains('expanded')) {
                // Collapse
                content.classList.remove('expanded');
                chevron.classList.remove('expanded');
            } else {
                // Expand
                content.classList.add('expanded');
                chevron.classList.add('expanded');
            }
        }

        // Manual Post Selection Functionality
        function loadPosts() {
            const postSelector = document.getElementById('postSelector');
            
            // Show loading state
            postSelector.innerHTML = '<option value="">Loading posts...</option>';
            
            // Get all published posts
            fetch('/api/syndication/posts')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.posts && data.posts.length > 0) {
                        postSelector.innerHTML = '<option value="">Select a post...</option>';
                        data.posts.forEach(post => {
                            const option = document.createElement('option');
                            option.value = post.id;
                            option.textContent = `${post.title} (ID: ${post.id})`;
                            postSelector.appendChild(option);
                        });
                    } else {
                        postSelector.innerHTML = '<option value="">No posts found</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading posts:', error);
                    postSelector.innerHTML = '<option value="">Error loading posts</option>';
                });
        }

        function loadPostSections(postId) {
            const sectionsContainer = document.getElementById('sectionsContainer');
            const sectionsList = document.getElementById('sectionsList');
            
            fetch(`/api/syndication/post-sections/${postId}`)
                .then(response => response.json())
                .then(data => {
                    sectionsContainer.innerHTML = '';
                    
                    if (data.sections && data.sections.length > 0) {
                        // Store sections globally for content generation
                        currentSections = data.sections;
                        currentPostId = postId;
                        
                        // Update section count and enable generate button
                        updateSectionCount(data.sections.length);
                        
                        data.sections.forEach(section => {
                            const sectionDiv = document.createElement('div');
                            sectionDiv.className = 'mb-2 p-2 bg-dark border border-secondary rounded';
                            sectionDiv.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-white">Section ${section.order}: ${section.title || 'Untitled'}</strong>
                                        <small class="text-muted d-block">${section.content ? section.content.substring(0, 100) + '...' : 'No content'}</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-info">${section.id}</span>
                                    </div>
                                </div>
                            `;
                            sectionsContainer.appendChild(sectionDiv);
                        });
                        sectionsList.classList.remove('d-none');
                    } else {
                        currentSections = [];
                        currentPostId = null;
                        updateSectionCount(0);
                        sectionsContainer.innerHTML = '<p class="text-muted">No sections found for this post.</p>';
                        sectionsList.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error loading sections:', error);
                    currentSections = [];
                    currentPostId = null;
                    updateSectionCount(0);
                    sectionsContainer.innerHTML = '<p class="text-danger">Error loading sections</p>';
                    sectionsList.classList.remove('d-none');
                });
        }

        function updatePostDetails(post) {
            document.getElementById('postTitle').textContent = post.title;
            document.getElementById('postCreatedAt').textContent = new Date(post.created_at).toLocaleDateString();
            document.getElementById('postUpdatedAt').textContent = new Date(post.updated_at).toLocaleDateString();
            document.getElementById('postId').textContent = post.id;
            document.getElementById('postStatus').textContent = post.status;
            document.getElementById('postSlug').textContent = post.slug;
            document.getElementById('postSectionCount').textContent = post.section_count || 'Unknown';
            
            document.getElementById('postDetails').classList.remove('d-none');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load all posts for manual selection
            loadPosts();
            
            // Add event listener for post selection
            document.getElementById('postSelector').addEventListener('change', function() {
                const postId = this.value;
                if (postId) {
                    loadPostSections(postId);
                    // Load post details
                    fetch(`/api/syndication/posts/${postId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success' && data.post) {
                                updatePostDetails(data.post);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading post details:', error);
                        });
                } else {
                    document.getElementById('postDetails').classList.add('d-none');
                    document.getElementById('sectionsList').classList.add('d-none');
                }
            });
            
            // Add event listener for Generate All Sections button
            document.getElementById('generateAllSectionsBtn').addEventListener('click', function() {
                generateAllSections();
            });
        });
        
        // Content Generation Functions
        let currentSections = [];
        let currentPostId = null;
        
        function updateSectionCount(count) {
            document.getElementById('sectionCount').textContent = count;
            const generateBtn = document.getElementById('generateAllSectionsBtn');
            generateBtn.disabled = count === 0;
        }
        
        function showProgress(show = true) {
            const progressDiv = document.getElementById('generationProgress');
            if (show) {
                progressDiv.classList.remove('d-none');
            } else {
                progressDiv.classList.add('d-none');
            }
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        async function generateAllSections() {
            if (!currentPostId || currentSections.length === 0) {
                alert('Please select a post with sections first.');
                return;
            }
            
            const generateBtn = document.getElementById('generateAllSectionsBtn');
            const originalText = generateBtn.innerHTML;
            
            try {
                // Disable button and show progress
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
                showProgress(true);
                
                let completedCount = 0;
                const totalCount = currentSections.length;
                const generatedPosts = [];
                
                // Process each section sequentially
                for (let i = 0; i < currentSections.length; i++) {
                    const section = currentSections[i];
                    
                    // Update progress
                    const percent = Math.round((completedCount / totalCount) * 100);
                    updateProgress(percent, `Processing section ${completedCount + 1}/${totalCount}: ${section.title}`);
                    
                    try {
                        // Generate content for this section
                        const generatedContent = await processSectionWithLLM(section, i);
                        generatedPosts.push({
                            sectionId: section.id,
                            sectionTitle: section.title,
                            content: generatedContent,
                            sectionIndex: i
                        });
                        
                        completedCount++;
                        
                        // Small delay between sections
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        console.error(`Error processing section ${i + 1}:`, error);
                        // Continue with next section
                    }
                }
                
                // Update progress to completion
                updateProgress(100, `Completed! Generated ${completedCount} Facebook posts.`);
                
                // Display results
                displayGeneratedPosts(generatedPosts);
                
                // Show success message
                setTimeout(() => {
                    showProgress(false);
                    alert(`Successfully generated ${completedCount} Facebook posts! Check the AI Content Generation panel.`);
                }, 1000);
                
            } catch (error) {
                console.error('Error generating content:', error);
                alert(`Error generating content: ${error.message}`);
                showProgress(false);
            } finally {
                // Restore button
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        }
        
        async function processSectionWithLLM(section, sectionIndex) {
            try {
                // Get LLM settings (using defaults for now)
                const llmRequest = {
                    provider: 'ollama',
                    model: 'mistral',
                    prompt: assembleLLMPrompt(section),
                    temperature: 0.7,
                    max_tokens: 1000
                };
                
                // Send to LLM service
                const response = await fetch('/api/syndication/ollama/direct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(llmRequest)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Extract response content
                const responseContent = result.output || result.result || result.response || result.content || 'No response received';
                
                // Save to database
                await saveSyndicationPiece(section, responseContent, llmRequest, sectionIndex);
                
                return responseContent;
                
            } catch (error) {
                console.error('Error processing section with LLM:', error);
                throw error;
            }
        }
        
        function assembleLLMPrompt(section) {
            const systemPrompt = 'You are a social media content specialist. Write a Facebook feed post based on the blog section below.';
            const userPrompt = `RULES:
. Output ONLY the final post text â€” no explanations, no notes, no commentary, no placeholders, no brackets.
. Use a conversational, engaging, and authentic tone.
. Include a clear call-to-action.
. Avoid the word 'delve'.
. Use EXACTLY THREE relevant hashtags, placed ONLY at the very end.
. Post length must be 150â€“200 characters.`;
            
            // Get blog post title
            const postTitle = document.getElementById('postTitle').textContent || 'Blog Post';
            
            // Clean section content
            let sectionText = section.content || section.polished || 'No content available';
            sectionText = sectionText
                .replace(/#\d+/g, '') // Remove post numbers like #53
                .replace(/<[^>]*>/g, '') // Remove HTML tags
                .replace(/\s+/g, ' ') // Normalize whitespace
                .trim();
            
            // Build the blog details section
            const blogDetails = `Title: ${postTitle}\nSection: ${section.title}\nText: ${sectionText}`;
            
            // Assemble the final prompt
            const finalPrompt = `${systemPrompt}\n\n${userPrompt}\n\n=== BLOG DETAILS ===\n${blogDetails}\n\nNow write the final Facebook post`;
            
            return finalPrompt;
        }
        
        async function saveSyndicationPiece(section, generatedContent, llmRequest, sectionIndex) {
            try {
                const pieceData = {
                    post_id: currentPostId,
                    section_id: section.id,
                    platform_id: 1, // Facebook
                    channel_type_id: 1, // feed_post
                    process_id: 1, // Default process
                    original_content: JSON.stringify({
                        title: section.title,
                        content: section.content,
                        polished: section.polished
                    }),
                    generated_content: generatedContent,
                    llm_model: llmRequest.model,
                    llm_temperature: llmRequest.temperature,
                    llm_max_tokens: llmRequest.max_tokens,
                    llm_provider: llmRequest.provider,
                    prompt_used: llmRequest.prompt,
                    processing_time_ms: 0, // Will be calculated if needed
                    platform_name: 'Facebook',
                    channel_type_name: 'feed_post',
                    requirements: 'Facebook feed post requirements'
                };
                
                const response = await fetch('/api/syndication/pieces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pieceData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('Syndication piece saved successfully:', result);
                } else {
                    console.error('Failed to save syndication piece:', result.error);
                }
                
            } catch (error) {
                console.error('Error saving syndication piece:', error);
            }
        }
        
        function displayGeneratedPosts(generatedPosts) {
            const resultsDiv = document.getElementById('generatedContentResults');
            const placeholderDiv = document.getElementById('contentGenerationPlaceholder');
            const container = document.getElementById('generatedPostsContainer');
            
            // Hide placeholder and show results
            placeholderDiv.classList.add('d-none');
            resultsDiv.classList.remove('d-none');
            
            // Clear previous results
            container.innerHTML = '';
            
            // Display each generated post
            generatedPosts.forEach((post, index) => {
                const postElement = document.createElement('div');
                postElement.className = 'generated-post mb-4 p-3 bg-dark border border-secondary rounded';
                postElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="text-info mb-0">Section ${post.sectionIndex + 1}: ${post.sectionTitle}</h6>
                        <span class="badge bg-success">Generated</span>
                    </div>
                    <div class="generated-content p-3 bg-secondary rounded">
                        <p class="mb-0 text-white">${post.content}</p>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Generated: ${new Date().toLocaleTimeString()}
                        </small>
                    </div>
                `;
                container.appendChild(postElement);
            });
            
            // Auto-expand the AI Content Generation accordion
            const accordionContent = document.getElementById('content-generation-content');
            const chevron = document.getElementById('content-generation-chevron');
            if (accordionContent && chevron) {
                accordionContent.style.display = 'block';
                chevron.classList.remove('fa-chevron-right');
                chevron.classList.add('fa-chevron-down');
            }
        }
    </script>
</body>
</html>
