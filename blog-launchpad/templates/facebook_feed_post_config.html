<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ platform.display_name }} {{ channel_type.display_name }} Configuration - Blog Launchpad</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/launchpad.css') }}">
    <style>
        /* Channel config specific styles */
        .channel-header {
            background: linear-gradient(135deg, #1877f2 0%, #0d6efd 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
        }
        
        .config-section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            color: #e0e0e0;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .config-card {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .config-card.channel-specific {
            border-left: 6px solid #06b6d4;
        }
        
        .config-card.platform-wide {
            border-left: 6px solid #8b5cf6;
        }
        
        .card-header {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid #4a5568;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568;
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-name {
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .config-value {
            color: #a0aec0;
            font-family: monospace;
        }
        
        .config-description {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        /* Accordion Styles for Channel Requirements */
        .accordion-item.config-card {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .accordion-button {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border: none;
            color: #e0e0e0;
            padding: 1.25rem;
            font-weight: 600;
            box-shadow: none;
        }
        
        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(6, 182, 212, 0.25);
            border-color: #06b6d4;
        }
        
        .accordion-button::after {
            display: none;
        }
        
        .requirement-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .requirement-indicator .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }
        
        .requirement-indicator .fa-chevron-down {
            transition: transform 0.3s ease;
        }
        
        .accordion-collapse {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
        }
        
        .accordion-body {
            padding: 1.5rem;
            border-top: 1px solid #4a5568;
        }
        
        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .requirement-category {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .category-title {
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #4a5568;
        }
        
        .requirement-category .config-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568;
        }
        
        .requirement-category .config-item:last-child {
            border-bottom: none;
        }
        
        .breadcrumb-nav {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .breadcrumb-item {
            color: #a0aec0;
        }
        
        .breadcrumb-item.active {
            color: #e0e0e0;
        }
        
        .breadcrumb-item a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb-item a:hover {
            color: #a5b4fc;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #10b981;
            color: white;
        }
        
        .status-limited {
            background: #f59e0b;
            color: white;
        }
        
        .status-draft {
            background: #6b7280;
            color: white;
        }
        
        .priority-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .priority-high {
            background: #dc2626;
            color: white;
        }
        
        .priority-medium {
            background: #ea580c;
            color: white;
        }
        
        .priority-low {
            background: #16a34a;
            color: white;
        }
    </style>
</head>
<body style="background-color: #0f1419; color: #e0e0e0;">
    <div class="container-fluid">
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb-nav">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="/syndication"><i class="fas fa-home me-1"></i>Syndication</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/syndication/dashboard"><i class="fab fa-{{ platform.name|lower }} me-1"></i>{{ platform.display_name }}</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i class="fas fa-newspaper me-1"></i>{{ channel_type.display_name }} Configuration
                    </li>
                </ol>
            </nav>
        </div>
        
        <!-- Channel Header -->
        <div class="channel-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-3">
                        <i class="fas fa-newspaper me-3"></i>{{ platform.display_name }} {{ channel_type.display_name }} Configuration
                    </h1>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Status:</strong> <span class="status-badge status-active">Active</span></p>
                            <p class="mb-2"><strong>Priority Score:</strong> <span class="priority-indicator priority-high">0.92</span></p>
                            <p class="mb-0"><strong>Development:</strong> <span class="status-badge status-active">Complete</span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Configurations:</strong> <span class="badge bg-info">{{ configs_count }}</span></p>
                            <p class="mb-2"><strong>Success Rate:</strong> <span class="badge bg-success">{{ "%.1f%%"|format(platform.success_rate_percentage) if platform.success_rate_percentage else "N/A" }}</span></p>
                            <p class="mb-0"><strong>Last Updated:</strong> {{ platform.updated_at.strftime('%Y-%m-%d %H:%M') if platform.updated_at else "Never" }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group-vertical">
                        <button class="btn btn-outline-light mb-2">
                            <i class="fas fa-edit me-2"></i>Edit Configuration
                        </button>
                        <button class="btn btn-outline-light mb-2">
                            <i class="fas fa-copy me-2"></i>Duplicate
                        </button>
                        <button class="btn btn-outline-light">
                            <i class="fas fa-trash me-2"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Disambiguation Legend -->
        <div class="alert alert-info" style="background: rgba(59, 130, 246, 0.1); border-color: #3b82f6;">
            <h6 class="alert-heading">
                <i class="fas fa-info-circle me-2"></i>Disambiguation Principle in Action
            </h6>
            <p class="mb-2">This view demonstrates the clear separation between platform-wide capabilities and channel-specific requirements:</p>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <div style="width: 16px; height: 16px; background-color: #8b5cf6; border-radius: 4px; margin-right: 8px;"></div>
                        <span><strong>Platform-Wide:</strong> General {{ platform.display_name }} capabilities that apply to all channels</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <div style="width: 16px; height: 16px; background-color: #06b6d4; border-radius: 4px; margin-right: 8px;"></div>
                        <span><strong>Channel-Specific:</strong> Requirements and settings specific to {{ channel_type.display_name }} only</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MVP LLM Test Interface (Active) -->
        <div class="config-section">
            <h3 class="section-title">
                <i class="fas fa-robot text-success"></i>
                MVP LLM Test Interface - ACTIVE
            </h3>
            
            <!-- Post Conversion Accordion -->
            <div class="accordion" id="postConversionAccordion" style="margin-bottom: 2rem;">
                <!-- Post Rewriting Section -->
                <div class="accordion-item" style="background: linear-gradient(135deg, #1a1d29 0%, #23273a 100%); border: 2px solid #22c55e; border-radius: 12px; overflow: hidden;">
                    <h2 class="accordion-header" id="headingTestLLM">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapseTestLLM" aria-expanded="false" 
                                aria-controls="collapseTestLLM"
                                style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none;">
                            <div class="d-flex align-items-center w-100">
                                <i class="fas fa-robot text-white me-3"></i>
                                <span class="flex-grow-1">Post Rewriting</span>
                                <div class="requirement-indicator">
                                    <span class="badge bg-white text-success me-2">Active</span>
                                    <i class="fas fa-chevron-down text-white"></i>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapseTestLLM" class="accordion-collapse collapse" 
                         aria-labelledby="headingTestLLM" 
                         data-bs-parent="#postConversionAccordion">
                        <div class="accordion-body" style="padding: 2rem;">
                            <div class="text-center mb-4">
                                <h4 class="text-white mb-3">
                                    <i class="fas fa-robot text-success me-3"></i>
                                    Test LLM Post Rewriting
                                </h4>
                                <p class="text-light mb-0">
                                    Test LLM-based post rewriting using {{ platform.display_name }} {{ channel_type.display_name }} channel requirements
                                </p>
                            </div>
                            
                            <!-- Channel Requirements Display -->
                            {% include 'includes/conversion_settings.html' %}
                            
                            <!-- LLM Test Area -->
                            <div class="test-area" style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 1.5rem;">
                                <div class="mb-3">
                                    <label for="blogContent" class="form-label text-white">Blog Post Content:</label>
                                    <textarea class="form-control" id="blogContent" rows="6" placeholder="Paste your blog post content here..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <button class="btn btn-success btn-lg" onclick="testLLM()">
                                        <i class="fas fa-magic me-2"></i>Rewrite for Facebook Feed Post
                                    </button>
                                </div>
                                
                                <div id="llmResult" style="display: none;">
                                    <h5 class="text-white mb-3">LLM Rewritten Post:</h5>
                                    <div class="alert alert-success">
                                        <div id="rewrittenContent"></div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-light">
                                            <strong>Applied Rules:</strong> 
                                            <span id="appliedRules"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Post Publication Accordion -->
            <div class="accordion" id="postPublicationAccordion" style="margin-bottom: 2rem;">
                <div class="accordion-item" style="background: linear-gradient(135deg, #1a1d29 0%, #23273a 100%); border: 2px solid #3b82f6; border-radius: 12px; overflow: hidden;">
                    <h2 class="accordion-header" id="headingPostPublication">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapsePostPublication" aria-expanded="false" 
                                aria-controls="collapsePostPublication"
                                style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none;">
                            <div class="d-flex align-items-center w-100">
                                <i class="fas fa-paper-plane text-white me-3"></i>
                                <span class="flex-grow-1">Post Publication</span>
                                <div class="requirement-indicator">
                                    <span class="badge bg-white text-primary me-2">Ready</span>
                                    <i class="fas fa-chevron-down text-white"></i>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapsePostPublication" class="accordion-collapse collapse" 
                         aria-labelledby="headingPostPublication" 
                         data-bs-parent="#postPublicationAccordion">
                        <div class="accordion-body" style="padding: 2rem;">
                            <div class="text-center mb-4">
                                <h4 class="text-white mb-3">
                                    <i class="fas fa-paper-plane text-primary me-3"></i>
                                    Facebook Post Assembly
                                </h4>
                                <p class="text-light mb-0">
                                    Assemble and preview your Facebook post before publication
                                </p>
                            </div>
                            
                            <!-- Content Assembly Section -->
                            <div class="content-assembly mb-4" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 8px; padding: 1.5rem;">
                                <h5 class="text-white mb-3">
                                    <i class="fas fa-puzzle-piece text-primary me-2"></i>
                                    Content Assembly
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="setting-item mb-3">
                                            <label class="form-label text-white">Blog Post Selection:</label>
                                            <select class="form-select bg-dark text-white border-primary" id="blogPostSelect">
                                                <option value="">Loading posts...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="setting-item mb-3">
                                            <label class="form-label text-white">Section Selection:</label>
                                            <select class="form-select bg-dark text-white border-primary" id="sectionSelect" disabled>
                                                <option value="">Select a post first...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="setting-item mb-3">
                                            <label class="form-label text-white">Caption Builder:</label>
                                            <textarea class="form-control bg-dark text-white border-primary" id="captionBuilder" rows="4" placeholder="AI-generated caption will appear here... You can edit this text to customize your post."></textarea>
                                            <div class="d-flex justify-content-between mt-2">
                                                <small class="text-light">Character count: <span id="captionCharCount">0</span>/63,206</small>
                                                <button class="btn btn-sm btn-outline-primary" onclick="regenerateCaption()">
                                                    <i class="fas fa-magic me-1"></i>Regenerate with AI
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                

                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="setting-item mb-3">
                                            <label class="form-label text-white">Blog URL:</label>
                                            <input type="text" class="form-control bg-dark text-white border-primary" id="blogUrl" readonly placeholder="Will be auto-populated from selected post">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Facebook API Payload Preview -->
                            <div class="api-payload-preview mb-4" style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px; padding: 1.5rem;">
                                <h5 class="text-white mb-3">
                                    <i class="fas fa-code text-success me-2"></i>
                                    Facebook API Payload
                                </h5>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label text-white">API Endpoint:</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-dark text-white border-success">POST</span>
                                            <input type="text" class="form-control bg-dark text-white border-success" id="apiEndpoint" readonly value="https://graph.facebook.com/{PAGE_ID}/photos">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label text-white">Request Payload:</label>
                                        <pre id="apiPayload" class="bg-dark text-white border-success p-3 rounded" style="font-size: 0.9rem; max-height: 200px; overflow-y: auto;">{
  "caption": "Your caption will appear here...",
  "url": "Image URL will appear here...",
  "published": false,
  "access_token": "PAGE_ACCESS_TOKEN"
}</pre>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="validation-status">
                                            <h6 class="text-white mb-2">Validation Status:</h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                <span class="badge bg-success" id="validationImageSize">
                                                    <i class="fas fa-check me-1"></i>Image Size âœ“
                                                </span>
                                                <span class="badge bg-success" id="validationCaptionLength">
                                                    <i class="fas fa-check me-1"></i>Caption Length âœ“
                                                </span>
                                                <span class="badge bg-warning" id="validationImageFormat">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Image Format
                                                </span>
                                                <span class="badge bg-danger" id="validationBlogUrl">
                                                    <i class="fas fa-times me-1"></i>Blog URL
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Output Format Preview -->
                            <div class="output-preview mb-4" style="background: rgba(168, 85, 247, 0.1); border: 1px solid #a855f7; border-radius: 8px; padding: 1.5rem;">
                                <h5 class="text-white mb-3">
                                    <i class="fas fa-eye text-purple me-2"></i>
                                    Facebook Post Preview
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="image-preview text-center">
                                            <div class="bg-dark rounded p-3" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                                            </div>
                                            <small class="text-light mt-2 d-block">Image Preview (1200Ã—630)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="post-preview bg-white text-dark p-3 rounded">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="bg-primary rounded-circle me-2" style="width: 40px; height: 40px;"></div>
                                                <div>
                                                    <strong>Your Page Name</strong>
                                                    <div class="text-muted small">Just now</div>
                                                </div>
                                            </div>
                                            <div id="previewCaption" class="mb-2">Your caption will appear here...</div>
                                            <div id="previewImage" class="bg-light rounded" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-image text-muted"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Assembly Controls -->
                            <div class="assembly-controls text-center">
                                <button class="btn btn-primary btn-lg me-3" onclick="buildPost()">
                                    <i class="fas fa-cogs me-2"></i>Build Post
                                </button>
                                <button class="btn btn-success btn-lg me-3" onclick="testPayload()">
                                    <i class="fas fa-vial me-2"></i>Test Payload
                                </button>
                                <button class="btn btn-info btn-lg" onclick="exportPayload()">
                                    <i class="fas fa-download me-2"></i>Export Payload
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Performance Metrics -->
        <div class="config-section">
            <h3 class="section-title">
                <i class="fas fa-chart-line text-success"></i>
                Performance Metrics
            </h3>
            
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card" style="background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%); border: 1px solid #4a5568;">
                        <div class="card-body text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #10b981;">{{ "%.1f%%"|format(platform.success_rate_percentage) if platform.success_rate_percentage else "N/A" }}</div>
                            <div style="color: #a0aec0; font-size: 0.9rem;">Success Rate</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card" style="background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%); border: 1px solid #4a5568;">
                        <div class="card-body text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{{ "%.1fs"|format(platform.average_response_time_ms/1000) if platform.average_response_time_ms else "N/A" }}</div>
                            <div style="color: #a0aec0; font-size: 0.9rem;">Avg Processing</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card" style="background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%); border: 1px solid #4a5568;">
                        <div class="card-body text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">{{ execution_data.total_executions if execution_data and execution_data.total_executions else 0 }}</div>
                            <div style="color: #a0aec0; font-size: 0.9rem;">Total Executions</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card" style="background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%); border: 1px solid #4a5568;">
                        <div class="card-body text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;">{{ configs_count }}</div>
                            <div style="color: #a0aec0; font-size: 0.9rem;">Active Configs</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Channel configuration functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Facebook Feed Post configuration loaded');
            
            // Add any interactive functionality here
            const editButtons = document.querySelectorAll('.btn-outline-light');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const action = this.textContent.trim();
                    console.log(`Action clicked: ${action}`);
                    
                    // For now, just show an alert
                    if (action.includes('Edit')) {
                        alert('Edit functionality coming soon!');
                    } else if (action.includes('Duplicate')) {
                        alert('Duplicate functionality coming soon!');
                    } else if (action.includes('Delete')) {
                        if (confirm('Are you sure you want to delete this configuration?')) {
                            alert('Delete functionality coming soon!');
                        }
                    }
                });
            });
            
            // Accordion functionality for Channel Requirements
            const accordionButtons = document.querySelectorAll('.accordion-button');
            
            accordionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const chevron = this.querySelector('.fa-chevron-down');
                    if (chevron) {
                        // Toggle chevron rotation
                        if (this.classList.contains('collapsed')) {
                            chevron.style.transform = 'rotate(0deg)';
                        } else {
                            chevron.style.transform = 'rotate(180deg)';
                        }
                    }
                });
            });
            
            // MVP Requirements Accordion functionality
            const mvpAccordionButtons = document.querySelectorAll('#mvpRequirementsAccordion .accordion-button');
            
            mvpAccordionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const chevron = this.querySelector('.fa-chevron-down');
                    if (chevron) {
                        // Toggle chevron rotation
                        if (this.classList.contains('collapsed')) {
                            chevron.style.transform = 'rotate(0deg)';
                        } else {
                            chevron.style.transform = 'rotate(180deg)';
                        }
                    }
                });
            });
        });
        
        // MVP LLM Test Functionality
        function testLLM() {
            const blogContent = document.getElementById('blogContent').value;
            if (!blogContent.trim()) {
                alert('Please enter some blog content to test.');
                return;
            }

            // Show loading state
            const resultDiv = document.getElementById('llmResult');
            const rewrittenContent = document.getElementById('rewrittenContent');
            const appliedRules = document.getElementById('appliedRules');
            
            resultDiv.style.display = 'block';
            rewrittenContent.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing with LLM...';
            appliedRules.innerHTML = 'Analyzing requirements...';

            // Simulate LLM processing (replace with actual LLM API call)
            setTimeout(() => {
                // Mock LLM response based on stored requirements
                const mockResponse = generateMockLLMResponse(blogContent);
                
                rewrittenContent.innerHTML = mockResponse.content;
                appliedRules.innerHTML = mockResponse.rules;
            }, 2000);
        }

        function generateMockLLMResponse(originalContent) {
            // Generate response based on actual database requirements - 100% DB-driven
            const requirements = {{ requirements|tojson }};
            const appliedRules = [];
            
            // Safety check - ensure requirements exist
            if (!requirements || requirements.length === 0) {
                return {
                    content: 'âš ï¸ No channel requirements found in database. Please configure requirements first.',
                    rules: 'No rules available'
                };
            }
            
            // Process each requirement to create applied rules
            requirements.forEach(req => {
                if (req.requirement_category === 'content' && req.requirement_key === 'tone_guidelines') {
                    appliedRules.push(`Applied tone: ${req.requirement_value}`);
                } else if (req.requirement_key === 'max_hashtags') {
                    appliedRules.push(`Applied hashtag limit: ${req.requirement_value} hashtags`);
                } else if (req.requirement_key === 'image_width' && req.requirement_value === '1200') {
                    const height = requirements.find(r => r.requirement_key === 'image_height')?.requirement_value || '630';
                    const ratio = requirements.find(r => r.requirement_key === 'aspect_ratio')?.requirement_value || '1.91:1';
                    appliedRules.push(`Applied image dimensions: ${req.requirement_value}x${height} (${ratio} ratio)`);
                } else if (req.requirement_key === 'cta_strategy') {
                    appliedRules.push(`Applied CTA strategy: ${req.requirement_value}`);
                }
            });
            
            // Generate content based on actual requirements
            let content = `ðŸŽ¯ ${originalContent.substring(0, 200)}...\n\n`;
            
            // Add content based on tone guidelines if available
            const toneReq = requirements.find(r => r.requirement_key === 'tone_guidelines');
            if (toneReq) {
                content += `ðŸ’¡ Tone: ${toneReq.requirement_value}\n\n`;
            }
            
            // Add hashtag guidance if available
            const hashtagReq = requirements.find(r => r.requirement_key === 'max_hashtags');
            if (hashtagReq) {
                content += `ðŸš€ Optimized for Facebook engagement with ${hashtagReq.requirement_value} strategic hashtags.\n\n`;
            }
            
            // Add CTA if available
            const ctaReq = requirements.find(r => r.requirement_key === 'cta_strategy');
            if (ctaReq) {
                content += `ðŸ“¢ ${ctaReq.requirement_value}\n\n`;
            }
            
            // Add generic hashtags based on content
            content += `#FacebookMarketing #ContentStrategy #SocialMediaSuccess`;
            
            return {
                content: content,
                rules: appliedRules.join(' â€¢ ')
            };
        }
        
        // Post Assembly Functionality
        function regenerateCaption() {
            const blogPost = document.getElementById('blogPostSelect').value;
            if (!blogPost) {
                alert('Please select a blog post first.');
                return;
            }
            
            // Simulate AI caption generation
            const caption = `ðŸŽ¯ Discover the fascinating world of Scottish storytelling traditions! From ancient Highland tales to modern interpretations, these stories have shaped our cultural heritage for generations. Perfect for anyone interested in Celtic folklore and traditional narratives. Read more to explore the rich tapestry of Scottish oral traditions! #ScottishCulture #HighlandTales #CelticFolklore #Storytelling #CulturalHeritage`;
            
            document.getElementById('captionBuilder').value = caption;
            updateCaptionCharCount();
            updatePreview();
        }
        
        function buildPost() {
            const blogPost = document.getElementById('blogPostSelect').value;
            const sectionType = document.getElementById('sectionSelect').value;
            const caption = document.getElementById('captionBuilder').value;
            
            if (!blogPost || !sectionType || !caption.trim()) {
                alert('Please complete all required fields: Blog Post, Section Selection, and Caption.');
                return;
            }
            
            // Build the Facebook API payload
            const payload = {
                caption: caption + " https://clan.com/blog/scottish-storytelling",
                url: "https://yourcdn.com/images/scottish-storytelling-header.jpg",
                published: false,
                access_token: "PAGE_ACCESS_TOKEN"
            };
            
            // Update the API payload preview
            document.getElementById('apiPayload').textContent = JSON.stringify(payload, null, 2);
            
            // Update validation status
            updateValidationStatus();
            
            // Update preview
            updatePreview();
            
            alert('Post assembled successfully! Check the API Payload and Preview sections.');
        }
        
        function testPayload() {
            const payload = document.getElementById('apiPayload').textContent;
            if (payload.includes('Your caption will appear here')) {
                alert('Please build the post first using the "Build Post" button.');
                return;
            }
            
            // Simulate payload validation
            alert('Payload validation completed! All requirements met for Facebook posting.');
        }
        
        function exportPayload() {
            const payload = document.getElementById('apiPayload').textContent;
            if (payload.includes('Your caption will appear here')) {
                alert('Please build the post first using the "Build Post" button.');
                return;
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(payload).then(() => {
                alert('Facebook API payload copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = payload;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Facebook API payload copied to clipboard!');
            });
        }
        
        function updateCaptionCharCount() {
            const caption = document.getElementById('captionBuilder').value;
            const charCount = caption.length;
            document.getElementById('captionCharCount').textContent = charCount;
            
            // Update character count color based on limits
            const charCountElement = document.getElementById('captionCharCount');
            if (charCount > 50000) {
                charCountElement.className = 'text-danger';
            } else if (charCount > 40000) {
                charCountElement.className = 'text-warning';
            } else {
                charCountElement.className = 'text-light';
            }
        }
        
        function updatePreview() {
            const caption = document.getElementById('captionBuilder').value;
            const sectionSelect = document.getElementById('sectionSelect');
            const sectionType = sectionSelect.value;
            
            // Update caption preview
            document.getElementById('previewCaption').textContent = caption || 'Your caption will appear here...';
            
            // Update image preview
            const previewImage = document.getElementById('previewImage');
            if (sectionType) {
                previewImage.innerHTML = '<div class="bg-primary text-white p-3 rounded d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-layer-group me-2"></i>Selected Section Content</div>';
            } else {
                previewImage.innerHTML = '<i class="fas fa-image text-muted"></i>';
            }
        }
        
        function updateValidationStatus() {
            // Simulate validation checks
            const imageSize = document.getElementById('validationImageSize');
            const captionLength = document.getElementById('validationCaptionLength');
            const imageFormat = document.getElementById('validationImageFormat');
            const blogUrl = document.getElementById('validationBlogUrl');
            
            // Update validation badges
            imageSize.className = 'badge bg-success';
            imageSize.innerHTML = '<i class="fas fa-check me-1"></i>Image Size âœ“';
            
            captionLength.className = 'badge bg-success';
            captionLength.innerHTML = '<i class="fas fa-check me-1"></i>Caption Length âœ“';
            
            imageFormat.className = 'badge bg-success';
            imageFormat.innerHTML = '<i class="fas fa-check me-1"></i>Image Format âœ“';
            
            blogUrl.className = 'badge bg-success';
            blogUrl.innerHTML = '<i class="fas fa-check me-1"></i>Blog URL âœ“';
        }
        
        // Event listeners for real-time updates
        document.addEventListener('DOMContentLoaded', function() {
            const captionBuilder = document.getElementById('captionBuilder');
            const blogPostSelect = document.getElementById('blogPostSelect');
            const sectionSelect = document.getElementById('sectionSelect');
            
            if (captionBuilder) {
                captionBuilder.addEventListener('input', updateCaptionCharCount);
            }
            
            if (blogPostSelect) {
                blogPostSelect.addEventListener('change', function() {
                    // Auto-populate blog URL when post is selected
                    const blogUrl = document.getElementById('blogUrl');
                    const sectionSelect = document.getElementById('sectionSelect');
                    
                    if (this.value) {
                        blogUrl.value = `https://clan.com/blog/post-${this.value}`;
                        // Load sections for the selected post
                        loadPostSections(this.value);
                        sectionSelect.disabled = false;
                    } else {
                        blogUrl.value = '';
                        sectionSelect.innerHTML = '<option value="">Select a post first...</option>';
                        sectionSelect.disabled = true;
                    }
                });
            }
            
            if (sectionSelect) {
                sectionSelect.addEventListener('change', function() {
                    updatePreview();
                    // Populate Caption Builder with polished content from selected section
                    populateCaptionBuilder();
                });
            }
            
            // Load published posts for the dropdown
            loadPublishedPosts();
        });
        
        // Load published posts from the API
        function loadPublishedPosts() {
            const blogPostSelect = document.getElementById('blogPostSelect');
            
            fetch('/api/syndication/published-posts')
                .then(response => response.json())
                .then(data => {
                    blogPostSelect.innerHTML = '<option value="">Select a published blog post...</option>';
                    
                    data.posts.forEach(post => {
                        const option = document.createElement('option');
                        option.value = post.id;
                        option.textContent = `${post.title} (ID: ${post.id})`;
                        blogPostSelect.appendChild(option);
                    });
                    
                    // Auto-select the first (most recent) post
                    if (data.posts.length > 0) {
                        blogPostSelect.value = data.posts[0].id;
                        // Trigger change event to populate blog URL
                        blogPostSelect.dispatchEvent(new Event('change'));
                    }
                })
                .catch(error => {
                    console.error('Error loading posts:', error);
                    blogPostSelect.innerHTML = '<option value="">Error loading posts</option>';
                });
        }
        
        // Load sections for a selected post
        function loadPostSections(postId) {
            const sectionSelect = document.getElementById('sectionSelect');
            
            fetch(`/api/syndication/post-sections/${postId}`)
                .then(response => response.json())
                .then(data => {
                    sectionSelect.innerHTML = '<option value="">Select a section...</option>';
                    
                    if (data.sections && data.sections.length > 0) {
                        data.sections.forEach(section => {
                            const option = document.createElement('option');
                            option.value = section.id;
                            option.textContent = `Section ${section.order}: ${section.title || 'Untitled'}`;
                            // Store section data for later use
                            option.dataset.sectionData = JSON.stringify(section);
                            sectionSelect.appendChild(option);
                        });
                    } else {
                        sectionSelect.innerHTML = '<option value="">No sections found</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sections:', error);
                    sectionSelect.innerHTML = '<option value="">Error loading sections</option>';
                });
        }
        
        // Populate Caption Builder with content piece from selected section
        function populateCaptionBuilder() {
            const sectionSelect = document.getElementById('sectionSelect');
            const captionBuilder = document.getElementById('captionBuilder');
            
            if (sectionSelect.value) {
                const postId = document.getElementById('blogPostSelect').value;
                const sectionId = sectionSelect.value;
                
                // Fetch the content piece for this section from the syndication pieces API
                fetch(`/api/syndication/pieces?post_id=${postId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success' && data.pieces) {
                            // Find the piece for this specific section
                            const sectionPiece = data.pieces.find(piece => {
                                const metadata = piece.interaction_metadata;
                                return metadata && metadata.section_id == sectionId;
                            });
                            
                            if (sectionPiece && sectionPiece.generated_content) {
                                captionBuilder.value = sectionPiece.generated_content;
                            } else {
                                captionBuilder.value = 'No content piece available for this section.';
                            }
                        } else {
                            captionBuilder.value = 'No content pieces found for this post.';
                        }
                        // Update character count
                        updateCaptionCharCount();
                    })
                    .catch(error => {
                        console.error('Error loading content piece:', error);
                        captionBuilder.value = 'Error loading content piece.';
                        updateCaptionCharCount();
                    });
            } else {
                captionBuilder.value = '';
                updateCaptionCharCount();
            }
        }

        // Remote execution of Process Checked Sections script for selected section
        async function regenerateWithAI() {
            const sectionSelect = document.getElementById('sectionSelect');
            const captionBuilder = document.getElementById('captionBuilder');
            
            if (!sectionSelect.value) {
                alert('Please select a section first.');
                return;
            }
            
            const postId = document.getElementById('blogPostSelect').value;
            const sectionId = sectionSelect.value;
            
            // Get the button and show loading state
            const regenerateBtn = document.querySelector('button[onclick="regenerateWithAI()"]');
            const originalText = regenerateBtn.textContent;
            regenerateBtn.textContent = 'Regenerating...';
            regenerateBtn.disabled = true;
            
            try {
                // Step 1: Get LLM settings from the create-piece page
                const llmSettings = await getLLMSettings();
                if (!llmSettings.provider_id || !llmSettings.model_id) {
                    throw new Error('LLM settings not configured. Please configure LLM settings on the create-piece page first.');
                }
                
                // Step 2: Get process configuration for Facebook feed_post
                const processConfig = await getProcessConfig();
                
                // Step 3: Get section content
                const sectionContent = await getSectionContent(sectionId);
                if (!sectionContent) {
                    throw new Error('Could not retrieve section content.');
                }
                
                // Step 4: Assemble the LLM prompt (same logic as create-piece page)
                const fullPrompt = assembleLLMPrompt(processConfig, sectionContent, llmSettings);
                
                // Step 5: Prepare LLM request
                const llmRequest = {
                    provider: llmSettings.provider_name || 'ollama',
                    model: llmSettings.model_name || 'mistral',
                    prompt: fullPrompt,
                    temperature: parseFloat(llmSettings.temperature),
                    max_tokens: parseInt(llmSettings.max_tokens)
                };
                
                // Step 6: Send to LLM service
                const response = await fetch('/api/syndication/ollama/direct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(llmRequest)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Step 7: Extract response content
                const responseContent = result.output || result.result || result.response || result.content || 'No response received';
                
                // Step 8: Update Caption Builder
                captionBuilder.value = responseContent;
                updateCaptionCharCount();
                
                // Step 9: Save to syndication pieces database
                await saveSyndicationPiece(sectionId, responseContent, llmRequest, result);
                
                // Success feedback
                alert('Content regenerated successfully!');
                
            } catch (error) {
                console.error('Error regenerating content:', error);
                alert(`Error regenerating content: ${error.message}`);
            } finally {
                // Restore button state
                regenerateBtn.textContent = originalText;
                regenerateBtn.disabled = false;
            }
        }
        
        // Helper function to get LLM settings
        async function getLLMSettings() {
            // Try to get from the current page first, then fall back to defaults
            const providerSelect = document.getElementById('llmProviderSelect');
            const modelSelect = document.getElementById('llmModelSelect');
            const temperatureInput = document.getElementById('llmTemperature');
            const maxTokensInput = document.getElementById('llmMaxTokens');
            const systemPromptInput = document.getElementById('llmSystemPrompt');
            const userPromptInput = document.getElementById('llmUserPromptTemplate');
            
            if (providerSelect && modelSelect) {
                return {
                    provider_id: providerSelect.value,
                    model_id: modelSelect.value,
                    provider_name: providerSelect.options[providerSelect.selectedIndex]?.textContent || 'ollama',
                    model_name: modelSelect.options[modelSelect.selectedIndex]?.textContent || 'mistral',
                    temperature: temperatureInput?.value || '0.7',
                    max_tokens: maxTokensInput?.value || '1000',
                    system_prompt: systemPromptInput?.value || '',
                    user_prompt_template: userPromptInput?.value || ''
                };
            }
            
            // Fallback to default settings (these should match create-piece page defaults)
            return {
                provider_id: '1',
                model_id: '1',
                provider_name: 'ollama',
                model_name: 'mistral',
                temperature: '0.7',
                max_tokens: '1000',
                system_prompt: 'You are a social media content creator specializing in converting blog content into engaging social media posts.',
                user_prompt_template: 'Convert the following blog section into a {platform} {channel_type} post following these requirements:\n{requirements}'
            };
        }
        
        // Helper function to get process configuration
        async function getProcessConfig() {
            // For Facebook feed_post, we'll use default configuration
            return {
                process_name: 'Facebook Feed Post Conversion',
                description: 'Convert blog sections into Facebook feed posts',
                platform: 'Facebook',
                channel_type: 'feed post'
            };
        }
        
        // Helper function to get section content
        async function getSectionContent(sectionId) {
            const postId = document.getElementById('blogPostSelect').value;
            
            try {
                const response = await fetch(`/api/syndication/post-sections/${postId}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.sections) {
                    const section = data.sections.find(s => s.id == sectionId);
                    if (section) {
                        return {
                            title: section.title || 'Unknown Section Title',
                            content: section.content || '',
                            polished: section.polished || ''
                        };
                    }
                }
                throw new Error('Section not found');
            } catch (error) {
                console.error('Error fetching section content:', error);
                throw new Error('Could not retrieve section content');
            }
        }
        
        // Helper function to assemble LLM prompt (same logic as create-piece page)
        function assembleLLMPrompt(processConfig, sectionContent, llmSettings) {
            const systemPrompt = llmSettings.system_prompt || 'You are a social media content creator specializing in converting blog content into engaging social media posts.';
            const userPrompt = llmSettings.user_prompt_template || 'Convert the following blog section into a {platform} {channel_type} post following these requirements:\n{requirements}';
            
            // Replace placeholders
            let finalUserPrompt = userPrompt
                .replace('{platform}', processConfig.platform)
                .replace('{channel_type}', processConfig.channel_type)
                .replace('{requirements}', 'Create engaging, platform-appropriate content');
            
            // Build blog details
            const blogTitle = document.getElementById('blogPostSelect').options[document.getElementById('blogPostSelect').selectedIndex]?.textContent || 'Unknown Blog Title';
            const blogDetails = `POST TITLE: ${blogTitle}\nSECTION TITLE: ${sectionContent.title}\nSECTION TEXT: ${sectionContent.polished || sectionContent.content}`;
            
            // Assemble final prompt
            return `${systemPrompt}\n\n${finalUserPrompt}\n\n=== BLOG DETAILS ===\n${blogDetails}\n\n=== REQUIREMENTS ===\n- Create engaging, platform-appropriate content\n- Use appropriate tone and style for Facebook\n- Include relevant hashtags if appropriate\n- Keep content concise and engaging`;
        }
        
        // Helper function to save syndication piece
        async function saveSyndicationPiece(sectionId, generatedContent, llmRequest, llmResult) {
            const postId = document.getElementById('blogPostSelect').value;
            
            const pieceData = {
                post_id: postId,
                section_id: sectionId,
                platform_id: '1', // Facebook
                channel_type_id: '1', // feed_post
                process_id: '1', // Default process
                original_content: JSON.stringify({ title: 'Section content', content: 'Original section content' }),
                generated_content: generatedContent,
                llm_model: llmRequest.model,
                llm_temperature: llmRequest.temperature,
                llm_max_tokens: llmRequest.max_tokens,
                llm_provider: llmRequest.provider,
                prompt_used: llmRequest.prompt,
                processing_time_ms: 0,
                platform_name: 'Facebook',
                channel_type_name: 'feed_post',
                requirements: 'Facebook feed post conversion'
            };
            
            try {
                const response = await fetch('/api/syndication/pieces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pieceData)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    console.log('Syndication piece saved successfully');
                } else {
                    console.warn('Failed to save syndication piece:', result);
                }
            } catch (error) {
                console.error('Error saving syndication piece:', error);
            }
        }
    </script>
</body>
</html>
