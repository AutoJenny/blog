<!-- TEST MARKER 5: NAV TEMPLATE VERIFICATION -->
<!-- Workflow Navigation -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

{# Context-aware static file loading for modular architecture #}
{# This template works in both standalone and integrated contexts #}
{% if request.blueprint == 'workflow_nav' %}
{# Standalone mode - use blueprint static #}
<link rel="stylesheet" href="{{ url_for('workflow_nav.static', filename='css/nav.dist.css') }}">
{% else %}
{# Integrated mode - use main app static with module-specific naming #}
<link rel="stylesheet" href="{{ url_for('static', filename='workflow_nav/css/nav.dist.css') }}">
{% endif %}

<div class="bg-dark-bg py-6">
    <div class="container mx-auto px-6">
        <!-- Line 1: Breadcrumbs and Post Selector -->
        <div class="flex justify-between items-center mb-8">
            <nav class="text-base">
                <h2 class="text-2xl font-bold text-dark-text">{{ substage|title }} : {{
                    all_posts|selectattr('id', 'equalto', post_id)|map(attribute='title')|first }}</h2>
            </nav>
            <div class="relative flex items-center gap-3">
                <select id="post-selector"
                    class="bg-dark-bg border border-dark-border rounded-lg px-4 py-2 text-dark-text min-w-[200px]">
                    {% for post in all_posts %}
                    <option value="{{ post.id }}" {% if post.id==post_id %}selected{% endif %}>{{ post.title }}
                    </option>
                    {% endfor %}
                </select>
                <a href="http://localhost:5001/preview/{{ post_id }}" 
                   target="_blank"
                   class="bg-dark-accent hover:bg-dark-hover text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center gap-2 border border-dark-accent shadow">
                    <i class="fas fa-eye"></i>
                    Preview
                </a>
            </div>
        </div>

        <!-- Second line: All sub-stages as named icons in three groups of three -->
        <div class="flex justify-center gap-12 mb-8">
            <!-- Planning Group -->
            <div class="flex flex-col items-center">
                <span class="text-sm text-gray-400 mb-3 font-medium">Planning</span>
                <div class="flex gap-6">
                    {% for substage in ['idea', 'research', 'structure'] %}
                    {% set icon = {
                    'idea': 'lightbulb',
                    'research': 'search',
                    'structure': 'sitemap'
                    } %}
                    {% set is_active = stage == 'planning' and substage == substage %}
                    {% set first_step = stages.get('planning', {}).get(substage, ['initial_concept'])[0]|lower|replace(' ', '_') if stages and 'planning' in stages and substage in stages['planning'] and stages['planning'][substage] else 'initial_concept' %}
                    <a href="/workflow/posts/{{ post_id }}/planning/{{ substage }}/{{ first_step }}"
                        class="flex flex-col items-center p-4 bg-dark-bg border rounded-lg hover:bg-dark-hover transition-colors duration-200 {% if is_active %}border-blue-500 bg-dark-hover{% else %}border-dark-border{% endif %}">
                        <i
                            class="fas fa-{{ icon[substage] }} text-2xl mb-3 {% if is_active %}text-blue-500{% else %}text-dark-text{% endif %}"></i>
                        <div
                            class="text-sm {% if is_active %}text-blue-500 font-medium{% else %}text-dark-text{% endif %}">
                            {{ substage|title }}</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            <!-- Writing Group -->
            <div class="flex flex-col items-center">
                <span class="text-sm text-gray-400 mb-3 font-medium">Writing</span>
                <div class="flex gap-6">
                    {% for substage in ['sections', 'post_info', 'images'] %}
                    {% set icon = {
                    'sections': 'pen',
                    'post_info': 'tags',
                    'images': 'image'
                    } %}
                    {% set is_active = stage == 'writing' and substage == substage %}
                    {% set first_step = stages.get('writing', {}).get(substage, ['main'])[0]|lower|replace(' ', '_') if stages and 'writing' in stages and substage in stages['writing'] and stages['writing'][substage] else 'main' %}
                    <a href="/workflow/posts/{{ post_id }}/writing/{{ substage }}/{{ first_step }}"
                        class="flex flex-col items-center p-4 bg-dark-bg border rounded-lg hover:bg-dark-hover transition-colors duration-200 {% if is_active %}border-blue-500 bg-dark-hover{% else %}border-dark-border{% endif %}">
                        <i
                            class="fas fa-{{ icon[substage] }} text-2xl mb-3 {% if is_active %}text-blue-500{% else %}text-dark-text{% endif %}"></i>
                        <div
                            class="text-sm {% if is_active %}text-blue-500 font-medium{% else %}text-dark-text{% endif %}">
                            {% if substage == 'sections' %}Sections{% elif substage == 'post_info' %}Post Info{% else %}{{ substage|title|replace('_', ' ') }}{% endif %}</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            <!-- Publishing Group -->
            <div class="flex flex-col items-center">
                <span class="text-sm text-gray-400 mb-3 font-medium">Publishing</span>
                <div class="flex gap-6">
                    {% for substage in ['preflight', 'launch', 'syndication'] %}
                    {% set icon = {
                    'preflight': 'check-circle',
                    'launch': 'rocket',
                    'syndication': 'share-alt'
                    } %}
                    {% set is_active = stage == 'publishing' and substage == substage %}
                    {% set first_step = stages.get('publishing', {}).get(substage, ['main'])[0]|lower|replace(' ', '_') if stages and 'publishing' in stages and substage in stages['publishing'] and stages['publishing'][substage] else 'main' %}
                    <a href="/workflow/posts/{{ post_id }}/publishing/{{ substage }}/{{ first_step }}"
                        class="flex flex-col items-center p-4 bg-dark-bg border rounded-lg hover:bg-dark-hover transition-colors duration-200 {% if is_active %}border-blue-500 bg-dark-hover{% else %}border-dark-border{% endif %}">
                        <i
                            class="fas fa-{{ icon[substage] }} text-2xl mb-3 {% if is_active %}text-blue-500{% else %}text-dark-text{% endif %}"></i>
                        <div
                            class="text-sm {% if is_active %}text-blue-500 font-medium{% else %}text-dark-text{% endif %}">
                            {{ substage|title }}</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Line 3: Tabs for steps in the current sub-stage -->
        <!-- REMOVED: Duplicate step navigation - now handled by workflow template -->
    </div>
</div>

{% if not post_id %}
<div class="text-red-500 bg-dark-bg p-4 rounded-lg border border-red-700 mt-4 mx-6">
    Workflow navigation is unavailable: missing required context variables.
    Missing: post_id
</div>
{% endif %}

<script>
    document.getElementById('post-selector').addEventListener('change', function () {
        const postId = this.value;
        
        // Extract current stage, substage, and step from URL path
        const pathParts = window.location.pathname.split('/');
        const stageIndex = pathParts.findIndex(part => part === 'planning' || part === 'writing' || part === 'publishing');
        const substageIndex = stageIndex + 1;
        const stepIndex = stageIndex + 2;
        
        let currentStage = 'planning'; // default
        let currentSubstage = 'idea';   // default
        let currentStep = null;
        
        if (stageIndex !== -1 && pathParts[stageIndex]) {
            currentStage = pathParts[stageIndex];
        }
        if (substageIndex !== -1 && pathParts[substageIndex]) {
            currentSubstage = pathParts[substageIndex];
        }
        if (stepIndex !== -1 && pathParts[stepIndex]) {
            currentStep = pathParts[stepIndex];
        }
        
        // Preserve current stage/substage/step when changing posts
        if (currentStep) {
            window.location.href = `/workflow/posts/${postId}/${currentStage}/${currentSubstage}/${currentStep}`;
        } else {
            window.location.href = `/workflow/posts/${postId}/${currentStage}/${currentSubstage}`;
        }
    });

    function navigateToPost(postId) {
        // Extract current stage, substage, and step from URL path
        const pathParts = window.location.pathname.split('/');
        const stageIndex = pathParts.findIndex(part => part === 'planning' || part === 'writing' || part === 'publishing');
        const substageIndex = stageIndex + 1;
        const stepIndex = stageIndex + 2;
        
        let currentStage = 'planning'; // default
        let currentSubstage = 'idea';   // default
        let currentStep = null;
        
        if (stageIndex !== -1 && pathParts[stageIndex]) {
            currentStage = pathParts[stageIndex];
        }
        if (substageIndex !== -1 && pathParts[substageIndex]) {
            currentSubstage = pathParts[substageIndex];
        }
        if (stepIndex !== -1 && pathParts[stepIndex]) {
            currentStep = pathParts[stepIndex];
        }
        
        if (currentStep) {
            window.location.href = `/workflow/posts/${postId}/${currentStage}/${currentSubstage}/${currentStep}`;
        } else {
            window.location.href = `/workflow/posts/${postId}/${currentStage}/${currentSubstage}`;
        }
    }
</script>