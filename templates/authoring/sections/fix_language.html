{% extends 'base.html' %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
{% endblock %}

{% block title %}Fix Language - Section Authoring{% endblock %}

{% block content %}
<!-- Set page context for navigation highlighting -->
<script>
    window.currentStage = 'authoring';
    window.currentSubstage = 'fix-language';
    window.postId = {{ post_id|default('null') }};
</script>

<!-- Include condensed header -->
{% include 'planning/includes/condensed_header.html' %}

<div class="container">
    <div class="authoring-main">
        <div class="authoring-content">
            <div class="sections-panel">
                <div class="input-data">
                    <h4>Input Data</h4>
                    <div id="sections-display" class="sections-content">
                        <!-- Sections from previous page will appear here -->
                    </div>
                </div>
                
                <!-- Input Data Panel -->
                <div class="input-data-panel">
                    <h5>Post Context</h5>
                    <div class="context-item">
                        <label>Selected Idea:</label>
                        <div id="selected-idea-display">-</div>
                    </div>
                    <div class="context-item">
                        <label>Expanded Idea:</label>
                        <div id="expanded-idea-display">-</div>
                    </div>
                    
                    <h5>Section Context</h5>
                    <div class="context-item">
                        <label>Title:</label>
                        <span id="section-title-display">-</span>
                    </div>
                    <div class="context-item">
                        <label>Subtitle:</label>
                        <span id="section-subtitle-display">-</span>
                    </div>
                    <div class="context-item">
                        <label>Group:</label>
                        <div id="section-group-display">-</div>
                    </div>
                    <div class="context-item">
                        <label>Group Summary:</label>
                        <div id="section-group-summary-display">-</div>
                    </div>
                    <div class="context-item">
                        <label>Topics:</label>
                        <div id="section-topics-display">-</div>
                    </div>
                    <div class="context-item">
                        <label>Avoid Topics:</label>
                        <div id="avoid-topics-display">-</div>
                    </div>
                </div>
            </div>
            
            <div class="authoring-results">
                {% include 'includes/llm_module.html' %}
            </div>
        </div>
    </div>
</div>

<script>
// FixLanguageManager class
class FixLanguageManager {
    constructor() {
        this.currentSectionId = null;
        this.sections = [];
        this.init();
    }
    
    init() {
        this.loadSections();
        this.bindEvents();
    }
    
    async loadSections() {
        try {
            const response = await fetch(`/authoring/api/posts/${window.postId}/sections`);
            const data = await response.json();
            
            if (data.success) {
                this.sections = data.sections;
                this.renderSections();
                // Auto-load first section
                if (this.sections.length > 0) {
                    this.selectSection(this.sections[0].id);
                }
            }
        } catch (error) {
            console.error('Error loading sections:', error);
        }
    }
    
    renderSections() {
        const container = document.getElementById('sections-display');
        container.innerHTML = '';
        
        this.sections.forEach(section => {
            const sectionElement = this.createSectionElement(section);
            container.appendChild(sectionElement);
        });
    }
    
    createSectionElement(section) {
        const div = document.createElement('div');
        div.className = 'section-item';
        div.dataset.sectionId = section.id;
        div.innerHTML = `
            <div class="section-header">
                <h6>${section.title || 'Untitled Section'}</h6>
                <span class="section-order">${section.order}</span>
            </div>
            <div class="section-description">${section.description || 'No description'}</div>
        `;
        
        div.addEventListener('click', () => this.selectSection(section.id));
        return div;
    }
    
    selectSection(sectionId) {
        this.currentSectionId = sectionId;
        
        // Update visual selection
        document.querySelectorAll('.section-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.querySelector(`[data-section-id="${sectionId}"]`).classList.add('selected');
        
        // Load section data
        this.loadSectionData(sectionId);
    }
    
    async loadSectionData(sectionId) {
        try {
            // Load post context
            await this.loadPostContext();
            
            // Load section context
            await this.loadSectionContext(sectionId);
        } catch (error) {
            console.error('Error loading section data:', error);
        }
    }
    
    async loadPostContext() {
        try {
            const response = await fetch(`/planning/api/posts/${window.postId}`);
            const data = await response.json();
            
            if (data.post) {
                // Selected idea (idea_seed)
                if (data.post.idea_scope) {
                    const ideaScope = JSON.parse(data.post.idea_scope);
                    document.getElementById('selected-idea-display').textContent = ideaScope.selected_idea || 'No selected idea found';
                } else {
                    document.getElementById('selected-idea-display').textContent = 'No selected idea found';
                }
                
                // Expanded idea
                if (data.post.expanded_idea) {
                    document.getElementById('expanded-idea-display').textContent = data.post.expanded_idea;
                } else {
                    document.getElementById('expanded-idea-display').textContent = 'No expanded idea found';
                }
            }
        } catch (error) {
            console.error('Error loading post context:', error);
            document.getElementById('selected-idea-display').textContent = 'Error loading';
            document.getElementById('expanded-idea-display').textContent = 'Error loading';
        }
    }
    
    async loadSectionContext(sectionId) {
        try {
            // Get section data
            const sectionResponse = await fetch(`/authoring/api/posts/${window.postId}/sections/${sectionId}`);
            const sectionData = await sectionResponse.json();
            
            if (sectionData.success && sectionData.section) {
                const section = sectionData.section;
                
                // Update section-specific input data display
                document.getElementById('section-title-display').textContent = section.title || '-';
                document.getElementById('section-subtitle-display').textContent = section.description || '-';
                
                // Get planning data for this section
                const planningResponse = await fetch(`/planning/api/posts/${window.postId}`);
                const planningData = await planningResponse.json();
                
                if (planningData.post && planningData.post.topic_allocation) {
                    const topicAllocation = planningData.post.topic_allocation;
                    if (topicAllocation.allocations) {
                        const sectionAllocation = topicAllocation.allocations.find(a => a.section_id === `section_${section.order}`);
                        
                        if (sectionAllocation) {
                            document.getElementById('section-group-display').textContent = sectionAllocation.section_theme || '-';
                            document.getElementById('section-group-summary-display').textContent = sectionAllocation.allocation_reason || '-';
                            
                            if (sectionAllocation.topics) {
                                const topicsDisplay = document.getElementById('section-topics-display');
                                topicsDisplay.innerHTML = sectionAllocation.topics.map(topic => 
                                    `<span class="topic-tag">${topic}</span>`
                                ).join('');
                            } else {
                                document.getElementById('section-topics-display').textContent = 'No topics found';
                            }
                        } else {
                            document.getElementById('section-group-display').textContent = 'No group data found';
                            document.getElementById('section-group-summary-display').textContent = 'No group data found';
                            document.getElementById('section-topics-display').textContent = 'No topics found';
                        }
                    }
                }
                
                document.getElementById('avoid-topics-display').textContent = 'No avoid topics defined';
            }
        } catch (error) {
            console.error('Error loading section context:', error);
        }
    }
    
    bindEvents() {
        // Event listeners can be added here if needed
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const fixLanguageManager = new FixLanguageManager();
});
</script>

{% endblock %}