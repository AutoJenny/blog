{% extends 'base.html' %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sections.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
{% endblock %}

{% block title %}Fix Language - Section Authoring{% endblock %}

{% block content %}
<!-- Set page context for navigation highlighting -->
<script>
    window.currentStage = 'authoring';
    window.currentSubstage = 'fix-language';
    window.postId = {{ post_id|default('null') }};
</script>

<!-- Include condensed header -->
{% include 'planning/includes/condensed_header.html' %}

<script>
// Move authoring content to process-tab after page loads
document.addEventListener('DOMContentLoaded', function() {
    const authoringContent = document.querySelector('.authoring-workspace');
    const processTab = document.getElementById('process-tab');
    if (authoringContent && processTab) {
        processTab.appendChild(authoringContent);
    }
});
</script>

<!-- Authoring Workspace -->
<div class="authoring-workspace">
    <div class="workspace-container">
        <!-- Left Panel: Sections List -->
        <div class="sections-panel">
            <div class="panel-header">
                <h3>Sections</h3>
                <div class="section-controls">
                    <button class="btn-secondary" id="select-all-btn">Select All</button>
                    <button class="btn-primary" id="batch-generate-btn">Fix All</button>
                </div>
            </div>
            
            <div class="section-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="draft">Draft</button>
                <button class="filter-btn" data-filter="complete">Complete</button>
                <button class="filter-btn" data-filter="needs-review">Needs Review</button>
            </div>
            
            <div class="sections-list" id="sections-list">
                <!-- Sections will be loaded here -->
            </div>
        </div>

        <!-- Right Panel: Main Content Area -->
        <div class="content-panel">
            <div class="content-header">
                <h2 id="section-title">Select a Section</h2>
                <span class="section-status" id="section-status"></span>
            </div>
            
            <div class="content-body">
                <!-- Input Data Panel -->
                <div class="input-data-panel">
                    <div class="panel-header">
                        <h5>Input Data</h5>
                    </div>
                    <div class="panel-content">
                        <div class="context-group">
                            <h5 class="context-header">Post Context</h5>
                            <div class="context-item">
                                <strong>Selected Idea:</strong> <span id="selected-idea"></span>
                            </div>
                            <div class="context-item">
                                <strong>Expanded Idea:</strong> <span id="expanded-idea"></span>
                            </div>
                        </div>
                        <div class="context-group">
                            <h5 class="context-header">Section Context</h5>
                            <div class="context-item">
                                <strong>Section Title:</strong> <span id="section-context-title"></span>
                            </div>
                            <div class="context-item">
                                <strong>Section Subtitle:</strong> <span id="section-context-subtitle"></span>
                            </div>
                            <div class="context-item">
                                <strong>Current Draft:</strong> <div id="current-draft-content" class="draft-preview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Module for Fix Language -->
                {% include 'includes/llm_module.html' %}

                <!-- Generated Fix Language Output -->
                <div class="output-panel">
                    <div class="panel-header">
                        <h5>Fixed Content</h5>
                        <button class="btn-secondary btn-sm" id="save-fixes-btn">Save Fixes</button>
                    </div>
                    <div class="panel-content">
                        <textarea id="generated-fixes" class="form-control" rows="10" placeholder="Fixed content will appear here..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fix Language Manager
class FixLanguageManager {
    constructor(postId) {
        this.postId = postId;
        this.sections = [];
        this.selectedSections = new Set();
        this.currentSection = null;
        
        this.init();
    }
    
    async init() {
        console.log('Initializing Fix Language Manager...');
        await this.loadSections();
        await this.loadPostContext();
        this.setupEventListeners();
        this.renderSections();
        
        // Initialize LLM module
        if (typeof initializeLLMModule === 'function') {
            this.llmModule = initializeLLMModule('fix_language', this.postId);
        }
    }
    
    async loadSections() {
        try {
            const response = await fetch(`/authoring/api/posts/${this.postId}/sections`);
            const data = await response.json();
            
            if (data.success) {
                this.sections = data.sections;
                console.log('Loaded sections:', this.sections);
            } else {
                console.error('Failed to load sections:', data.error);
            }
        } catch (error) {
            console.error('Error loading sections:', error);
        }
    }
    
    async loadPostContext() {
        try {
            const response = await fetch(`/planning/api/posts/${this.postId}`);
            const data = await response.json();
            
            if (data.success) {
                const post = data.post;
                
                // Update post context
                document.getElementById('selected-idea').textContent = post.idea_seed || 'Not specified';
                document.getElementById('expanded-idea').textContent = post.expanded_idea || 'Not specified';
                
                console.log('Loaded post context:', post);
            } else {
                console.error('Failed to load post context:', data.error);
            }
        } catch (error) {
            console.error('Error loading post context:', error);
        }
    }
    
    setupEventListeners() {
        // Select All button
        document.getElementById('select-all-btn').addEventListener('click', () => {
            this.selectAllSections();
        });
        
        // Batch Generate button
        document.getElementById('batch-generate-btn').addEventListener('click', () => {
            this.batchGenerate();
        });
        
        // Save Fixes button
        document.getElementById('save-fixes-btn').addEventListener('click', () => {
            this.saveFixes();
        });
    }
    
    renderSections() {
        const sectionsList = document.getElementById('sections-list');
        
        if (this.sections.length === 0) {
            sectionsList.innerHTML = '<div class="no-sections">No sections found</div>';
            return;
        }
        
        sectionsList.innerHTML = this.sections.map(section => `
            <div class="section-item ${this.selectedSections.has(section.id) ? 'selected' : ''}" 
                 data-section-id="${section.id}" data-status="${section.status}">
                <div class="section-header">
                    <div class="section-info">
                        <h4>${section.section_heading || 'Untitled Section'}</h4>
                        <span class="section-order">${section.section_order}</span>
                    </div>
                    <div class="section-controls">
                        <input type="checkbox" class="section-checkbox" 
                               ${this.selectedSections.has(section.id) ? 'checked' : ''}>
                    </div>
                </div>
                <div class="section-content">
                    <div class="section-status ${section.status}">
                        ${section.status.charAt(0).toUpperCase() + section.status.slice(1)}
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add click handlers for section selection
        sectionsList.querySelectorAll('.section-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('section-checkbox')) {
                    this.toggleSectionSelection(parseInt(item.dataset.sectionId));
                }
            });
        });
        
        // Add checkbox handlers
        sectionsList.querySelectorAll('.section-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                this.toggleSectionSelection(parseInt(e.target.closest('.section-item').dataset.sectionId));
            });
        });
    }
    
    toggleSectionSelection(sectionId) {
        if (this.selectedSections.has(sectionId)) {
            this.selectedSections.delete(sectionId);
        } else {
            this.selectedSections.add(sectionId);
        }
        
        this.renderSections();
        this.loadSectionContext(sectionId);
    }
    
    selectAllSections() {
        this.sections.forEach(section => {
            this.selectedSections.add(section.id);
        });
        this.renderSections();
    }
    
    async loadSectionContext(sectionId) {
        const section = this.sections.find(s => s.id === sectionId);
        if (!section) return;
        
        this.currentSection = section;
        
        // Update section context display
        document.getElementById('section-title').textContent = section.section_heading || 'Untitled Section';
        document.getElementById('section-context-title').textContent = section.section_heading || 'Untitled Section';
        document.getElementById('section-context-subtitle').textContent = section.section_description || 'No description';
        
        // Show current draft content
        const draftContent = document.getElementById('current-draft-content');
        if (section.draft) {
            draftContent.innerHTML = `<pre>${section.draft.substring(0, 500)}${section.draft.length > 500 ? '...' : ''}</pre>`;
        } else {
            draftContent.textContent = 'No draft content';
        }
    }
    
    async batchGenerate() {
        const selectedIds = Array.from(this.selectedSections);
        if (selectedIds.length === 0) {
            console.log('No sections selected. Please select sections to generate first.');
            return;
        }
        
        console.log(`Fixing language for ${selectedIds.length} sections...`);
        
        // Implementation would call the LLM API for each section
        for (const sectionId of selectedIds) {
            await this.fixLanguage(sectionId);
        }
    }
    
    async fixLanguage(sectionId) {
        console.log(`Fixing language for section ${sectionId}`);
        
        // This would call the LLM API to fix language issues
        // Implementation depends on the specific API endpoint
    }
    
    async saveFixes() {
        console.log('Saving language fixes...');
        
        // Implementation would save the fixed content to the database
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const postId = window.postId;
    if (postId) {
        window.fixLanguageManager = new FixLanguageManager(postId);
    } else {
        console.error('Post ID not found');
    }
});
</script>
{% endblock %}
