{% extends 'base.html' %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
{% endblock %}

{% block title %}Fix Language - Section Authoring{% endblock %}

{% block content %}
<!-- Set page context for navigation highlighting -->
<script>
    window.currentStage = 'authoring';
    window.currentSubstage = 'fix-language';
    window.postId = {{ post_id|default('null') }};
</script>

<!-- Include condensed header -->
{% include 'planning/includes/condensed_header.html' %}

<div class="container">
    <div class="authoring-main">
        <div class="authoring-content">
            <div class="sections-panel">
                <div class="input-data">
                    <h4>Input Data</h4>
                    <div id="sections-display" class="sections-content">
                        <!-- Sections from previous page will appear here -->
                    </div>
                </div>
                
                <!-- Input Data Panel -->
                <div class="input-data-panel">
                    <h5>Post Context</h5>
                    <div class="context-item">
                        <label>Selected Idea:</label>
                        <div id="selected-idea-display">-</div>
                    </div>
                    <div class="context-item">
                        <label>Expanded Idea:</label>
                        <div id="expanded-idea-display">-</div>
                    </div>
                    
                    <h5>Section Context</h5>
                    <div class="context-item">
                        <label>Title:</label>
                        <span id="section-title-display">-</span>
                    </div>
                    <div class="context-item">
                        <label>Subtitle:</label>
                        <span id="section-subtitle-display">-</span>
                    </div>
                    <div class="context-item">
                        <label>Current Draft:</label>
                        <div id="current-draft-display">-</div>
                    </div>
                </div>
            </div>
            
            <div class="authoring-results">
                {% include 'includes/llm_module.html' %}
            </div>
        </div>
    </div>
</div>

<script>
// FixLanguageManager class
class FixLanguageManager {
    constructor() {
        this.currentSectionId = null;
        this.sections = [];
        this.init();
    }
    
    init() {
        this.loadSections();
        this.bindEvents();
    }
    
    async loadSections() {
        try {
            const response = await fetch(`/authoring/api/posts/${window.postId}/sections`);
            const data = await response.json();
            
            if (data.success) {
                this.sections = data.sections;
                this.renderSections();
                // Auto-load first section
                if (this.sections.length > 0) {
                    this.selectSection(this.sections[0].id);
                }
            }
        } catch (error) {
            console.error('Error loading sections:', error);
        }
    }
    
    renderSections() {
        const container = document.getElementById('sections-display');
        container.innerHTML = '';
        
        this.sections.forEach(section => {
            const sectionElement = this.createSectionElement(section);
            container.appendChild(sectionElement);
        });
    }
    
    createSectionElement(section) {
        const div = document.createElement('div');
        div.className = 'section-item';
        div.dataset.sectionId = section.id;
        div.innerHTML = `
            <div class="section-header">
                <h6>${section.section_heading || 'Untitled Section'}</h6>
                <span class="section-order">${section.section_order}</span>
            </div>
            <div class="section-description">${section.section_description || 'No description'}</div>
        `;
        
        div.addEventListener('click', () => this.selectSection(section.id));
        return div;
    }
    
    selectSection(sectionId) {
        this.currentSectionId = sectionId;
        
        // Update visual selection
        document.querySelectorAll('.section-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.querySelector(`[data-section-id="${sectionId}"]`).classList.add('selected');
        
        // Load section data
        this.loadSectionData(sectionId);
    }
    
    async loadSectionData(sectionId) {
        try {
            // Load post context
            await this.loadPostContext();
            
            // Load section context
            await this.loadSectionContext(sectionId);
        } catch (error) {
            console.error('Error loading section data:', error);
        }
    }
    
    async loadPostContext() {
        try {
            const response = await fetch(`/planning/api/posts/${window.postId}`);
            const data = await response.json();
            
            if (data.post) {
                // Selected idea (idea_seed)
                if (data.post.idea_seed) {
                    document.getElementById('selected-idea-display').textContent = data.post.idea_seed;
                } else {
                    document.getElementById('selected-idea-display').textContent = 'No selected idea found';
                }
                
                // Expanded idea
                if (data.post.expanded_idea) {
                    document.getElementById('expanded-idea-display').textContent = data.post.expanded_idea;
                } else {
                    document.getElementById('expanded-idea-display').textContent = 'No expanded idea found';
                }
            }
        } catch (error) {
            console.error('Error loading post context:', error);
            document.getElementById('selected-idea-display').textContent = 'Error loading';
            document.getElementById('expanded-idea-display').textContent = 'Error loading';
        }
    }
    
    async loadSectionContext(sectionId) {
        try {
            // Get section data
            const sectionResponse = await fetch(`/authoring/api/posts/${window.postId}/sections/${sectionId}`);
            const sectionData = await sectionResponse.json();
            
            if (sectionData.success && sectionData.section) {
                const section = sectionData.section;
                
                // Update section-specific input data display
                document.getElementById('section-title-display').textContent = section.section_heading || '-';
                document.getElementById('section-subtitle-display').textContent = section.section_description || '-';
                
                // Show current draft content
                if (section.draft) {
                    const draftDisplay = document.getElementById('current-draft-display');
                    draftDisplay.innerHTML = `<pre style="max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 4px;">${section.draft.substring(0, 1000)}${section.draft.length > 1000 ? '...' : ''}</pre>`;
                } else {
                    document.getElementById('current-draft-display').textContent = 'No draft content';
                }
            }
        } catch (error) {
            console.error('Error loading section context:', error);
        }
    }
    
    bindEvents() {
        // Event listeners can be added here if needed
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const fixLanguageManager = new FixLanguageManager();
});
</script>

{% endblock %}