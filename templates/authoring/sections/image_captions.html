{% extends 'base.html' %}

{% block title %}Authoring - Image Captions{% endblock %}

{% block content %}
<!-- Set page context for navigation highlighting -->
<script>
    window.currentStage = 'authoring';
    window.currentSubstage = 'image_captions';
    window.postId = {{ post_id }};
</script>

<!-- Include condensed header -->
{% include 'planning/includes/condensed_header.html' %}

<script>
// Move authoring content to process-tab after page loads
document.addEventListener('DOMContentLoaded', function() {
    const authoringContent = document.querySelector('.authoring-workspace');
    const processTab = document.getElementById('process-tab');
    if (authoringContent && processTab) {
        processTab.appendChild(authoringContent);
    }
});
</script>

<!-- Authoring Workspace -->
<div class="authoring-workspace">
    <div class="workspace-container">
        <!-- Left Panel: Sections List -->
        <div class="sections-panel">
            <div class="panel-header">
                <h3>Sections</h3>
                <div class="section-controls">
                    <button class="btn-secondary" id="select-all-btn">Select All</button>
                    <button class="btn-primary" id="batch-generate-btn">Generate All</button>
                </div>
            </div>
            
            <div class="sections-list" id="sections-list">
                <!-- Sections will be loaded here -->
                <div class="loading">Loading sections...</div>
            </div>
        </div>
        
        <!-- Right Panel: Content Area -->
        <div class="content-panel">
            <div class="panel-header">
                <h3>Image Captions</h3>
                <div class="content-controls">
                    <button class="btn-secondary" id="save-captions-btn">Save Captions</button>
                </div>
            </div>
            
            <div class="content-area">
                <div class="input-data-panel">
                    <h4>Input Data</h4>
                    <div id="post-context" class="context-section">
                        <h5>Post Context</h5>
                        <div class="context-content">
                            <div class="context-item">
                                <strong>Selected Idea:</strong> <span id="selected-idea">Loading...</span>
                            </div>
                            <div class="context-item">
                                <strong>Post Title:</strong> <span id="post-title">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="section-context" class="context-section">
                        <h5>Section Context</h5>
                        <div class="context-content">
                            <div class="context-item">
                                <strong>Section Title:</strong> <span id="section-title">Select a section</span>
                            </div>
                            <div class="context-item">
                                <strong>Section Description:</strong> <span id="section-description">-</span>
                            </div>
                            <div class="context-item">
                                <strong>Image Prompts:</strong> <span id="image-prompts">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="llm-module-container">
                    <!-- LLM Module will be initialized here -->
                    <div id="llm-module" class="llm-module">
                        <div class="module-header">
                            <h4>Generate Image Captions</h4>
                            <div class="module-controls">
                                <button class="btn-primary" id="generate-btn">Generate Captions</button>
                            </div>
                        </div>
                        
                        <div class="module-content">
                            <div class="prompt-section">
                                <div class="prompt-header">
                                    <h5>Prompt</h5>
                                    <button class="btn-secondary" id="edit-prompt-btn">Edit</button>
                                </div>
                                <div class="prompt-content">
                                    <div id="prompt-display">Loading prompt...</div>
                                </div>
                            </div>
                            
                            <div class="results-section">
                                <div class="results-header">
                                    <h5>Generated Image Captions</h5>
                                </div>
                                <div class="results-content">
                                    <div id="results-display">No captions generated yet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Image Captions Manager
class ImageCaptionsManager {
    constructor(postId) {
        this.postId = postId;
        this.sections = [];
        this.selectedSections = new Set();
        this.currentSection = null;
        
        this.init();
    }
    
    async init() {
        console.log('Initializing Image Captions Manager...');
        await this.loadSections();
        await this.loadPostContext();
        this.setupEventListeners();
        this.renderSections();
        
        // Initialize LLM module
        if (typeof initializeLLMModule === 'function') {
            this.llmModule = initializeLLMModule('image_captions', this.postId);
        }
    }
    
    async loadSections() {
        try {
            const response = await fetch(`/authoring/api/posts/${this.postId}/sections`);
            const data = await response.json();
            
            if (data.success) {
                this.sections = data.sections;
                console.log('Loaded sections:', this.sections);
            } else {
                console.error('Failed to load sections:', data.error);
            }
        } catch (error) {
            console.error('Error loading sections:', error);
        }
    }
    
    async loadPostContext() {
        try {
            const response = await fetch(`/planning/api/posts/${this.postId}`);
            const data = await response.json();
            
            if (data.success) {
                const post = data.post;
                
                // Update post context
                document.getElementById('selected-idea').textContent = post.idea_seed || 'Not specified';
                document.getElementById('post-title').textContent = post.title || 'Untitled';
                
                console.log('Loaded post context:', post);
            } else {
                console.error('Failed to load post context:', data.error);
            }
        } catch (error) {
            console.error('Error loading post context:', error);
        }
    }
    
    setupEventListeners() {
        // Select All button
        document.getElementById('select-all-btn').addEventListener('click', () => {
            this.selectAllSections();
        });
        
        // Batch Generate button
        document.getElementById('batch-generate-btn').addEventListener('click', () => {
            this.batchGenerate();
        });
        
        // Save Captions button
        document.getElementById('save-captions-btn').addEventListener('click', () => {
            this.saveCaptions();
        });
    }
    
    renderSections() {
        const sectionsList = document.getElementById('sections-list');
        
        if (this.sections.length === 0) {
            sectionsList.innerHTML = '<div class="no-sections">No sections found</div>';
            return;
        }
        
        sectionsList.innerHTML = this.sections.map(section => `
            <div class="section-item ${this.selectedSections.has(section.id) ? 'selected' : ''}" 
                 data-section-id="${section.id}" data-status="${section.status}">
                <div class="section-header">
                    <div class="section-info">
                        <h4>${section.title || 'Untitled Section'}</h4>
                        <span class="section-order">${section.order}</span>
                    </div>
                    <div class="section-controls">
                        <input type="checkbox" class="section-checkbox" 
                               ${this.selectedSections.has(section.id) ? 'checked' : ''}>
                    </div>
                </div>
                <div class="section-content">
                    <div class="section-status ${section.status}">
                        ${section.status.charAt(0).toUpperCase() + section.status.slice(1)}
                    </div>
                    <div class="section-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${section.progress}%"></div>
                        </div>
                        <span class="progress-text">${section.progress}% complete</span>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add click handlers for section selection
        sectionsList.querySelectorAll('.section-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('section-checkbox')) {
                    this.toggleSectionSelection(parseInt(item.dataset.sectionId));
                }
            });
        });
        
        // Add checkbox handlers
        sectionsList.querySelectorAll('.section-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                this.toggleSectionSelection(parseInt(e.target.closest('.section-item').dataset.sectionId));
            });
        });
    }
    
    toggleSectionSelection(sectionId) {
        if (this.selectedSections.has(sectionId)) {
            this.selectedSections.delete(sectionId);
        } else {
            this.selectedSections.add(sectionId);
        }
        
        this.renderSections();
        this.loadSectionContext(sectionId);
    }
    
    selectAllSections() {
        this.sections.forEach(section => {
            this.selectedSections.add(section.id);
        });
        this.renderSections();
    }
    
    async loadSectionContext(sectionId) {
        const section = this.sections.find(s => s.id === sectionId);
        if (!section) return;
        
        this.currentSection = section;
        
        // Update section context display
        document.getElementById('section-title').textContent = section.title || 'Untitled Section';
        document.getElementById('section-description').textContent = section.description || 'No description';
        document.getElementById('image-prompts').textContent = section.image_prompts || 'No prompts specified';
    }
    
    async batchGenerate() {
        const selectedIds = Array.from(this.selectedSections);
        if (selectedIds.length === 0) {
            console.log('No sections selected. Please select sections to generate first.');
            return;
        }
        
        console.log(`Generating image captions for ${selectedIds.length} sections...`);
        
        // Implementation would call the LLM API for each section
        for (const sectionId of selectedIds) {
            await this.generateImageCaptions(sectionId);
        }
    }
    
    async generateImageCaptions(sectionId) {
        console.log(`Generating image captions for section ${sectionId}`);
        
        // This would call the LLM API to generate image captions
        // Implementation depends on the specific API endpoint
    }
    
    async saveCaptions() {
        console.log('Saving image captions...');
        
        // Implementation would save the generated captions to the database
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const postId = window.postId;
    if (postId) {
        window.imageCaptionsManager = new ImageCaptionsManager(postId);
    } else {
        console.error('Post ID not found');
    }
});
</script>

{% endblock %}
