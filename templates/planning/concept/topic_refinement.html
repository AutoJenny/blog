{% extends "base.html" %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
{% endblock %}

{% block title %}Topic Refinement - Concept Development - Planning - BlogForge{% endblock %}

{% block content %}
<div class="container">
    <!-- Include condensed header -->
    {% include 'planning/includes/condensed_header.html' %}
    
    {% block process_content %}
    <div class="brainstorm-main">
        
        <div class="brainstorm-content">
            <div class="idea-generator">
                <div class="input-data">
                    <h4>Input Data</h4>
                    <div class="data-section">
                        <h5>Current Topic Allocation</h5>
                        <div id="allocation-display" class="data-display">
                            <p class="loading">Loading topic allocation...</p>
                        </div>
                    </div>
                    
                    <div class="input-actions">
                        <button id="refine-topics-btn" class="btn btn-primary" onclick="refineTopics()">
                            <i class="fas fa-compress-alt"></i>
                            Refine Overloaded Sections
                        </button>
                    </div>
                </div>
                
                <div class="brainstorm-settings">
                    <h4>Refinement Settings</h4>
                    <div class="form-group">
                        <label for="refinement-strategy">Refinement Strategy</label>
                        <select id="refinement-strategy">
                            <option value="consolidate">Consolidate (merge similar topics)</option>
                            <option value="prioritize">Prioritize (keep most important)</option>
                            <option value="redistribute">Redistribute (move to other sections)</option>
                            <option value="summarize">Summarize (create overview topics)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="brainstorm-results">
                {% include 'includes/llm_module.html' %}
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div id="results-panel" class="results-panel" style="display: none;">
        <div class="panel-header">
            <h3>Refined Topic Allocation</h3>
        </div>
        <div class="panel-content">
            <div id="refinement-results" class="results-display">
                <!-- Refinement results will be displayed here -->
            </div>
        </div>
    </div>
    {% endblock %}
</div>

<script>
let topicAllocation = null;
let refinedTopics = null;

// Set post ID for API calls
window.postId = {{ post_id }};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadTopicAllocation();
    loadExistingRefinement();
    initializeLLMModule('topic_refinement', window.postId);
});

// Load topic allocation
async function loadTopicAllocation() {
    try {
        const response = await fetch(`/planning/api/sections/allocate-topics/${window.postId}`);
        const data = await response.json();
        
        if (data.success && data.allocation) {
            topicAllocation = data.allocation;
            displayTopicAllocation();
        } else {
            document.getElementById('allocation-display').innerHTML = '<p class="error">No topic allocation found. Please complete Topic Allocation first.</p>';
        }
    } catch (error) {
        console.error('Error loading topic allocation:', error);
        document.getElementById('allocation-display').innerHTML = '<p class="error">Error loading topic allocation</p>';
    }
}

// Display topic allocation
function displayTopicAllocation() {
    const container = document.getElementById('allocation-display');
    
    if (!topicAllocation || !topicAllocation.allocations) {
        container.innerHTML = '<p class="error">No allocation data available</p>';
        return;
    }
    
    // Check for overloaded sections (>5 topics)
    const overloadedSections = topicAllocation.allocations.filter(allocation => allocation.topics.length > 5);
    
    const allocationsHtml = topicAllocation.allocations.map((allocation, index) => {
        const isOverloaded = allocation.topics.length > 5;
        const sectionClass = isOverloaded ? 'allocation-item overloaded' : 'allocation-item';
        
        return `
            <div class="${sectionClass}">
                <h5>Section ${allocation.section_id.replace('section_', '')}: ${allocation.section_theme}</h5>
                <div class="topics-count ${isOverloaded ? 'overloaded' : ''}">
                    <strong>${allocation.topics.length} topics</strong>
                    ${isOverloaded ? '<span class="warning">⚠️ Needs refinement</span>' : ''}
                </div>
                <div class="topics-in-section">
                    ${allocation.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="allocation-summary">
            <p><strong>Current allocation: ${topicAllocation.metadata.total_topics_allocated} topics across ${topicAllocation.allocations.length} sections</strong></p>
            ${overloadedSections.length > 0 ? `<p class="warning">⚠️ ${overloadedSections.length} sections have more than 5 topics and need refinement</p>` : '<p class="success">✅ All sections have 5 or fewer topics - no refinement needed</p>'}
        </div>
        <div class="allocations-list">
            ${allocationsHtml}
        </div>
    `;
}

// Refine topics
async function refineTopics() {
    const btn = document.getElementById('refine-topics-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refining Topics...';
    
    try {
        const response = await fetch('/planning/api/sections/refine-topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic_allocation: topicAllocation,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            refinedTopics = result.refined_allocation;
            displayRefinementResults();
            showResultsPanel();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error refining topics:', error);
        alert('Error refining topics: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-compress-alt"></i> Refine Overloaded Sections';
    }
}

// Display refinement results
function displayRefinementResults() {
    const container = document.getElementById('refinement-results');
    
    if (!refinedTopics || !refinedTopics.allocations) {
        container.innerHTML = '<p class="error">No refinement data available</p>';
        return;
    }
    
    const allocationsHtml = refinedTopics.allocations.map((allocation, index) => `
        <div class="allocation-item">
            <h4>Section ${allocation.section_id.replace('section_', '')}: ${allocation.section_theme}</h4>
            <div class="topics-count">
                <strong>${allocation.topics.length} topics</strong>
            </div>
            <div class="topics-in-section">
                ${allocation.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
            </div>
            <p class="refinement-reason"><em>${allocation.refinement_reason || 'Topics refined for optimal coverage'}</em></p>
        </div>
    `).join('');
    
    container.innerHTML = `
        <div class="refinement-summary">
            <p><strong>Refined allocation: ${refinedTopics.metadata.total_topics_allocated} topics across ${refinedTopics.allocations.length} sections</strong></p>
            <p class="success">✅ All sections now have 5 or fewer topics</p>
        </div>
        <div class="allocations-list">
            ${allocationsHtml}
        </div>
    `;
}

// Show results panel
function showResultsPanel() {
    document.getElementById('results-panel').style.display = 'block';
}

// Load existing refinement
async function loadExistingRefinement() {
    try {
        const response = await fetch(`/planning/api/sections/refine-topics/${window.postId}`);
        const data = await response.json();
        
        if (data.success && data.refined_allocation) {
            refinedTopics = data.refined_allocation;
            displayRefinementResults();
            showResultsPanel();
        }
    } catch (error) {
        console.error('Error loading existing refinement:', error);
    }
}
</script>

<style>
.allocation-item {
    padding: 16px;
    margin: 12px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border-left: 4px solid var(--accent-color);
}

.allocation-item.overloaded {
    border-left-color: #ff9800;
    background: rgba(255, 152, 0, 0.1);
}

.allocation-item h4,
.allocation-item h5 {
    margin: 0 0 12px 0;
    color: var(--accent-color);
}

.allocation-item.overloaded h5 {
    color: #ff9800;
}

.topics-count {
    margin: 8px 0;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    display: inline-block;
}

.topics-count.overloaded {
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
}

.topics-in-section {
    margin: 8px 0;
}

.topic-tag {
    display: inline-block;
    padding: 4px 8px;
    margin: 2px 4px 2px 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    font-size: 0.9em;
}

.refinement-reason {
    margin: 8px 0 0 0;
    font-size: 0.9em;
    color: #888;
}

.allocation-summary,
.refinement-summary {
    padding: 16px;
    background: rgba(0, 255, 0, 0.1);
    border-radius: 8px;
    margin-bottom: 16px;
    border-left: 4px solid #00ff00;
}

.warning {
    color: #ff9800;
}

.success {
    color: #4CAF50;
}

.results-panel {
    margin-top: 20px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.loading {
    color: #888;
    font-style: italic;
}

.error {
    color: #ff6b6b;
}
</style>

<!-- LLM Module JavaScript Files -->
<script src="{{ url_for('static', filename='js/llm-config.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-ui-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-api-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-event-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-module.js') }}"></script>

<script>
// Initialize LLM module for topic refinement
document.addEventListener('DOMContentLoaded', function() {
    initializeLLMModule('topic_refinement');
});
</script>
{% endblock %}
