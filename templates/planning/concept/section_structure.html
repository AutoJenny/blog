{% extends "base.html" %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
{% endblock %}

{% block title %}Section Structure Design - Concept Development - Planning - BlogForge{% endblock %}

{% block content %}
<div class="container">
    <!-- Include condensed header -->
    {% include 'planning/includes/condensed_header.html' %}
    
    {% block process_content %}
    <div class="brainstorm-main">
        
        <div class="brainstorm-content">
            <div class="idea-generator">
                <div class="input-data">
                    <h4>Input Data</h4>
                    <div id="topics-display" class="expanded-idea-content">
                        <!-- Topics from brainstorming will appear here -->
                    </div>
                    <div class="input-actions">
                        <button class="btn btn-primary" onclick="generateSectionStructure()" id="generate-btn">
                            <i class="fas fa-magic"></i> Design Section Structure
                        </button>
                    </div>
                </div>
                
                <div class="brainstorm-settings">
                    <h4>Structure Settings</h4>
                    <div class="form-group">
                        <label for="structure-type">Structure Type</label>
                        <select id="structure-type">
                            <option value="chronological">Chronological (time-based)</option>
                            <option value="thematic">Thematic (topic-based)</option>
                            <option value="progressive">Progressive (building complexity)</option>
                            <option value="comparative">Comparative (contrasting views)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="brainstorm-results">
                {% include 'includes/llm_module.html' %}
            </div>
        </div>
    </div>
    {% endblock %}
</div>

<style>
.brainstorm-main {
    padding: 2rem 0;
}

.brainstorm-header {
    text-align: center;
    margin-bottom: 3rem;
}

.brainstorm-header h2 {
    font-size: 2rem;
    color: #f1f5f9;
    margin-bottom: 0.5rem;
}

.brainstorm-header p {
    font-size: 1.125rem;
    color: #94a3b8;
    max-width: 600px;
    margin: 0 auto;
}

.brainstorm-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.idea-generator {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.input-data {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 1.5rem;
}

.input-data h4 {
    color: #f1f5f9;
    margin-bottom: 1rem;
    font-size: 1.125rem;
    font-weight: 600;
}

.expanded-idea-content {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    min-height: 200px;
    max-height: 400px;
    overflow-y: auto;
}

.input-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.btn-primary:disabled {
    background: #64748b;
    cursor: not-allowed;
    transform: none;
}

.brainstorm-settings {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 1.5rem;
}

.brainstorm-settings h4 {
    color: #f1f5f9;
    margin-bottom: 1rem;
    font-size: 1.125rem;
    font-weight: 600;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    color: #e2e8f0;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-group select {
    width: 100%;
    padding: 0.75rem;
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 6px;
    color: #f1f5f9;
    font-size: 0.875rem;
}

.form-group select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.brainstorm-results {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 1.5rem;
    min-height: 600px;
}

.topic-item {
    padding: 8px 12px;
    margin: 4px 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    border-left: 3px solid #3b82f6;
    font-size: 0.875rem;
}

.loading {
    color: #94a3b8;
    font-style: italic;
    text-align: center;
    padding: 2rem;
}

.error {
    color: #ef4444;
    text-align: center;
    padding: 2rem;
}

.topics-list {
    max-height: 300px;
    overflow-y: auto;
}

.topics-list p {
    margin-bottom: 1rem;
    color: #e2e8f0;
    font-weight: 500;
}

@media (max-width: 1024px) {
    .brainstorm-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .brainstorm-main {
        padding: 1rem 0;
    }
}
</style>

<script>
// Set post ID for API calls
window.postId = {{ post_id }};

let topics = [];
let sectionStructure = null;
let llmModule = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadBrainstormTopics();
    loadExistingStructure();
    initializeLLMModule();
});

// Initialize LLM module
function initializeLLMModule() {
    if (typeof initializeLLMModule === 'function') {
        llmModule = initializeLLMModule('section_structure', window.postId);
    } else {
        console.error('initializeLLMModule function not found');
    }
}

// Load topics from brainstorming
async function loadBrainstormTopics() {
    try {
        const response = await fetch(`/planning/api/posts/${window.postId}`);
        const data = await response.json();
        
        if (data.success && data.development.idea_scope) {
            const ideaScopeData = JSON.parse(data.development.idea_scope);
            topics = ideaScopeData.generated_topics.map(topic => topic.title);
            displayTopics();
        } else {
            document.getElementById('topics-display').innerHTML = '<p class="error">No topics found from brainstorming</p>';
        }
    } catch (error) {
        console.error('Error loading topics:', error);
        document.getElementById('topics-display').innerHTML = '<p class="error">Error loading topics</p>';
    }
}

// Display topics
function displayTopics() {
    const container = document.getElementById('topics-display');
    if (topics.length === 0) {
        container.innerHTML = '<p class="error">No topics available</p>';
        return;
    }
    
    const topicsList = topics.map((topic, index) => 
        `<div class="topic-item">${index + 1}. ${topic}</div>`
    ).join('');
    
    container.innerHTML = `
        <div class="topics-list">
            <p><strong>${topics.length} topics from brainstorming:</strong></p>
            ${topicsList}
        </div>
    `;
}

// Generate section structure
async function generateSectionStructure() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Designing Structure...';
    
    try {
        const response = await fetch('/planning/api/sections/design-structure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topics: topics,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            sectionStructure = result.structure;
            // The LLM module will handle displaying the results
            console.log('Section structure generated successfully');
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error generating structure:', error);
        alert('Error generating structure: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> Design Section Structure';
    }
}

// Load existing structure
async function loadExistingStructure() {
    try {
        const response = await fetch(`/planning/api/sections/design-structure/${window.postId}`);
        const data = await response.json();
        
        if (data.success && data.structure) {
            sectionStructure = data.structure;
            console.log('Existing structure loaded');
        }
    } catch (error) {
        console.error('Error loading existing structure:', error);
    }
}
</script>
{% endblock %}