{% extends "base.html" %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
<style>
.three-step-process {
    max-width: 1200px;
    margin: 0 auto;
}

.step-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    overflow: hidden;
}

.step-container.active {
    border: 2px solid #007bff;
}

.step-container.completed {
    border: 2px solid #28a745;
    background: #f8fff9;
}

.step-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.step-header h3 {
    margin: 0;
    color: #495057;
}

.step-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.step-status .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.step-status .status-pending {
    background: #e9ecef;
    color: #6c757d;
}

.step-status .status-active {
    background: #cce5ff;
    color: #007bff;
}

.step-status .status-completed {
    background: #d4edda;
    color: #155724;
}

.step-content {
    padding: 30px;
}

.step-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

.input-panel, .output-panel {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 20px;
}

.input-panel h4, .output-panel h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 16px;
}

.action-panel {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.action-panel .btn {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: 600;
}

.topics-display, .structure-display, .allocation-display, .refined-display {
    max-height: 300px;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
}

.topic-item, .section-item, .allocation-item {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 8px;
    font-size: 14px;
}

.section-item {
    border-left: 4px solid #007bff;
}

.allocation-item {
    border-left: 4px solid #28a745;
}

.allocation-item .section-theme {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
}

.allocation-item .topics-list {
    color: #6c757d;
    font-size: 13px;
}

.allocation-item .allocation-reason {
    font-style: italic;
    color: #6c757d;
    font-size: 12px;
    margin-top: 5px;
}

.refinement-summary {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
}

.refinement-summary h5 {
    margin: 0 0 10px 0;
    color: #856404;
}

.refinement-summary .stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #856404;
}

.progress-indicator {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin: 30px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.progress-step .step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
}

.progress-step .step-number.pending {
    background: #e9ecef;
    color: #6c757d;
}

.progress-step .step-number.active {
    background: #007bff;
    color: #fff;
}

.progress-step .step-number.completed {
    background: #28a745;
    color: #fff;
}

.progress-step .step-label {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    text-align: center;
}

.progress-connector {
    width: 40px;
    height: 2px;
    background: #dee2e6;
}

.progress-connector.completed {
    background: #28a745;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
}

.loading-spinner.active {
    display: block;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.success-message {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.llm-response-display {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}

.llm-response-display h5 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
}

.raw-response {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #495057;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block title %}3-Step Topic Allocation - Concept Development - Planning - BlogForge{% endblock %}

{% block content %}
<div class="container">
    <!-- Include condensed header -->
    {% include 'planning/includes/condensed_header.html' %}
    
    {% block process_content %}
    <div class="three-step-process">
        
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-step">
                <div class="step-number pending" id="progress-step-1">1</div>
                <div class="step-label">Design Structure</div>
            </div>
            <div class="progress-connector" id="connector-1-2"></div>
            <div class="progress-step">
                <div class="step-number pending" id="progress-step-2">2</div>
                <div class="step-label">Allocate Topics</div>
            </div>
            <div class="progress-connector" id="connector-2-3"></div>
            <div class="progress-step">
                <div class="step-number pending" id="progress-step-3">3</div>
                <div class="step-label">Refine Topics</div>
            </div>
        </div>
        
        <!-- Step 1: Section Structure Design -->
        <div class="step-container active" id="step-1">
            <div class="step-header">
                <h3>Step 1: Design Section Structure</h3>
                <div class="step-status">
                    <span class="status-badge status-active" id="step-1-status">Active</span>
                </div>
            </div>
            <div class="step-content">
                <div class="step-panels">
                    <div class="input-panel">
                        <h4>Input: Generated Topics</h4>
                        <div id="topics-display" class="topics-display">
                            <div class="loading-spinner" id="topics-loading">
                                <div class="spinner"></div>
                                <div>Loading topics from brainstorming...</div>
                            </div>
                        </div>
                    </div>
                    <div class="output-panel">
                        <h4>Section Structure</h4>
                        <div id="section-structure-display" class="structure-display">
                            <div class="text-muted">Section structure will appear here after generation</div>
                        </div>
                    </div>
                </div>
                <div class="action-panel">
                    <button onclick="designSectionStructure()" class="btn btn-primary" id="step-1-btn">
                        <i class="fas fa-drafting-compass"></i> Design 7-Section Structure
                    </button>
                </div>
                <div class="loading-spinner" id="step-1-loading">
                    <div class="spinner"></div>
                    <div>Designing section structure...</div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Topic Allocation -->
        <div class="step-container" id="step-2" style="display: none;">
            <div class="step-header">
                <h3>Step 2: Allocate Topics to Sections</h3>
                <div class="step-status">
                    <span class="status-badge status-pending" id="step-2-status">Pending</span>
                </div>
            </div>
            <div class="step-content">
                <div class="step-panels">
                    <div class="input-panel">
                        <h4>Section Structure</h4>
                        <div id="structure-display" class="structure-display">
                            <div class="text-muted">Section structure from Step 1</div>
                        </div>
                    </div>
                    <div class="output-panel">
                        <h4>Topic Allocation</h4>
                        <div id="allocation-display" class="allocation-display">
                            <div class="text-muted">Topic allocation will appear here after generation</div>
                        </div>
                        <div id="llm-response-display" class="llm-response-display" style="display: none;">
                            <h5>LLM Raw Response:</h5>
                            <pre id="raw-llm-response" class="raw-response"></pre>
                        </div>
                    </div>
                </div>
                <div class="action-panel">
                    <button onclick="allocateTopics()" class="btn btn-primary" id="step-2-btn">
                        <i class="fas fa-sitemap"></i> Allocate All Topics
                    </button>
                </div>
                <div class="loading-spinner" id="step-2-loading">
                    <div class="spinner"></div>
                    <div>Allocating topics to sections...</div>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Topic Refinement -->
        <div class="step-container" id="step-3" style="display: none;">
            <div class="step-header">
                <h3>Step 3: Refine Topics (Optional)</h3>
                <div class="step-status">
                    <span class="status-badge status-pending" id="step-3-status">Pending</span>
                </div>
            </div>
            <div class="step-content">
                <div class="step-panels">
                    <div class="input-panel">
                        <h4>Current Allocation</h4>
                        <div id="allocation-review" class="allocation-display">
                            <div class="text-muted">Current topic allocation from Step 2</div>
                        </div>
                    </div>
                    <div class="output-panel">
                        <h4>Refined Topics</h4>
                        <div id="refined-display" class="refined-display">
                            <div class="text-muted">Refined topics will appear here after processing</div>
                        </div>
                    </div>
                </div>
                <div class="action-panel">
                    <button onclick="refineTopics()" class="btn btn-primary" id="step-3-btn">
                        <i class="fas fa-filter"></i> Refine Overloaded Sections
                    </button>
                </div>
                <div class="loading-spinner" id="step-3-loading">
                    <div class="spinner"></div>
                    <div>Refining overloaded sections...</div>
                </div>
            </div>
        </div>
        
        <!-- Completion Summary -->
        <div class="step-container" id="completion-summary" style="display: none;">
            <div class="step-header">
                <h3>âœ… Topic Allocation Complete</h3>
                <div class="step-status">
                    <span class="status-badge status-completed">Completed</span>
                </div>
            </div>
            <div class="step-content">
                <div class="success-message">
                    <h5>ðŸŽ‰ All steps completed successfully!</h5>
                    <p>Your topics have been systematically allocated to sections and refined for optimal blog structure. You can now proceed to the authoring phase.</p>
                </div>
                <div class="action-panel">
                    <a href="/planning/posts/{{ post_id }}/concept/titling" class="btn btn-success">
                        <i class="fas fa-arrow-right"></i> Continue to Titling
                    </a>
                </div>
            </div>
        </div>
        
    </div>
    {% endblock %}
</div>

<script>
// Global variables
let currentStep = 1;
let topics = [];
let sectionStructure = null;
let topicAllocation = null;
let refinedTopics = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Set post ID for API calls
    window.postId = {{ post_id }};
    
    loadBrainstormTopics();
    updateProgressIndicator();
});

// Load topics from brainstorming
async function loadBrainstormTopics() {
    try {
        showLoading('topics-loading');
        
        const response = await fetch(`/planning/api/posts/${window.postId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.development && data.development.idea_scope) {
            const ideaScope = JSON.parse(data.development.idea_scope);
            topics = ideaScope.generated_topics || [];
            displayTopics();
        } else {
            showError('topics-display', 'No topics found. Please complete brainstorming first.');
        }
        
        hideLoading('topics-loading');
    } catch (error) {
        console.error('Error loading topics:', error);
        showError('topics-display', `Error loading topics from brainstorming: ${error.message}`);
        hideLoading('topics-loading');
    }
}

// Display topics
function displayTopics() {
    const container = document.getElementById('topics-display');
    
    if (!container) {
        console.error('topics-display container not found');
        return;
    }
    
    if (topics.length === 0) {
        container.innerHTML = '<div class="text-muted">No topics available</div>';
        return;
    }
    
    const topicsHtml = topics.map(topic => 
        `<div class="topic-item">${topic.title}</div>`
    ).join('');
    
    container.innerHTML = `
        <div class="mb-2">
            <strong>${topics.length} topics from brainstorming:</strong>
        </div>
        ${topicsHtml}
    `;
}

// Step 1: Design Section Structure
async function designSectionStructure() {
    try {
        showLoading('step-1-loading');
        disableButton('step-1-btn');
        
        const response = await fetch('/planning/api/sections/design-structure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topics: topics,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            sectionStructure = result.section_structure;
            displaySectionStructure();
            completeStep(1);
            showStep(2);
        } else {
            showError('section-structure-display', result.error);
        }
        
        hideLoading('step-1-loading');
        enableButton('step-1-btn');
    } catch (error) {
        console.error('Error designing section structure:', error);
        showError('section-structure-display', 'Error designing section structure.');
        hideLoading('step-1-loading');
        enableButton('step-1-btn');
    }
}

// Display section structure
function displaySectionStructure() {
    const container = document.getElementById('section-structure-display');
    
    if (!sectionStructure || !sectionStructure.sections) {
        container.innerHTML = '<div class="text-muted">No section structure available</div>';
        return;
    }
    
    const sectionsHtml = sectionStructure.sections.map(section => 
        `<div class="section-item">
            <div><strong>Section ${section.order}: ${section.theme}</strong></div>
            <div class="text-muted">${section.description}</div>
            <div class="text-muted"><small>Boundaries: ${section.boundaries}</small></div>
        </div>`
    ).join('');
    
    container.innerHTML = `
        <div class="mb-2">
            <strong>${sectionStructure.sections.length} sections designed:</strong>
        </div>
        ${sectionsHtml}
    `;
    
    // Update structure display for Step 2
    document.getElementById('structure-display').innerHTML = container.innerHTML;
}

// Step 2: Allocate Topics
async function allocateTopics() {
    try {
        showLoading('step-2-loading');
        disableButton('step-2-btn');
        
        // Clear previous LLM response
        hideLLMResponse();
        
        const response = await fetch('/planning/api/sections/allocate-topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topics: topics,
                section_structure: sectionStructure,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            topicAllocation = result.allocations;
            displayTopicAllocation();
            completeStep(2);
            showStep(3);
        } else {
            showError('allocation-display', result.error);
            // Show LLM response for debugging
            if (result.llm_response) {
                showLLMResponse(result.llm_response);
            }
        }
        
        hideLoading('step-2-loading');
        enableButton('step-2-btn');
    } catch (error) {
        console.error('Error allocating topics:', error);
        showError('allocation-display', `Error allocating topics: ${error.message}`);
        hideLoading('step-2-loading');
        enableButton('step-2-btn');
    }
}

// Display topic allocation
function displayTopicAllocation() {
    const container = document.getElementById('allocation-display');
    
    if (!topicAllocation || !topicAllocation.allocations) {
        container.innerHTML = '<div class="text-muted">No topic allocation available</div>';
        return;
    }
    
    const allocationsHtml = topicAllocation.allocations.map(allocation => 
        `<div class="allocation-item">
            <div class="section-theme">${allocation.section_theme}</div>
            <div class="topics-list">Topics: ${allocation.topics.join(', ')}</div>
            <div class="allocation-reason">${allocation.allocation_reason}</div>
        </div>`
    ).join('');
    
    container.innerHTML = `
        <div class="mb-2">
            <strong>${topicAllocation.allocations.length} sections with allocated topics:</strong>
        </div>
        ${allocationsHtml}
    `;
    
    // Update allocation review for Step 3
    document.getElementById('allocation-review').innerHTML = container.innerHTML;
}

// Step 3: Refine Topics
async function refineTopics() {
    try {
        showLoading('step-3-loading');
        disableButton('step-3-btn');
        
        const response = await fetch('/planning/api/sections/refine-topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                allocations: topicAllocation,
                section_structure: sectionStructure,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            refinedTopics = result.refined_data;
            displayRefinedTopics();
            completeStep(3);
            showCompletion();
        } else {
            showError('refined-display', result.error);
        }
        
        hideLoading('step-3-loading');
        enableButton('step-3-btn');
    } catch (error) {
        console.error('Error refining topics:', error);
        showError('refined-display', 'Error refining topics.');
        hideLoading('step-3-loading');
        enableButton('step-3-btn');
    }
}

// Display refined topics
function displayRefinedTopics() {
    const container = document.getElementById('refined-display');
    
    if (!refinedTopics) {
        container.innerHTML = '<div class="text-muted">No refined topics available</div>';
        return;
    }
    
    if (refinedTopics.metadata && refinedTopics.metadata.total_sections_refined === 0) {
        container.innerHTML = `
            <div class="success-message">
                <h5>âœ… No Refinement Needed</h5>
                <p>All sections already have optimal topic counts (â‰¤7 topics per section).</p>
            </div>
        `;
        return;
    }
    
    const refinedHtml = refinedTopics.allocations.map(allocation => 
        `<div class="allocation-item">
            <div class="section-theme">${allocation.section_theme}</div>
            <div class="topics-list">Final Topics: ${allocation.topics.join(', ')}</div>
            ${allocation.refinement_notes ? `<div class="allocation-reason">${allocation.refinement_notes}</div>` : ''}
        </div>`
    ).join('');
    
    container.innerHTML = `
        <div class="refinement-summary">
            <h5>Refinement Summary</h5>
            <div class="stats">
                <span>Sections Refined: ${refinedTopics.metadata.total_sections_refined}</span>
                <span>Original Topics: ${refinedTopics.metadata.original_topic_count}</span>
                <span>Final Topics: ${refinedTopics.metadata.refined_topic_count}</span>
            </div>
        </div>
        <div class="mb-2">
            <strong>Final topic allocation:</strong>
        </div>
        ${refinedHtml}
    `;
}

// Step management functions
function showStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= 3; i++) {
        document.getElementById(`step-${i}`).style.display = 'none';
    }
    
    // Show current step
    document.getElementById(`step-${stepNumber}`).style.display = 'block';
    
    // Update progress indicator
    updateProgressIndicator(stepNumber);
}

function completeStep(stepNumber) {
    const stepElement = document.getElementById(`step-${stepNumber}`);
    const statusElement = document.getElementById(`step-${stepNumber}-status`);
    
    stepElement.classList.remove('active');
    stepElement.classList.add('completed');
    statusElement.textContent = 'Completed';
    statusElement.className = 'status-badge status-completed';
    
    // Update progress indicator
    updateProgressIndicator(stepNumber, true);
}

function showCompletion() {
    document.getElementById('completion-summary').style.display = 'block';
}

function updateProgressIndicator(activeStep = currentStep, completed = false) {
    for (let i = 1; i <= 3; i++) {
        const stepNumber = document.getElementById(`progress-step-${i}`);
        const connector = document.getElementById(`connector-${i}-${i+1}`);
        
        if (i < activeStep || (i === activeStep && completed)) {
            stepNumber.className = 'step-number completed';
            if (connector) connector.className = 'progress-connector completed';
        } else if (i === activeStep) {
            stepNumber.className = 'step-number active';
        } else {
            stepNumber.className = 'step-number pending';
            if (connector) connector.className = 'progress-connector';
        }
    }
}

// Utility functions
function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.add('active');
    }
}

function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.remove('active');
    }
}

function showError(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `<div class="error-message">${message}</div>`;
    }
}

function disableButton(buttonId) {
    document.getElementById(buttonId).disabled = true;
}

function enableButton(buttonId) {
    document.getElementById(buttonId).disabled = false;
}

function showLLMResponse(response) {
    const display = document.getElementById('llm-response-display');
    const rawResponse = document.getElementById('raw-llm-response');
    if (display && rawResponse) {
        rawResponse.textContent = response;
        display.style.display = 'block';
    }
}

function hideLLMResponse() {
    const display = document.getElementById('llm-response-display');
    if (display) {
        display.style.display = 'none';
    }
}
</script>
{% endblock %}