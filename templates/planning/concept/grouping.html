{% extends "base.html" %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
<style>
/* Orthodox Layout Styles */
.grouping-main {
    display: flex;
    gap: 30px;
    margin-top: 20px;
}

.input-panel, .output-panel {
    flex: 1;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
}

.input-panel h4, .output-panel h4 {
    margin: 0 0 15px 0;
    color: #495057;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
}

.topics-display, .final-results-display {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    min-height: 200px;
    margin-bottom: 15px;
}

.topic-item {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 5px 0;
    font-size: 14px;
}

.section-group {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    margin: 10px 0;
    overflow: hidden;
}

.section-header {
    background: #007bff;
    color: white;
    padding: 10px 15px;
    font-weight: bold;
}

.section-topics {
    padding: 15px;
}

.section-topic {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 5px 0;
    font-size: 14px;
}

/* Accordion Styles */
.process-accordion {
    margin-top: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.accordion-header {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.accordion-header:hover {
    background: #e9ecef;
}

.accordion-content {
    padding: 20px;
}

/* 3-Step Process Styles (when accordion is open) */
.three-step-process {
    max-width: 1200px;
    margin: 0 auto;
}

.step-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    overflow: hidden;
}

.step-container.active {
    border: 2px solid #007bff;
}

.step-container.completed {
    border: 2px solid #28a745;
    background: #f8fff9;
}

.step-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.step-header h3 {
    margin: 0;
    color: #495057;
}

.step-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.step-status .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
}

.step-status .status-badge.pending {
    background: #6c757d;
    color: white;
}

.step-status .status-badge.active {
    background: #007bff;
    color: white;
}

.step-status .status-badge.completed {
    background: #28a745;
    color: white;
}

.step-content {
    padding: 20px;
}

.step-content.hidden {
    display: none;
}

.input-output-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.input-panel-step, .output-panel-step {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
}

.input-panel-step h4, .output-panel-step h4 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
}

.action-panel {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-primary:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.btn-outline-secondary {
    background: transparent;
    color: #6c757d;
    border: 1px solid #6c757d;
}

.btn-outline-secondary:hover {
    background: #6c757d;
    color: white;
}

.loading {
    display: none;
    text-align: center;
    padding: 20px;
    color: #6c757d;
}

.loading.show {
    display: block;
}

.error-message {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.success-message {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.llm-response-display {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}

.llm-response-display h5 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
}

.raw-response {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #495057;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block title %}Section Grouping - Concept Development - Planning - BlogForge{% endblock %}

{% block content %}
<div class="container">
    <!-- Include condensed header -->
    {% include 'planning/includes/condensed_header.html' %}
    
    {% block process_content %}
    <div class="grouping-main">
        <!-- Left Panel: Input Data -->
        <div class="input-panel">
            <h4>Input Data</h4>
            <div id="topics-display" class="topics-display">
                <div class="text-muted">Loading topics from brainstorming...</div>
            </div>
            <div class="input-actions">
                <button class="btn btn-primary" onclick="runSectionGrouping()" id="run-grouping-btn">
                    <i class="fas fa-sitemap"></i> Run Section Grouping
                </button>
            </div>
        </div>
        
        <!-- Right Panel: Final Results -->
        <div class="output-panel">
            <h4>Final Results</h4>
            <div id="final-results-display" class="final-results-display">
                <div class="text-muted">Section grouping results will appear here</div>
            </div>
            <div class="output-actions">
                <button class="btn btn-outline-secondary" onclick="toggleProcessDetails()" id="toggle-process-btn">
                    <i class="fas fa-cog"></i> Show Process Details
                </button>
            </div>
        </div>
    </div>
    
    <!-- Accordion Content (Hidden by Default) -->
    <div id="process-accordion" class="process-accordion" style="display: none;">
        <div class="accordion-header" onclick="toggleProcessDetails()">
            <h4>3-Step Topic Allocation Process</h4>
            <i class="fas fa-chevron-up" id="accordion-icon"></i>
        </div>
        <div class="accordion-content">
            <div class="three-step-process">
                <!-- Step 1: Section Structure Design -->
                <div class="step-container" id="step-1-container">
                    <div class="step-header">
                        <h3>Step 1: Section Structure Design</h3>
                        <div class="step-status">
                            <span class="status-badge pending" id="step-1-status">Pending</span>
                        </div>
                    </div>
                    <div class="step-content" id="step-1-content">
                        <div class="input-output-grid">
                            <div class="input-panel-step">
                                <h4>Input Data</h4>
                                <div id="step-1-input" class="step-input">
                                    <div class="text-muted">Topics from brainstorming</div>
                                </div>
                            </div>
                            <div class="output-panel-step">
                                <h4>Section Structure</h4>
                                <div id="structure-display" class="structure-display">
                                    <div class="text-muted">Section structure from Step 1</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-panel">
                            <button onclick="designSectionStructure()" class="btn btn-primary" id="step-1-btn">
                                <i class="fas fa-cogs"></i> Design Section Structure
                            </button>
                            <div id="step-1-loading" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Generating section structure...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Topic Allocation -->
                <div class="step-container" id="step-2-container">
                    <div class="step-header">
                        <h3>Step 2: Topic Allocation</h3>
                        <div class="step-status">
                            <span class="status-badge pending" id="step-2-status">Pending</span>
                        </div>
                    </div>
                    <div class="step-content hidden" id="step-2-content">
                        <div class="input-output-grid">
                            <div class="input-panel-step">
                                <h4>Input Data</h4>
                                <div id="step-2-input" class="step-input">
                                    <div class="text-muted">Topics and section structure</div>
                                </div>
                            </div>
                            <div class="output-panel-step">
                                <h4>Topic Allocation</h4>
                                <div id="allocation-display" class="allocation-display">
                                    <div class="text-muted">Topic allocation will appear here after generation</div>
                                </div>
                                <div id="llm-response-display" class="llm-response-display" style="display: none;">
                                    <h5>LLM Raw Response:</h5>
                                    <pre id="raw-llm-response" class="raw-response"></pre>
                                </div>
                            </div>
                        </div>
                        <div class="action-panel">
                            <button onclick="allocateTopics()" class="btn btn-primary" id="step-2-btn">
                                <i class="fas fa-sitemap"></i> Allocate All Topics
                            </button>
                            <div id="step-2-loading" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Allocating topics...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Topic Refinement -->
                <div class="step-container" id="step-3-container">
                    <div class="step-header">
                        <h3>Step 3: Topic Refinement</h3>
                        <div class="step-status">
                            <span class="status-badge pending" id="step-3-status">Pending</span>
                        </div>
                    </div>
                    <div class="step-content hidden" id="step-3-content">
                        <div class="input-output-grid">
                            <div class="input-panel-step">
                                <h4>Input Data</h4>
                                <div id="step-3-input" class="step-input">
                                    <div class="text-muted">Allocated topics by section</div>
                                </div>
                            </div>
                            <div class="output-panel-step">
                                <h4>Refined Topics</h4>
                                <div id="refinement-display" class="refinement-display">
                                    <div class="text-muted">Refined topic allocation will appear here</div>
                                </div>
                            </div>
                        </div>
                        <div class="action-panel">
                            <button onclick="refineTopics()" class="btn btn-primary" id="step-3-btn">
                                <i class="fas fa-filter"></i> Refine Topics
                            </button>
                            <div id="step-3-loading" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Refining topics...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
</div>

<script>
// Set post ID for API calls
window.postId = {{ post_id }};

// Global variables
let topics = [];
let sectionStructure = null;
let topicAllocation = null;
let refinedTopics = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadBrainstormTopics();
});

// Load topics from brainstorming
async function loadBrainstormTopics() {
    try {
        const response = await fetch(`/planning/api/posts/${window.postId}`);
        const data = await response.json();
        
        if (data.success && data.development && data.development.idea_scope) {
            const ideaScope = JSON.parse(data.development.idea_scope);
            if (ideaScope.generated_topics && Array.isArray(ideaScope.generated_topics)) {
                topics = ideaScope.generated_topics.map(topic => topic.title);
                displayTopics();
            } else {
                showError('topics-display', 'No generated topics found in brainstorming data');
            }
        } else {
            showError('topics-display', 'Error loading topics from brainstorming');
        }
    } catch (error) {
        console.error('Error loading topics:', error);
        showError('topics-display', 'Error loading topics from brainstorming');
    }
}

// Display topics in input panel
function displayTopics() {
    const container = document.getElementById('topics-display');
    container.innerHTML = '';
    
    topics.forEach((topic, index) => {
        const topicDiv = document.createElement('div');
        topicDiv.className = 'topic-item';
        topicDiv.textContent = `${index + 1}. ${topic}`;
        container.appendChild(topicDiv);
    });
}

// Run complete section grouping process
async function runSectionGrouping() {
    try {
        showLoading('run-grouping-btn');
        
        // Step 1: Design section structure
        await designSectionStructure();
        
        // Step 2: Allocate topics
        await allocateTopics();
        
        // Step 3: Refine topics (optional)
        await refineTopics();
        
        // Display final results
        displayFinalResults();
        
        hideLoading('run-grouping-btn');
    } catch (error) {
        console.error('Error in section grouping:', error);
        showError('final-results-display', `Error: ${error.message}`);
        hideLoading('run-grouping-btn');
    }
}

// Step 1: Design Section Structure
async function designSectionStructure() {
    try {
        showLoading('step-1-loading');
        disableButton('step-1-btn');
        
        const response = await fetch('/planning/api/sections/design-structure', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topics: topics,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            sectionStructure = result.structure;
            displaySectionStructure();
            completeStep(1);
            showStep(2);
        } else {
            showError('structure-display', result.error);
        }
        
        hideLoading('step-1-loading');
        enableButton('step-1-btn');
    } catch (error) {
        console.error('Error designing structure:', error);
        showError('structure-display', 'Error designing section structure.');
        hideLoading('step-1-loading');
        enableButton('step-1-btn');
    }
}

// Display section structure
function displaySectionStructure() {
    const container = document.getElementById('structure-display');
    container.innerHTML = '';
    
    sectionStructure.sections.forEach(section => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section-group';
        
        const header = document.createElement('div');
        header.className = 'section-header';
        header.textContent = `S${section.order.toString().padStart(2, '0')}: ${section.theme}`;
        
        const content = document.createElement('div');
        content.className = 'section-topics';
        content.innerHTML = `
            <div><strong>Boundaries:</strong> ${section.boundaries}</div>
            <div><strong>Exclusions:</strong> ${section.exclusions}</div>
        `;
        
        sectionDiv.appendChild(header);
        sectionDiv.appendChild(content);
        container.appendChild(sectionDiv);
    });
}

// Step 2: Allocate Topics
async function allocateTopics() {
    try {
        showLoading('step-2-loading');
        disableButton('step-2-btn');
        
        // Clear previous LLM response
        hideLLMResponse();
        
        const response = await fetch('/planning/api/sections/allocate-topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topics: topics,
                section_structure: sectionStructure,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            topicAllocation = result.allocations;
            displayTopicAllocation();
            completeStep(2);
            showStep(3);
        } else {
            let errorMsg = result.error;
            if (result.debug_info) {
                errorMsg += `\n\nDebug Info:\n${JSON.stringify(result.debug_info, null, 2)}`;
            }
            showError('allocation-display', errorMsg);
            // Show LLM response for debugging
            if (result.llm_response) {
                showLLMResponse(result.llm_response);
            }
        }
        
        hideLoading('step-2-loading');
        enableButton('step-2-btn');
    } catch (error) {
        console.error('Error allocating topics:', error);
        showError('allocation-display', `Network error: ${error.message}\n\nFull error: ${JSON.stringify(error, null, 2)}`);
        hideLoading('step-2-loading');
        enableButton('step-2-btn');
    }
}

// Display topic allocation
function displayTopicAllocation() {
    const container = document.getElementById('allocation-display');
    container.innerHTML = '';
    
    topicAllocation.allocations.forEach(allocation => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section-group';
        
        const header = document.createElement('div');
        header.className = 'section-header';
        header.textContent = `${allocation.section_id}: ${allocation.section_theme}`;
        
        const content = document.createElement('div');
        content.className = 'section-topics';
        
        allocation.topics.forEach(topic => {
            const topicDiv = document.createElement('div');
            topicDiv.className = 'section-topic';
            topicDiv.textContent = topic;
            content.appendChild(topicDiv);
        });
        
        sectionDiv.appendChild(header);
        sectionDiv.appendChild(content);
        container.appendChild(sectionDiv);
    });
}

// Step 3: Refine Topics
async function refineTopics() {
    try {
        showLoading('step-3-loading');
        disableButton('step-3-btn');
        
        const response = await fetch('/planning/api/sections/refine-topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic_allocation: topicAllocation,
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            refinedTopics = result.refined_topics;
            displayRefinedTopics();
            completeStep(3);
        } else {
            showError('refinement-display', result.error);
        }
        
        hideLoading('step-3-loading');
        enableButton('step-3-btn');
    } catch (error) {
        console.error('Error refining topics:', error);
        showError('refinement-display', 'Error refining topics.');
        hideLoading('step-3-loading');
        enableButton('step-3-btn');
    }
}

// Display refined topics
function displayRefinedTopics() {
    const container = document.getElementById('refinement-display');
    container.innerHTML = '';
    
    refinedTopics.allocations.forEach(allocation => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section-group';
        
        const header = document.createElement('div');
        header.className = 'section-header';
        header.textContent = `${allocation.section_id}: ${allocation.section_theme}`;
        
        const content = document.createElement('div');
        content.className = 'section-topics';
        
        allocation.topics.forEach(topic => {
            const topicDiv = document.createElement('div');
            topicDiv.className = 'section-topic';
            topicDiv.textContent = topic;
            content.appendChild(topicDiv);
        });
        
        sectionDiv.appendChild(header);
        sectionDiv.appendChild(content);
        container.appendChild(sectionDiv);
    });
}

// Display final results in orthodox layout
function displayFinalResults() {
    const container = document.getElementById('final-results-display');
    container.innerHTML = '';
    
    const finalData = refinedTopics || topicAllocation;
    
    finalData.allocations.forEach(allocation => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section-group';
        
        const header = document.createElement('div');
        header.className = 'section-header';
        header.textContent = `${allocation.section_id}: ${allocation.section_theme}`;
        
        const content = document.createElement('div');
        content.className = 'section-topics';
        
        allocation.topics.forEach(topic => {
            const topicDiv = document.createElement('div');
            topicDiv.className = 'section-topic';
            topicDiv.textContent = topic;
            content.appendChild(topicDiv);
        });
        
        sectionDiv.appendChild(header);
        sectionDiv.appendChild(content);
        container.appendChild(sectionDiv);
    });
}

// Toggle process details accordion
function toggleProcessDetails() {
    const accordion = document.getElementById('process-accordion');
    const toggleBtn = document.getElementById('toggle-process-btn');
    const icon = document.getElementById('accordion-icon');
    
    if (accordion.style.display === 'none') {
        accordion.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-cog"></i> Hide Process Details';
        icon.className = 'fas fa-chevron-down';
    } else {
        accordion.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-cog"></i> Show Process Details';
        icon.className = 'fas fa-chevron-up';
    }
}

// Step management functions
function completeStep(stepNumber) {
    const container = document.getElementById(`step-${stepNumber}-container`);
    const status = document.getElementById(`step-${stepNumber}-status`);
    
    container.classList.remove('active');
    container.classList.add('completed');
    status.textContent = 'Completed';
    status.className = 'status-badge completed';
}

function showStep(stepNumber) {
    const content = document.getElementById(`step-${stepNumber}-content`);
    const status = document.getElementById(`step-${stepNumber}-status`);
    const container = document.getElementById(`step-${stepNumber}-container`);
    
    content.classList.remove('hidden');
    container.classList.add('active');
    status.textContent = 'Active';
    status.className = 'status-badge active';
}

// Utility functions
function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.add('show');
    }
}

function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.remove('show');
    }
}

function showError(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `<div class="error-message">${message}</div>`;
    }
}

function disableButton(buttonId) {
    document.getElementById(buttonId).disabled = true;
}

function enableButton(buttonId) {
    document.getElementById(buttonId).disabled = false;
}

function showLLMResponse(response) {
    const display = document.getElementById('llm-response-display');
    const rawResponse = document.getElementById('raw-llm-response');
    if (display && rawResponse) {
        rawResponse.textContent = response;
        display.style.display = 'block';
    }
}

function hideLLMResponse() {
    const display = document.getElementById('llm-response-display');
    if (display) {
        display.style.display = 'none';
    }
}
</script>
{% endblock %}