{% extends "base.html" %}

{% block css_assets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/llm-module.css') }}">
{% endblock %}

{% block title %}Topic Allocation - Concept Development - Planning - BlogForge{% endblock %}

{% block content %}
<div class="container">
    <!-- Include condensed header -->
    {% include 'planning/includes/condensed_header.html' %}
    
    <script>
    // Move topic allocation content to process-tab after page loads
    document.addEventListener('DOMContentLoaded', function() {
        const allocationContent = document.querySelector('.brainstorm-main');
        const processTab = document.getElementById('process-tab');
        if (allocationContent && processTab) {
            processTab.appendChild(allocationContent);
        }
    });
    </script>
    
    <div class="brainstorm-main">
        
        <div class="brainstorm-content">
            <div class="idea-generator">
                <div class="input-data">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0;">Input Data</h4>
                        <button class="btn btn-primary" id="custom-allocate-btn" onclick="generateSectionSpecificTopics()" style="margin: 0;">
                            <i class="fas fa-magic"></i> Generate Section-Specific Topics
                        </button>
                    </div>
                    
                    <div class="input-section">
                        <h5>Section Structure</h5>
                        <div id="section-structure-display" class="expanded-idea-content">
                            <!-- Section structure from previous page will appear here -->
                        </div>
                    </div>
                    
                    
                </div>
            </div>
            
            <div class="brainstorm-results">
                {% include 'includes/llm_module.html' %}
            </div>
        </div>
    </div>
</div>

<style>
.brainstorm-main {
    padding: 2rem 0;
}

.brainstorm-header {
    text-align: center;
    margin-bottom: 3rem;
}

.brainstorm-header h2 {
    font-size: 2rem;
    color: #f1f5f9;
    margin-bottom: 0.5rem;
}

.brainstorm-header p {
    font-size: 1.125rem;
    color: #94a3b8;
    max-width: 600px;
    margin: 0 auto;
}

.brainstorm-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.idea-generator {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.input-data {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 1.5rem;
}

.input-data h4 {
    color: #f1f5f9;
    margin-bottom: 1rem;
    font-size: 1.125rem;
    font-weight: 600;
}

.input-section {
    margin-bottom: 1.5rem;
}

.input-section h5 {
    color: #e2e8f0;
    margin-bottom: 0.75rem;
    font-size: 1rem;
    font-weight: 600;
    border-bottom: 1px solid #334155;
    padding-bottom: 0.5rem;
}

.expanded-idea-content {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    min-height: 200px;
    max-height: 400px;
    overflow-y: auto;
}

.input-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.btn-primary:disabled {
    background: #64748b;
    cursor: not-allowed;
    transform: none;
}

.brainstorm-results {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 12px;
    padding: 1.5rem;
    min-height: 600px;
}

.topic-item {
    padding: 8px 12px;
    margin: 4px 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    border-left: 3px solid #3b82f6;
    font-size: 0.875rem;
}

.loading {
    color: #94a3b8;
    font-style: italic;
    text-align: center;
    padding: 2rem;
}

.error {
    color: #ef4444;
    text-align: center;
    padding: 2rem;
}

.section-structure-results {
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 8px;
    padding: 1rem;
}

.section-item {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.section-item h5 {
    color: #f1f5f9;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.section-item p {
    color: #cbd5e1;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.section-item strong {
    color: #e2e8f0;
}

.topics-list {
    max-height: 300px;
    overflow-y: auto;
}

.topics-list p {
    margin-bottom: 1rem;
    color: #e2e8f0;
    font-weight: 500;
}

.allocation-results {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 8px;
    padding: 1rem;
}

.allocation-results h4 {
    color: #f1f5f9;
    margin-bottom: 1rem;
    font-size: 1.125rem;
}

.section-allocation {
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.section-allocation h5 {
    color: #e2e8f0;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.topic-item {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 4px;
    padding: 0.5rem;
    margin: 0.25rem 0;
    color: #cbd5e1;
    font-size: 0.9rem;
}

.topic-content {
    padding: 0.5rem;
}

.topic-title {
    font-weight: 600;
    color: #f1f5f9; /* Changed to white for better contrast */
    margin-bottom: 0.5rem;
    font-size: 1.1rem; /* Slightly larger */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.topic-description {
    color: #cbd5e1;
    font-size: 0.9rem; /* Smaller */
    margin-bottom: 0.5rem;
    line-height: 1.4;
    font-style: italic; /* Italic */
}

.topic-category {
    color: #10b981; /* Green color */
    font-size: 0.85rem; /* Smallest */
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

@media (max-width: 1024px) {
    .brainstorm-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .brainstorm-main {
        padding: 1rem 0;
    }
}
</style>

<script>
// Set post ID for API calls
window.postId = {{ post_id }};

// Set navigation highlighting
window.currentStage = 'concept';
window.currentSubstage = 'topic-allocation';

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

let sectionStructure = null;
let llmModule = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSectionStructure();
    loadExistingAllocation();
    initializeTopicAllocationModule();
});

// Initialize LLM module
function initializeTopicAllocationModule() {
    if (typeof initializeLLMModule === 'function') {
        llmModule = initializeLLMModule('topic_allocation', window.postId);
    } else {
        console.error('initializeLLMModule function not found');
    }
}

// Load section structure from previous page
async function loadSectionStructure() {
    try {
        const response = await fetch(`/planning/api/sections/design-structure/${window.postId}`);
        const data = await response.json();
        
        if (data.success && data.section_structure) {
            sectionStructure = data.section_structure;
            displaySectionStructure(sectionStructure);
        } else {
            document.getElementById('section-structure-display').innerHTML = '<p class="error">No section structure found from previous page</p>';
        }
    } catch (error) {
        console.error('Error loading section structure:', error);
        document.getElementById('section-structure-display').innerHTML = '<p class="error">Error loading section structure</p>';
    }
}

// Load existing topic allocation
async function loadExistingAllocation() {
    try {
        const response = await fetch(`/planning/api/sections/allocate-topics/${window.postId}`);
        const result = await response.json();
        
        if (result.success && result.allocations) {
            // Display the existing allocation results
            displayAllocationResults(result);
            
            // Display the raw response if available
            if (result.raw_response) {
                displayRawResponse(result.raw_response);
            }
        }
    } catch (error) {
        console.error('Error loading existing allocation:', error);
        // Don't show error to user, just log it
    }
}

// Display section structure (same format as section structure page output)
function displaySectionStructure(structure) {
    const container = document.getElementById('section-structure-display');
    if (!structure) {
        container.innerHTML = '<p class="error">No section structure available</p>';
        return;
    }
    
    console.log('Displaying structure:', structure);
    
    let html = '<div class="section-structure-results">';
    
    // Handle both new format (array) and old format (object with sections)
    let sections = [];
    if (Array.isArray(structure)) {
        sections = structure;
    } else if (structure.sections) {
        sections = structure.sections;
    }
    
    console.log('Sections to display:', sections);
    
    sections.forEach((section, index) => {
        const sectionCode = section.section_code || `S${String(index + 1).padStart(2, '0')}`;
        const title = section.title || section.theme || 'Untitled Section'; // Support both new and old format
        const description = section.description || 'No description available';
        
        console.log(`Section ${index}:`, { sectionCode, title, description, section });
        
        html += `
            <div class="section-item">
                <h5>{${sectionCode}} ${escapeHtml(title)}</h5>
                <p><strong>Description:</strong> ${escapeHtml(description)}</p>
        `;
        
        // Show boundaries, topics, and exclusions if they exist (old format compatibility)
        if (section.boundaries && (Array.isArray(section.boundaries) ? section.boundaries.length > 0 : section.boundaries)) {
            const boundaries = Array.isArray(section.boundaries) ? section.boundaries.join(', ') : section.boundaries;
            html += `<p><strong>Boundaries:</strong> ${escapeHtml(boundaries)}</p>`;
        }
        
        if (section.topics && section.topics.length > 0) {
            const topics = Array.isArray(section.topics) ? section.topics.join(', ') : section.topics;
            html += `<p><strong>Topics:</strong> ${escapeHtml(topics)}</p>`;
        }
        
        if (section.exclusions && section.exclusions.length > 0) {
            const exclusions = Array.isArray(section.exclusions) ? section.exclusions.join(', ') : section.exclusions;
            html += `<p><strong>Exclusions:</strong> ${escapeHtml(exclusions)}</p>`;
        }
        
        html += `</div>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
}


// Generate section-specific topics
async function generateSectionSpecificTopics() {
    const btn = document.getElementById('custom-allocate-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Topics...';
    
    try {
        // Generate section-specific topics
        const response = await fetch('/planning/api/sections/generate-section-specific-topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                post_id: window.postId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Display the results in the LLM module
            console.log('Section-specific topics generated successfully');
            displayAllocationResults(result);
            
            // Display the raw LLM response
            if (result.raw_response) {
                displayRawResponse(result.raw_response);
            }
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error generating section-specific topics:', error);
        alert('Error generating topics: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> Generate Section-Specific Topics';
    }
}

// Display allocation results
function displayAllocationResults(result) {
    const resultsDisplay = document.getElementById('llm-results-display');
    if (!resultsDisplay) return;
    
    let html = '<div class="allocation-results">';
    html += '<h4>Topic Allocation Results</h4>';
    
    if (result.allocations && result.allocations.allocations) {
        // Sort sections by section_id to match the order from section structure
        const sortedSections = result.allocations.allocations.sort((a, b) => {
            const aNum = parseInt(a.section_id.replace('section_', ''));
            const bNum = parseInt(b.section_id.replace('section_', ''));
            return aNum - bNum;
        });
        
        sortedSections.forEach(section => {
            html += `<div class="section-allocation">`;
            html += `<h5>${section.section_theme}</h5>`;
            html += `<div class="topics-list">`;
            section.topics.forEach(topic => {
                html += `<div class="topic-item">${topic}</div>`;
            });
            html += `</div></div>`;
        });
    }
    
    html += '</div>';
    resultsDisplay.innerHTML = html;
}

// Display raw LLM response
function displayRawResponse(rawResponse) {
    const rawResponseElement = document.getElementById('raw-llm-response');
    if (rawResponseElement) {
        rawResponseElement.textContent = rawResponse;
    }
}
</script>

<!-- LLM Module JavaScript Files -->
<script src="{{ url_for('static', filename='js/llm-config.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-ui-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-api-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-event-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/llm-module.js') }}"></script>

{% endblock %}
